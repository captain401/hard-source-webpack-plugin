'use strict';

const relateContext = require('./util/relate-context');
const pluginCompat = require('./util/plugin-compat');

const GeneratorSchemas4 = [['ByTypeGenerator', 'map'], ['JavascriptGenerator'], ['JsonGenerator'], ['WebAssemblyGenerator'], ['WebAssemblyJavascriptGenerator']];

try {
  try {
    GeneratorSchemas4[0].Generator = require('webpack/lib/Generator').byType({}).constructor;
  } catch (_) {}
  GeneratorSchemas4[1].Generator = require('webpack/lib/JavascriptGenerator');
  GeneratorSchemas4[2].Generator = require('webpack/lib/JsonGenerator');
  try {
    GeneratorSchemas4[3].Generator = require('webpack/lib/WebAssemblyGenerator');
  } catch (_) {
    GeneratorSchemas4[3].Generator = require('webpack/lib/wasm/WebAssemblyGenerator');
  }
  try {
    GeneratorSchemas4[4].Generator = require('webpack/lib/wasm/WebAssemblyJavascriptGenerator');
  } catch (_) {}
} catch (_) {}

const freezeArgument = {
  map(arg, generator, extra, methods) {
    const map = {};
    for (const key in arg) {
      map[key] = methods.freeze('Generator', null, arg[key], extra);
    }
    return map;
  }
};

const thawArgument = {
  map(arg, generator, extra, methods) {
    const map = {};
    for (const key in arg) {
      map[key] = methods.thaw('Generator', null, arg[key], extra);
    }
    return map;
  }
};

function freezeGenerator(generator, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (generator.constructor === schemas[i].Generator) {
      const frozen = {
        type: schemas[i][0]
      };
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = generator[schemas[i][j]];
        if (freezeArgument[schemas[i][j]]) {
          arg = freezeArgument[schemas[i][j]](arg, generator, extra, methods);
        }
        frozen[schemas[i][j]] = arg;
      }
      return frozen;
    }
  }
}

function thawGenerator(frozen, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (frozen.type === schemas[i][0]) {
      const Generator = schemas[i].Generator;
      const args = [];
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = frozen[schemas[i][j]];
        if (thawArgument[schemas[i][j]]) {
          arg = thawArgument[schemas[i][j]](arg, frozen, extra, methods);
        }
        args.push(arg);
      }
      try {
        return new Generator(...args);
      } catch (_) {
        return new (Function.prototype.bind.apply(Generator, [null].concat(args)))();
      }
    }
  }
}

class TransformGeneratorPlugin {
  apply(compiler) {
    pluginCompat.register(compiler, '_hardSourceBeforeFreezeGenerator', 'syncWaterfall', ['frozen', 'item', 'extra']);
    pluginCompat.register(compiler, '_hardSourceFreezeGenerator', 'syncWaterfall', ['frozen', 'item', 'extra']);
    pluginCompat.register(compiler, '_hardSourceAfterFreezeGenerator', 'syncWaterfall', ['frozen', 'item', 'extra']);

    pluginCompat.register(compiler, '_hardSourceBeforeThawGenerator', 'syncWaterfall', ['item', 'frozen', 'extra']);
    pluginCompat.register(compiler, '_hardSourceThawGenerator', 'syncWaterfall', ['item', 'frozen', 'extra']);
    pluginCompat.register(compiler, '_hardSourceAfterThawGenerator', 'syncWaterfall', ['item', 'frozen', 'extra']);

    let methods;

    pluginCompat.tap(compiler, '_hardSourceMethods', 'TransformGeneratorPlugin', _methods => {
      methods = _methods;
    });

    pluginCompat.tap(compiler, '_hardSourceFreezeGenerator', 'TransformGeneratorPlugin freeze', (frozen, generator, extra) => {
      extra.schemas = GeneratorSchemas4;
      frozen = freezeGenerator(generator, extra, methods);
      frozen.moduleType = extra.module.type;
      frozen.options = {};
      return frozen;
    });

    pluginCompat.tap(compiler, '_hardSourceThawGenerator', 'TransformGeneratorPlugin thaw', (generator, { moduleType, options }, { normalModuleFactory }) => {
      return normalModuleFactory.getGenerator(moduleType, options);
    });
  }
}

module.exports = TransformGeneratorPlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9UcmFuc2Zvcm1HZW5lcmF0b3JQbHVnaW4uanMiXSwibmFtZXMiOlsicmVsYXRlQ29udGV4dCIsInJlcXVpcmUiLCJwbHVnaW5Db21wYXQiLCJHZW5lcmF0b3JTY2hlbWFzNCIsIkdlbmVyYXRvciIsImJ5VHlwZSIsImNvbnN0cnVjdG9yIiwiXyIsImZyZWV6ZUFyZ3VtZW50IiwibWFwIiwiYXJnIiwiZ2VuZXJhdG9yIiwiZXh0cmEiLCJtZXRob2RzIiwia2V5IiwiZnJlZXplIiwidGhhd0FyZ3VtZW50IiwidGhhdyIsImZyZWV6ZUdlbmVyYXRvciIsInNjaGVtYXMiLCJpIiwibGVuZ3RoIiwiZnJvemVuIiwidHlwZSIsImoiLCJ0aGF3R2VuZXJhdG9yIiwiYXJncyIsInB1c2giLCJGdW5jdGlvbiIsInByb3RvdHlwZSIsImJpbmQiLCJhcHBseSIsImNvbmNhdCIsIlRyYW5zZm9ybUdlbmVyYXRvclBsdWdpbiIsImNvbXBpbGVyIiwicmVnaXN0ZXIiLCJ0YXAiLCJfbWV0aG9kcyIsIm1vZHVsZVR5cGUiLCJtb2R1bGUiLCJvcHRpb25zIiwibm9ybWFsTW9kdWxlRmFjdG9yeSIsImdldEdlbmVyYXRvciIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTUEsZ0JBQWdCQyxnQ0FBdEI7QUFDQSxNQUFNQyxlQUFlRCwrQkFBckI7O0FBRUEsTUFBTUUsb0JBQW9CLENBQ3hCLENBQUMsaUJBQUQsRUFBb0IsS0FBcEIsQ0FEd0IsRUFFeEIsQ0FBQyxxQkFBRCxDQUZ3QixFQUd4QixDQUFDLGVBQUQsQ0FId0IsRUFJeEIsQ0FBQyxzQkFBRCxDQUp3QixFQUt4QixDQUFDLGdDQUFELENBTHdCLENBQTFCOztBQVFBLElBQUk7QUFDRixNQUFJO0FBQ0ZBLHNCQUFrQixDQUFsQixFQUFxQkMsU0FBckIsR0FBaUNILFFBQVEsdUJBQVIsRUFBaUNJLE1BQWpDLENBQy9CLEVBRCtCLEVBRS9CQyxXQUZGO0FB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LEVBSUUsQ0FBQ3ZCLFNBQUQsRUFBWSxFQUFFMkIsVUFBRixFQUFjRSxPQUFkLEVBQVosRUFBcUMsRUFBRUMsbUJBQUYsRUFBckMsS0FBaUU7QUFDL0QsYUFBT0Esb0JBQW9CQyxZQUFwQixDQUFpQ0osVUFBakMsRUFBNkNFLE9BQTdDLENBQVA7QUFDRCxLQU5IO0FBUUQ7QUF4RTRCOztBQTJFL0JELE9BQU9JLE9BQVAsR0FBaUJWLHdCQUFqQiIsImZpbGUiOiJoYXJkLXNvdXJjZS13ZWJwYWNrLXBsdWdpbi9saWIvVHJhbnNmb3JtR2VuZXJhdG9yUGx1Z2luLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcmVsYXRlQ29udGV4dCA9IHJlcXVpcmUoJy4vdXRpbC9yZWxhdGUtY29udGV4dCcpO1xuY29uc3QgcGx1Z2luQ29tcGF0ID0gcmVxdWlyZSgnLi91dGlsL3BsdWdpbi1jb21wYXQnKTtcblxuY29uc3QgR2VuZXJhdG9yU2NoZW1hczQgPSBbXG4gIFsnQnlUeXBlR2VuZXJhdG9yJywgJ21hcCddLFxuICBbJ0phdmFzY3JpcHRHZW5lcmF0b3InXSxcbiAgWydKc29uR2VuZXJhdG9yJ10sXG4gIFsnV2ViQXNzZW1ibHlHZW5lcmF0b3InXSxcbiAgWydXZWJBc3NlbWJseUphdmFzY3JpcHRHZW5lcmF0b3InXSxcbl07XG5cbnRyeSB7XG4gIHRyeSB7XG4gICAgR2VuZXJhdG9yU2NoZW1hczRbMF0uR2VuZXJhdG9yID0gcmVxdWlyZSgnd2VicGFjay9saWIvR2VuZXJhdG9yJykuYnlUeXBlKFxuICAgICAge30sXG4gICAgKS5jb25zdHJ1Y3RvcjtcbiAgfSBjYXRjaCAoXykge31cbiAgR2VuZXJhdG9yU2NoZW1hczRbMV0uR2VuZXJhdG9yID0gcmVxdWlyZSgnd2VicGFjay9saWIvSmF2YXNjcmlwdEdlbmVyYXRvcicpO1xuICBHZW5lcmF0b3JTY2hlbWFzNFsyXS5HZW5lcmF0b3IgPSByZXF1aXJlKCd3ZWJwYWNrL2xpYi9Kc29uR2VuZXJhdG9yJyk7XG4gIHRyeSB7XG4gICAgR2VuZXJhdG9yU2NoZW1hczRbM10uR2VuZXJhdG9yID0gcmVxdWlyZSgnd2VicGFjay9saWIvV2ViQXNzZW1ibHlHZW5lcmF0b3InKTtcbiAgfSBjYXRjaCAoXykge1xuICAgIEdlbmVyYXRvclNjaGVtYXM0WzNdLkdlbmVyYXRvciA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL3dhc20vV2ViQXNzZW1ibHlHZW5lcmF0b3InKTtcbiAgfVxuICB0cnkge1xuICAgIEdlbmVyYXRvclNjaGVtYXM0WzRdLkdlbmVyYXRvciA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL3dhc20vV2ViQXNzZW1ibHlKYXZhc2NyaXB0R2VuZXJhdG9yJyk7XG4gIH0gY2F0Y2ggKF8pIHt9XG59IGNhdGNoIChfKSB7fVxuXG5jb25zdCBmcmVlemVBcmd1bWVudCA9IHtcbiAgbWFwKGFyZywgZ2VuZXJhdG9yLCBleHRyYSwgbWV0aG9kcykge1xuICAgIGNvbnN0IG1hcCA9IHt9O1xuICAgIGZvciAoY29uc3Qga2V5IGluIGFyZykge1xuICAgICAgbWFwW2tleV0gPSBtZXRob2RzLmZyZWV6ZSgnR2VuZXJhdG9yJywgbnVsbCwgYXJnW2tleV0sIGV4dHJhKTtcbiAgICB9XG4gICAgcmV0dXJuIG1hcDtcbiAgfSxcbn07XG5cbmNvbnN0IHRoYXdBcmd1bWVudCA9IHtcbiAgbWFwKGFyZywgZ2VuZXJhdG9yLCBleHRyYSwgbWV0aG9kcykge1xuICAgIGNvbnN0IG1hcCA9IHt9O1xuICAgIGZvciAoY29uc3Qga2V5IGluIGFyZykge1xuICAgICAgbWFwW2tleV0gPSBtZXRob2RzLnRoYXcoJ0dlbmVyYXRvcicsIG51bGwsIGFyZ1trZXldLCBleHRyYSk7XG4gICAgfVxuICAgIHJldHVybiBtYXA7XG4gIH0sXG59O1xuXG5mdW5jdGlvbiBmcmVlemVHZW5lcmF0b3IoZ2VuZXJhdG9yLCBleHRyYSwgbWV0aG9kcykge1xuICBjb25zdCBzY2hlbWFzID0gZXh0cmEuc2NoZW1hcztcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzY2hlbWFzLmxlbmd0aDsgaSsrKSB7XG4gICAgaWYgKGdlbmVyYXRvci5jb25zdHJ1Y3RvciA9PT0gc2NoZW1hc1tpXS5HZW5lcmF0b3IpIHtcbiAgICAgIGNvbnN0IGZyb3plbiA9IHtcbiAgICAgICAgdHlwZTogc2NoZW1hc1tpXVswXSxcbiAgICAgIH07XG4gICAgICBmb3IgKGxldCBqID0gMTsgaiA8IHNjaGVtYXNbaV0ubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgbGV0IGFyZyA9IGdlbmVyYXRvcltzY2hlbWFzW2ldW2pdXTtcbiAgICAgICAgaWYgKGZyZWV6ZUFyZ3VtZW50W3NjaGVtYXNbaV1bal1dKSB7XG4gICAgICAgICAgYXJnID0gZnJlZXplQXJndW1lbnRbc2NoZW1hc1tpXVtqXV0oYXJnLCBnZW5lcmF0b3IsIGV4dHJhLCBtZXRob2RzKTtcbiAgICAgICAgfVxuICAgICAgICBmcm96ZW5bc2NoZW1hc1tpXVtqXV0gPSBhcmc7XG4gICAgICB9XG4gICAgICByZXR1cm4gZnJvemVuO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiB0aGF3R2VuZXJhdG9yKGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgY29uc3Qgc2NoZW1hcyA9IGV4dHJhLnNjaGVtYXM7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgc2NoZW1hcy5sZW5ndGg7IGkrKykge1xuICAgIGlmIChmcm96ZW4udHlwZSA9PT0gc2NoZW1hc1tpXVswXSkge1xuICAgICAgY29uc3QgR2VuZXJhdG9yID0gc2NoZW1hc1tpXS5HZW5lcmF0b3I7XG4gICAgICBjb25zdCBhcmdzID0gW107XG4gICAgICBmb3IgKGxldCBqID0gMTsgaiA8IHNjaGVtYXNbaV0ubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgbGV0IGFyZyA9IGZyb3plbltzY2hlbWFzW2ldW2pdXTtcbiAgICAgICAgaWYgKHRoYXdBcmd1bWVudFtzY2hlbWFzW2ldW2pdXSkge1xuICAgICAgICAgIGFyZyA9IHRoYXdBcmd1bWVudFtzY2hlbWFzW2ldW2pdXShhcmcsIGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpO1xuICAgICAgICB9XG4gICAgICAgIGFyZ3MucHVzaChhcmcpO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIG5ldyBHZW5lcmF0b3IoLi4uYXJncyk7XG4gICAgICB9IGNhdGNoIChfKSB7XG4gICAgICAgIHJldHVybiBuZXcgKEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kLmFwcGx5KFxuICAgICAgICAgIEdlbmVyYXRvcixcbiAgICAgICAgICBbbnVsbF0uY29uY2F0KGFyZ3MpLFxuICAgICAgICApKSgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5jbGFzcyBUcmFuc2Zvcm1HZW5lcmF0b3JQbHVnaW4ge1xuICBhcHBseShjb21waWxlcikge1xuICAgIHBsdWdpbkNvbXBhdC5yZWdpc3RlcihcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlQmVmb3JlRnJlZXplR2VuZXJhdG9yJyxcbiAgICAgICdzeW5jV2F0ZXJmYWxsJyxcbiAgICAgIFsnZnJvemVuJywgJ2l0ZW0nLCAnZXh0cmEnXSxcbiAgICApO1xuICAgIHBsdWdpbkNvbXBhdC5yZWdpc3RlcihcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlRnJlZXplR2VuZXJhdG9yJyxcbiAgICAgICdzeW5jV2F0ZXJmYWxsJyxcbiAgICAgIFsnZnJvemVuJywgJ2l0ZW0nLCAnZXh0cmEnXSxcbiAgICApO1xuICAgIHBsdWdpbkNvbXBhdC5yZWdpc3RlcihcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlQWZ0ZXJGcmVlemVHZW5lcmF0b3InLFxuICAgICAgJ3N5bmNXYXRlcmZhbGwnLFxuICAgICAgWydmcm96ZW4nLCAnaXRlbScsICdleHRyYSddLFxuICAgICk7XG5cbiAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZUJlZm9yZVRoYXdHZW5lcmF0b3InLFxuICAgICAgJ3N5bmNXYXRlcmZhbGwnLFxuICAgICAgWydpdGVtJywgJ2Zyb3plbicsICdleHRyYSddLFxuICAgICk7XG4gICAgcGx1Z2luQ29tcGF0LnJlZ2lzdGVyKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnX2hhcmRTb3VyY2VUaGF3R2VuZXJhdG9yJyxcbiAgICAgICdzeW5jV2F0ZXJmYWxsJyxcbiAgICAgIFsnaXRlbScsICdmcm96ZW4nLCAnZXh0cmEnXSxcbiAgICApO1xuICAgIHBsdWdpbkNvbXBhdC5yZWdpc3RlcihcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlQWZ0ZXJUaGF3R2VuZXJhdG9yJyxcbiAgICAgICdzeW5jV2F0ZXJmYWxsJyxcbiAgICAgIFsnaXRlbScsICdmcm96ZW4nLCAnZXh0cmEnXSxcbiAgICApO1xuXG4gICAgbGV0IG1ldGhvZHM7XG5cbiAgICBwbHVnaW5Db21wYXQudGFwKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnX2hhcmRTb3VyY2VNZXRob2RzJyxcbiAgICAgICdUcmFuc2Zvcm1HZW5lcmF0b3JQbHVnaW4nLFxuICAgICAgX21ldGhvZHMgPT4ge1xuICAgICAgICBtZXRob2RzID0gX21ldGhvZHM7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICBwbHVnaW5Db21wYXQudGFwKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnX2hhcmRTb3VyY2VGcmVlemVHZW5lcmF0b3InLFxuICAgICAgJ1RyYW5zZm9ybUdlbmVyYXRvclBsdWdpbiBmcmVlemUnLFxuICAgICAgKGZyb3plbiwgZ2VuZXJhdG9yLCBleHRyYSkgPT4ge1xuICAgICAgICBleHRyYS5zY2hlbWFzID0gR2VuZXJhdG9yU2NoZW1hczQ7XG4gICAgICAgIGZyb3plbiA9IGZyZWV6ZUdlbmVyYXRvcihnZW5lcmF0b3IsIGV4dHJhLCBtZXRob2RzKTtcbiAgICAgICAgZnJvemVuLm1vZHVsZVR5cGUgPSBleHRyYS5tb2R1bGUudHlwZTtcbiAgICAgICAgZnJvemVuLm9wdGlvbnMgPSB7fTtcbiAgICAgICAgcmV0dXJuIGZyb3plbjtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZVRoYXdHZW5lcmF0b3InLFxuICAgICAgJ1RyYW5zZm9ybUdlbmVyYXRvclBsdWdpbiB0aGF3JyxcbiAgICAgIChnZW5lcmF0b3IsIHsgbW9kdWxlVHlwZSwgb3B0aW9ucyB9LCB7IG5vcm1hbE1vZHVsZUZhY3RvcnkgfSkgPT4ge1xuICAgICAgICByZXR1cm4gbm9ybWFsTW9kdWxlRmFjdG9yeS5nZXRHZW5lcmF0b3IobW9kdWxlVHlwZSwgb3B0aW9ucyk7XG4gICAgICB9LFxuICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBUcmFuc2Zvcm1HZW5lcmF0b3JQbHVnaW47XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
