'use strict';

require('source-map-support/register');

const relateContext = require('./util/relate-context');
const pluginCompat = require('./util/plugin-compat');

const GeneratorSchemas4 = [['ByTypeGenerator', 'map'], ['JavascriptGenerator'], ['JsonGenerator'], ['WebAssemblyGenerator'], ['WebAssemblyJavascriptGenerator']];

try {
  try {
    GeneratorSchemas4[0].Generator = require('webpack/lib/Generator').byType({}).constructor;
  } catch (_) {}
  GeneratorSchemas4[1].Generator = require('webpack/lib/JavascriptGenerator');
  GeneratorSchemas4[2].Generator = require('webpack/lib/JsonGenerator');
  try {
    GeneratorSchemas4[3].Generator = require('webpack/lib/WebAssemblyGenerator');
  } catch (_) {
    GeneratorSchemas4[3].Generator = require('webpack/lib/wasm/WebAssemblyGenerator');
  }
  try {
    GeneratorSchemas4[4].Generator = require('webpack/lib/wasm/WebAssemblyJavascriptGenerator');
  } catch (_) {}
} catch (_) {}

const freezeArgument = {
  map(arg, generator, extra, methods) {
    const map = {};
    for (const key in arg) {
      map[key] = methods.freeze('Generator', null, arg[key], extra);
    }
    return map;
  }
};

const thawArgument = {
  map(arg, generator, extra, methods) {
    const map = {};
    for (const key in arg) {
      map[key] = methods.thaw('Generator', null, arg[key], extra);
    }
    return map;
  }
};

function freezeGenerator(generator, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (generator.constructor === schemas[i].Generator) {
      const frozen = {
        type: schemas[i][0]
      };
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = generator[schemas[i][j]];
        if (freezeArgument[schemas[i][j]]) {
          arg = freezeArgument[schemas[i][j]](arg, generator, extra, methods);
        }
        frozen[schemas[i][j]] = arg;
      }
      return frozen;
    }
  }
}

function thawGenerator(frozen, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (frozen.type === schemas[i][0]) {
      const Generator = schemas[i].Generator;
      const args = [];
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = frozen[schemas[i][j]];
        if (thawArgument[schemas[i][j]]) {
          arg = thawArgument[schemas[i][j]](arg, frozen, extra, methods);
        }
        args.push(arg);
      }
      try {
        return new Generator(...args);
      } catch (_) {
        return new (Function.prototype.bind.apply(Generator, [null].concat(args)))();
      }
    }
  }
}

class TransformGeneratorPlugin {
  apply(compiler) {
    pluginCompat.register(compiler, '_hardSourceBeforeFreezeGenerator', 'syncWaterfall', ['frozen', 'item', 'extra']);
    pluginCompat.register(compiler, '_hardSourceFreezeGenerator', 'syncWaterfall', ['frozen', 'item', 'extra']);
    pluginCompat.register(compiler, '_hardSourceAfterFreezeGenerator', 'syncWaterfall', ['frozen', 'item', 'extra']);

    pluginCompat.register(compiler, '_hardSourceBeforeThawGenerator', 'syncWaterfall', ['item', 'frozen', 'extra']);
    pluginCompat.register(compiler, '_hardSourceThawGenerator', 'syncWaterfall', ['item', 'frozen', 'extra']);
    pluginCompat.register(compiler, '_hardSourceAfterThawGenerator', 'syncWaterfall', ['item', 'frozen', 'extra']);

    let methods;

    pluginCompat.tap(compiler, '_hardSourceMethods', 'TransformGeneratorPlugin', _methods => {
      methods = _methods;
    });

    pluginCompat.tap(compiler, '_hardSourceFreezeGenerator', 'TransformGeneratorPlugin freeze', (frozen, generator, extra) => {
      extra.schemas = GeneratorSchemas4;
      frozen = freezeGenerator(generator, extra, methods);
      frozen.moduleType = extra.module.type;
      frozen.options = {};
      return frozen;
    });

    pluginCompat.tap(compiler, '_hardSourceThawGenerator', 'TransformGeneratorPlugin thaw', (generator, { moduleType, options }, { normalModuleFactory }) => {
      return normalModuleFactory.getGenerator(moduleType, options);
    });
  }
}

module.exports = TransformGeneratorPlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9UcmFuc2Zvcm1HZW5lcmF0b3JQbHVnaW4uanMiXSwibmFtZXMiOlsicmVsYXRlQ29udGV4dCIsInJlcXVpcmUiLCJwbHVnaW5Db21wYXQiLCJHZW5lcmF0b3JTY2hlbWFzNCIsIkdlbmVyYXRvciIsImJ5VHlwZSIsImNvbnN0cnVjdG9yIiwiXyIsImZyZWV6ZUFyZ3VtZW50IiwibWFwIiwiYXJnIiwiZ2VuZXJhdG9yIiwiZXh0cmEiLCJtZXRob2RzIiwia2V5IiwiZnJlZXplIiwidGhhd0FyZ3VtZW50IiwidGhhdyIsImZyZWV6ZUdlbmVyYXRvciIsInNjaGVtYXMiLCJpIiwibGVuZ3RoIiwiZnJvemVuIiwidHlwZSIsImoiLCJ0aGF3R2VuZXJhdG9yIiwiYXJncyIsInB1c2giLCJGdW5jdGlvbiIsInByb3RvdHlwZSIsImJpbmQiLCJhcHBseSIsImNvbmNhdCIsIlRyYW5zZm9ybUdlbmVyYXRvclBsdWdpbiIsImNvbXBpbGVyIiwicmVnaXN0ZXIiLCJ0YXAiLCJfbWV0aG9kcyIsIm1vZHVsZVR5cGUiLCJtb2R1bGUiLCJvcHRpb25zIiwibm9ybWFsTW9kdWxlRmFjdG9yeSIsImdldEdlbmVyYXRvciIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxnQkFBZ0JDLFFBQVEsdUJBQVIsQ0FBdEI7QUFDQSxNQUFNQyxlQUFlRCxRQUFRLHNCQUFSLENBQXJCOztBQUVBLE1BQU1FLG9CQUFvQixDQUN4QixDQUFDLGlCQUFELEVBQW9CLEtBQXBCLENBRHdCLEVBRXhCLENBQUMscUJBQUQsQ0FGd0IsRUFHeEIsQ0FBQyxlQUFELENBSHdCLEVBSXhCLENBQUMsc0JBQUQsQ0FKd0IsRUFLeEIsQ0FBQyxnQ0FBRCxDQUx3QixDQUExQjs7QUFRQSxJQUFJO0FBQ0YsTUFBSTtBQUNGQSxzQkFBa0IsQ0FBbEIsRUFBcUJDLFNBQXJCLEdBQWlDSCxRQUFRLHVCQUFSLEVBQWlDSSxNQUFqQyxDQUMv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LEVBRUUsMEJBRkYsRUFHRSwrQkFIRixFQUlFLENBQUN2QixTQUFELEVBQVksRUFBRTJCLFVBQUYsRUFBY0UsT0FBZCxFQUFaLEVBQXFDLEVBQUVDLG1CQUFGLEVBQXJDLEtBQWlFO0FBQy9ELGFBQU9BLG9CQUFvQkMsWUFBcEIsQ0FBaUNKLFVBQWpDLEVBQTZDRSxPQUE3QyxDQUFQO0FBQ0QsS0FOSDtBQVFEO0FBeEU0Qjs7QUEyRS9CRCxPQUFPSSxPQUFQLEdBQWlCVix3QkFBakIiLCJmaWxlIjoiaGFyZC1zb3VyY2Utd2VicGFjay1wbHVnaW4vbGliL1RyYW5zZm9ybUdlbmVyYXRvclBsdWdpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHJlbGF0ZUNvbnRleHQgPSByZXF1aXJlKCcuL3V0aWwvcmVsYXRlLWNvbnRleHQnKTtcbmNvbnN0IHBsdWdpbkNvbXBhdCA9IHJlcXVpcmUoJy4vdXRpbC9wbHVnaW4tY29tcGF0Jyk7XG5cbmNvbnN0IEdlbmVyYXRvclNjaGVtYXM0ID0gW1xuICBbJ0J5VHlwZUdlbmVyYXRvcicsICdtYXAnXSxcbiAgWydKYXZhc2NyaXB0R2VuZXJhdG9yJ10sXG4gIFsnSnNvbkdlbmVyYXRvciddLFxuICBbJ1dlYkFzc2VtYmx5R2VuZXJhdG9yJ10sXG4gIFsnV2ViQXNzZW1ibHlKYXZhc2NyaXB0R2VuZXJhdG9yJ10sXG5dO1xuXG50cnkge1xuICB0cnkge1xuICAgIEdlbmVyYXRvclNjaGVtYXM0WzBdLkdlbmVyYXRvciA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL0dlbmVyYXRvcicpLmJ5VHlwZShcbiAgICAgIHt9LFxuICAgICkuY29uc3RydWN0b3I7XG4gIH0gY2F0Y2ggKF8pIHt9XG4gIEdlbmVyYXRvclNjaGVtYXM0WzFdLkdlbmVyYXRvciA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL0phdmFzY3JpcHRHZW5lcmF0b3InKTtcbiAgR2VuZXJhdG9yU2NoZW1hczRbMl0uR2VuZXJhdG9yID0gcmVxdWlyZSgnd2VicGFjay9saWIvSnNvbkdlbmVyYXRvcicpO1xuICB0cnkge1xuICAgIEdlbmVyYXRvclNjaGVtYXM0WzNdLkdlbmVyYXRvciA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL1dlYkFzc2VtYmx5R2VuZXJhdG9yJyk7XG4gIH0gY2F0Y2ggKF8pIHtcbiAgICBHZW5lcmF0b3JTY2hlbWFzNFszXS5HZW5lcmF0b3IgPSByZXF1aXJlKCd3ZWJwYWNrL2xpYi93YXNtL1dlYkFzc2VtYmx5R2VuZXJhdG9yJyk7XG4gIH1cbiAgdHJ5IHtcbiAgICBHZW5lcmF0b3JTY2hlbWFzNFs0XS5HZW5lcmF0b3IgPSByZXF1aXJlKCd3ZWJwYWNrL2xpYi93YXNtL1dlYkFzc2VtYmx5SmF2YXNjcmlwdEdlbmVyYXRvcicpO1xuICB9IGNhdGNoIChfKSB7fVxufSBjYXRjaCAoXykge31cblxuY29uc3QgZnJlZXplQXJndW1lbnQgPSB7XG4gIG1hcChhcmcsIGdlbmVyYXRvciwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgICBjb25zdCBtYXAgPSB7fTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBhcmcpIHtcbiAgICAgIG1hcFtrZXldID0gbWV0aG9kcy5mcmVlemUoJ0dlbmVyYXRvcicsIG51bGwsIGFyZ1trZXldLCBleHRyYSk7XG4gICAgfVxuICAgIHJldHVybiBtYXA7XG4gIH0sXG59O1xuXG5jb25zdCB0aGF3QXJndW1lbnQgPSB7XG4gIG1hcChhcmcsIGdlbmVyYXRvciwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgICBjb25zdCBtYXAgPSB7fTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBhcmcpIHtcbiAgICAgIG1hcFtrZXldID0gbWV0aG9kcy50aGF3KCdHZW5lcmF0b3InLCBudWxsLCBhcmdba2V5XSwgZXh0cmEpO1xuICAgIH1cbiAgICByZXR1cm4gbWFwO1xuICB9LFxufTtcblxuZnVuY3Rpb24gZnJlZXplR2VuZXJhdG9yKGdlbmVyYXRvciwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgY29uc3Qgc2NoZW1hcyA9IGV4dHJhLnNjaGVtYXM7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgc2NoZW1hcy5sZW5ndGg7IGkrKykge1xuICAgIGlmIChnZW5lcmF0b3IuY29uc3RydWN0b3IgPT09IHNjaGVtYXNbaV0uR2VuZXJhdG9yKSB7XG4gICAgICBjb25zdCBmcm96ZW4gPSB7XG4gICAgICAgIHR5cGU6IHNjaGVtYXNbaV1bMF0sXG4gICAgICB9O1xuICAgICAgZm9yIChsZXQgaiA9IDE7IGogPCBzY2hlbWFzW2ldLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGxldCBhcmcgPSBnZW5lcmF0b3Jbc2NoZW1hc1tpXVtqXV07XG4gICAgICAgIGlmIChmcmVlemVBcmd1bWVudFtzY2hlbWFzW2ldW2pdXSkge1xuICAgICAgICAgIGFyZyA9IGZyZWV6ZUFyZ3VtZW50W3NjaGVtYXNbaV1bal1dKGFyZywgZ2VuZXJhdG9yLCBleHRyYSwgbWV0aG9kcyk7XG4gICAgICAgIH1cbiAgICAgICAgZnJvemVuW3NjaGVtYXNbaV1bal1dID0gYXJnO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZyb3plbjtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gdGhhd0dlbmVyYXRvcihmcm96ZW4sIGV4dHJhLCBtZXRob2RzKSB7XG4gIGNvbnN0IHNjaGVtYXMgPSBleHRyYS5zY2hlbWFzO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHNjaGVtYXMubGVuZ3RoOyBpKyspIHtcbiAgICBpZiAoZnJvemVuLnR5cGUgPT09IHNjaGVtYXNbaV1bMF0pIHtcbiAgICAgIGNvbnN0IEdlbmVyYXRvciA9IHNjaGVtYXNbaV0uR2VuZXJhdG9yO1xuICAgICAgY29uc3QgYXJncyA9IFtdO1xuICAgICAgZm9yIChsZXQgaiA9IDE7IGogPCBzY2hlbWFzW2ldLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGxldCBhcmcgPSBmcm96ZW5bc2NoZW1hc1tpXVtqXV07XG4gICAgICAgIGlmICh0aGF3QXJndW1lbnRbc2NoZW1hc1tpXVtqXV0pIHtcbiAgICAgICAgICBhcmcgPSB0aGF3QXJndW1lbnRbc2NoZW1hc1tpXVtqXV0oYXJnLCBmcm96ZW4sIGV4dHJhLCBtZXRob2RzKTtcbiAgICAgICAgfVxuICAgICAgICBhcmdzLnB1c2goYXJnKTtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBuZXcgR2VuZXJhdG9yKC4uLmFyZ3MpO1xuICAgICAgfSBjYXRjaCAoXykge1xuICAgICAgICByZXR1cm4gbmV3IChGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5hcHBseShcbiAgICAgICAgICBHZW5lcmF0b3IsXG4gICAgICAgICAgW251bGxdLmNvbmNhdChhcmdzKSxcbiAgICAgICAgKSkoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgVHJhbnNmb3JtR2VuZXJhdG9yUGx1Z2luIHtcbiAgYXBwbHkoY29tcGlsZXIpIHtcbiAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZUJlZm9yZUZyZWV6ZUdlbmVyYXRvcicsXG4gICAgICAnc3luY1dhdGVyZmFsbCcsXG4gICAgICBbJ2Zyb3plbicsICdpdGVtJywgJ2V4dHJhJ10sXG4gICAgKTtcbiAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZUZyZWV6ZUdlbmVyYXRvcicsXG4gICAgICAnc3luY1dhdGVyZmFsbCcsXG4gICAgICBbJ2Zyb3plbicsICdpdGVtJywgJ2V4dHJhJ10sXG4gICAgKTtcbiAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZUFmdGVyRnJlZXplR2VuZXJhdG9yJyxcbiAgICAgICdzeW5jV2F0ZXJmYWxsJyxcbiAgICAgIFsnZnJvemVuJywgJ2l0ZW0nLCAnZXh0cmEnXSxcbiAgICApO1xuXG4gICAgcGx1Z2luQ29tcGF0LnJlZ2lzdGVyKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnX2hhcmRTb3VyY2VCZWZvcmVUaGF3R2VuZXJhdG9yJyxcbiAgICAgICdzeW5jV2F0ZXJmYWxsJyxcbiAgICAgIFsnaXRlbScsICdmcm96ZW4nLCAnZXh0cmEnXSxcbiAgICApO1xuICAgIHBsdWdpbkNvbXBhdC5yZWdpc3RlcihcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlVGhhd0dlbmVyYXRvcicsXG4gICAgICAnc3luY1dhdGVyZmFsbCcsXG4gICAgICBbJ2l0ZW0nLCAnZnJvemVuJywgJ2V4dHJhJ10sXG4gICAgKTtcbiAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZUFmdGVyVGhhd0dlbmVyYXRvcicsXG4gICAgICAnc3luY1dhdGVyZmFsbCcsXG4gICAgICBbJ2l0ZW0nLCAnZnJvemVuJywgJ2V4dHJhJ10sXG4gICAgKTtcblxuICAgIGxldCBtZXRob2RzO1xuXG4gICAgcGx1Z2luQ29tcGF0LnRhcChcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlTWV0aG9kcycsXG4gICAgICAnVHJhbnNmb3JtR2VuZXJhdG9yUGx1Z2luJyxcbiAgICAgIF9tZXRob2RzID0+IHtcbiAgICAgICAgbWV0aG9kcyA9IF9tZXRob2RzO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgcGx1Z2luQ29tcGF0LnRhcChcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlRnJlZXplR2VuZXJhdG9yJyxcbiAgICAgICdUcmFuc2Zvcm1HZW5lcmF0b3JQbHVnaW4gZnJlZXplJyxcbiAgICAgIChmcm96ZW4sIGdlbmVyYXRvciwgZXh0cmEpID0+IHtcbiAgICAgICAgZXh0cmEuc2NoZW1hcyA9IEdlbmVyYXRvclNjaGVtYXM0O1xuICAgICAgICBmcm96ZW4gPSBmcmVlemVHZW5lcmF0b3IoZ2VuZXJhdG9yLCBleHRyYSwgbWV0aG9kcyk7XG4gICAgICAgIGZyb3plbi5tb2R1bGVUeXBlID0gZXh0cmEubW9kdWxlLnR5cGU7XG4gICAgICAgIGZyb3plbi5vcHRpb25zID0ge307XG4gICAgICAgIHJldHVybiBmcm96ZW47XG4gICAgICB9LFxuICAgICk7XG5cbiAgICBwbHVnaW5Db21wYXQudGFwKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnX2hhcmRTb3VyY2VUaGF3R2VuZXJhdG9yJyxcbiAgICAgICdUcmFuc2Zvcm1HZW5lcmF0b3JQbHVnaW4gdGhhdycsXG4gICAgICAoZ2VuZXJhdG9yLCB7IG1vZHVsZVR5cGUsIG9wdGlvbnMgfSwgeyBub3JtYWxNb2R1bGVGYWN0b3J5IH0pID0+IHtcbiAgICAgICAgcmV0dXJuIG5vcm1hbE1vZHVsZUZhY3RvcnkuZ2V0R2VuZXJhdG9yKG1vZHVsZVR5cGUsIG9wdGlvbnMpO1xuICAgICAgfSxcbiAgICApO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gVHJhbnNmb3JtR2VuZXJhdG9yUGx1Z2luO1xuIl0sInNvdXJjZVJvb3QiOiIvVXNlcnMvdHlsZXJhcmJ1cy9kZXYvcHJvdmlkZXIvc3JjIn0=
