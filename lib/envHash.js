'use strict';

require('source-map-support/register');

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

// - scan dirs
//   - stat items
//   - hash files
//   - stat dir items under
//     - hash files
// - hash files

const crypto = require('crypto');
const fs = require('fs');
const path = require('path');

const pkgDir = require('pkg-dir');

const promisify = require('./util/promisify');

const readFile = promisify(fs.readFile);
const readdir = promisify(fs.readdir);
const stat = promisify(fs.stat);

function hashFile(file) {
  return readFile(file).then(src => [file, crypto.createHash('md5').update(src).digest('hex')]).catch(() => {});
}

function hashObject(obj) {
  const hash = crypto.createHash('md5');
  obj.forEach(item => {
    hash.update(item[0]);
    hash.update(item[1]);
  });
  return hash.digest('hex');
}

function hashFiles(root, files) {
  return Promise.all(files.map(file => hashFile(path.join(root, file)))).then(hashes => hashes.filter(Boolean));
}

function flatten(items) {
  return (items || []).reduce((carry, item) => item ? carry.concat(item) : carry, []);
}

const inputs = (() => {
  var _ref = _asyncToGenerator(function* ({ files, directories, root = process.cwd() } = {}) {
    let defaults;
    if (!files && !directories) {
      const lockFiles = (yield Promise.all(['package-lock.json', 'yarn.lock'].map(function (f) {
        return stat(path.join(root, f)).then(function () {
          return f;
        }, function () {
          return null;
        });
      }))).filter(Boolean);
      if (lockFiles.length) {
        return lockFiles;
      }
    }
    if (!files) {
      files = ['package.json'];
    }
    if (!directories) {
      directories = ['node_modules'];
    }
    directories = directories.map(function (d) {
      return `${d}/*`;
    });
    return flatten([files, directories]);
  });

  return function inputs() {
    return _ref.apply(this, arguments);
  };
})();

module.exports = options => {
  options = options || {};
  const root = options.root || pkgDir.sync(process.cwd());
  let files = options.files;
  let directories = options.directories;

  let hashDefaults = Promise.resolve();
  if (!files && !directories) {
    hashDefaults = hashFiles(root, ['package-lock.json', 'yarn.lock']);
  }

  return hashDefaults.then(_defaults => {
    if (_defaults && _defaults.length > 0) {
      return [_defaults];
    } else {
      if (!files) {
        files = ['package.json'];
      }
      if (!directories) {
        directories = ['node_modules'];
      }
    }

    return Promise.all([hashFiles(root, files), Promise.all(directories.map(dir => readdir(path.join(root, dir)).then(items => Promise.all(items.map(item => stat(path.join(root, dir, item)).then(stat => {
      if (stat.isDirectory()) {
        return hashFiles(path.join(root, dir, item), files);
      }
      if (stat.isFile()) {
        return hashFile(path.join(root, dir, item)).then(hash => hash ? [hash] : hash);
      }
    }).catch(function (...args) {
      console.error(args);
    }))).then(hashes => hashes.filter(Boolean))).catch(() => {}).then(flatten))).then(flatten)]);
  }).then(flatten).then(items => {
    items.forEach(item => {
      item[0] = path.relative(root, item[0]);
    });
    // console.log(items);
    items.sort((a, b) => {
      if (a[0] < b[0]) {
        return -1;
      } else if (a[0] > b[0]) {
        return 1;
      }
      return 0;
    });
    return hashObject(items);
  });
};

module.exports.inputs = inputs;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9lbnZIYXNoLmpzIl0sIm5hbWVzIjpbImNyeXB0byIsInJlcXVpcmUiLCJmcyIsInBhdGgiLCJwa2dEaXIiLCJwcm9taXNpZnkiLCJyZWFkRmlsZSIsInJlYWRkaXIiLCJzdGF0IiwiaGFzaEZpbGUiLCJmaWxlIiwidGhlbiIsInNyYyIsImNyZWF0ZUhhc2giLCJ1cGRhdGUiLCJkaWdlc3QiLCJjYXRjaCIsImhhc2hPYmplY3QiLCJvYmoiLCJoYXNoIiwiZm9yRWFjaCIsIml0ZW0iLCJoYXNoRmlsZXMiLCJyb290IiwiZmlsZXMiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwiam9pbiIsImhhc2hlcyIsImZpbHRlciIsIkJvb2xlYW4iLCJmbGF0dGVuIiwiaXRlbXMiLCJyZWR1Y2UiLCJjYXJyeSIsImNvbmNhdCIsImlucHV0cyIsImRpcmVjdG9yaWVzIiwicHJvY2VzcyIsImN3ZCIsImRlZmF1bHRzIiwibG9ja0ZpbGVzIiwiZiIsImxlbmd0aCIsImQiLCJtb2R1bGUiLCJleHBvcnRzIiwib3B0aW9ucyIsInN5bmMiLCJoYXNoRGVmYXVsdHMiLCJyZXNvbHZlIiwiX2RlZmF1bHRzIiwiZGlyIiwiaXNEaXJlY3RvcnkiLCJpc0ZpbGUiLCJhcmdzIiwiY29uc29sZSIsImVycm9yIiwicmVsYXRpdmUiLCJzb3J0IiwiYSIsImIiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxNQUFNQSxTQUFTQyxRQUFRLFFBQVIsQ0FBZjtBQUNBLE1BQU1DLEtBQUtELFFBQVEsSUFBUixDQUFYO0FBQ0EsTUFBTUUsT0FBT0YsUUFBUSxNQUFSLENBQWI7O0FBRUEsTUFBTUcsU0FBU0gsUUFBUSxTQUFSLENBQWY7O0FBRUEsTUFBTUksWUFBWUosUUFBUSxrQkFBUixDQUFsQjs7QUFFQSxNQUFNSyxXQUFXRCxVQUFVSCxHQUFHSSxRQUFiLENBQWpCO0FBQ0EsTUFBTUMsVUFB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QUFRQSxXQUFPN0MsV0FBV2dCLEtBQVgsQ0FBUDtBQUNELEdBM0RJLENBQVA7QUE0REQsQ0F2RUQ7O0FBeUVBYSxPQUFPQyxPQUFQLENBQWVWLE1BQWYsR0FBd0JBLE1BQXhCIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9lbnZIYXNoLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gLSBzY2FuIGRpcnNcbi8vICAgLSBzdGF0IGl0ZW1zXG4vLyAgIC0gaGFzaCBmaWxlc1xuLy8gICAtIHN0YXQgZGlyIGl0ZW1zIHVuZGVyXG4vLyAgICAgLSBoYXNoIGZpbGVzXG4vLyAtIGhhc2ggZmlsZXNcblxuY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXG5jb25zdCBwa2dEaXIgPSByZXF1aXJlKCdwa2ctZGlyJyk7XG5cbmNvbnN0IHByb21pc2lmeSA9IHJlcXVpcmUoJy4vdXRpbC9wcm9taXNpZnknKTtcblxuY29uc3QgcmVhZEZpbGUgPSBwcm9taXNpZnkoZnMucmVhZEZpbGUpO1xuY29uc3QgcmVhZGRpciA9IHByb21pc2lmeShmcy5yZWFkZGlyKTtcbmNvbnN0IHN0YXQgPSBwcm9taXNpZnkoZnMuc3RhdCk7XG5cbmZ1bmN0aW9uIGhhc2hGaWxlKGZpbGUpIHtcbiAgcmV0dXJuIHJlYWRGaWxlKGZpbGUpXG4gICAgLnRoZW4oc3JjID0+IFtcbiAgICAgIGZpbGUsXG4gICAgICBjcnlwdG9cbiAgICAgICAgLmNyZWF0ZUhhc2goJ21kNScpXG4gICAgICAgIC51cGRhdGUoc3JjKVxuICAgICAgICAuZGlnZXN0KCdoZXgnKSxcbiAgICBdKVxuICAgIC5jYXRjaCgoKSA9PiB7fSk7XG59XG5cbmZ1bmN0aW9uIGhhc2hPYmplY3Qob2JqKSB7XG4gIGNvbnN0IGhhc2ggPSBjcnlwdG8uY3JlYXRlSGFzaCgnbWQ1Jyk7XG4gIG9iai5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgIGhhc2gudXBkYXRlKGl0ZW1bMF0pO1xuICAgIGhhc2gudXBkYXRlKGl0ZW1bMV0pO1xuICB9KTtcbiAgcmV0dXJuIGhhc2guZGlnZXN0KCdoZXgnKTtcbn1cblxuZnVuY3Rpb24gaGFzaEZpbGVzKHJvb3QsIGZpbGVzKSB7XG4gIHJldHVybiBQcm9taXNlLmFsbChmaWxlcy5tYXAoZmlsZSA9PiBoYXNoRmlsZShwYXRoLmpvaW4ocm9vdCwgZmlsZSkpKSkudGhlbihcbiAgICBoYXNoZXMgPT4gaGFzaGVzLmZpbHRlcihCb29sZWFuKSxcbiAgKTtcbn1cblxuZnVuY3Rpb24gZmxhdHRlbihpdGVtcykge1xuICByZXR1cm4gKGl0ZW1zIHx8IFtdKS5yZWR1Y2UoXG4gICAgKGNhcnJ5LCBpdGVtKSA9PiAoaXRlbSA/IGNhcnJ5LmNvbmNhdChpdGVtKSA6IGNhcnJ5KSxcbiAgICBbXSxcbiAgKTtcbn1cblxuY29uc3QgaW5wdXRzID0gYXN5bmMgKHsgZmlsZXMsIGRpcmVjdG9yaWVzLCByb290ID0gcHJvY2Vzcy5jd2QoKSB9ID0ge30pID0+IHtcbiAgbGV0IGRlZmF1bHRzO1xuICBpZiAoIWZpbGVzICYmICFkaXJlY3Rvcmllcykge1xuICAgIGNvbnN0IGxvY2tGaWxlcyA9IChhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIFsncGFja2FnZS1sb2NrLmpzb24nLCAneWFybi5sb2NrJ10ubWFwKGYgPT5cbiAgICAgICAgc3RhdChwYXRoLmpvaW4ocm9vdCwgZikpLnRoZW4oKCkgPT4gZiwgKCkgPT4gbnVsbCksXG4gICAgICApLFxuICAgICkpLmZpbHRlcihCb29sZWFuKTtcbiAgICBpZiAobG9ja0ZpbGVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGxvY2tGaWxlcztcbiAgICB9XG4gIH1cbiAgaWYgKCFmaWxlcykge1xuICAgIGZpbGVzID0gWydwYWNrYWdlLmpzb24nXTtcbiAgfVxuICBpZiAoIWRpcmVjdG9yaWVzKSB7XG4gICAgZGlyZWN0b3JpZXMgPSBbJ25vZGVfbW9kdWxlcyddO1xuICB9XG4gIGRpcmVjdG9yaWVzID0gZGlyZWN0b3JpZXMubWFwKGQgPT4gYCR7ZH0vKmApO1xuICByZXR1cm4gZmxhdHRlbihbZmlsZXMsIGRpcmVjdG9yaWVzXSk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IG9wdGlvbnMgPT4ge1xuICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgY29uc3Qgcm9vdCA9IG9wdGlvbnMucm9vdCB8fCBwa2dEaXIuc3luYyhwcm9jZXNzLmN3ZCgpKTtcbiAgbGV0IGZpbGVzID0gb3B0aW9ucy5maWxlcztcbiAgbGV0IGRpcmVjdG9yaWVzID0gb3B0aW9ucy5kaXJlY3RvcmllcztcblxuICBsZXQgaGFzaERlZmF1bHRzID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIGlmICghZmlsZXMgJiYgIWRpcmVjdG9yaWVzKSB7XG4gICAgaGFzaERlZmF1bHRzID0gaGFzaEZpbGVzKHJvb3QsIFsncGFja2FnZS1sb2NrLmpzb24nLCAneWFybi5sb2NrJ10pO1xuICB9XG5cbiAgcmV0dXJuIGhhc2hEZWZhdWx0c1xuICAgIC50aGVuKF9kZWZhdWx0cyA9PiB7XG4gICAgICBpZiAoX2RlZmF1bHRzICYmIF9kZWZhdWx0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiBbX2RlZmF1bHRzXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICghZmlsZXMpIHtcbiAgICAgICAgICBmaWxlcyA9IFsncGFja2FnZS5qc29uJ107XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFkaXJlY3Rvcmllcykge1xuICAgICAgICAgIGRpcmVjdG9yaWVzID0gWydub2RlX21vZHVsZXMnXTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICBoYXNoRmlsZXMocm9vdCwgZmlsZXMpLFxuICAgICAgICBQcm9taXNlLmFsbChcbiAgICAgICAgICBkaXJlY3Rvcmllcy5tYXAoZGlyID0+XG4gICAgICAgICAgICByZWFkZGlyKHBhdGguam9pbihyb290LCBkaXIpKVxuICAgICAgICAgICAgICAudGhlbihpdGVtcyA9PlxuICAgICAgICAgICAgICAgIFByb21pc2UuYWxsKFxuICAgICAgICAgICAgICAgICAgaXRlbXMubWFwKGl0ZW0gPT5cbiAgICAgICAgICAgICAgICAgICAgc3RhdChwYXRoLmpvaW4ocm9vdCwgZGlyLCBpdGVtKSlcbiAgICAgICAgICAgICAgICAgICAgICAudGhlbihzdGF0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0LmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhhc2hGaWxlcyhwYXRoLmpvaW4ocm9vdCwgZGlyLCBpdGVtKSwgZmlsZXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXQuaXNGaWxlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhhc2hGaWxlKHBhdGguam9pbihyb290LCBkaXIsIGl0ZW0pKS50aGVuKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2ggPT4gKGhhc2ggPyBbaGFzaF0gOiBoYXNoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiguLi5hcmdzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGFyZ3MpO1xuICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICApLnRoZW4oaGFzaGVzID0+IGhhc2hlcy5maWx0ZXIoQm9vbGVhbikpLFxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIC5jYXRjaCgoKSA9PiB7fSlcbiAgICAgICAgICAgICAgLnRoZW4oZmxhdHRlbiksXG4gICAgICAgICAgKSxcbiAgICAgICAgKS50aGVuKGZsYXR0ZW4pLFxuICAgICAgXSk7XG4gICAgfSlcbiAgICAudGhlbihmbGF0dGVuKVxuICAgIC50aGVuKGl0ZW1zID0+IHtcbiAgICAgIGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgIGl0ZW1bMF0gPSBwYXRoLnJlbGF0aXZlKHJvb3QsIGl0ZW1bMF0pO1xuICAgICAgfSk7XG4gICAgICAvLyBjb25zb2xlLmxvZyhpdGVtcyk7XG4gICAgICBpdGVtcy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgIGlmIChhWzBdIDwgYlswXSkge1xuICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgfSBlbHNlIGlmIChhWzBdID4gYlswXSkge1xuICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gaGFzaE9iamVjdChpdGVtcyk7XG4gICAgfSk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cy5pbnB1dHMgPSBpbnB1dHM7XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
