'use strict';

require('source-map-support/register');

const { cachePrefix } = require('.');
const parseJson = require('./parseJson');

class ParityRoot {
  constructor() {
    this.children = [];
  }

  add(name) {
    const bits = new ParityCache(name);
    this.children.push(bits);
    return bits;
  }

  verify() {
    const firstChild = this.children[0];
    if (!this.children.some(child => child.root)) {
      return true;
    }
    for (const child of this.children) {
      if (!child.verify()) {
        this.reason = {
          cache: child,
          cacheName: child.name,
          cacheReason: child.reason,
          message: `Cache ${child.name} is not complete. ${child.reason.message}`
        };
        return false;
      }
      if (child !== firstChild && child.root.token !== firstChild.root.token) {
        this.reason = {
          firstCache: firstChild,
          firstCacheName: firstChild.name,
          firstCacheReason: firstChild.reason,
          secondCache: child,
          secondCacheName: child.name,
          secondCacheReason: child.reason,

          message: `Cache ${firstChild.name} and ${child.name} disagree.`
        };
        return false;
      }
    }
    return true;
  }
}

class ParityCache {
  constructor(name) {
    this.name = name;
    this.root = null;
    this.bits = {};

    this.reason = null;
  }

  add(_token) {
    const token = ParityToken.fromJson(_token);
    if (token.isRoot) {
      this.root = token;
    }
    this.bits[token.id] = token;
  }

  verify() {
    if (this.root === null) {
      this.reason = {
        message: 'Root compilation not found.'
      };
      return false;
    }

    for (const id of this.root.ids) {
      if (typeof this.bits[id] === 'undefined') {
        this.reason = {
          message: `Compilation '${id}' not found.`
        };
        return false;
      } else if (this.root.token !== this.bits[id].token) {
        this.reason = {
          message: `Root and '${id}' compilation disagree.`
        };
        return false;
      }
    }

    return true;
  }
}

const createParityToken = (id, ids = null) => {
  const token = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => c === 'x' ? (Math.random() * 16 | 0).toString(16) : ((Math.random() * 4 | 0) + 8).toString(16));

  return new ParityToken(id, token, ids);
};

class ParityToken {
  constructor(id, token, ids = null) {
    this.id = id;
    this.token = token;

    this.isRoot = ids !== null;
    this.ids = ids;
  }

  static fromCompilation(compilation) {
    let parentCompilation = compilation;
    while (parentCompilation.compiler.parentCompilation) {
      parentCompilation = parentCompilation.compiler.parentCompilation;
    }

    if (!parentCompilation.__hardSource_parityToken) {
      parentCompilation.__hardSource_parityToken = createParityToken(cachePrefix(parentCompilation), []);
    }

    if (compilation !== parentCompilation) {
      return parentCompilation.__hardSource_parityToken.createChild(cachePrefix(compilation));
    }
    return parentCompilation.__hardSource_parityToken;
  }

  static fromJson(json) {
    return new ParityToken(json.id, json.token, json.ids);
  }

  createChild(id) {
    this.ids.push(id);

    return new ParityToken(id, this.token);
  }

  toJSON() {
    return {
      type: 'CacheParityToken',
      id: this.id,
      ids: this.ids,
      token: this.token
    };
  }
}

const parseIfString = item => {
  if (typeof item === 'string') {
    return parseJson(item);
  }
  return item;
};

const parityCacheFromCache = (name, parityRoot, cache) => {
  const parityCache = parityRoot.add(name);
  if (cache.__hardSource_parityToken_root) {
    const rootCompilation = parseIfString(cache.__hardSource_parityToken_root);
    parityCache.add(rootCompilation);
    rootCompilation.ids.forEach(id => {
      if (cache[`__hardSource_parityToken_${id}`]) {
        parityCache.add(parseIfString(cache[`__hardSource_parityToken_${id}`]));
      }
    });
  }
};

const pushParityWriteOps = (compilation, ops) => {
  if (compilation.compiler.parentCompilation) {
    ops.push({
      key: `__hardSource_parityToken_${cachePrefix(compilation)}`,
      value: JSON.stringify(ParityToken.fromCompilation(compilation))
    });
  } else {
    ops.push({
      key: `__hardSource_parityToken_root`,
      value: JSON.stringify(ParityToken.fromCompilation(compilation))
    });
  }
};

module.exports = {
  ParityRoot,
  ParityCache,
  ParityToken,

  parityCacheFromCache,
  pushParityWriteOps
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi91dGlsL3Bhcml0eS5qcyJdLCJuYW1lcyI6WyJjYWNoZVByZWZpeCIsInJlcXVpcmUiLCJwYXJzZUpzb24iLCJQYXJpdHlSb290IiwiY29uc3RydWN0b3IiLCJjaGlsZHJlbiIsImFkZCIsIm5hbWUiLCJiaXRzIiwiUGFyaXR5Q2FjaGUiLCJwdXNoIiwidmVyaWZ5IiwiZmlyc3RDaGlsZCIsInNvbWUiLCJjaGlsZCIsInJvb3QiLCJyZWFzb24iLCJjYWNoZSIsImNhY2hlTmFtZSIsImNhY2hlUmVhc29uIiwibWVzc2FnZSIsInRva2VuIiwiZmlyc3RDYWNoZSIsImZpcnN0Q2FjaGVOYW1lIiwiZmlyc3RDYWNoZVJlYXNvbiIsInNlY29uZENhY2hlIiwic2Vjb25kQ2FjaGVOYW1lIiwic2Vjb25kQ2FjaGVSZWFzb24iLCJfdG9rZW4iLCJQYXJpdHlUb2tlbiIsImZyb21Kc29uIiwiaXNSb290IiwiaWQiLCJpZHMiLCJjcmVhdGVQYXJpdHlUb2tlbiIsInJlcGxhY2UiLCJjIiwiTWF0aCIsInJhbmRvbSIsInRvU3RyaW5nIiwiZnJvbUNvbXBpbGF0aW9uIiwiY29tcGlsYXRpb24iLCJwYXJlbnRDb21waWxhdGlvbiIsImNvbXBpbGVyIiwiX19oYXJkU291cmNlX3Bhcml0eVRva2VuIiwiY3JlYXRlQ2hpbGQiLCJqc29uIiwidG9KU09OIiwidHlwZSIsInBhcnNlSWZTdHJpbmciLCJpdGVtIiwicGFyaXR5Q2FjaGVGcm9tQ2FjaGUiLCJwYXJpdHlSb290IiwicGFyaXR5Q2FjaGUiLCJfX2hhcmRTb3VyY2VfcGFyaXR5VG9rZW5fcm9vdCIsInJvb3RDb21waWxhdGlvbiIsImZvckVhY2giLCJwdXNoUGFyaXR5V3JpdGVPcHMiLCJvcHMiLCJrZXkiLCJ2YWx1ZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTSxFQUFFQSxXQUFGLEtBQWtC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b0J1QixPQUFwQixDQUE0QnhCLE1BQU07QUFDaEMsVUFBSWYsTUFBTyw0QkFBMkJlLEVBQUcsRUFBckMsQ0FBSixFQUE2QztBQUMzQ3FCLG9CQUFZL0MsR0FBWixDQUFnQjJDLGNBQWNoQyxNQUFPLDRCQUEyQmUsRUFBRyxFQUFyQyxDQUFkLENBQWhCO0FBQ0Q7QUFDRixLQUpEO0FBS0Q7QUFDRixDQVhEOztBQWFBLE1BQU15QixxQkFBcUIsQ0FBQ2hCLFdBQUQsRUFBY2lCLEdBQWQsS0FBc0I7QUFDL0MsTUFBSWpCLFlBQVlFLFFBQVosQ0FBcUJELGlCQUF6QixFQUE0QztBQUMxQ2dCLFFBQUloRCxJQUFKLENBQVM7QUFDUGlELFdBQU0sNEJBQTJCM0QsWUFBWXlDLFdBQVosQ0FBeUIsRUFEbkQ7QUFFUG1CLGFBQU9DLEtBQUtDLFNBQUwsQ0FBZWpDLFlBQVlXLGVBQVosQ0FBNEJDLFdBQTVCLENBQWY7QUFGQSxLQUFUO0FBSUQsR0FMRCxNQUtPO0FBQ0xpQixRQUFJaEQsSUFBSixDQUFTO0FBQ1BpRCxXQUFNLCtCQURDO0FBRVBDLGFBQU9DLEtBQUtDLFNBQUwsQ0FBZWpDLFlBQVlXLGVBQVosQ0FBNEJDLFdBQTVCLENBQWY7QUFGQSxLQUFUO0FBSUQ7QUFDRixDQVpEOztBQWNBc0IsT0FBT0MsT0FBUCxHQUFpQjtBQUNmN0QsWUFEZTtBQUVmTSxhQUZlO0FBR2ZvQixhQUhlOztBQUtmc0Isc0JBTGU7QUFNZk07QUFOZSxDQUFqQiIsImZpbGUiOiJoYXJkLXNvdXJjZS13ZWJwYWNrLXBsdWdpbi9saWIvdXRpbC9wYXJpdHkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IGNhY2hlUHJlZml4IH0gPSByZXF1aXJlKCcuJyk7XG5jb25zdCBwYXJzZUpzb24gPSByZXF1aXJlKCcuL3BhcnNlSnNvbicpO1xuXG5jbGFzcyBQYXJpdHlSb290IHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5jaGlsZHJlbiA9IFtdO1xuICB9XG5cbiAgYWRkKG5hbWUpIHtcbiAgICBjb25zdCBiaXRzID0gbmV3IFBhcml0eUNhY2hlKG5hbWUpO1xuICAgIHRoaXMuY2hpbGRyZW4ucHVzaChiaXRzKTtcbiAgICByZXR1cm4gYml0cztcbiAgfVxuXG4gIHZlcmlmeSgpIHtcbiAgICBjb25zdCBmaXJzdENoaWxkID0gdGhpcy5jaGlsZHJlblswXTtcbiAgICBpZiAoIXRoaXMuY2hpbGRyZW4uc29tZShjaGlsZCA9PiBjaGlsZC5yb290KSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdGhpcy5jaGlsZHJlbikge1xuICAgICAgaWYgKCFjaGlsZC52ZXJpZnkoKSkge1xuICAgICAgICB0aGlzLnJlYXNvbiA9IHtcbiAgICAgICAgICBjYWNoZTogY2hpbGQsXG4gICAgICAgICAgY2FjaGVOYW1lOiBjaGlsZC5uYW1lLFxuICAgICAgICAgIGNhY2hlUmVhc29uOiBjaGlsZC5yZWFzb24sXG4gICAgICAgICAgbWVzc2FnZTogYENhY2hlICR7Y2hpbGQubmFtZX0gaXMgbm90IGNvbXBsZXRlLiAke1xuICAgICAgICAgICAgY2hpbGQucmVhc29uLm1lc3NhZ2VcbiAgICAgICAgICB9YCxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKGNoaWxkICE9PSBmaXJzdENoaWxkICYmIGNoaWxkLnJvb3QudG9rZW4gIT09IGZpcnN0Q2hpbGQucm9vdC50b2tlbikge1xuICAgICAgICB0aGlzLnJlYXNvbiA9IHtcbiAgICAgICAgICBmaXJzdENhY2hlOiBmaXJzdENoaWxkLFxuICAgICAgICAgIGZpcnN0Q2FjaGVOYW1lOiBmaXJzdENoaWxkLm5hbWUsXG4gICAgICAgICAgZmlyc3RDYWNoZVJlYXNvbjogZmlyc3RDaGlsZC5yZWFzb24sXG4gICAgICAgICAgc2Vjb25kQ2FjaGU6IGNoaWxkLFxuICAgICAgICAgIHNlY29uZENhY2hlTmFtZTogY2hpbGQubmFtZSxcbiAgICAgICAgICBzZWNvbmRDYWNoZVJlYXNvbjogY2hpbGQucmVhc29uLFxuXG4gICAgICAgICAgbWVzc2FnZTogYENhY2hlICR7Zmlyc3RDaGlsZC5uYW1lfSBhbmQgJHtjaGlsZC5uYW1lfSBkaXNhZ3JlZS5gLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmNsYXNzIFBhcml0eUNhY2hlIHtcbiAgY29uc3RydWN0b3IobmFtZSkge1xuICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgdGhpcy5yb290ID0gbnVsbDtcbiAgICB0aGlzLmJpdHMgPSB7fTtcblxuICAgIHRoaXMucmVhc29uID0gbnVsbDtcbiAgfVxuXG4gIGFkZChfdG9rZW4pIHtcbiAgICBjb25zdCB0b2tlbiA9IFBhcml0eVRva2VuLmZyb21Kc29uKF90b2tlbik7XG4gICAgaWYgKHRva2VuLmlzUm9vdCkge1xuICAgICAgdGhpcy5yb290ID0gdG9rZW47XG4gICAgfVxuICAgIHRoaXMuYml0c1t0b2tlbi5pZF0gPSB0b2tlbjtcbiAgfVxuXG4gIHZlcmlmeSgpIHtcbiAgICBpZiAodGhpcy5yb290ID09PSBudWxsKSB7XG4gICAgICB0aGlzLnJlYXNvbiA9IHtcbiAgICAgICAgbWVzc2FnZTogJ1Jvb3QgY29tcGlsYXRpb24gbm90IGZvdW5kLicsXG4gICAgICB9O1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgaWQgb2YgdGhpcy5yb290Lmlkcykge1xuICAgICAgaWYgKHR5cGVvZiB0aGlzLmJpdHNbaWRdID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICB0aGlzLnJlYXNvbiA9IHtcbiAgICAgICAgICBtZXNzYWdlOiBgQ29tcGlsYXRpb24gJyR7aWR9JyBub3QgZm91bmQuYCxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLnJvb3QudG9rZW4gIT09IHRoaXMuYml0c1tpZF0udG9rZW4pIHtcbiAgICAgICAgdGhpcy5yZWFzb24gPSB7XG4gICAgICAgICAgbWVzc2FnZTogYFJvb3QgYW5kICcke2lkfScgY29tcGlsYXRpb24gZGlzYWdyZWUuYCxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmNvbnN0IGNyZWF0ZVBhcml0eVRva2VuID0gKGlkLCBpZHMgPSBudWxsKSA9PiB7XG4gIGNvbnN0IHRva2VuID0gJ3h4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCcucmVwbGFjZShcbiAgICAvW3h5XS9nLFxuICAgIGMgPT5cbiAgICAgIGMgPT09ICd4J1xuICAgICAgICA/ICgoTWF0aC5yYW5kb20oKSAqIDE2KSB8IDApLnRvU3RyaW5nKDE2KVxuICAgICAgICA6ICgoKE1hdGgucmFuZG9tKCkgKiA0KSB8IDApICsgOCkudG9TdHJpbmcoMTYpLFxuICApO1xuXG4gIHJldHVybiBuZXcgUGFyaXR5VG9rZW4oaWQsIHRva2VuLCBpZHMpO1xufTtcblxuY2xhc3MgUGFyaXR5VG9rZW4ge1xuICBjb25zdHJ1Y3RvcihpZCwgdG9rZW4sIGlkcyA9IG51bGwpIHtcbiAgICB0aGlzLmlkID0gaWQ7XG4gICAgdGhpcy50b2tlbiA9IHRva2VuO1xuXG4gICAgdGhpcy5pc1Jvb3QgPSBpZHMgIT09IG51bGw7XG4gICAgdGhpcy5pZHMgPSBpZHM7XG4gIH1cblxuICBzdGF0aWMgZnJvbUNvbXBpbGF0aW9uKGNvbXBpbGF0aW9uKSB7XG4gICAgbGV0IHBhcmVudENvbXBpbGF0aW9uID0gY29tcGlsYXRpb247XG4gICAgd2hpbGUgKHBhcmVudENvbXBpbGF0aW9uLmNvbXBpbGVyLnBhcmVudENvbXBpbGF0aW9uKSB7XG4gICAgICBwYXJlbnRDb21waWxhdGlvbiA9IHBhcmVudENvbXBpbGF0aW9uLmNvbXBpbGVyLnBhcmVudENvbXBpbGF0aW9uO1xuICAgIH1cblxuICAgIGlmICghcGFyZW50Q29tcGlsYXRpb24uX19oYXJkU291cmNlX3Bhcml0eVRva2VuKSB7XG4gICAgICBwYXJlbnRDb21waWxhdGlvbi5fX2hhcmRTb3VyY2VfcGFyaXR5VG9rZW4gPSBjcmVhdGVQYXJpdHlUb2tlbihcbiAgICAgICAgY2FjaGVQcmVmaXgocGFyZW50Q29tcGlsYXRpb24pLFxuICAgICAgICBbXSxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGNvbXBpbGF0aW9uICE9PSBwYXJlbnRDb21waWxhdGlvbikge1xuICAgICAgcmV0dXJuIHBhcmVudENvbXBpbGF0aW9uLl9faGFyZFNvdXJjZV9wYXJpdHlUb2tlbi5jcmVhdGVDaGlsZChcbiAgICAgICAgY2FjaGVQcmVmaXgoY29tcGlsYXRpb24pLFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhcmVudENvbXBpbGF0aW9uLl9faGFyZFNvdXJjZV9wYXJpdHlUb2tlbjtcbiAgfVxuXG4gIHN0YXRpYyBmcm9tSnNvbihqc29uKSB7XG4gICAgcmV0dXJuIG5ldyBQYXJpdHlUb2tlbihqc29uLmlkLCBqc29uLnRva2VuLCBqc29uLmlkcyk7XG4gIH1cblxuICBjcmVhdGVDaGlsZChpZCkge1xuICAgIHRoaXMuaWRzLnB1c2goaWQpO1xuXG4gICAgcmV0dXJuIG5ldyBQYXJpdHlUb2tlbihpZCwgdGhpcy50b2tlbik7XG4gIH1cblxuICB0b0pTT04oKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6ICdDYWNoZVBhcml0eVRva2VuJyxcbiAgICAgIGlkOiB0aGlzLmlkLFxuICAgICAgaWRzOiB0aGlzLmlkcyxcbiAgICAgIHRva2VuOiB0aGlzLnRva2VuLFxuICAgIH07XG4gIH1cbn1cblxuY29uc3QgcGFyc2VJZlN0cmluZyA9IGl0ZW0gPT4ge1xuICBpZiAodHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIHBhcnNlSnNvbihpdGVtKTtcbiAgfVxuICByZXR1cm4gaXRlbTtcbn07XG5cbmNvbnN0IHBhcml0eUNhY2hlRnJvbUNhY2hlID0gKG5hbWUsIHBhcml0eVJvb3QsIGNhY2hlKSA9PiB7XG4gIGNvbnN0IHBhcml0eUNhY2hlID0gcGFyaXR5Um9vdC5hZGQobmFtZSk7XG4gIGlmIChjYWNoZS5fX2hhcmRTb3VyY2VfcGFyaXR5VG9rZW5fcm9vdCkge1xuICAgIGNvbnN0IHJvb3RDb21waWxhdGlvbiA9IHBhcnNlSWZTdHJpbmcoY2FjaGUuX19oYXJkU291cmNlX3Bhcml0eVRva2VuX3Jvb3QpO1xuICAgIHBhcml0eUNhY2hlLmFkZChyb290Q29tcGlsYXRpb24pO1xuICAgIHJvb3RDb21waWxhdGlvbi5pZHMuZm9yRWFjaChpZCA9PiB7XG4gICAgICBpZiAoY2FjaGVbYF9faGFyZFNvdXJjZV9wYXJpdHlUb2tlbl8ke2lkfWBdKSB7XG4gICAgICAgIHBhcml0eUNhY2hlLmFkZChwYXJzZUlmU3RyaW5nKGNhY2hlW2BfX2hhcmRTb3VyY2VfcGFyaXR5VG9rZW5fJHtpZH1gXSkpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG59O1xuXG5jb25zdCBwdXNoUGFyaXR5V3JpdGVPcHMgPSAoY29tcGlsYXRpb24sIG9wcykgPT4ge1xuICBpZiAoY29tcGlsYXRpb24uY29tcGlsZXIucGFyZW50Q29tcGlsYXRpb24pIHtcbiAgICBvcHMucHVzaCh7XG4gICAgICBrZXk6IGBfX2hhcmRTb3VyY2VfcGFyaXR5VG9rZW5fJHtjYWNoZVByZWZpeChjb21waWxhdGlvbil9YCxcbiAgICAgIHZhbHVlOiBKU09OLnN0cmluZ2lmeShQYXJpdHlUb2tlbi5mcm9tQ29tcGlsYXRpb24oY29tcGlsYXRpb24pKSxcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICBvcHMucHVzaCh7XG4gICAgICBrZXk6IGBfX2hhcmRTb3VyY2VfcGFyaXR5VG9rZW5fcm9vdGAsXG4gICAgICB2YWx1ZTogSlNPTi5zdHJpbmdpZnkoUGFyaXR5VG9rZW4uZnJvbUNvbXBpbGF0aW9uKGNvbXBpbGF0aW9uKSksXG4gICAgfSk7XG4gIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBQYXJpdHlSb290LFxuICBQYXJpdHlDYWNoZSxcbiAgUGFyaXR5VG9rZW4sXG5cbiAgcGFyaXR5Q2FjaGVGcm9tQ2FjaGUsXG4gIHB1c2hQYXJpdHlXcml0ZU9wcyxcbn07XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
