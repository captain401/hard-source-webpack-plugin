'use strict';

const { cachePrefix } = require('.');
const parseJson = require('./parseJson');

class ParityRoot {
  constructor() {
    this.children = [];
  }

  add(name) {
    const bits = new ParityCache(name);
    this.children.push(bits);
    return bits;
  }

  verify() {
    const firstChild = this.children[0];
    if (!this.children.some(child => child.root)) {
      return true;
    }
    for (const child of this.children) {
      if (!child.verify()) {
        this.reason = {
          cache: child,
          cacheName: child.name,
          cacheReason: child.reason,
          message: `Cache ${child.name} is not complete. ${child.reason.message}`
        };
        return false;
      }
      if (child !== firstChild && child.root.token !== firstChild.root.token) {
        this.reason = {
          firstCache: firstChild,
          firstCacheName: firstChild.name,
          firstCacheReason: firstChild.reason,
          secondCache: child,
          secondCacheName: child.name,
          secondCacheReason: child.reason,

          message: `Cache ${firstChild.name} and ${child.name} disagree.`
        };
        return false;
      }
    }
    return true;
  }
}

class ParityCache {
  constructor(name) {
    this.name = name;
    this.root = null;
    this.bits = {};

    this.reason = null;
  }

  add(_token) {
    const token = ParityToken.fromJson(_token);
    if (token.isRoot) {
      this.root = token;
    }
    this.bits[token.id] = token;
  }

  verify() {
    if (this.root === null) {
      this.reason = {
        message: 'Root compilation not found.'
      };
      return false;
    }

    for (const id of this.root.ids) {
      if (typeof this.bits[id] === 'undefined') {
        this.reason = {
          message: `Compilation '${id}' not found.`
        };
        return false;
      } else if (this.root.token !== this.bits[id].token) {
        this.reason = {
          message: `Root and '${id}' compilation disagree.`
        };
        return false;
      }
    }

    return true;
  }
}

const createParityToken = (id, ids = null) => {
  const token = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => c === 'x' ? (Math.random() * 16 | 0).toString(16) : ((Math.random() * 4 | 0) + 8).toString(16));

  return new ParityToken(id, token, ids);
};

class ParityToken {
  constructor(id, token, ids = null) {
    this.id = id;
    this.token = token;

    this.isRoot = ids !== null;
    this.ids = ids;
  }

  static fromCompilation(compilation) {
    let parentCompilation = compilation;
    while (parentCompilation.compiler.parentCompilation) {
      parentCompilation = parentCompilation.compiler.parentCompilation;
    }

    if (!parentCompilation.__hardSource_parityToken) {
      parentCompilation.__hardSource_parityToken = createParityToken(cachePrefix(parentCompilation), []);
    }

    if (compilation !== parentCompilation) {
      return parentCompilation.__hardSource_parityToken.createChild(cachePrefix(compilation));
    }
    return parentCompilation.__hardSource_parityToken;
  }

  static fromJson(json) {
    return new ParityToken(json.id, json.token, json.ids);
  }

  createChild(id) {
    this.ids.push(id);

    return new ParityToken(id, this.token);
  }

  toJSON() {
    return {
      type: 'CacheParityToken',
      id: this.id,
      ids: this.ids,
      token: this.token
    };
  }
}

const parseIfString = item => {
  if (typeof item === 'string') {
    return parseJson(item);
  }
  return item;
};

const parityCacheFromCache = (name, parityRoot, cache) => {
  const parityCache = parityRoot.add(name);
  if (cache.__hardSource_parityToken_root) {
    const rootCompilation = parseIfString(cache.__hardSource_parityToken_root);
    parityCache.add(rootCompilation);
    rootCompilation.ids.forEach(id => {
      if (cache[`__hardSource_parityToken_${id}`]) {
        parityCache.add(parseIfString(cache[`__hardSource_parityToken_${id}`]));
      }
    });
  }
};

const pushParityWriteOps = (compilation, ops) => {
  if (compilation.compiler.parentCompilation) {
    ops.push({
      key: `__hardSource_parityToken_${cachePrefix(compilation)}`,
      value: JSON.stringify(ParityToken.fromCompilation(compilation))
    });
  } else {
    ops.push({
      key: `__hardSource_parityToken_root`,
      value: JSON.stringify(ParityToken.fromCompilation(compilation))
    });
  }
};

module.exports = {
  ParityRoot,
  ParityCache,
  ParityToken,

  parityCacheFromCache,
  pushParityWriteOps
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi91dGlsL3Bhcml0eS5qcyJdLCJuYW1lcyI6WyJjYWNoZVByZWZpeCIsInJlcXVpcmUiLCJwYXJzZUpzb24iLCJQYXJpdHlSb290IiwiY29uc3RydWN0b3IiLCJjaGlsZHJlbiIsImFkZCIsIm5hbWUiLCJiaXRzIiwiUGFyaXR5Q2FjaGUiLCJwdXNoIiwidmVyaWZ5IiwiZmlyc3RDaGlsZCIsInNvbWUiLCJjaGlsZCIsInJvb3QiLCJyZWFzb24iLCJjYWNoZSIsImNhY2hlTmFtZSIsImNhY2hlUmVhc29uIiwibWVzc2FnZSIsInRva2VuIiwiZmlyc3RDYWNoZSIsImZpcnN0Q2FjaGVOYW1lIiwiZmlyc3RDYWNoZVJlYXNvbiIsInNlY29uZENhY2hlIiwic2Vjb25kQ2FjaGVOYW1lIiwic2Vjb25kQ2FjaGVSZWFzb24iLCJfdG9rZW4iLCJQYXJpdHlUb2tlbiIsImZyb21Kc29uIiwiaXNSb290IiwiaWQiLCJpZHMiLCJjcmVhdGVQYXJpdHlUb2tlbiIsInJlcGxhY2UiLCJjIiwiTWF0aCIsInJhbmRvbSIsInRvU3RyaW5nIiwiZnJvbUNvbXBpbGF0aW9uIiwiY29tcGlsYXRpb24iLCJwYXJlbnRDb21waWxhdGlvbiIsImNvbXBpbGVyIiwiX19oYXJkU291cmNlX3Bhcml0eVRva2VuIiwiY3JlYXRlQ2hpbGQiLCJqc29uIiwidG9KU09OIiwidHlwZSIsInBhcnNlSWZTdHJpbmciLCJpdGVtIiwicGFyaXR5Q2FjaGVGcm9tQ2FjaGUiLCJwYXJpdHlSb290IiwicGFyaXR5Q2FjaGUiLCJfX2hhcmRTb3VyY2VfcGFyaXR5VG9rZW5fcm9vdCIsInJvb3RDb21waWxhdGlvbiIsImZvckVhY2giLCJwdXNoUGFyaXR5V3JpdGVPcHMiLCJvcHMiLCJrZXkiLCJ2YWx1ZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sRUFBRUEsV0FBRixLQUFrQkMs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Q0FBNEJ4QixNQUFNO0FBQ2hDLFVBQUlmLE1BQU8sNEJBQTJCZSxFQUFHLEVBQXJDLENBQUosRUFBNkM7QUFDM0NxQixvQkFBWS9DLEdBQVosQ0FBZ0IyQyxjQUFjaEMsTUFBTyw0QkFBMkJlLEVBQUcsRUFBckMsQ0FBZCxDQUFoQjtBQUNEO0FBQ0YsS0FKRDtBQUtEO0FBQ0YsQ0FYRDs7QUFhQSxNQUFNeUIscUJBQXFCLENBQUNoQixXQUFELEVBQWNpQixHQUFkLEtBQXNCO0FBQy9DLE1BQUlqQixZQUFZRSxRQUFaLENBQXFCRCxpQkFBekIsRUFBNEM7QUFDMUNnQixRQUFJaEQsSUFBSixDQUFTO0FBQ1BpRCxXQUFNLDRCQUEyQjNELFlBQVl5QyxXQUFaLENBQXlCLEVBRG5EO0FBRVBtQixhQUFPQyxLQUFLQyxTQUFMLENBQWVqQyxZQUFZVyxlQUFaLENBQTRCQyxXQUE1QixDQUFmO0FBRkEsS0FBVDtBQUlELEdBTEQsTUFLTztBQUNMaUIsUUFBSWhELElBQUosQ0FBUztBQUNQaUQsV0FBTSwrQkFEQztBQUVQQyxhQUFPQyxLQUFLQyxTQUFMLENBQWVqQyxZQUFZVyxlQUFaLENBQTRCQyxXQUE1QixDQUFmO0FBRkEsS0FBVDtBQUlEO0FBQ0YsQ0FaRDs7QUFjQXNCLE9BQU9DLE9BQVAsR0FBaUI7QUFDZjdELFlBRGU7QUFFZk0sYUFGZTtBQUdmb0IsYUFIZTs7QUFLZnNCLHNCQUxlO0FBTWZNO0FBTmUsQ0FBakIiLCJmaWxlIjoiaGFyZC1zb3VyY2Utd2VicGFjay1wbHVnaW4vbGliL3V0aWwvcGFyaXR5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBjYWNoZVByZWZpeCB9ID0gcmVxdWlyZSgnLicpO1xuY29uc3QgcGFyc2VKc29uID0gcmVxdWlyZSgnLi9wYXJzZUpzb24nKTtcblxuY2xhc3MgUGFyaXR5Um9vdCB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuY2hpbGRyZW4gPSBbXTtcbiAgfVxuXG4gIGFkZChuYW1lKSB7XG4gICAgY29uc3QgYml0cyA9IG5ldyBQYXJpdHlDYWNoZShuYW1lKTtcbiAgICB0aGlzLmNoaWxkcmVuLnB1c2goYml0cyk7XG4gICAgcmV0dXJuIGJpdHM7XG4gIH1cblxuICB2ZXJpZnkoKSB7XG4gICAgY29uc3QgZmlyc3RDaGlsZCA9IHRoaXMuY2hpbGRyZW5bMF07XG4gICAgaWYgKCF0aGlzLmNoaWxkcmVuLnNvbWUoY2hpbGQgPT4gY2hpbGQucm9vdCkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMuY2hpbGRyZW4pIHtcbiAgICAgIGlmICghY2hpbGQudmVyaWZ5KCkpIHtcbiAgICAgICAgdGhpcy5yZWFzb24gPSB7XG4gICAgICAgICAgY2FjaGU6IGNoaWxkLFxuICAgICAgICAgIGNhY2hlTmFtZTogY2hpbGQubmFtZSxcbiAgICAgICAgICBjYWNoZVJlYXNvbjogY2hpbGQucmVhc29uLFxuICAgICAgICAgIG1lc3NhZ2U6IGBDYWNoZSAke2NoaWxkLm5hbWV9IGlzIG5vdCBjb21wbGV0ZS4gJHtcbiAgICAgICAgICAgIGNoaWxkLnJlYXNvbi5tZXNzYWdlXG4gICAgICAgICAgfWAsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmIChjaGlsZCAhPT0gZmlyc3RDaGlsZCAmJiBjaGlsZC5yb290LnRva2VuICE9PSBmaXJzdENoaWxkLnJvb3QudG9rZW4pIHtcbiAgICAgICAgdGhpcy5yZWFzb24gPSB7XG4gICAgICAgICAgZmlyc3RDYWNoZTogZmlyc3RDaGlsZCxcbiAgICAgICAgICBmaXJzdENhY2hlTmFtZTogZmlyc3RDaGlsZC5uYW1lLFxuICAgICAgICAgIGZpcnN0Q2FjaGVSZWFzb246IGZpcnN0Q2hpbGQucmVhc29uLFxuICAgICAgICAgIHNlY29uZENhY2hlOiBjaGlsZCxcbiAgICAgICAgICBzZWNvbmRDYWNoZU5hbWU6IGNoaWxkLm5hbWUsXG4gICAgICAgICAgc2Vjb25kQ2FjaGVSZWFzb246IGNoaWxkLnJlYXNvbixcblxuICAgICAgICAgIG1lc3NhZ2U6IGBDYWNoZSAke2ZpcnN0Q2hpbGQubmFtZX0gYW5kICR7Y2hpbGQubmFtZX0gZGlzYWdyZWUuYCxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuXG5jbGFzcyBQYXJpdHlDYWNoZSB7XG4gIGNvbnN0cnVjdG9yKG5hbWUpIHtcbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgIHRoaXMucm9vdCA9IG51bGw7XG4gICAgdGhpcy5iaXRzID0ge307XG5cbiAgICB0aGlzLnJlYXNvbiA9IG51bGw7XG4gIH1cblxuICBhZGQoX3Rva2VuKSB7XG4gICAgY29uc3QgdG9rZW4gPSBQYXJpdHlUb2tlbi5mcm9tSnNvbihfdG9rZW4pO1xuICAgIGlmICh0b2tlbi5pc1Jvb3QpIHtcbiAgICAgIHRoaXMucm9vdCA9IHRva2VuO1xuICAgIH1cbiAgICB0aGlzLmJpdHNbdG9rZW4uaWRdID0gdG9rZW47XG4gIH1cblxuICB2ZXJpZnkoKSB7XG4gICAgaWYgKHRoaXMucm9vdCA9PT0gbnVsbCkge1xuICAgICAgdGhpcy5yZWFzb24gPSB7XG4gICAgICAgIG1lc3NhZ2U6ICdSb290IGNvbXBpbGF0aW9uIG5vdCBmb3VuZC4nLFxuICAgICAgfTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGlkIG9mIHRoaXMucm9vdC5pZHMpIHtcbiAgICAgIGlmICh0eXBlb2YgdGhpcy5iaXRzW2lkXSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgdGhpcy5yZWFzb24gPSB7XG4gICAgICAgICAgbWVzc2FnZTogYENvbXBpbGF0aW9uICcke2lkfScgbm90IGZvdW5kLmAsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5yb290LnRva2VuICE9PSB0aGlzLmJpdHNbaWRdLnRva2VuKSB7XG4gICAgICAgIHRoaXMucmVhc29uID0ge1xuICAgICAgICAgIG1lc3NhZ2U6IGBSb290IGFuZCAnJHtpZH0nIGNvbXBpbGF0aW9uIGRpc2FncmVlLmAsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuXG5jb25zdCBjcmVhdGVQYXJpdHlUb2tlbiA9IChpZCwgaWRzID0gbnVsbCkgPT4ge1xuICBjb25zdCB0b2tlbiA9ICd4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgnLnJlcGxhY2UoXG4gICAgL1t4eV0vZyxcbiAgICBjID0+XG4gICAgICBjID09PSAneCdcbiAgICAgICAgPyAoKE1hdGgucmFuZG9tKCkgKiAxNikgfCAwKS50b1N0cmluZygxNilcbiAgICAgICAgOiAoKChNYXRoLnJhbmRvbSgpICogNCkgfCAwKSArIDgpLnRvU3RyaW5nKDE2KSxcbiAgKTtcblxuICByZXR1cm4gbmV3IFBhcml0eVRva2VuKGlkLCB0b2tlbiwgaWRzKTtcbn07XG5cbmNsYXNzIFBhcml0eVRva2VuIHtcbiAgY29uc3RydWN0b3IoaWQsIHRva2VuLCBpZHMgPSBudWxsKSB7XG4gICAgdGhpcy5pZCA9IGlkO1xuICAgIHRoaXMudG9rZW4gPSB0b2tlbjtcblxuICAgIHRoaXMuaXNSb290ID0gaWRzICE9PSBudWxsO1xuICAgIHRoaXMuaWRzID0gaWRzO1xuICB9XG5cbiAgc3RhdGljIGZyb21Db21waWxhdGlvbihjb21waWxhdGlvbikge1xuICAgIGxldCBwYXJlbnRDb21waWxhdGlvbiA9IGNvbXBpbGF0aW9uO1xuICAgIHdoaWxlIChwYXJlbnRDb21waWxhdGlvbi5jb21waWxlci5wYXJlbnRDb21waWxhdGlvbikge1xuICAgICAgcGFyZW50Q29tcGlsYXRpb24gPSBwYXJlbnRDb21waWxhdGlvbi5jb21waWxlci5wYXJlbnRDb21waWxhdGlvbjtcbiAgICB9XG5cbiAgICBpZiAoIXBhcmVudENvbXBpbGF0aW9uLl9faGFyZFNvdXJjZV9wYXJpdHlUb2tlbikge1xuICAgICAgcGFyZW50Q29tcGlsYXRpb24uX19oYXJkU291cmNlX3Bhcml0eVRva2VuID0gY3JlYXRlUGFyaXR5VG9rZW4oXG4gICAgICAgIGNhY2hlUHJlZml4KHBhcmVudENvbXBpbGF0aW9uKSxcbiAgICAgICAgW10sXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChjb21waWxhdGlvbiAhPT0gcGFyZW50Q29tcGlsYXRpb24pIHtcbiAgICAgIHJldHVybiBwYXJlbnRDb21waWxhdGlvbi5fX2hhcmRTb3VyY2VfcGFyaXR5VG9rZW4uY3JlYXRlQ2hpbGQoXG4gICAgICAgIGNhY2hlUHJlZml4KGNvbXBpbGF0aW9uKSxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBwYXJlbnRDb21waWxhdGlvbi5fX2hhcmRTb3VyY2VfcGFyaXR5VG9rZW47XG4gIH1cblxuICBzdGF0aWMgZnJvbUpzb24oanNvbikge1xuICAgIHJldHVybiBuZXcgUGFyaXR5VG9rZW4oanNvbi5pZCwganNvbi50b2tlbiwganNvbi5pZHMpO1xuICB9XG5cbiAgY3JlYXRlQ2hpbGQoaWQpIHtcbiAgICB0aGlzLmlkcy5wdXNoKGlkKTtcblxuICAgIHJldHVybiBuZXcgUGFyaXR5VG9rZW4oaWQsIHRoaXMudG9rZW4pO1xuICB9XG5cbiAgdG9KU09OKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiAnQ2FjaGVQYXJpdHlUb2tlbicsXG4gICAgICBpZDogdGhpcy5pZCxcbiAgICAgIGlkczogdGhpcy5pZHMsXG4gICAgICB0b2tlbjogdGhpcy50b2tlbixcbiAgICB9O1xuICB9XG59XG5cbmNvbnN0IHBhcnNlSWZTdHJpbmcgPSBpdGVtID0+IHtcbiAgaWYgKHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBwYXJzZUpzb24oaXRlbSk7XG4gIH1cbiAgcmV0dXJuIGl0ZW07XG59O1xuXG5jb25zdCBwYXJpdHlDYWNoZUZyb21DYWNoZSA9IChuYW1lLCBwYXJpdHlSb290LCBjYWNoZSkgPT4ge1xuICBjb25zdCBwYXJpdHlDYWNoZSA9IHBhcml0eVJvb3QuYWRkKG5hbWUpO1xuICBpZiAoY2FjaGUuX19oYXJkU291cmNlX3Bhcml0eVRva2VuX3Jvb3QpIHtcbiAgICBjb25zdCByb290Q29tcGlsYXRpb24gPSBwYXJzZUlmU3RyaW5nKGNhY2hlLl9faGFyZFNvdXJjZV9wYXJpdHlUb2tlbl9yb290KTtcbiAgICBwYXJpdHlDYWNoZS5hZGQocm9vdENvbXBpbGF0aW9uKTtcbiAgICByb290Q29tcGlsYXRpb24uaWRzLmZvckVhY2goaWQgPT4ge1xuICAgICAgaWYgKGNhY2hlW2BfX2hhcmRTb3VyY2VfcGFyaXR5VG9rZW5fJHtpZH1gXSkge1xuICAgICAgICBwYXJpdHlDYWNoZS5hZGQocGFyc2VJZlN0cmluZyhjYWNoZVtgX19oYXJkU291cmNlX3Bhcml0eVRva2VuXyR7aWR9YF0pKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufTtcblxuY29uc3QgcHVzaFBhcml0eVdyaXRlT3BzID0gKGNvbXBpbGF0aW9uLCBvcHMpID0+IHtcbiAgaWYgKGNvbXBpbGF0aW9uLmNvbXBpbGVyLnBhcmVudENvbXBpbGF0aW9uKSB7XG4gICAgb3BzLnB1c2goe1xuICAgICAga2V5OiBgX19oYXJkU291cmNlX3Bhcml0eVRva2VuXyR7Y2FjaGVQcmVmaXgoY29tcGlsYXRpb24pfWAsXG4gICAgICB2YWx1ZTogSlNPTi5zdHJpbmdpZnkoUGFyaXR5VG9rZW4uZnJvbUNvbXBpbGF0aW9uKGNvbXBpbGF0aW9uKSksXG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgb3BzLnB1c2goe1xuICAgICAga2V5OiBgX19oYXJkU291cmNlX3Bhcml0eVRva2VuX3Jvb3RgLFxuICAgICAgdmFsdWU6IEpTT04uc3RyaW5naWZ5KFBhcml0eVRva2VuLmZyb21Db21waWxhdGlvbihjb21waWxhdGlvbikpLFxuICAgIH0pO1xuICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgUGFyaXR5Um9vdCxcbiAgUGFyaXR5Q2FjaGUsXG4gIFBhcml0eVRva2VuLFxuXG4gIHBhcml0eUNhY2hlRnJvbUNhY2hlLFxuICBwdXNoUGFyaXR5V3JpdGVPcHMsXG59O1xuIl0sInNvdXJjZVJvb3QiOiIvVXNlcnMvdHlsZXJhcmJ1cy9kZXYvcHJvdmlkZXIvc3JjIn0=
