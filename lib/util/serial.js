'use strict';

const relateContext = require('./relate-context');

const pipe = exports.pipe = (...fns) => ({
  freeze(arg, module, extra, methods) {
    for (const fn of fns) {
      arg = fn.freeze(arg, module, extra, methods);
    }
    return arg;
  },
  thaw(arg, frozen, extra, methods) {
    for (const fn of fns) {
      arg = fn.thaw(arg, frozen, extra, methods);
    }
    return arg;
  }
});

const serialMap = exports.map = (keyOp, valueOp) => ({
  freeze(arg, module, extra) {
    const resolved = [];
    for (const key in arg) {
      resolved.push([keyOp.freeze(key, key, extra), valueOp.freeze(arg[key], arg[key], extra)]);
    }
    return resolved;
  },
  thaw(arg, frozen, extra) {
    const resolved = {};
    for (const item of arg) {
      const key = keyOp.thaw(item[0], item[0], extra);
      const value = valueOp.thaw(item[1], item[1], extra);
      resolved[key] = value;
    }
    return resolved;
  }
});

const contextual = exports.contextual = fnname => {
  const relate = relateContext[`relateNormal${fnname}`];
  const context = relateContext[`contextNormal${fnname}`];
  return {
    freeze: (arg, module, { compiler, compilation }, methods) => arg ? relate(compiler || compilation.compiler, arg) : arg,
    thaw: (arg, module, { compiler, compilation }, methods) => arg ? context(compiler || compilation.compiler, arg) : arg
  };
};

const archetype = exports.archetype = type => ({
  freeze: (arg, module, extra, { freeze }) => freeze(type, null, arg, extra),
  thaw: (arg, module, extra, { thaw }) => thaw(type, null, arg, extra)
});
const mapArchetype = exports.mapArchetype = type => ({
  freeze: (arg, module, extra, { mapFreeze }) => mapFreeze(type, null, arg, extra),
  thaw: (arg, module, extra, { mapThaw }) => mapThaw(type, null, arg, extra)
});

const path = exports.path = contextual('Path');
const pathArray = exports.pathArray = contextual('PathArray');
const pathSet = exports.pathSet = contextual('PathSet');
const request = exports.request = contextual('Request');
const _loaders = exports._loaders = contextual('Loaders');
const loaders = exports.loaders = {
  freeze: _loaders.freeze,
  thaw(arg, frozen, extra, methods) {
    return _loaders.thaw(arg, frozen, extra, methods).map(loader => {
      if (loader.ident) {
        let ruleSet = extra.normalModuleFactory && extra.normalModuleFactory.ruleSet;
        if (!ruleSet) {
          ruleSet = extra.compiler.__hardSource_ruleSet;
          if (!ruleSet) {
            const RuleSet = require('webpack/lib/RuleSet');
            if (extra.compiler.options.module.defaultRules) {
              // webpack 4
              ruleSet = extra.compiler.__hardSource_ruleSet = new RuleSet(extra.compiler.options.module.defaultRules.concat(extra.compiler.options.module.rules));
            } else {
              // webpack <4
              ruleSet = extra.compiler.__hardSource_ruleSet = new RuleSet(extra.compiler.options.module.rules || extra.compiler.options.module.loaders);
            }
          }
        }
        return {
          loader: loader.loader,
          ident: loader.ident,
          options: ruleSet.findOptionsByIdent(loader.ident)
        };
      }
      return loader;
    });
  }
};
const regExp = exports.regExp = {
  freeze: arg => arg ? arg.source : false,
  thaw: arg => arg ? new RegExp(arg) : false
};

const parser = exports.parser = archetype('Parser');
const generator = exports.generator = archetype('Generator');
const source = exports.source = archetype('Source');
const moduleAssets = exports.moduleAssets = archetype('ModuleAssets');
const moduleError = exports.moduleError = mapArchetype('ModuleError');
const moduleWarning = exports.moduleWarning = mapArchetype('ModuleWarning');
const dependencyBlock = exports.dependencyBlock = {
  freeze: (arg, module, extra, { freeze }) => freeze('DependencyBlock', null, arg, extra),
  thaw: (arg, module, extra, { thaw }) => thaw('DependencyBlock', arg, module, extra)
};

const _null = exports.null = {
  freeze: () => null,
  thaw: () => null
};
const identity = exports.identity = {
  freeze: (arg, module, extra, methods) => arg,
  thaw: (arg, module, extra, methods) => arg
};

const assigned = exports.assigned = members => ({
  freeze(arg, module, extra, methods) {
    const out = {};
    for (const key in members) {
      out[key] = members[key].freeze(arg[key], module, extra, methods);
    }
    return out;
  },
  thaw(arg, frozen, extra, methods) {
    for (const key in members) {
      arg[key] = members[key].thaw(frozen[key], frozen, extra, methods);
    }
    return arg;
  }
});

const created = exports.created = members => ({
  freeze(arg, module, extra, methods) {
    if (!arg) {
      return null;
    }
    const out = {};
    for (const key in members) {
      out[key] = members[key].freeze(arg[key], module, extra, methods);
    }
    return out;
  },
  thaw(arg, frozen, extra, methods) {
    if (!arg) {
      return null;
    }
    const out = {};
    for (const key in members) {
      out[key] = members[key].thaw(arg[key], frozen, extra, methods);
    }
    return out;
  }
});

const objectAssign = exports.objectAssign = opts => ({
  freeze(arg, module, extra) {
    const out = Object.assign({}, arg);
    for (const key in opts) {
      out[key] = opts[key].freeze(arg[key], arg, extra);
    }
    return out;
  },
  thaw(arg, frozen, extra) {
    const out = Object.assign({}, arg);
    for (const key in opts) {
      out[key] = opts[key].thaw(arg[key], arg, extra);
    }
    return out;
  }
});

const constructed = exports.constructed = (Type, args) => ({
  freeze(arg, module, extra, methods) {
    const out = {};
    for (const key in args) {
      out[key] = args[key].freeze(arg[key], module, extra, methods);
    }
    return out;
  },
  thaw(arg, frozen, extra, methods) {
    const newArgs = [];
    for (const key in args) {
      newArgs.push(args[key].thaw(frozen[key], frozen, extra, methods));
    }
    return new Type(...newArgs);
  }
});

const serial = exports.serial = (name, stages) => ({
  freeze(arg, module, extra, methods) {
    const out = {
      type: name
    };
    for (const key in stages) {
      out[key] = stages[key].freeze(module, module, extra, methods);
    }
    return out;
  },
  thaw(arg, frozen, extra, methods) {
    let out = arg;
    for (const key in stages) {
      out = stages[key].thaw(out, frozen[key], extra, methods);
    }
    return out;
  }
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi91dGlsL3NlcmlhbC5qcyJdLCJuYW1lcyI6WyJyZWxhdGVDb250ZXh0IiwicmVxdWlyZSIsInBpcGUiLCJleHBvcnRzIiwiZm5zIiwiZnJlZXplIiwiYXJnIiwibW9kdWxlIiwiZXh0cmEiLCJtZXRob2RzIiwiZm4iLCJ0aGF3IiwiZnJvemVuIiwic2VyaWFsTWFwIiwibWFwIiwia2V5T3AiLCJ2YWx1ZU9wIiwicmVzb2x2ZWQiLCJrZXkiLCJwdXNoIiwiaXRlbSIsInZhbHVlIiwiY29udGV4dHVhbCIsImZubmFtZSIsInJlbGF0ZSIsImNvbnRleHQiLCJjb21waWxlciIsImNvbXBpbGF0aW9uIiwiYXJjaGV0eXBlIiwidHlwZSIsIm1hcEFyY2hldHlwZSIsIm1hcEZyZWV6ZSIsIm1hcFRoYXciLCJwYXRoIiwicGF0aEFycmF5IiwicGF0aFNldCIsInJlcXVlc3QiLCJfbG9hZGVycyIsImxvYWRlcnMiLCJsb2FkZXIiLCJpZGVudCIsInJ1bGVTZXQiLCJub3JtYWxNb2R1bGVGYWN0b3J5IiwiX19oYXJkU291cmNlX3J1bGVTZXQiLCJSdWxlU2V0Iiwib3B0aW9ucyIsImRlZmF1bHRSdWxlcyIsImNvbmNhdCIsInJ1bGVzIiwiZmluZE9wdGlvbnNCeUlkZW50IiwicmVnRXhwIiwic291cmNlIiwiUmVnRXhwIiwicGFyc2VyIiwiZ2VuZXJhdG9yIiwibW9kdWxlQXNzZXRzIiwibW9kdWxlRXJyb3IiLCJtb2R1bGVXYXJuaW5nIiwiZGVwZW5kZW5jeUJsb2NrIiwiX251bGwiLCJudWxsIiwiaWRlbnRpdHkiLCJhc3NpZ25lZCIsIm1lbWJlcnMiLCJvdXQiLCJjcmVhdGVkIiwib2JqZWN0QXNzaWduIiwib3B0cyIsIk9iamVjdCIsImFzc2lnbiIsImNvbnN0cnVjdGVkIiwiVHlwZSIsImFyZ3MiLCJuZXdBcmdzIiwic2VyaWFsIiwibmFtZSIsInN0YWdlcyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxn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TCxFQUFVUCxJQUFWLENBQWVDLE9BQU9NLEdBQVAsQ0FBZixFQUE0Qk4sTUFBNUIsRUFBb0NKLEtBQXBDLEVBQTJDQyxPQUEzQyxDQUFiO0FBQ0Q7QUFDRCxXQUFPLElBQUk4RCxJQUFKLENBQVMsR0FBR0UsT0FBWixDQUFQO0FBQ0Q7QUFkeUQsQ0FBakIsQ0FBM0M7O0FBaUJBLE1BQU1DLFNBQVV2RSxRQUFRdUUsTUFBUixHQUFpQixDQUFDQyxJQUFELEVBQU9DLE1BQVAsTUFBbUI7QUFDbER2RSxTQUFPQyxHQUFQLEVBQVlDLE1BQVosRUFBb0JDLEtBQXBCLEVBQTJCQyxPQUEzQixFQUFvQztBQUNsQyxVQUFNdUQsTUFBTTtBQUNWbkMsWUFBTThDO0FBREksS0FBWjtBQUdBLFNBQUssTUFBTXpELEdBQVgsSUFBa0IwRCxNQUFsQixFQUEwQjtBQUN4QlosVUFBSTlDLEdBQUosSUFBVzBELE9BQU8xRCxHQUFQLEVBQVliLE1BQVosQ0FBbUJFLE1BQW5CLEVBQTJCQSxNQUEzQixFQUFtQ0MsS0FBbkMsRUFBMENDLE9BQTFDLENBQVg7QUFDRDtBQUNELFdBQU91RCxHQUFQO0FBQ0QsR0FUaUQ7QUFVbERyRCxPQUFLTCxHQUFMLEVBQVVNLE1BQVYsRUFBa0JKLEtBQWxCLEVBQXlCQyxPQUF6QixFQUFrQztBQUNoQyxRQUFJdUQsTUFBTTFELEdBQVY7QUFDQSxTQUFLLE1BQU1ZLEdBQVgsSUFBa0IwRCxNQUFsQixFQUEwQjtBQUN4QlosWUFBTVksT0FBTzFELEdBQVAsRUFBWVAsSUFBWixDQUFpQnFELEdBQWpCLEVBQXNCcEQsT0FBT00sR0FBUCxDQUF0QixFQUFtQ1YsS0FBbkMsRUFBMENDLE9BQTFDLENBQU47QUFDRDtBQUNELFdBQU91RCxHQUFQO0FBQ0Q7QUFoQmlELENBQW5CLENBQWpDIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi91dGlsL3NlcmlhbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHJlbGF0ZUNvbnRleHQgPSByZXF1aXJlKCcuL3JlbGF0ZS1jb250ZXh0Jyk7XG5cbmNvbnN0IHBpcGUgPSAoZXhwb3J0cy5waXBlID0gKC4uLmZucykgPT4gKHtcbiAgZnJlZXplKGFyZywgbW9kdWxlLCBleHRyYSwgbWV0aG9kcykge1xuICAgIGZvciAoY29uc3QgZm4gb2YgZm5zKSB7XG4gICAgICBhcmcgPSBmbi5mcmVlemUoYXJnLCBtb2R1bGUsIGV4dHJhLCBtZXRob2RzKTtcbiAgICB9XG4gICAgcmV0dXJuIGFyZztcbiAgfSxcbiAgdGhhdyhhcmcsIGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgICBmb3IgKGNvbnN0IGZuIG9mIGZucykge1xuICAgICAgYXJnID0gZm4udGhhdyhhcmcsIGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpO1xuICAgIH1cbiAgICByZXR1cm4gYXJnO1xuICB9LFxufSkpO1xuXG5jb25zdCBzZXJpYWxNYXAgPSAoZXhwb3J0cy5tYXAgPSAoa2V5T3AsIHZhbHVlT3ApID0+ICh7XG4gIGZyZWV6ZShhcmcsIG1vZHVsZSwgZXh0cmEpIHtcbiAgICBjb25zdCByZXNvbHZlZCA9IFtdO1xuICAgIGZvciAoY29uc3Qga2V5IGluIGFyZykge1xuICAgICAgcmVzb2x2ZWQucHVzaChbXG4gICAgICAgIGtleU9wLmZyZWV6ZShrZXksIGtleSwgZXh0cmEpLFxuICAgICAgICB2YWx1ZU9wLmZyZWV6ZShhcmdba2V5XSwgYXJnW2tleV0sIGV4dHJhKSxcbiAgICAgIF0pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzb2x2ZWQ7XG4gIH0sXG4gIHRoYXcoYXJnLCBmcm96ZW4sIGV4dHJhKSB7XG4gICAgY29uc3QgcmVzb2x2ZWQgPSB7fTtcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgYXJnKSB7XG4gICAgICBjb25zdCBrZXkgPSBrZXlPcC50aGF3KGl0ZW1bMF0sIGl0ZW1bMF0sIGV4dHJhKTtcbiAgICAgIGNvbnN0IHZhbHVlID0gdmFsdWVPcC50aGF3KGl0ZW1bMV0sIGl0ZW1bMV0sIGV4dHJhKTtcbiAgICAgIHJlc29sdmVkW2tleV0gPSB2YWx1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc29sdmVkO1xuICB9LFxufSkpO1xuXG5jb25zdCBjb250ZXh0dWFsID0gKGV4cG9ydHMuY29udGV4dHVhbCA9IGZubmFtZSA9PiB7XG4gIGNvbnN0IHJlbGF0ZSA9IHJlbGF0ZUNvbnRleHRbYHJlbGF0ZU5vcm1hbCR7Zm5uYW1lfWBdO1xuICBjb25zdCBjb250ZXh0ID0gcmVsYXRlQ29udGV4dFtgY29udGV4dE5vcm1hbCR7Zm5uYW1lfWBdO1xuICByZXR1cm4ge1xuICAgIGZyZWV6ZTogKGFyZywgbW9kdWxlLCB7IGNvbXBpbGVyLCBjb21waWxhdGlvbiB9LCBtZXRob2RzKSA9PlxuICAgICAgYXJnID8gcmVsYXRlKGNvbXBpbGVyIHx8IGNvbXBpbGF0aW9uLmNvbXBpbGVyLCBhcmcpIDogYXJnLFxuICAgIHRoYXc6IChhcmcsIG1vZHVsZSwgeyBjb21waWxlciwgY29tcGlsYXRpb24gfSwgbWV0aG9kcykgPT5cbiAgICAgIGFyZyA/IGNvbnRleHQoY29tcGlsZXIgfHwgY29tcGlsYXRpb24uY29tcGlsZXIsIGFyZykgOiBhcmcsXG4gIH07XG59KTtcblxuY29uc3QgYXJjaGV0eXBlID0gKGV4cG9ydHMuYXJjaGV0eXBlID0gdHlwZSA9PiAoe1xuICBmcmVlemU6IChhcmcsIG1vZHVsZSwgZXh0cmEsIHsgZnJlZXplIH0pID0+IGZyZWV6ZSh0eXBlLCBudWxsLCBhcmcsIGV4dHJhKSxcbiAgdGhhdzogKGFyZywgbW9kdWxlLCBleHRyYSwgeyB0aGF3IH0pID0+IHRoYXcodHlwZSwgbnVsbCwgYXJnLCBleHRyYSksXG59KSk7XG5jb25zdCBtYXBBcmNoZXR5cGUgPSAoZXhwb3J0cy5tYXBBcmNoZXR5cGUgPSB0eXBlID0+ICh7XG4gIGZyZWV6ZTogKGFyZywgbW9kdWxlLCBleHRyYSwgeyBtYXBGcmVlemUgfSkgPT5cbiAgICBtYXBGcmVlemUodHlwZSwgbnVsbCwgYXJnLCBleHRyYSksXG4gIHRoYXc6IChhcmcsIG1vZHVsZSwgZXh0cmEsIHsgbWFwVGhhdyB9KSA9PiBtYXBUaGF3KHR5cGUsIG51bGwsIGFyZywgZXh0cmEpLFxufSkpO1xuXG5jb25zdCBwYXRoID0gKGV4cG9ydHMucGF0aCA9IGNvbnRleHR1YWwoJ1BhdGgnKSk7XG5jb25zdCBwYXRoQXJyYXkgPSAoZXhwb3J0cy5wYXRoQXJyYXkgPSBjb250ZXh0dWFsKCdQYXRoQXJyYXknKSk7XG5jb25zdCBwYXRoU2V0ID0gKGV4cG9ydHMucGF0aFNldCA9IGNvbnRleHR1YWwoJ1BhdGhTZXQnKSk7XG5jb25zdCByZXF1ZXN0ID0gKGV4cG9ydHMucmVxdWVzdCA9IGNvbnRleHR1YWwoJ1JlcXVlc3QnKSk7XG5jb25zdCBfbG9hZGVycyA9IChleHBvcnRzLl9sb2FkZXJzID0gY29udGV4dHVhbCgnTG9hZGVycycpKTtcbmNvbnN0IGxvYWRlcnMgPSAoZXhwb3J0cy5sb2FkZXJzID0ge1xuICBmcmVlemU6IF9sb2FkZXJzLmZyZWV6ZSxcbiAgdGhhdyhhcmcsIGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgICByZXR1cm4gX2xvYWRlcnMudGhhdyhhcmcsIGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpLm1hcChsb2FkZXIgPT4ge1xuICAgICAgaWYgKGxvYWRlci5pZGVudCkge1xuICAgICAgICBsZXQgcnVsZVNldCA9XG4gICAgICAgICAgZXh0cmEubm9ybWFsTW9kdWxlRmFjdG9yeSAmJiBleHRyYS5ub3JtYWxNb2R1bGVGYWN0b3J5LnJ1bGVTZXQ7XG4gICAgICAgIGlmICghcnVsZVNldCkge1xuICAgICAgICAgIHJ1bGVTZXQgPSBleHRyYS5jb21waWxlci5fX2hhcmRTb3VyY2VfcnVsZVNldDtcbiAgICAgICAgICBpZiAoIXJ1bGVTZXQpIHtcbiAgICAgICAgICAgIGNvbnN0IFJ1bGVTZXQgPSByZXF1aXJlKCd3ZWJwYWNrL2xpYi9SdWxlU2V0Jyk7XG4gICAgICAgICAgICBpZiAoZXh0cmEuY29tcGlsZXIub3B0aW9ucy5tb2R1bGUuZGVmYXVsdFJ1bGVzKSB7XG4gICAgICAgICAgICAgIC8vIHdlYnBhY2sgNFxuICAgICAgICAgICAgICBydWxlU2V0ID0gZXh0cmEuY29tcGlsZXIuX19oYXJkU291cmNlX3J1bGVTZXQgPSBuZXcgUnVsZVNldChcbiAgICAgICAgICAgICAgICBleHRyYS5jb21waWxlci5vcHRpb25zLm1vZHVsZS5kZWZhdWx0UnVsZXMuY29uY2F0KFxuICAgICAgICAgICAgICAgICAgZXh0cmEuY29tcGlsZXIub3B0aW9ucy5tb2R1bGUucnVsZXMsXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIC8vIHdlYnBhY2sgPDRcbiAgICAgICAgICAgICAgcnVsZVNldCA9IGV4dHJhLmNvbXBpbGVyLl9faGFyZFNvdXJjZV9ydWxlU2V0ID0gbmV3IFJ1bGVTZXQoXG4gICAgICAgICAgICAgICAgZXh0cmEuY29tcGlsZXIub3B0aW9ucy5tb2R1bGUucnVsZXMgfHxcbiAgICAgICAgICAgICAgICAgIGV4dHJhLmNvbXBpbGVyLm9wdGlvbnMubW9kdWxlLmxvYWRlcnMsXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbG9hZGVyOiBsb2FkZXIubG9hZGVyLFxuICAgICAgICAgIGlkZW50OiBsb2FkZXIuaWRlbnQsXG4gICAgICAgICAgb3B0aW9uczogcnVsZVNldC5maW5kT3B0aW9uc0J5SWRlbnQobG9hZGVyLmlkZW50KSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBsb2FkZXI7XG4gICAgfSk7XG4gIH0sXG59KTtcbmNvbnN0IHJlZ0V4cCA9IChleHBvcnRzLnJlZ0V4cCA9IHtcbiAgZnJlZXplOiBhcmcgPT4gKGFyZyA/IGFyZy5zb3VyY2UgOiBmYWxzZSksXG4gIHRoYXc6IGFyZyA9PiAoYXJnID8gbmV3IFJlZ0V4cChhcmcpIDogZmFsc2UpLFxufSk7XG5cbmNvbnN0IHBhcnNlciA9IChleHBvcnRzLnBhcnNlciA9IGFyY2hldHlwZSgnUGFyc2VyJykpO1xuY29uc3QgZ2VuZXJhdG9yID0gKGV4cG9ydHMuZ2VuZXJhdG9yID0gYXJjaGV0eXBlKCdHZW5lcmF0b3InKSk7XG5jb25zdCBzb3VyY2UgPSAoZXhwb3J0cy5zb3VyY2UgPSBhcmNoZXR5cGUoJ1NvdXJjZScpKTtcbmNvbnN0IG1vZHVsZUFzc2V0cyA9IChleHBvcnRzLm1vZHVsZUFzc2V0cyA9IGFyY2hldHlwZSgnTW9kdWxlQXNzZXRzJykpO1xuY29uc3QgbW9kdWxlRXJyb3IgPSAoZXhwb3J0cy5tb2R1bGVFcnJvciA9IG1hcEFyY2hldHlwZSgnTW9kdWxlRXJyb3InKSk7XG5jb25zdCBtb2R1bGVXYXJuaW5nID0gKGV4cG9ydHMubW9kdWxlV2FybmluZyA9IG1hcEFyY2hldHlwZSgnTW9kdWxlV2FybmluZycpKTtcbmNvbnN0IGRlcGVuZGVuY3lCbG9jayA9IChleHBvcnRzLmRlcGVuZGVuY3lCbG9jayA9IHtcbiAgZnJlZXplOiAoYXJnLCBtb2R1bGUsIGV4dHJhLCB7IGZyZWV6ZSB9KSA9PlxuICAgIGZyZWV6ZSgnRGVwZW5kZW5jeUJsb2NrJywgbnVsbCwgYXJnLCBleHRyYSksXG4gIHRoYXc6IChhcmcsIG1vZHVsZSwgZXh0cmEsIHsgdGhhdyB9KSA9PlxuICAgIHRoYXcoJ0RlcGVuZGVuY3lCbG9jaycsIGFyZywgbW9kdWxlLCBleHRyYSksXG59KTtcblxuY29uc3QgX251bGwgPSAoZXhwb3J0cy5udWxsID0ge1xuICBmcmVlemU6ICgpID0+IG51bGwsXG4gIHRoYXc6ICgpID0+IG51bGwsXG59KTtcbmNvbnN0IGlkZW50aXR5ID0gKGV4cG9ydHMuaWRlbnRpdHkgPSB7XG4gIGZyZWV6ZTogKGFyZywgbW9kdWxlLCBleHRyYSwgbWV0aG9kcykgPT4gYXJnLFxuICB0aGF3OiAoYXJnLCBtb2R1bGUsIGV4dHJhLCBtZXRob2RzKSA9PiBhcmcsXG59KTtcblxuY29uc3QgYXNzaWduZWQgPSAoZXhwb3J0cy5hc3NpZ25lZCA9IG1lbWJlcnMgPT4gKHtcbiAgZnJlZXplKGFyZywgbW9kdWxlLCBleHRyYSwgbWV0aG9kcykge1xuICAgIGNvbnN0IG91dCA9IHt9O1xuICAgIGZvciAoY29uc3Qga2V5IGluIG1lbWJlcnMpIHtcbiAgICAgIG91dFtrZXldID0gbWVtYmVyc1trZXldLmZyZWV6ZShhcmdba2V5XSwgbW9kdWxlLCBleHRyYSwgbWV0aG9kcyk7XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG4gIH0sXG4gIHRoYXcoYXJnLCBmcm96ZW4sIGV4dHJhLCBtZXRob2RzKSB7XG4gICAgZm9yIChjb25zdCBrZXkgaW4gbWVtYmVycykge1xuICAgICAgYXJnW2tleV0gPSBtZW1iZXJzW2tleV0udGhhdyhmcm96ZW5ba2V5XSwgZnJvemVuLCBleHRyYSwgbWV0aG9kcyk7XG4gICAgfVxuICAgIHJldHVybiBhcmc7XG4gIH0sXG59KSk7XG5cbmNvbnN0IGNyZWF0ZWQgPSAoZXhwb3J0cy5jcmVhdGVkID0gbWVtYmVycyA9PiAoe1xuICBmcmVlemUoYXJnLCBtb2R1bGUsIGV4dHJhLCBtZXRob2RzKSB7XG4gICAgaWYgKCFhcmcpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBvdXQgPSB7fTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBtZW1iZXJzKSB7XG4gICAgICBvdXRba2V5XSA9IG1lbWJlcnNba2V5XS5mcmVlemUoYXJnW2tleV0sIG1vZHVsZSwgZXh0cmEsIG1ldGhvZHMpO1xuICAgIH1cbiAgICByZXR1cm4gb3V0O1xuICB9LFxuICB0aGF3KGFyZywgZnJvemVuLCBleHRyYSwgbWV0aG9kcykge1xuICAgIGlmICghYXJnKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3Qgb3V0ID0ge307XG4gICAgZm9yIChjb25zdCBrZXkgaW4gbWVtYmVycykge1xuICAgICAgb3V0W2tleV0gPSBtZW1iZXJzW2tleV0udGhhdyhhcmdba2V5XSwgZnJvemVuLCBleHRyYSwgbWV0aG9kcyk7XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG4gIH0sXG59KSk7XG5cbmNvbnN0IG9iamVjdEFzc2lnbiA9IChleHBvcnRzLm9iamVjdEFzc2lnbiA9IG9wdHMgPT4gKHtcbiAgZnJlZXplKGFyZywgbW9kdWxlLCBleHRyYSkge1xuICAgIGNvbnN0IG91dCA9IE9iamVjdC5hc3NpZ24oe30sIGFyZyk7XG4gICAgZm9yIChjb25zdCBrZXkgaW4gb3B0cykge1xuICAgICAgb3V0W2tleV0gPSBvcHRzW2tleV0uZnJlZXplKGFyZ1trZXldLCBhcmcsIGV4dHJhKTtcbiAgICB9XG4gICAgcmV0dXJuIG91dDtcbiAgfSxcbiAgdGhhdyhhcmcsIGZyb3plbiwgZXh0cmEpIHtcbiAgICBjb25zdCBvdXQgPSBPYmplY3QuYXNzaWduKHt9LCBhcmcpO1xuICAgIGZvciAoY29uc3Qga2V5IGluIG9wdHMpIHtcbiAgICAgIG91dFtrZXldID0gb3B0c1trZXldLnRoYXcoYXJnW2tleV0sIGFyZywgZXh0cmEpO1xuICAgIH1cbiAgICByZXR1cm4gb3V0O1xuICB9LFxufSkpO1xuXG5jb25zdCBjb25zdHJ1Y3RlZCA9IChleHBvcnRzLmNvbnN0cnVjdGVkID0gKFR5cGUsIGFyZ3MpID0+ICh7XG4gIGZyZWV6ZShhcmcsIG1vZHVsZSwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgICBjb25zdCBvdXQgPSB7fTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBhcmdzKSB7XG4gICAgICBvdXRba2V5XSA9IGFyZ3Nba2V5XS5mcmVlemUoYXJnW2tleV0sIG1vZHVsZSwgZXh0cmEsIG1ldGhvZHMpO1xuICAgIH1cbiAgICByZXR1cm4gb3V0O1xuICB9LFxuICB0aGF3KGFyZywgZnJvemVuLCBleHRyYSwgbWV0aG9kcykge1xuICAgIGNvbnN0IG5ld0FyZ3MgPSBbXTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBhcmdzKSB7XG4gICAgICBuZXdBcmdzLnB1c2goYXJnc1trZXldLnRoYXcoZnJvemVuW2tleV0sIGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBUeXBlKC4uLm5ld0FyZ3MpO1xuICB9LFxufSkpO1xuXG5jb25zdCBzZXJpYWwgPSAoZXhwb3J0cy5zZXJpYWwgPSAobmFtZSwgc3RhZ2VzKSA9PiAoe1xuICBmcmVlemUoYXJnLCBtb2R1bGUsIGV4dHJhLCBtZXRob2RzKSB7XG4gICAgY29uc3Qgb3V0ID0ge1xuICAgICAgdHlwZTogbmFtZSxcbiAgICB9O1xuICAgIGZvciAoY29uc3Qga2V5IGluIHN0YWdlcykge1xuICAgICAgb3V0W2tleV0gPSBzdGFnZXNba2V5XS5mcmVlemUobW9kdWxlLCBtb2R1bGUsIGV4dHJhLCBtZXRob2RzKTtcbiAgICB9XG4gICAgcmV0dXJuIG91dDtcbiAgfSxcbiAgdGhhdyhhcmcsIGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgICBsZXQgb3V0ID0gYXJnO1xuICAgIGZvciAoY29uc3Qga2V5IGluIHN0YWdlcykge1xuICAgICAgb3V0ID0gc3RhZ2VzW2tleV0udGhhdyhvdXQsIGZyb3plbltrZXldLCBleHRyYSwgbWV0aG9kcyk7XG4gICAgfVxuICAgIHJldHVybiBvdXQ7XG4gIH0sXG59KSk7XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
