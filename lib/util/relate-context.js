'use strict';

const path = require('path');

const rootCompiler = compiler => {
  while (compiler.parentCompilation) {
    compiler = compiler.parentCompilation.compiler;
  }
  return compiler;
};

const compilerContext = exports.compilerContext = function compilerContext(compiler) {
  return rootCompiler(compiler.compiler ? compiler.compiler : compiler).context;
};

const relateNormalPath = exports.relateNormalPath = function relateNormalPath(compiler, key) {
  if (typeof key !== 'string') {
    return key;
  }
  if (compilerContext(compiler) === key) {
    return '.';
  }
  if (key === '') {
    return key;
  }
  const rel = path.relative(compilerContext(compiler), key.split('?')[0]);
  return [rel.replace(/\\/g, '/')].concat(key.split('?').slice(1)).join('?');
};

const relateNormalRequest = exports.relateNormalRequest = function relateNormalRequest(compiler, key) {
  return key.split('!').map(subkey => relateNormalPath(compiler, subkey)).join('!');
};

const relateNormalModuleId = exports.relateNormalModuleId = function relateNormalModuleId(compiler, id) {
  return id.substring(0, 24) + relateNormalRequest(compiler, id.substring(24));
};

const relateNormalLoaders = exports.relateNormalLoaders = function relateNormalLoaders(compiler, loaders) {
  return loaders.map(loader => Object.assign({}, loader, {
    loader: relateNormalPath(compiler, loader.loader)
  }));
};

const relateNormalPathArray = exports.relateNormalPathArray = function relateNormalPathArray(compiler, paths) {
  return paths.map(subpath => relateNormalPath(compiler, subpath));
};

const relateNormalPathSet = exports.relateNormalPathSet = function relateNormalPathSet(compiler, paths) {
  return relateNormalPathArray(compiler, Array.from(paths));
};

/**
 *
 */

const contextNormalPath = exports.contextNormalPath = function contextNormalPath(compiler, key) {
  if (typeof key !== 'string') {
    return key;
  }
  if (key === '.') {
    return compilerContext(compiler);
  }
  if (key === '') {
    return '';
  }
  const abs = path.resolve(compilerContext(compiler), key.split('?')[0]);
  return [abs.replace(/\//g, path.sep)].concat(key.split('?').slice(1)).join('?');
};

const contextNormalRequest = exports.contextNormalRequest = function contextNormalRequest(compiler, key) {
  // return key
  // .split('!')
  // .map(subkey => contextNormalPath(compiler, subkey))
  // .join('!');

  let i = -1;
  let j = -1;
  let _newkey = '';
  while ((i = key.indexOf('!', i + 1)) !== -1) {
    _newkey += contextNormalPath(compiler, key.substring(j + 1, i));
    _newkey += '!';
    j = i;
  }
  _newkey += contextNormalPath(compiler, key.substring(j + 1));
  return _newkey;
};

const contextNormalModuleId = exports.contextNormalModuleId = function contextNormalModuleId(compiler, id) {
  return id.substring(0, 24) + contextNormalRequest(compiler, id.substring(24));
};

const contextNormalLoaders = exports.contextNormalLoaders = function contextNormalLoaders(compiler, loaders) {
  return loaders.map(loader => Object.assign({}, loader, {
    loader: contextNormalPath(compiler, loader.loader)
  }));
};

const contextNormalPathArray = exports.contextNormalPathArray = function contextNormalPathArray(compiler, paths) {
  return paths.map(subpath => contextNormalPath(compiler, subpath));
};

const contextNormalPathSet = exports.contextNormalPathSet = function contextNormalPathSet(compiler, paths) {
  return new Set(contextNormalPathArray(compiler, paths));
};

/**
 *
 */

const maybeAbsolutePath = exports.maybeAbsolutePath = function maybeAbsolutePath(path) {
  return (/^([a-zA-Z]:\\\\|\/)/.test(path)
  );
};

const relateAbsolutePath = exports.relateAbsolutePath = function relateAbsolutePath(context, absPath) {
  if (maybeAbsolutePath(absPath)) {
    return path.relative(context, absPath);
  }
  return absPath;
};

const relateAbsoluteRequest = exports.relateAbsoluteRequest = function relateAbsoluteRequest(context, absReq) {
  return absReq.split(/!/g).map(path => relateAbsolutePath(context, path)).join('!');
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi91dGlsL3JlbGF0ZS1jb250ZXh0LmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwicm9vdENvbXBpbGVyIiwiY29tcGlsZXIiLCJwYXJlbnRDb21waWxhdGlvbiIsImNvbXBpbGVyQ29udGV4dCIsImV4cG9ydHMiLCJjb250ZXh0IiwicmVsYXRlTm9ybWFsUGF0aCIsImtleSIsInJlbCIsInJlbGF0aXZlIiwic3BsaXQiLCJyZXBsYWNlIiwiY29uY2F0Iiwic2xpY2UiLCJqb2luIiwicmVsYXRlTm9ybWFsUmVxdWVzdCIsIm1hcCIsInN1YmtleSIsInJlbGF0ZU5vcm1hbE1vZHVsZUlkIiwiaWQiLCJzdWJzdHJpbmciLCJyZWxhdGVOb3JtYWxMb2FkZXJzIiwibG9hZGVycyIsImxvYWRlciIsIk9iamVjdCIsImFzc2lnbiIsInJlbGF0ZU5vcm1hbFBhdGhBcnJheSIsInBhdGhzIiwic3VicGF0aCIsInJlbGF0ZU5vcm1hbFBhdGhTZXQiLCJBcnJheSIsImZyb20iLCJjb250ZXh0Tm9ybWFsUGF0aCIsImFicyIsInJlc29sdmUiLCJzZXAiLCJjb250ZXh0Tm9ybWFsUmVxdWVzdCIsImkiLCJqIiwiX25ld2tleSIsImluZGV4T2YiLCJjb250ZXh0Tm9ybWFsTW9kdWxlSWQiLCJjb250ZXh0Tm9ybWFsTG9hZGVycyIsImNvbnRleHROb3JtYWxQYXRoQXJyYXkiLCJjb250ZXh0Tm9ybWFsUGF0aFNldCIsIlNldCIsIm1heWJlQWJzb2x1dGVQYXRoIiwidGVzdCIsInJlbGF0ZUFic29sdXRlUGF0aCIsImFic1BhdGgiLCJyZWxhdGVBYnNvbHV0ZVJlcXVlc3QiLCJhYnNSZXEiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTUEsT0FBT0MsUUFBUSxNQUFSLENBQWI7O0FBRUEsTUFBTUMsZUFBZUMsWUFBWTtBQUMvQixTQUFPQSxTQUFTQyxpQkFBaEIsRUFBbUM7QUFDakNELGVBQVdBLFNBQVNDLGlCQUFULENBQTJCRCxRQUF0QztBQUNEO0FBQ0QsU0FBT0EsUUFBUDtBQUNELENBTEQ7O0FBT0EsTUFBTUUsa0JBQW1CQyxRQUFRRCxlQUFSLEdBQTBCLFNBQVNBLGVBQVQsQ0FDakRGLFFBRGlELEVBRWpEO0FBQ0EsU0FBT0QsYUFBYUMsU0FBU0EsUUFBVCxHQUFvQkEsU0FBU0EsUUFBN0IsR0FBd0NBLFFBQXJELEVBQStESSxPQUF0RTtBQUNELENBSkQ7O0FBTUEsTUFBTUMsbUJBQW9CRixRQUFRRSxnQkFBUixHQUEyQixTQUFTQSxnQkFBVCxDQUNuREwsUUFEbUQsRUFFbkRNLEdBRm1ELEVBR25EO0FBQ0EsTUFBSSxPQUFPQSxHQUFQLEtBQWUsUUFBbkIsRUFBNkI7QUFDM0IsV0FBT0EsR0FBUDtBQUNEO0FBQ0QsTUFBSUosZ0JBQWdCRixRQUFoQixNQUE4Qk0sR0FBbEMsRUFBdUM7QUFDckMsV0FBTyxHQUFQO0FBQ0Q7QUFDRCxNQUFJQSxRQUFRLEVBQVosRUFBZ0I7QUFDZCxXQUFPQSxHQUFQO0FBQ0Q7QUFDRCxRQUFNQyxNQUFNVixLQUFLVyxRQUFMLENBQWNOLGdCQUFnQkYsUUFBaEIsQ0FBZCxFQUF5Q00sSUFBSUcsS0FBSixDQUFVLEdBQVYsRUFBZSxDQUFmLENBQXpDLENBQVo7QUFDQSxTQUFPLENBQUNGLElBQUlHLE9BQUosQ0FBWSxLQUFaLEVBQW1CLEdBQW5CLENBQUQsRUFBMEJDLE1BQTFCLENBQWlDTCxJQUFJRyxLQUFKLENBQVUsR0FBVixFQUFlRyxLQUFmLENBQXFCLENBQXJCLENBQWpDLEVBQTBEQyxJQUExRCxDQUErRCxHQUEvRCxDQUFQO0FBQ0QsQ0FmRDs7QUFpQkEsTUFBTUMsc0JBQXVCWCxRQUFRVyxtQkFBUixHQUE4QixTQUFTQSxtQkFBVCxDQUN6RGQsUUFEeUQsRUFFekRNLEdBRnlELEVBR3pEO0FBQ0EsU0FBT0EsSUFDSkcsS0FESSxDQUNFLEdBREYsRUFFSk0sR0FGSSxDQUVBQyxVQUFVWCxpQkFBaUJMLFFBQWpCLEVBQTJCZ0IsTUFBM0IsQ0FGVixFQUdKSCxJQUhJLENBR0MsR0FIRCxDQUFQO0FBSUQsQ0FSRDs7QUFVQSxNQUFNSSx1QkFBd0JkLFFBQVFjLG9CQUFSLEdBQStCLFNBQVNBLG9CQUFULENBQzNEakIsUUFEMkQsRUFFM0RrQixFQUYyRCxFQUczRDtBQUNBLFNBQU9BLEdBQUdDLFNBQUgsQ0FBYSxDQUFiLEVBQWdCLEVBQWhCLElBQXNCTCxvQkFBb0JkLFFBQXBCLEVBQThCa0IsR0FBR0MsU0FBSCxDQUFhLEVBQWIsQ0FBOUIsQ0FBN0I7QUFDRCxDQUxEOztBQU9BLE1BQU1DLHNCQUF1QmpCLFFBQVFpQixtQkFBUixHQUE4QixTQUFTQSxtQkFBVCxDQUN6RHBCLFFBRHlELEVBRXpEcUIsT0FGeUQsRUFHekQ7QUFDQSxTQUFPQSxRQUFRTixHQUFSLENBQVlPLFVBQ2pCQyxPQUFPQyxNQUFQLENBQWMsRUFBZCxFQUFrQkYsTUFBbEIsRUFBMEI7QUFDeEJBLFlBQVFqQixpQkFBaUJMLFFBQWpCLEVBQTJCc0IsT0FBT0EsTUFBbEM7QUFEZ0IsR0FBMUIsQ0FESyxDQUFQO0FBS0QsQ0FURDs7QUFXQSxNQUFNRyx3QkFBeUJ0QixRQUFRc0IscUJBQVIsR0FBZ0MsU0FBU0EscUJBQVQsQ0FDN0R6QixRQUQ2RCxFQUU3RDBCLEtBRjZELEVBRzdEO0FBQ0EsU0FBT0EsTUFBTVgsR0FBTixDQUFVWSxXQUFXdEIsaUJBQWlCTCxRQUFqQixFQUEyQjJCLE9BQTNCLENBQXJCLENBQVA7QUFDRCxDQUxEOztBQU9BLE1BQU1DLHNCQUF1QnpCLFFBQVF5QixtQkFBUixHQUE4QixTQUFTQSxtQkFBVCxDQUN6RDVCLFFBRHlELEVBRXpEMEIsS0FGeUQsRUFHekQ7QUFDQSxTQUFPRCxzQkFBc0J6QixRQUF0QixFQUFnQzZCLE1BQU1DLElBQU4sQ0FBV0osS0FBWCxDQUFoQyxDQUFQO0FBQ0QsQ0FMRDs7QUFPQTs7OztBQUlBLE1BQU1LLG9CQUFxQjVCLFFBQVE0QixpQkFBUixHQUE0QixTQUFTQSxpQkFBVCxDQUNyRC9CLFFBRHFELEVBRXJETSxHQUZxRCxFQUdyRDtBQUNBLE1BQUksT0FBT0EsR0FBUCxLQUFlLFFBQW5CLEVBQTZCO0FBQzNCLFdBQU9BLEdBQVA7QUFDRDtBQUNELE1BQUlBLFFBQVEsR0FBWixFQUFpQjtBQUNmLFdBQU9KLGdCQUFnQkYsUUFBaEIsQ0FBUDtBQUNEO0FBQ0QsTUFBSU0sUUFBUSxFQUFaLEVBQWdCO0FBQ2QsV0FBTyxFQUFQO0FBQ0Q7QUFDRCxRQUFNMEIsTUFBTW5DLEtBQUtvQyxPQUFMLENBQWEvQixnQkFBZ0JGLFFBQWhCLENBQWIsRUFBd0NNLElBQUlHLEtBQUosQ0FBVSxHQUFWLEVBQWUsQ0FBZixDQUF4QyxDQUFaO0FBQ0EsU0FBTyxDQUFDdUIsSUFBSXRCLE9BQUosQ0FBWSxLQUFaLEVBQW1CYixLQUFLcUMsR0FBeEIsQ0FBRCxFQUNKdkIsTUFESSxDQUNHTCxJQUFJRyxLQUFKLENBQVUsR0FBVixFQUFlRyxLQUFmLENBQXFCLENBQXJCLENBREgsRUFFSkMsSUFGSSxDQUVDLEdBRkQsQ0FBUDtBQUdELENBakJEOztBQW1CQSxNQUFNc0IsdUJBQXdCaEMsUUFBUWdDLG9CQUFSLEdBQStCLFNBQVNBLG9CQUFULENBQzNEbkMsUUFEMkQsRUFFM0RNLEdBRjJELEVBRzNEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsTUFBSThCLElBQUksQ0FBQyxDQUFUO0FBQ0EsTUFBSUMsSUFBSSxDQUFDLENBQVQ7QUFDQSxNQUFJQyxVQUFVLEVBQWQ7QUFDQSxTQUFPLENBQUNGLElBQUk5QixJQUFJaUMsT0FBSixDQUFZLEdBQVosRUFBaUJILElBQUksQ0FBckIsQ0FBTCxNQUFrQyxDQUFDLENBQTFDLEVBQTZDO0FBQzNDRSxlQUFXUCxrQkFBa0IvQixRQUFsQixFQUE0Qk0sSUFBSWEsU0FBSixDQUFja0IsSUFBSSxDQUFsQixFQUFxQkQsQ0FBckIsQ0FBNUIsQ0FBWDtBQUNBRSxlQUFXLEdBQVg7QUFDQUQsUUFBSUQsQ0FBSjtBQUNEO0FBQ0RFLGFBQVdQLGtCQUFrQi9CLFFBQWxCLEVBQTRCTSxJQUFJYSxTQUFKLENBQWNrQixJQUFJLENBQWxCLENBQTVCLENBQVg7QUFDQSxTQUFPQyxPQUFQO0FBQ0QsQ0FuQkQ7O0FBcUJBLE1BQU1FLHdCQUF5QnJDLFFBQVFxQyxxQkFBUixHQUFnQyxTQUFTQSxxQkFBVCxDQUM3RHhDLFFBRDZELEVBRTdEa0IsRUFGNkQsRUFHN0Q7QUFDQSxTQUFPQSxHQUFHQyxTQUFILENBQWEsQ0FBYixFQUFnQixFQUFoQixJQUFzQmdCLHFCQUFxQm5DLFFBQXJCLEVBQStCa0IsR0FBR0MsU0FBSCxDQUFhLEVBQWIsQ0FBL0IsQ0FBN0I7QUFDRCxDQUxEOztBQU9BLE1BQU1zQix1QkFBd0J0QyxRQUFRc0Msb0JBQVIsR0FBK0IsU0FBU0Esb0JBQVQsQ0FDM0R6QyxRQUQyRCxFQUUzRHFCLE9BRjJELEVBRzNEO0FBQ0EsU0FBT0EsUUFBUU4sR0FBUixDQUFZTyxVQUNqQkMsT0FBT0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JGLE1BQWxCLEVBQTBCO0FBQ3hCQSxZQUFRUyxrQkFBa0IvQixRQUFsQixFQUE0QnNCLE9BQU9BLE1BQW5DO0FBRGdCLEdBQTFCLENBREssQ0FBUDtBQUtELENBVEQ7O0FBV0EsTUFBTW9CLHlCQUEwQnZDLFFBQVF1QyxzQkFBUixHQUFpQyxTQUFTQSxzQkFBVCxDQUMvRDFDLFFBRCtELEVBRS9EMEIsS0FGK0QsRUFHL0Q7QUFDQSxTQUFPQSxNQUFNWCxHQUFOLENBQVVZLFdBQVdJLGtCQUFrQi9CLFFBQWxCLEVBQTRCMkIsT0FBNUIsQ0FBckIsQ0FBUDtBQUNELENBTEQ7O0FBT0EsTUFBTWdCLHVCQUF3QnhDLFFBQVF3QyxvQkFBUixHQUErQixTQUFTQSxvQkFBVCxDQUMzRDNDLFFBRDJELEVBRTNEMEIsS0FGMkQsRUFHM0Q7QUFDQSxTQUFPLElBQUlrQixHQUFKLENBQVFGLHVCQUF1QjFDLFFBQXZCLEVBQWlDMEIsS0FBakMsQ0FBUixDQUFQO0FBQ0QsQ0FMRDs7QUFPQTs7OztBQUlBLE1BQU1tQixvQkFBcUIxQyxRQUFRMEMsaUJBQVIsR0FBNEIsU0FBU0EsaUJBQVQsQ0FDckRoRCxJQURxRCxFQUVyRDtBQUNBLFNBQU8sdUJBQXNCaUQsSUFBdEIsQ0FBMkJqRCxJQUEzQjtBQUFQO0FBQ0QsQ0FKRDs7QUFNQSxNQUFNa0QscUJBQXNCNUMsUUFBUTRDLGtCQUFSLEdBQTZCLFNBQVNBLGtCQUFULENBQ3ZEM0MsT0FEdUQsRUFFdkQ0QyxPQUZ1RCxFQUd2RDtBQUNBLE1BQUlILGtCQUFrQkcsT0FBbEIsQ0FBSixFQUFnQztBQUM5QixXQUFPbkQsS0FBS1csUUFBTCxDQUFjSixPQUFkLEVBQXVCNEMsT0FBdkIsQ0FBUDtBQUNEO0FBQ0QsU0FBT0EsT0FBUDtBQUNELENBUkQ7O0FBVUEsTUFBTUMsd0JBQXlCOUMsUUFBUThDLHFCQUFSLEdBQWdDLFNBQVNBLHFCQUFULENBQzdEN0MsT0FENkQsRUFFN0Q4QyxNQUY2RCxFQUc3RDtBQUNBLFNBQU9BLE9BQ0p6QyxLQURJLENBQ0UsSUFERixFQUVKTSxHQUZJLENBRUFsQixRQUFRa0QsbUJBQW1CM0MsT0FBbkIsRUFBNEJQLElBQTVCLENBRlIsRUFHSmdCLElBSEksQ0FHQyxHQUhELENBQVA7QUFJRCxDQVJEIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi91dGlsL3JlbGF0ZS1jb250ZXh0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuY29uc3Qgcm9vdENvbXBpbGVyID0gY29tcGlsZXIgPT4ge1xuICB3aGlsZSAoY29tcGlsZXIucGFyZW50Q29tcGlsYXRpb24pIHtcbiAgICBjb21waWxlciA9IGNvbXBpbGVyLnBhcmVudENvbXBpbGF0aW9uLmNvbXBpbGVyO1xuICB9XG4gIHJldHVybiBjb21waWxlcjtcbn07XG5cbmNvbnN0IGNvbXBpbGVyQ29udGV4dCA9IChleHBvcnRzLmNvbXBpbGVyQ29udGV4dCA9IGZ1bmN0aW9uIGNvbXBpbGVyQ29udGV4dChcbiAgY29tcGlsZXIsXG4pIHtcbiAgcmV0dXJuIHJvb3RDb21waWxlcihjb21waWxlci5jb21waWxlciA/IGNvbXBpbGVyLmNvbXBpbGVyIDogY29tcGlsZXIpLmNvbnRleHQ7XG59KTtcblxuY29uc3QgcmVsYXRlTm9ybWFsUGF0aCA9IChleHBvcnRzLnJlbGF0ZU5vcm1hbFBhdGggPSBmdW5jdGlvbiByZWxhdGVOb3JtYWxQYXRoKFxuICBjb21waWxlcixcbiAga2V5LFxuKSB7XG4gIGlmICh0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBrZXk7XG4gIH1cbiAgaWYgKGNvbXBpbGVyQ29udGV4dChjb21waWxlcikgPT09IGtleSkge1xuICAgIHJldHVybiAnLic7XG4gIH1cbiAgaWYgKGtleSA9PT0gJycpIHtcbiAgICByZXR1cm4ga2V5O1xuICB9XG4gIGNvbnN0IHJlbCA9IHBhdGgucmVsYXRpdmUoY29tcGlsZXJDb250ZXh0KGNvbXBpbGVyKSwga2V5LnNwbGl0KCc/JylbMF0pO1xuICByZXR1cm4gW3JlbC5yZXBsYWNlKC9cXFxcL2csICcvJyldLmNvbmNhdChrZXkuc3BsaXQoJz8nKS5zbGljZSgxKSkuam9pbignPycpO1xufSk7XG5cbmNvbnN0IHJlbGF0ZU5vcm1hbFJlcXVlc3QgPSAoZXhwb3J0cy5yZWxhdGVOb3JtYWxSZXF1ZXN0ID0gZnVuY3Rpb24gcmVsYXRlTm9ybWFsUmVxdWVzdChcbiAgY29tcGlsZXIsXG4gIGtleSxcbikge1xuICByZXR1cm4ga2V5XG4gICAgLnNwbGl0KCchJylcbiAgICAubWFwKHN1YmtleSA9PiByZWxhdGVOb3JtYWxQYXRoKGNvbXBpbGVyLCBzdWJrZXkpKVxuICAgIC5qb2luKCchJyk7XG59KTtcblxuY29uc3QgcmVsYXRlTm9ybWFsTW9kdWxlSWQgPSAoZXhwb3J0cy5yZWxhdGVOb3JtYWxNb2R1bGVJZCA9IGZ1bmN0aW9uIHJlbGF0ZU5vcm1hbE1vZHVsZUlkKFxuICBjb21waWxlcixcbiAgaWQsXG4pIHtcbiAgcmV0dXJuIGlkLnN1YnN0cmluZygwLCAyNCkgKyByZWxhdGVOb3JtYWxSZXF1ZXN0KGNvbXBpbGVyLCBpZC5zdWJzdHJpbmcoMjQpKTtcbn0pO1xuXG5jb25zdCByZWxhdGVOb3JtYWxMb2FkZXJzID0gKGV4cG9ydHMucmVsYXRlTm9ybWFsTG9hZGVycyA9IGZ1bmN0aW9uIHJlbGF0ZU5vcm1hbExvYWRlcnMoXG4gIGNvbXBpbGVyLFxuICBsb2FkZXJzLFxuKSB7XG4gIHJldHVybiBsb2FkZXJzLm1hcChsb2FkZXIgPT5cbiAgICBPYmplY3QuYXNzaWduKHt9LCBsb2FkZXIsIHtcbiAgICAgIGxvYWRlcjogcmVsYXRlTm9ybWFsUGF0aChjb21waWxlciwgbG9hZGVyLmxvYWRlciksXG4gICAgfSksXG4gICk7XG59KTtcblxuY29uc3QgcmVsYXRlTm9ybWFsUGF0aEFycmF5ID0gKGV4cG9ydHMucmVsYXRlTm9ybWFsUGF0aEFycmF5ID0gZnVuY3Rpb24gcmVsYXRlTm9ybWFsUGF0aEFycmF5KFxuICBjb21waWxlcixcbiAgcGF0aHMsXG4pIHtcbiAgcmV0dXJuIHBhdGhzLm1hcChzdWJwYXRoID0+IHJlbGF0ZU5vcm1hbFBhdGgoY29tcGlsZXIsIHN1YnBhdGgpKTtcbn0pO1xuXG5jb25zdCByZWxhdGVOb3JtYWxQYXRoU2V0ID0gKGV4cG9ydHMucmVsYXRlTm9ybWFsUGF0aFNldCA9IGZ1bmN0aW9uIHJlbGF0ZU5vcm1hbFBhdGhTZXQoXG4gIGNvbXBpbGVyLFxuICBwYXRocyxcbikge1xuICByZXR1cm4gcmVsYXRlTm9ybWFsUGF0aEFycmF5KGNvbXBpbGVyLCBBcnJheS5mcm9tKHBhdGhzKSk7XG59KTtcblxuLyoqXG4gKlxuICovXG5cbmNvbnN0IGNvbnRleHROb3JtYWxQYXRoID0gKGV4cG9ydHMuY29udGV4dE5vcm1hbFBhdGggPSBmdW5jdGlvbiBjb250ZXh0Tm9ybWFsUGF0aChcbiAgY29tcGlsZXIsXG4gIGtleSxcbikge1xuICBpZiAodHlwZW9mIGtleSAhPT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4ga2V5O1xuICB9XG4gIGlmIChrZXkgPT09ICcuJykge1xuICAgIHJldHVybiBjb21waWxlckNvbnRleHQoY29tcGlsZXIpO1xuICB9XG4gIGlmIChrZXkgPT09ICcnKSB7XG4gICAgcmV0dXJuICcnO1xuICB9XG4gIGNvbnN0IGFicyA9IHBhdGgucmVzb2x2ZShjb21waWxlckNvbnRleHQoY29tcGlsZXIpLCBrZXkuc3BsaXQoJz8nKVswXSk7XG4gIHJldHVybiBbYWJzLnJlcGxhY2UoL1xcLy9nLCBwYXRoLnNlcCldXG4gICAgLmNvbmNhdChrZXkuc3BsaXQoJz8nKS5zbGljZSgxKSlcbiAgICAuam9pbignPycpO1xufSk7XG5cbmNvbnN0IGNvbnRleHROb3JtYWxSZXF1ZXN0ID0gKGV4cG9ydHMuY29udGV4dE5vcm1hbFJlcXVlc3QgPSBmdW5jdGlvbiBjb250ZXh0Tm9ybWFsUmVxdWVzdChcbiAgY29tcGlsZXIsXG4gIGtleSxcbikge1xuICAvLyByZXR1cm4ga2V5XG4gIC8vIC5zcGxpdCgnIScpXG4gIC8vIC5tYXAoc3Via2V5ID0+IGNvbnRleHROb3JtYWxQYXRoKGNvbXBpbGVyLCBzdWJrZXkpKVxuICAvLyAuam9pbignIScpO1xuXG4gIGxldCBpID0gLTE7XG4gIGxldCBqID0gLTE7XG4gIGxldCBfbmV3a2V5ID0gJyc7XG4gIHdoaWxlICgoaSA9IGtleS5pbmRleE9mKCchJywgaSArIDEpKSAhPT0gLTEpIHtcbiAgICBfbmV3a2V5ICs9IGNvbnRleHROb3JtYWxQYXRoKGNvbXBpbGVyLCBrZXkuc3Vic3RyaW5nKGogKyAxLCBpKSk7XG4gICAgX25ld2tleSArPSAnISc7XG4gICAgaiA9IGk7XG4gIH1cbiAgX25ld2tleSArPSBjb250ZXh0Tm9ybWFsUGF0aChjb21waWxlciwga2V5LnN1YnN0cmluZyhqICsgMSkpO1xuICByZXR1cm4gX25ld2tleTtcbn0pO1xuXG5jb25zdCBjb250ZXh0Tm9ybWFsTW9kdWxlSWQgPSAoZXhwb3J0cy5jb250ZXh0Tm9ybWFsTW9kdWxlSWQgPSBmdW5jdGlvbiBjb250ZXh0Tm9ybWFsTW9kdWxlSWQoXG4gIGNvbXBpbGVyLFxuICBpZCxcbikge1xuICByZXR1cm4gaWQuc3Vic3RyaW5nKDAsIDI0KSArIGNvbnRleHROb3JtYWxSZXF1ZXN0KGNvbXBpbGVyLCBpZC5zdWJzdHJpbmcoMjQpKTtcbn0pO1xuXG5jb25zdCBjb250ZXh0Tm9ybWFsTG9hZGVycyA9IChleHBvcnRzLmNvbnRleHROb3JtYWxMb2FkZXJzID0gZnVuY3Rpb24gY29udGV4dE5vcm1hbExvYWRlcnMoXG4gIGNvbXBpbGVyLFxuICBsb2FkZXJzLFxuKSB7XG4gIHJldHVybiBsb2FkZXJzLm1hcChsb2FkZXIgPT5cbiAgICBPYmplY3QuYXNzaWduKHt9LCBsb2FkZXIsIHtcbiAgICAgIGxvYWRlcjogY29udGV4dE5vcm1hbFBhdGgoY29tcGlsZXIsIGxvYWRlci5sb2FkZXIpLFxuICAgIH0pLFxuICApO1xufSk7XG5cbmNvbnN0IGNvbnRleHROb3JtYWxQYXRoQXJyYXkgPSAoZXhwb3J0cy5jb250ZXh0Tm9ybWFsUGF0aEFycmF5ID0gZnVuY3Rpb24gY29udGV4dE5vcm1hbFBhdGhBcnJheShcbiAgY29tcGlsZXIsXG4gIHBhdGhzLFxuKSB7XG4gIHJldHVybiBwYXRocy5tYXAoc3VicGF0aCA9PiBjb250ZXh0Tm9ybWFsUGF0aChjb21waWxlciwgc3VicGF0aCkpO1xufSk7XG5cbmNvbnN0IGNvbnRleHROb3JtYWxQYXRoU2V0ID0gKGV4cG9ydHMuY29udGV4dE5vcm1hbFBhdGhTZXQgPSBmdW5jdGlvbiBjb250ZXh0Tm9ybWFsUGF0aFNldChcbiAgY29tcGlsZXIsXG4gIHBhdGhzLFxuKSB7XG4gIHJldHVybiBuZXcgU2V0KGNvbnRleHROb3JtYWxQYXRoQXJyYXkoY29tcGlsZXIsIHBhdGhzKSk7XG59KTtcblxuLyoqXG4gKlxuICovXG5cbmNvbnN0IG1heWJlQWJzb2x1dGVQYXRoID0gKGV4cG9ydHMubWF5YmVBYnNvbHV0ZVBhdGggPSBmdW5jdGlvbiBtYXliZUFic29sdXRlUGF0aChcbiAgcGF0aCxcbikge1xuICByZXR1cm4gL14oW2EtekEtWl06XFxcXFxcXFx8XFwvKS8udGVzdChwYXRoKTtcbn0pO1xuXG5jb25zdCByZWxhdGVBYnNvbHV0ZVBhdGggPSAoZXhwb3J0cy5yZWxhdGVBYnNvbHV0ZVBhdGggPSBmdW5jdGlvbiByZWxhdGVBYnNvbHV0ZVBhdGgoXG4gIGNvbnRleHQsXG4gIGFic1BhdGgsXG4pIHtcbiAgaWYgKG1heWJlQWJzb2x1dGVQYXRoKGFic1BhdGgpKSB7XG4gICAgcmV0dXJuIHBhdGgucmVsYXRpdmUoY29udGV4dCwgYWJzUGF0aCk7XG4gIH1cbiAgcmV0dXJuIGFic1BhdGg7XG59KTtcblxuY29uc3QgcmVsYXRlQWJzb2x1dGVSZXF1ZXN0ID0gKGV4cG9ydHMucmVsYXRlQWJzb2x1dGVSZXF1ZXN0ID0gZnVuY3Rpb24gcmVsYXRlQWJzb2x1dGVSZXF1ZXN0KFxuICBjb250ZXh0LFxuICBhYnNSZXEsXG4pIHtcbiAgcmV0dXJuIGFic1JlcVxuICAgIC5zcGxpdCgvIS9nKVxuICAgIC5tYXAocGF0aCA9PiByZWxhdGVBYnNvbHV0ZVBhdGgoY29udGV4dCwgcGF0aCkpXG4gICAgLmpvaW4oJyEnKTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvVXNlcnMvdHlsZXJhcmJ1cy9kZXYvcHJvdmlkZXIvc3JjIn0=
