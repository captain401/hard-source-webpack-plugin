'use strict';

require('source-map-support/register');

const path = require('path');

const rootCompiler = compiler => {
  while (compiler.parentCompilation) {
    compiler = compiler.parentCompilation.compiler;
  }
  return compiler;
};

const compilerContext = exports.compilerContext = function compilerContext(compiler) {
  return rootCompiler(compiler.compiler ? compiler.compiler : compiler).context;
};

const relateNormalPath = exports.relateNormalPath = function relateNormalPath(compiler, key) {
  if (typeof key !== 'string') {
    return key;
  }
  if (compilerContext(compiler) === key) {
    return '.';
  }
  if (key === '') {
    return key;
  }
  return path.relative(compilerContext(compiler), key).replace(/\\/g, '/');
};

const relateNormalRequest = exports.relateNormalRequest = function relateNormalRequest(compiler, key) {
  return key.split('!').map(subkey => relateNormalPath(compiler, subkey)).join('!');
};

const relateNormalModuleId = exports.relateNormalModuleId = function relateNormalModuleId(compiler, id) {
  return id.substring(0, 24) + relateNormalRequest(compiler, id.substring(24));
};

const relateNormalLoaders = exports.relateNormalLoaders = function relateNormalLoaders(compiler, loaders) {
  return loaders.map(loader => Object.assign({}, loader, {
    loader: relateNormalPath(compiler, loader.loader)
  }));
};

const relateNormalPathArray = exports.relateNormalPathArray = function relateNormalPathArray(compiler, paths) {
  return paths.map(subpath => relateNormalPath(compiler, subpath));
};

const relateNormalPathSet = exports.relateNormalPathSet = function relateNormalPathSet(compiler, paths) {
  return relateNormalPathArray(compiler, Array.from(paths));
};

/**
 *
 */

const contextNormalPath = exports.contextNormalPath = function contextNormalPath(compiler, key) {
  if (typeof key !== 'string') {
    return key;
  }
  if (key === '.') {
    return compilerContext(compiler);
  }
  if (key === '') {
    return '';
  }
  return path.resolve(compilerContext(compiler), key).replace(/\//g, path.sep);
};

const contextNormalRequest = exports.contextNormalRequest = function contextNormalRequest(compiler, key) {
  // return key
  // .split('!')
  // .map(subkey => contextNormalPath(compiler, subkey))
  // .join('!');

  let i = -1;
  let j = -1;
  let _newkey = '';
  while ((i = key.indexOf('!', i + 1)) !== -1) {
    _newkey += contextNormalPath(compiler, key.substring(j + 1, i));
    _newkey += '!';
    j = i;
  }
  _newkey += contextNormalPath(compiler, key.substring(j + 1));
  return _newkey;
};

const contextNormalModuleId = exports.contextNormalModuleId = function contextNormalModuleId(compiler, id) {
  return id.substring(0, 24) + contextNormalRequest(compiler, id.substring(24));
};

const contextNormalLoaders = exports.contextNormalLoaders = function contextNormalLoaders(compiler, loaders) {
  return loaders.map(loader => Object.assign({}, loader, {
    loader: contextNormalPath(compiler, loader.loader)
  }));
};

const contextNormalPathArray = exports.contextNormalPathArray = function contextNormalPathArray(compiler, paths) {
  return paths.map(subpath => contextNormalPath(compiler, subpath));
};

const contextNormalPathSet = exports.contextNormalPathSet = function contextNormalPathSet(compiler, paths) {
  return new Set(contextNormalPathArray(compiler, paths));
};

/**
 *
 */

const maybeAbsolutePath = exports.maybeAbsolutePath = function maybeAbsolutePath(path) {
  return (/^([a-zA-Z]:\\\\|\/)/.test(path)
  );
};

const relateAbsolutePath = exports.relateAbsolutePath = function relateAbsolutePath(context, absPath) {
  if (maybeAbsolutePath(absPath)) {
    return path.relative(context, absPath);
  }
  return absPath;
};

const relateAbsoluteRequest = exports.relateAbsoluteRequest = function relateAbsoluteRequest(context, absReq) {
  return absReq.split(/!/g).map(path => relateAbsolutePath(context, path)).join('!');
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi91dGlsL3JlbGF0ZS1jb250ZXh0LmpzIl0sIm5hbWVzIjpbInBhdGgiLCJyZXF1aXJlIiwicm9vdENvbXBpbGVyIiwiY29tcGlsZXIiLCJwYXJlbnRDb21waWxhdGlvbiIsImNvbXBpbGVyQ29udGV4dCIsImV4cG9ydHMiLCJjb250ZXh0IiwicmVsYXRlTm9ybWFsUGF0aCIsImtleSIsInJlbGF0aXZlIiwicmVwbGFjZSIsInJlbGF0ZU5vcm1hbFJlcXVlc3QiLCJzcGxpdCIsIm1hcCIsInN1YmtleSIsImpvaW4iLCJyZWxhdGVOb3JtYWxNb2R1bGVJZCIsImlkIiwic3Vic3RyaW5nIiwicmVsYXRlTm9ybWFsTG9hZGVycyIsImxvYWRlcnMiLCJsb2FkZXIiLCJPYmplY3QiLCJhc3NpZ24iLCJyZWxhdGVOb3JtYWxQYXRoQXJyYXkiLCJwYXRocyIsInN1YnBhdGgiLCJyZWxhdGVOb3JtYWxQYXRoU2V0IiwiQXJyYXkiLCJmcm9tIiwiY29udGV4dE5vcm1hbFBhdGgiLCJyZXNvbHZlIiwic2VwIiwiY29udGV4dE5vcm1hbFJlcXVlc3QiLCJpIiwiaiIsIl9uZXdrZXkiLCJpbmRleE9mIiwiY29udGV4dE5vcm1hbE1vZHVsZUlkIiwiY29udGV4dE5vcm1hbExvYWRlcnMiLCJjb250ZXh0Tm9ybWFsUGF0aEFycmF5IiwiY29udGV4dE5vcm1hbFBhdGhTZXQiLCJTZXQiLCJtYXliZUFic29sdXRlUGF0aCIsInRlc3QiLCJyZWxhdGVBYnNvbHV0ZVBhdGgiLCJhYnNQYXRoIiwicmVsYXRlQWJzb2x1dGVSZXF1ZXN0IiwiYWJzUmVxIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsT0FBT0MsUUFBUSxNQUFSLENBQWI7O0FBRUEsTUFBTUMsZUFBZUMsWUFBWTtBQUMvQixTQUFPQSxTQUFTQyxpQkFBaEIsRUFBbUM7QUFDakNELGVBQVdBLFNBQVNDLGlCQUFULENBQTJCRCxRQUF0QztBQUNEO0FBQ0QsU0FB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QUNBLFNBQU9BLE9BQ0pwQyxLQURJLENBQ0UsSUFERixFQUVKQyxHQUZJLENBRUFkLFFBQVE4QyxtQkFBbUJ2QyxPQUFuQixFQUE0QlAsSUFBNUIsQ0FGUixFQUdKZ0IsSUFISSxDQUdDLEdBSEQsQ0FBUDtBQUlELENBUkQiLCJmaWxlIjoiaGFyZC1zb3VyY2Utd2VicGFjay1wbHVnaW4vbGliL3V0aWwvcmVsYXRlLWNvbnRleHQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXG5jb25zdCByb290Q29tcGlsZXIgPSBjb21waWxlciA9PiB7XG4gIHdoaWxlIChjb21waWxlci5wYXJlbnRDb21waWxhdGlvbikge1xuICAgIGNvbXBpbGVyID0gY29tcGlsZXIucGFyZW50Q29tcGlsYXRpb24uY29tcGlsZXI7XG4gIH1cbiAgcmV0dXJuIGNvbXBpbGVyO1xufTtcblxuY29uc3QgY29tcGlsZXJDb250ZXh0ID0gKGV4cG9ydHMuY29tcGlsZXJDb250ZXh0ID0gZnVuY3Rpb24gY29tcGlsZXJDb250ZXh0KFxuICBjb21waWxlcixcbikge1xuICByZXR1cm4gcm9vdENvbXBpbGVyKGNvbXBpbGVyLmNvbXBpbGVyID8gY29tcGlsZXIuY29tcGlsZXIgOiBjb21waWxlcikuY29udGV4dDtcbn0pO1xuXG5jb25zdCByZWxhdGVOb3JtYWxQYXRoID0gKGV4cG9ydHMucmVsYXRlTm9ybWFsUGF0aCA9IGZ1bmN0aW9uIHJlbGF0ZU5vcm1hbFBhdGgoXG4gIGNvbXBpbGVyLFxuICBrZXksXG4pIHtcbiAgaWYgKHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIGtleTtcbiAgfVxuICBpZiAoY29tcGlsZXJDb250ZXh0KGNvbXBpbGVyKSA9PT0ga2V5KSB7XG4gICAgcmV0dXJuICcuJztcbiAgfVxuICBpZiAoa2V5ID09PSAnJykge1xuICAgIHJldHVybiBrZXk7XG4gIH1cbiAgcmV0dXJuIHBhdGgucmVsYXRpdmUoY29tcGlsZXJDb250ZXh0KGNvbXBpbGVyKSwga2V5KS5yZXBsYWNlKC9cXFxcL2csICcvJyk7XG59KTtcblxuY29uc3QgcmVsYXRlTm9ybWFsUmVxdWVzdCA9IChleHBvcnRzLnJlbGF0ZU5vcm1hbFJlcXVlc3QgPSBmdW5jdGlvbiByZWxhdGVOb3JtYWxSZXF1ZXN0KFxuICBjb21waWxlcixcbiAga2V5LFxuKSB7XG4gIHJldHVybiBrZXlcbiAgICAuc3BsaXQoJyEnKVxuICAgIC5tYXAoc3Via2V5ID0+IHJlbGF0ZU5vcm1hbFBhdGgoY29tcGlsZXIsIHN1YmtleSkpXG4gICAgLmpvaW4oJyEnKTtcbn0pO1xuXG5jb25zdCByZWxhdGVOb3JtYWxNb2R1bGVJZCA9IChleHBvcnRzLnJlbGF0ZU5vcm1hbE1vZHVsZUlkID0gZnVuY3Rpb24gcmVsYXRlTm9ybWFsTW9kdWxlSWQoXG4gIGNvbXBpbGVyLFxuICBpZCxcbikge1xuICByZXR1cm4gaWQuc3Vic3RyaW5nKDAsIDI0KSArIHJlbGF0ZU5vcm1hbFJlcXVlc3QoY29tcGlsZXIsIGlkLnN1YnN0cmluZygyNCkpO1xufSk7XG5cbmNvbnN0IHJlbGF0ZU5vcm1hbExvYWRlcnMgPSAoZXhwb3J0cy5yZWxhdGVOb3JtYWxMb2FkZXJzID0gZnVuY3Rpb24gcmVsYXRlTm9ybWFsTG9hZGVycyhcbiAgY29tcGlsZXIsXG4gIGxvYWRlcnMsXG4pIHtcbiAgcmV0dXJuIGxvYWRlcnMubWFwKGxvYWRlciA9PlxuICAgIE9iamVjdC5hc3NpZ24oe30sIGxvYWRlciwge1xuICAgICAgbG9hZGVyOiByZWxhdGVOb3JtYWxQYXRoKGNvbXBpbGVyLCBsb2FkZXIubG9hZGVyKSxcbiAgICB9KSxcbiAgKTtcbn0pO1xuXG5jb25zdCByZWxhdGVOb3JtYWxQYXRoQXJyYXkgPSAoZXhwb3J0cy5yZWxhdGVOb3JtYWxQYXRoQXJyYXkgPSBmdW5jdGlvbiByZWxhdGVOb3JtYWxQYXRoQXJyYXkoXG4gIGNvbXBpbGVyLFxuICBwYXRocyxcbikge1xuICByZXR1cm4gcGF0aHMubWFwKHN1YnBhdGggPT4gcmVsYXRlTm9ybWFsUGF0aChjb21waWxlciwgc3VicGF0aCkpO1xufSk7XG5cbmNvbnN0IHJlbGF0ZU5vcm1hbFBhdGhTZXQgPSAoZXhwb3J0cy5yZWxhdGVOb3JtYWxQYXRoU2V0ID0gZnVuY3Rpb24gcmVsYXRlTm9ybWFsUGF0aFNldChcbiAgY29tcGlsZXIsXG4gIHBhdGhzLFxuKSB7XG4gIHJldHVybiByZWxhdGVOb3JtYWxQYXRoQXJyYXkoY29tcGlsZXIsIEFycmF5LmZyb20ocGF0aHMpKTtcbn0pO1xuXG4vKipcbiAqXG4gKi9cblxuY29uc3QgY29udGV4dE5vcm1hbFBhdGggPSAoZXhwb3J0cy5jb250ZXh0Tm9ybWFsUGF0aCA9IGZ1bmN0aW9uIGNvbnRleHROb3JtYWxQYXRoKFxuICBjb21waWxlcixcbiAga2V5LFxuKSB7XG4gIGlmICh0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBrZXk7XG4gIH1cbiAgaWYgKGtleSA9PT0gJy4nKSB7XG4gICAgcmV0dXJuIGNvbXBpbGVyQ29udGV4dChjb21waWxlcik7XG4gIH1cbiAgaWYgKGtleSA9PT0gJycpIHtcbiAgICByZXR1cm4gJyc7XG4gIH1cbiAgcmV0dXJuIHBhdGgucmVzb2x2ZShjb21waWxlckNvbnRleHQoY29tcGlsZXIpLCBrZXkpLnJlcGxhY2UoL1xcLy9nLCBwYXRoLnNlcCk7XG59KTtcblxuY29uc3QgY29udGV4dE5vcm1hbFJlcXVlc3QgPSAoZXhwb3J0cy5jb250ZXh0Tm9ybWFsUmVxdWVzdCA9IGZ1bmN0aW9uIGNvbnRleHROb3JtYWxSZXF1ZXN0KFxuICBjb21waWxlcixcbiAga2V5LFxuKSB7XG4gIC8vIHJldHVybiBrZXlcbiAgLy8gLnNwbGl0KCchJylcbiAgLy8gLm1hcChzdWJrZXkgPT4gY29udGV4dE5vcm1hbFBhdGgoY29tcGlsZXIsIHN1YmtleSkpXG4gIC8vIC5qb2luKCchJyk7XG5cbiAgbGV0IGkgPSAtMTtcbiAgbGV0IGogPSAtMTtcbiAgbGV0IF9uZXdrZXkgPSAnJztcbiAgd2hpbGUgKChpID0ga2V5LmluZGV4T2YoJyEnLCBpICsgMSkpICE9PSAtMSkge1xuICAgIF9uZXdrZXkgKz0gY29udGV4dE5vcm1hbFBhdGgoY29tcGlsZXIsIGtleS5zdWJzdHJpbmcoaiArIDEsIGkpKTtcbiAgICBfbmV3a2V5ICs9ICchJztcbiAgICBqID0gaTtcbiAgfVxuICBfbmV3a2V5ICs9IGNvbnRleHROb3JtYWxQYXRoKGNvbXBpbGVyLCBrZXkuc3Vic3RyaW5nKGogKyAxKSk7XG4gIHJldHVybiBfbmV3a2V5O1xufSk7XG5cbmNvbnN0IGNvbnRleHROb3JtYWxNb2R1bGVJZCA9IChleHBvcnRzLmNvbnRleHROb3JtYWxNb2R1bGVJZCA9IGZ1bmN0aW9uIGNvbnRleHROb3JtYWxNb2R1bGVJZChcbiAgY29tcGlsZXIsXG4gIGlkLFxuKSB7XG4gIHJldHVybiBpZC5zdWJzdHJpbmcoMCwgMjQpICsgY29udGV4dE5vcm1hbFJlcXVlc3QoY29tcGlsZXIsIGlkLnN1YnN0cmluZygyNCkpO1xufSk7XG5cbmNvbnN0IGNvbnRleHROb3JtYWxMb2FkZXJzID0gKGV4cG9ydHMuY29udGV4dE5vcm1hbExvYWRlcnMgPSBmdW5jdGlvbiBjb250ZXh0Tm9ybWFsTG9hZGVycyhcbiAgY29tcGlsZXIsXG4gIGxvYWRlcnMsXG4pIHtcbiAgcmV0dXJuIGxvYWRlcnMubWFwKGxvYWRlciA9PlxuICAgIE9iamVjdC5hc3NpZ24oe30sIGxvYWRlciwge1xuICAgICAgbG9hZGVyOiBjb250ZXh0Tm9ybWFsUGF0aChjb21waWxlciwgbG9hZGVyLmxvYWRlciksXG4gICAgfSksXG4gICk7XG59KTtcblxuY29uc3QgY29udGV4dE5vcm1hbFBhdGhBcnJheSA9IChleHBvcnRzLmNvbnRleHROb3JtYWxQYXRoQXJyYXkgPSBmdW5jdGlvbiBjb250ZXh0Tm9ybWFsUGF0aEFycmF5KFxuICBjb21waWxlcixcbiAgcGF0aHMsXG4pIHtcbiAgcmV0dXJuIHBhdGhzLm1hcChzdWJwYXRoID0+IGNvbnRleHROb3JtYWxQYXRoKGNvbXBpbGVyLCBzdWJwYXRoKSk7XG59KTtcblxuY29uc3QgY29udGV4dE5vcm1hbFBhdGhTZXQgPSAoZXhwb3J0cy5jb250ZXh0Tm9ybWFsUGF0aFNldCA9IGZ1bmN0aW9uIGNvbnRleHROb3JtYWxQYXRoU2V0KFxuICBjb21waWxlcixcbiAgcGF0aHMsXG4pIHtcbiAgcmV0dXJuIG5ldyBTZXQoY29udGV4dE5vcm1hbFBhdGhBcnJheShjb21waWxlciwgcGF0aHMpKTtcbn0pO1xuXG4vKipcbiAqXG4gKi9cblxuY29uc3QgbWF5YmVBYnNvbHV0ZVBhdGggPSAoZXhwb3J0cy5tYXliZUFic29sdXRlUGF0aCA9IGZ1bmN0aW9uIG1heWJlQWJzb2x1dGVQYXRoKFxuICBwYXRoLFxuKSB7XG4gIHJldHVybiAvXihbYS16QS1aXTpcXFxcXFxcXHxcXC8pLy50ZXN0KHBhdGgpO1xufSk7XG5cbmNvbnN0IHJlbGF0ZUFic29sdXRlUGF0aCA9IChleHBvcnRzLnJlbGF0ZUFic29sdXRlUGF0aCA9IGZ1bmN0aW9uIHJlbGF0ZUFic29sdXRlUGF0aChcbiAgY29udGV4dCxcbiAgYWJzUGF0aCxcbikge1xuICBpZiAobWF5YmVBYnNvbHV0ZVBhdGgoYWJzUGF0aCkpIHtcbiAgICByZXR1cm4gcGF0aC5yZWxhdGl2ZShjb250ZXh0LCBhYnNQYXRoKTtcbiAgfVxuICByZXR1cm4gYWJzUGF0aDtcbn0pO1xuXG5jb25zdCByZWxhdGVBYnNvbHV0ZVJlcXVlc3QgPSAoZXhwb3J0cy5yZWxhdGVBYnNvbHV0ZVJlcXVlc3QgPSBmdW5jdGlvbiByZWxhdGVBYnNvbHV0ZVJlcXVlc3QoXG4gIGNvbnRleHQsXG4gIGFic1JlcSxcbikge1xuICByZXR1cm4gYWJzUmVxXG4gICAgLnNwbGl0KC8hL2cpXG4gICAgLm1hcChwYXRoID0+IHJlbGF0ZUFic29sdXRlUGF0aChjb250ZXh0LCBwYXRoKSlcbiAgICAuam9pbignIScpO1xufSk7XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
