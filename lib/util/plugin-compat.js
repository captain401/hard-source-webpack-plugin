'use strict';

let hookTypes;

const callStyles = {
  sync: 'applyPlugins',
  syncWaterfall: 'applyPluginsWaterfall',
  syncBail: 'applyPluginsBailResult',
  sync_map: 'applyPlugins',
  asyncWaterfall: 'applyPluginsAsyncWaterfall',
  asyncParallel: 'applyPluginsParallel',
  asyncSerial: 'applyPluginsAsync'
};

const camelToDash = camel => camel.replace(/_/g, '--').replace(/[A-Z]/g, c => `-${c.toLowerCase()}`);

const knownPluginRegistrations = {
  Compilation: {
    needAdditionalPass: ['sync', []],
    succeedModule: ['sync', ['module']],
    buildModule: ['sync', ['module']],
    seal: ['sync', []]
  },
  Compiler: {
    afterCompile: ['asyncSerial', ['compilation']],
    afterEnvironment: ['sync', []],
    afterPlugins: ['sync', []],
    afterResolvers: ['sync', []],
    compilation: ['sync', ['compilation', 'params']],
    emit: ['asyncSerial', ['compilation']],
    make: ['asyncParallel', ['compilation']],
    watchRun: ['asyncSerial', ['watcher']],
    run: ['asyncSerial', ['compiler']]
  },
  NormalModuleFactory: {
    createModule: ['syncBail', ['data']],
    parser: ['sync_map', ['parser', 'parserOptions']],
    resolver: ['syncWaterfall', ['nextResolver']]
  },
  ContextModuleFactory: {
    afterResolve: ['asyncWaterfall', ['data']]
  }
};

exports.register = (tapable, name, style, args) => {
  if (tapable.hooks) {
    if (!hookTypes) {
      const Tapable = require('tapable');
      hookTypes = {
        sync: Tapable.SyncHook,
        syncWaterfall: Tapable.SyncWaterfallHook,
        syncBail: Tapable.SyncBailHook,
        asyncWaterfall: Tapable.AsyncWaterfallHook,
        asyncParallel: Tapable.AsyncParallelHook,
        asyncSerial: Tapable.AsyncSeriesHook,
        asyncSeries: Tapable.AsyncSeriesHook
      };
    }
    if (!tapable.hooks[name]) {
      tapable.hooks[name] = new hookTypes[style](args);
    }
  } else {
    if (!tapable.__hardSource_hooks) {
      tapable.__hardSource_hooks = {};
    }
    if (!tapable.__hardSource_hooks[name]) {
      tapable.__hardSource_hooks[name] = {
        name,
        dashName: camelToDash(name),
        style,
        args,
        async: style.startsWith('async'),
        map: style.endsWith('_map')
      };
    }
    if (!tapable.__hardSource_proxy) {
      tapable.__hardSource_proxy = {};
    }
    if (!tapable.__hardSource_proxy[name]) {
      if (tapable.__hardSource_hooks[name].map) {
        const _forCache = {};
        tapable.__hardSource_proxy[name] = {
          _forCache,
          for: key => {
            let hook = _forCache[key];
            if (hook) {
              return hook;
            }
            _forCache[key] = {
              tap: (...args) => exports.tapFor(tapable, name, key, ...args),
              tapPromise: (...args) => exports.tapPromiseFor(tapable, name, key, ...args),
              call: (...args) => exports.callFor(tapable, name, key, ...args),
              promise: (...args) => exports.promiseFor(tapable, name, key, ...args)
            };
            return _forCache[key];
          },
          tap: (...args) => exports.tapFor(tapable, name, ...args),
          tapPromise: (...args) => exports.tapPromiseFor(tapable, name, ...args),
          call: (...args) => exports.callFor(tapable, name, ...args),
          promise: (...args) => exports.promiseFor(tapable, name, ...args)
        };
      } else {
        tapable.__hardSource_proxy[name] = {
          tap: (...args) => exports.tap(tapable, name, ...args),
          tapPromise: (...args) => exports.tapPromise(tapable, name, ...args),
          call: (...args) => exports.call(tapable, name, args),
          promise: (...args) => exports.promise(tapable, name, args)
        };
      }
    }
  }
};

exports.tap = (tapable, name, reason, callback) => {
  if (tapable.hooks) {
    tapable.hooks[name].tap(reason, callback);
  } else {
    if (!tapable.__hardSource_hooks || !tapable.__hardSource_hooks[name]) {
      const registration = knownPluginRegistrations[tapable.constructor.name][name];
      exports.register(tapable, name, registration[0], registration[1]);
    }
    const dashName = tapable.__hardSource_hooks[name].dashName;
    if (tapable.__hardSource_hooks[name].async) {
      tapable.plugin(dashName, (...args) => {
        const cb = args.pop();
        cb(null, callback(...args));
      });
    } else {
      tapable.plugin(dashName, callback);
    }
  }
};

exports.tapPromise = (tapable, name, reason, callback) => {
  if (tapable.hooks) {
    tapable.hooks[name].tapPromise(reason, callback);
  } else {
    if (!tapable.__hardSource_hooks || !tapable.__hardSource_hooks[name]) {
      const registration = knownPluginRegistrations[tapable.constructor.name][name];
      exports.register(tapable, name, registration[0], registration[1]);
    }
    const dashName = tapable.__hardSource_hooks[name].dashName;
    tapable.plugin(dashName, (...args) => {
      const cb = args.pop();
      return callback(...args).then(value => cb(null, value), cb);
    });
  }
};

exports.tapAsync = (tapable, name, reason, callback) => {
  if (tapable.hooks) {
    tapable.hooks[name].tapAsync(reason, callback);
  } else {
    if (!tapable.__hardSource_hooks || !tapable.__hardSource_hooks[name]) {
      const registration = knownPluginRegistrations[tapable.constructor.name][name];
      exports.register(tapable, name, registration[0], registration[1]);
    }
    const dashName = tapable.__hardSource_hooks[name].dashName;
    tapable.plugin(dashName, callback);
  }
};

exports.call = (tapable, name, args) => {
  if (tapable.hooks) {
    const hook = tapable.hooks[name];
    return hook.call(...args);
  } else {
    const dashName = tapable.__hardSource_hooks[name].dashName;
    const style = tapable.__hardSource_hooks[name].style;
    return tapable[callStyles[style]](...[dashName].concat(args));
  }
};

exports.promise = (tapable, name, args) => {
  if (tapable.hooks) {
    const hook = tapable.hooks[name];
    return hook.promise(...args);
  } else {
    const dashName = tapable.__hardSource_hooks[name].dashName;
    const style = tapable.__hardSource_hooks[name].style;
    return new Promise((resolve, reject) => {
      tapable[callStyles[style]](...[dashName].concat(args, (err, value) => {
        if (err) {
          reject(err);
        } else {
          resolve(value);
        }
      }));
    });
  }
};

exports.tapFor = (tapable, name, key, reason, callback) => {
  if (tapable.hooks) {
    tapable.hooks[name].for(key).tap(reason, callback);
  } else {
    exports.tap(tapable, name, reason, callback);
  }
};

exports.tapPromiseFor = (tapable, name, key, reason, callback) => {
  if (tapable.hooks) {
    tapable.hooks[name].for(key).tapPromise(reason, callback);
  } else {
    exports.tapPromise(tapable, name, reason, callback);
  }
};

exports.callFor = (tapable, name, key, args) => {
  if (tapable.hooks) {
    tapable.hooks[name].for(key).call(...args);
  } else {
    exports.call(tapable, name, args);
  }
};

exports.promiseFor = (tapable, name, key, args) => {
  if (tapable.hooks) {
    tapable.hooks[name].for(key).promise(...args);
  } else {
    exports.promise(tapable, name, args);
  }
};

exports.hooks = tapable => {
  if (tapable.hooks) {
    return tapable.hooks;
  }
  if (!tapable.__hardSource_proxy) {
    tapable.__hardSource_proxy = {};
  }
  const registrations = knownPluginRegistrations[tapable.constructor.name];
  if (registrations) {
    for (const name in registrations) {
      const registration = registrations[name];
      exports.register(tapable, name, registration[0], registration[1]);
    }
  }
  return tapable.__hardSource_proxy;
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi91dGlsL3BsdWdpbi1jb21wYXQuanMiXSwibmFtZXMiOlsiaG9va1R5cGVzIiwiY2FsbFN0eWxlcyIsInN5bmMiLCJzeW5jV2F0ZXJmYWxsIiwic3luY0JhaWwiLCJzeW5jX21hcCIsImFzeW5jV2F0ZXJmYWxsIiwiYXN5bmNQYXJhbGxlbCIsImFzeW5jU2VyaWFsIiwiY2FtZWxUb0Rhc2giLCJjYW1lbCIsInJlcGxhY2UiLCJjIiwidG9Mb3dlckNhc2UiLCJrbm93blBsdWdpblJlZ2lzdHJhdGlvbnMiLCJDb21waWxhdGlvbiIsIm5lZWRBZGRpdGlvbmFsUGFzcyIsInN1Y2NlZWRNb2R1bGUiLCJidWlsZE1vZHVsZSIsInNlYWwiLCJDb21waWxlciIsImFmdGVyQ29tcGlsZSIsImFmdGVyRW52aXJvbm1lbnQiLCJhZnRlclBsdWdpbnMiLCJhZnRlclJlc29sdmVycyIsImNvbXBpbGF0aW9uIiwiZW1pdCIsIm1ha2UiLCJ3YXRjaFJ1biIsInJ1biIsIk5vcm1hbE1vZHVsZUZhY3RvcnkiLCJjcmVhdGVNb2R1bGUiLCJwYXJzZXIiLCJyZXNvbHZlciIsIkNvbnRleHRNb2R1bGVGYWN0b3J5IiwiYWZ0ZXJSZXNvbHZlIiwiZXhwb3J0cyIsInJlZ2lzdGVyIiwidGFwYWJsZSIsIm5hbWUiLCJzdHlsZSIsImFyZ3MiLCJob29rcyIsIlRhcGFibGUiLCJyZXF1aXJlIiwiU3luY0hvb2siLCJTeW5jV2F0ZXJmYWxsSG9vayIsIlN5bmNCYWlsSG9vayIsIkFzeW5jV2F0ZXJmYWxsSG9vayIsIkFzeW5jUGFyYWxsZWxIb29rIiwiQXN5bmNTZXJpZXNIb29rIiwiYXN5bmNTZXJpZXMiLCJfX2hhcmRTb3VyY2VfaG9va3MiLCJkYXNoTmFtZSIsImFzeW5jIiwic3RhcnRzV2l0aCIsIm1hcCIsImVuZHNXaXRoIiwiX19oYXJkU291cmNlX3Byb3h5IiwiX2ZvckNhY2hlIiwiZm9yIiwia2V5IiwiaG9vayIsInRhcCIsInRhcEZvciIsInRhcFByb21pc2UiLCJ0YXBQcm9taXNlRm9yIiwiY2FsbCIsImNhbGxGb3IiLCJwcm9taXNlIiwicHJvbWlzZUZvciIsInJlYXNvbiIsImNhbGxiYWNrIiwicmVnaXN0cmF0aW9uIiwiY29uc3RydWN0b3IiLCJwbHVnaW4iLCJjYiIsInBvcCIsInRoZW4iLCJ2YWx1ZSIsInRhcEFzeW5jIiwiY29uY2F0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJlcnIiLCJyZWdpc3RyYXRpb25zIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUlBLFNBQUo7O0FBRUEsTUFBTUMsYUFBYTtBQUNqQkMsUUFBTSxjQURXO0FBRWpCQyxpQkFBZSx1QkFGRTtBQUdqQkMsWUFBVSx3QkFITztBQUlqQkMsWUFBVSxjQUpPO0FBS2pCQyxrQkFBZ0IsNEJBTEM7QUFNakJDLGlCQUFlLHNCQU5FO0FBT2pCQyxlQUFhO0FBUEksQ0FBbkI7O0FBVUEsTUFBTUMsY0FBY0MsU0FDbEJBLE1BQU1DLE9BQU4sQ0FBYyxJQUFkLEVBQW9CLElBQXBCLEVBQTBCQSxPQUExQixDQUFrQyxRQUFsQyxFQUE0Q0MsS0FBTSxJQUFHQSxFQUFFQyxXQUFGLEVBQWdCLEVBQXJFLENBREY7O0FBR0EsTUFBTUMsMkJBQTJCO0FBQy9CQyxlQUFhO0FBQ1hDLHdCQUFvQixDQUFDLE1BQUQsRUFBUyxFQUFULENBRFQ7QUFFWEMsbUJBQWUsQ0FBQyxNQUFELEVBQVMsQ0FBQyxRQUFELENBQVQsQ0FGSjtBQUdYQyxpQkFBYSxDQUFDLE1BQUQsRUFBUyxDQUFDLFFBQUQsQ0FBVCxDQUhGO0FBSVhDLFVBQU0sQ0FBQyxNQUFELEVBQVMsRUFBVDtBQUpLLEdBRGtCO0FBTy9CQyxZQUFVO0FBQ1JDLGtCQUFjLENBQUMsYUFBRCxFQUFnQixDQUFDLGFBQUQsQ0FBaEIsQ0FETjtBQUVSQyxzQkFBa0IsQ0FBQyxNQUFELEVBQVMsRUFBVCxDQUZWO0FBR1JDLGtCQUFjLENBQUMsTUFBRCxFQUFTLEVBQVQsQ0FITjtBQUlSQyxvQkFBZ0IsQ0FB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QVVDLElBQVYsRUFBZ0JzQixHQUFoQixFQUFxQnBCLElBQXJCLEtBQThCO0FBQ2pELE1BQUlILFFBQVFJLEtBQVosRUFBbUI7QUFDakJKLFlBQVFJLEtBQVIsQ0FBY0gsSUFBZCxFQUFvQnFCLEdBQXBCLENBQXdCQyxHQUF4QixFQUE2QlEsT0FBN0IsQ0FBcUMsR0FBRzVCLElBQXhDO0FBQ0QsR0FGRCxNQUVPO0FBQ0xMLFlBQVFpQyxPQUFSLENBQWdCL0IsT0FBaEIsRUFBeUJDLElBQXpCLEVBQStCRSxJQUEvQjtBQUNEO0FBQ0YsQ0FORDs7QUFRQUwsUUFBUU0sS0FBUixHQUFnQkosV0FBVztBQUN6QixNQUFJQSxRQUFRSSxLQUFaLEVBQW1CO0FBQ2pCLFdBQU9KLFFBQVFJLEtBQWY7QUFDRDtBQUNELE1BQUksQ0FBQ0osUUFBUW9CLGtCQUFiLEVBQWlDO0FBQy9CcEIsWUFBUW9CLGtCQUFSLEdBQTZCLEVBQTdCO0FBQ0Q7QUFDRCxRQUFNNEIsZ0JBQWdCeEUseUJBQXlCd0IsUUFBUW9DLFdBQVIsQ0FBb0JuQyxJQUE3QyxDQUF0QjtBQUNBLE1BQUkrQyxhQUFKLEVBQW1CO0FBQ2pCLFNBQUssTUFBTS9DLElBQVgsSUFBbUIrQyxhQUFuQixFQUFrQztBQUNoQyxZQUFNYixlQUFlYSxjQUFjL0MsSUFBZCxDQUFyQjtBQUNBSCxjQUFRQyxRQUFSLENBQWlCQyxPQUFqQixFQUEwQkMsSUFBMUIsRUFBZ0NrQyxhQUFhLENBQWIsQ0FBaEMsRUFBaURBLGFBQWEsQ0FBYixDQUFqRDtBQUNEO0FBQ0Y7QUFDRCxTQUFPbkMsUUFBUW9CLGtCQUFmO0FBQ0QsQ0FmRCIsImZpbGUiOiJoYXJkLXNvdXJjZS13ZWJwYWNrLXBsdWdpbi9saWIvdXRpbC9wbHVnaW4tY29tcGF0LmpzIiwic291cmNlc0NvbnRlbnQiOlsibGV0IGhvb2tUeXBlcztcblxuY29uc3QgY2FsbFN0eWxlcyA9IHtcbiAgc3luYzogJ2FwcGx5UGx1Z2lucycsXG4gIHN5bmNXYXRlcmZhbGw6ICdhcHBseVBsdWdpbnNXYXRlcmZhbGwnLFxuICBzeW5jQmFpbDogJ2FwcGx5UGx1Z2luc0JhaWxSZXN1bHQnLFxuICBzeW5jX21hcDogJ2FwcGx5UGx1Z2lucycsXG4gIGFzeW5jV2F0ZXJmYWxsOiAnYXBwbHlQbHVnaW5zQXN5bmNXYXRlcmZhbGwnLFxuICBhc3luY1BhcmFsbGVsOiAnYXBwbHlQbHVnaW5zUGFyYWxsZWwnLFxuICBhc3luY1NlcmlhbDogJ2FwcGx5UGx1Z2luc0FzeW5jJyxcbn07XG5cbmNvbnN0IGNhbWVsVG9EYXNoID0gY2FtZWwgPT5cbiAgY2FtZWwucmVwbGFjZSgvXy9nLCAnLS0nKS5yZXBsYWNlKC9bQS1aXS9nLCBjID0+IGAtJHtjLnRvTG93ZXJDYXNlKCl9YCk7XG5cbmNvbnN0IGtub3duUGx1Z2luUmVnaXN0cmF0aW9ucyA9IHtcbiAgQ29tcGlsYXRpb246IHtcbiAgICBuZWVkQWRkaXRpb25hbFBhc3M6IFsnc3luYycsIFtdXSxcbiAgICBzdWNjZWVkTW9kdWxlOiBbJ3N5bmMnLCBbJ21vZHVsZSddXSxcbiAgICBidWlsZE1vZHVsZTogWydzeW5jJywgWydtb2R1bGUnXV0sXG4gICAgc2VhbDogWydzeW5jJywgW11dLFxuICB9LFxuICBDb21waWxlcjoge1xuICAgIGFmdGVyQ29tcGlsZTogWydhc3luY1NlcmlhbCcsIFsnY29tcGlsYXRpb24nXV0sXG4gICAgYWZ0ZXJFbnZpcm9ubWVudDogWydzeW5jJywgW11dLFxuICAgIGFmdGVyUGx1Z2luczogWydzeW5jJywgW11dLFxuICAgIGFmdGVyUmVzb2x2ZXJzOiBbJ3N5bmMnLCBbXV0sXG4gICAgY29tcGlsYXRpb246IFsnc3luYycsIFsnY29tcGlsYXRpb24nLCAncGFyYW1zJ11dLFxuICAgIGVtaXQ6IFsnYXN5bmNTZXJpYWwnLCBbJ2NvbXBpbGF0aW9uJ11dLFxuICAgIG1ha2U6IFsnYXN5bmNQYXJhbGxlbCcsIFsnY29tcGlsYXRpb24nXV0sXG4gICAgd2F0Y2hSdW46IFsnYXN5bmNTZXJpYWwnLCBbJ3dhdGNoZXInXV0sXG4gICAgcnVuOiBbJ2FzeW5jU2VyaWFsJywgWydjb21waWxlciddXSxcbiAgfSxcbiAgTm9ybWFsTW9kdWxlRmFjdG9yeToge1xuICAgIGNyZWF0ZU1vZHVsZTogWydzeW5jQmFpbCcsIFsnZGF0YSddXSxcbiAgICBwYXJzZXI6IFsnc3luY19tYXAnLCBbJ3BhcnNlcicsICdwYXJzZXJPcHRpb25zJ11dLFxuICAgIHJlc29sdmVyOiBbJ3N5bmNXYXRlcmZhbGwnLCBbJ25leHRSZXNvbHZlciddXSxcbiAgfSxcbiAgQ29udGV4dE1vZHVsZUZhY3Rvcnk6IHtcbiAgICBhZnRlclJlc29sdmU6IFsnYXN5bmNXYXRlcmZhbGwnLCBbJ2RhdGEnXV0sXG4gIH0sXG59O1xuXG5leHBvcnRzLnJlZ2lzdGVyID0gKHRhcGFibGUsIG5hbWUsIHN0eWxlLCBhcmdzKSA9PiB7XG4gIGlmICh0YXBhYmxlLmhvb2tzKSB7XG4gICAgaWYgKCFob29rVHlwZXMpIHtcbiAgICAgIGNvbnN0IFRhcGFibGUgPSByZXF1aXJlKCd0YXBhYmxlJyk7XG4gICAgICBob29rVHlwZXMgPSB7XG4gICAgICAgIHN5bmM6IFRhcGFibGUuU3luY0hvb2ssXG4gICAgICAgIHN5bmNXYXRlcmZhbGw6IFRhcGFibGUuU3luY1dhdGVyZmFsbEhvb2ssXG4gICAgICAgIHN5bmNCYWlsOiBUYXBhYmxlLlN5bmNCYWlsSG9vayxcbiAgICAgICAgYXN5bmNXYXRlcmZhbGw6IFRhcGFibGUuQXN5bmNXYXRlcmZhbGxIb29rLFxuICAgICAgICBhc3luY1BhcmFsbGVsOiBUYXBhYmxlLkFzeW5jUGFyYWxsZWxIb29rLFxuICAgICAgICBhc3luY1NlcmlhbDogVGFwYWJsZS5Bc3luY1Nlcmllc0hvb2ssXG4gICAgICAgIGFzeW5jU2VyaWVzOiBUYXBhYmxlLkFzeW5jU2VyaWVzSG9vayxcbiAgICAgIH07XG4gICAgfVxuICAgIGlmICghdGFwYWJsZS5ob29rc1tuYW1lXSkge1xuICAgICAgdGFwYWJsZS5ob29rc1tuYW1lXSA9IG5ldyBob29rVHlwZXNbc3R5bGVdKGFyZ3MpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAoIXRhcGFibGUuX19oYXJkU291cmNlX2hvb2tzKSB7XG4gICAgICB0YXBhYmxlLl9faGFyZFNvdXJjZV9ob29rcyA9IHt9O1xuICAgIH1cbiAgICBpZiAoIXRhcGFibGUuX19oYXJkU291cmNlX2hvb2tzW25hbWVdKSB7XG4gICAgICB0YXBhYmxlLl9faGFyZFNvdXJjZV9ob29rc1tuYW1lXSA9IHtcbiAgICAgICAgbmFtZSxcbiAgICAgICAgZGFzaE5hbWU6IGNhbWVsVG9EYXNoKG5hbWUpLFxuICAgICAgICBzdHlsZSxcbiAgICAgICAgYXJncyxcbiAgICAgICAgYXN5bmM6IHN0eWxlLnN0YXJ0c1dpdGgoJ2FzeW5jJyksXG4gICAgICAgIG1hcDogc3R5bGUuZW5kc1dpdGgoJ19tYXAnKSxcbiAgICAgIH07XG4gICAgfVxuICAgIGlmICghdGFwYWJsZS5fX2hhcmRTb3VyY2VfcHJveHkpIHtcbiAgICAgIHRhcGFibGUuX19oYXJkU291cmNlX3Byb3h5ID0ge307XG4gICAgfVxuICAgIGlmICghdGFwYWJsZS5fX2hhcmRTb3VyY2VfcHJveHlbbmFtZV0pIHtcbiAgICAgIGlmICh0YXBhYmxlLl9faGFyZFNvdXJjZV9ob29rc1tuYW1lXS5tYXApIHtcbiAgICAgICAgY29uc3QgX2ZvckNhY2hlID0ge307XG4gICAgICAgIHRhcGFibGUuX19oYXJkU291cmNlX3Byb3h5W25hbWVdID0ge1xuICAgICAgICAgIF9mb3JDYWNoZSxcbiAgICAgICAgICBmb3I6IGtleSA9PiB7XG4gICAgICAgICAgICBsZXQgaG9vayA9IF9mb3JDYWNoZVtrZXldO1xuICAgICAgICAgICAgaWYgKGhvb2spIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGhvb2s7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBfZm9yQ2FjaGVba2V5XSA9IHtcbiAgICAgICAgICAgICAgdGFwOiAoLi4uYXJncykgPT4gZXhwb3J0cy50YXBGb3IodGFwYWJsZSwgbmFtZSwga2V5LCAuLi5hcmdzKSxcbiAgICAgICAgICAgICAgdGFwUHJvbWlzZTogKC4uLmFyZ3MpID0+XG4gICAgICAgICAgICAgICAgZXhwb3J0cy50YXBQcm9taXNlRm9yKHRhcGFibGUsIG5hbWUsIGtleSwgLi4uYXJncyksXG4gICAgICAgICAgICAgIGNhbGw6ICguLi5hcmdzKSA9PiBleHBvcnRzLmNhbGxGb3IodGFwYWJsZSwgbmFtZSwga2V5LCAuLi5hcmdzKSxcbiAgICAgICAgICAgICAgcHJvbWlzZTogKC4uLmFyZ3MpID0+XG4gICAgICAgICAgICAgICAgZXhwb3J0cy5wcm9taXNlRm9yKHRhcGFibGUsIG5hbWUsIGtleSwgLi4uYXJncyksXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmV0dXJuIF9mb3JDYWNoZVtrZXldO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgdGFwOiAoLi4uYXJncykgPT4gZXhwb3J0cy50YXBGb3IodGFwYWJsZSwgbmFtZSwgLi4uYXJncyksXG4gICAgICAgICAgdGFwUHJvbWlzZTogKC4uLmFyZ3MpID0+XG4gICAgICAgICAgICBleHBvcnRzLnRhcFByb21pc2VGb3IodGFwYWJsZSwgbmFtZSwgLi4uYXJncyksXG4gICAgICAgICAgY2FsbDogKC4uLmFyZ3MpID0+IGV4cG9ydHMuY2FsbEZvcih0YXBhYmxlLCBuYW1lLCAuLi5hcmdzKSxcbiAgICAgICAgICBwcm9taXNlOiAoLi4uYXJncykgPT4gZXhwb3J0cy5wcm9taXNlRm9yKHRhcGFibGUsIG5hbWUsIC4uLmFyZ3MpLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGFwYWJsZS5fX2hhcmRTb3VyY2VfcHJveHlbbmFtZV0gPSB7XG4gICAgICAgICAgdGFwOiAoLi4uYXJncykgPT4gZXhwb3J0cy50YXAodGFwYWJsZSwgbmFtZSwgLi4uYXJncyksXG4gICAgICAgICAgdGFwUHJvbWlzZTogKC4uLmFyZ3MpID0+IGV4cG9ydHMudGFwUHJvbWlzZSh0YXBhYmxlLCBuYW1lLCAuLi5hcmdzKSxcbiAgICAgICAgICBjYWxsOiAoLi4uYXJncykgPT4gZXhwb3J0cy5jYWxsKHRhcGFibGUsIG5hbWUsIGFyZ3MpLFxuICAgICAgICAgIHByb21pc2U6ICguLi5hcmdzKSA9PiBleHBvcnRzLnByb21pc2UodGFwYWJsZSwgbmFtZSwgYXJncyksXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuICB9XG59O1xuXG5leHBvcnRzLnRhcCA9ICh0YXBhYmxlLCBuYW1lLCByZWFzb24sIGNhbGxiYWNrKSA9PiB7XG4gIGlmICh0YXBhYmxlLmhvb2tzKSB7XG4gICAgdGFwYWJsZS5ob29rc1tuYW1lXS50YXAocmVhc29uLCBjYWxsYmFjayk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKCF0YXBhYmxlLl9faGFyZFNvdXJjZV9ob29rcyB8fCAhdGFwYWJsZS5fX2hhcmRTb3VyY2VfaG9va3NbbmFtZV0pIHtcbiAgICAgIGNvbnN0IHJlZ2lzdHJhdGlvbiA9XG4gICAgICAgIGtub3duUGx1Z2luUmVnaXN0cmF0aW9uc1t0YXBhYmxlLmNvbnN0cnVjdG9yLm5hbWVdW25hbWVdO1xuICAgICAgZXhwb3J0cy5yZWdpc3Rlcih0YXBhYmxlLCBuYW1lLCByZWdpc3RyYXRpb25bMF0sIHJlZ2lzdHJhdGlvblsxXSk7XG4gICAgfVxuICAgIGNvbnN0IGRhc2hOYW1lID0gdGFwYWJsZS5fX2hhcmRTb3VyY2VfaG9va3NbbmFtZV0uZGFzaE5hbWU7XG4gICAgaWYgKHRhcGFibGUuX19oYXJkU291cmNlX2hvb2tzW25hbWVdLmFzeW5jKSB7XG4gICAgICB0YXBhYmxlLnBsdWdpbihkYXNoTmFtZSwgKC4uLmFyZ3MpID0+IHtcbiAgICAgICAgY29uc3QgY2IgPSBhcmdzLnBvcCgpO1xuICAgICAgICBjYihudWxsLCBjYWxsYmFjayguLi5hcmdzKSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGFwYWJsZS5wbHVnaW4oZGFzaE5hbWUsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cbn07XG5cbmV4cG9ydHMudGFwUHJvbWlzZSA9ICh0YXBhYmxlLCBuYW1lLCByZWFzb24sIGNhbGxiYWNrKSA9PiB7XG4gIGlmICh0YXBhYmxlLmhvb2tzKSB7XG4gICAgdGFwYWJsZS5ob29rc1tuYW1lXS50YXBQcm9taXNlKHJlYXNvbiwgY2FsbGJhY2spO1xuICB9IGVsc2Uge1xuICAgIGlmICghdGFwYWJsZS5fX2hhcmRTb3VyY2VfaG9va3MgfHwgIXRhcGFibGUuX19oYXJkU291cmNlX2hvb2tzW25hbWVdKSB7XG4gICAgICBjb25zdCByZWdpc3RyYXRpb24gPVxuICAgICAgICBrbm93blBsdWdpblJlZ2lzdHJhdGlvbnNbdGFwYWJsZS5jb25zdHJ1Y3Rvci5uYW1lXVtuYW1lXTtcbiAgICAgIGV4cG9ydHMucmVnaXN0ZXIodGFwYWJsZSwgbmFtZSwgcmVnaXN0cmF0aW9uWzBdLCByZWdpc3RyYXRpb25bMV0pO1xuICAgIH1cbiAgICBjb25zdCBkYXNoTmFtZSA9IHRhcGFibGUuX19oYXJkU291cmNlX2hvb2tzW25hbWVdLmRhc2hOYW1lO1xuICAgIHRhcGFibGUucGx1Z2luKGRhc2hOYW1lLCAoLi4uYXJncykgPT4ge1xuICAgICAgY29uc3QgY2IgPSBhcmdzLnBvcCgpO1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKC4uLmFyZ3MpLnRoZW4odmFsdWUgPT4gY2IobnVsbCwgdmFsdWUpLCBjYik7XG4gICAgfSk7XG4gIH1cbn07XG5cbmV4cG9ydHMudGFwQXN5bmMgPSAodGFwYWJsZSwgbmFtZSwgcmVhc29uLCBjYWxsYmFjaykgPT4ge1xuICBpZiAodGFwYWJsZS5ob29rcykge1xuICAgIHRhcGFibGUuaG9va3NbbmFtZV0udGFwQXN5bmMocmVhc29uLCBjYWxsYmFjayk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKCF0YXBhYmxlLl9faGFyZFNvdXJjZV9ob29rcyB8fCAhdGFwYWJsZS5fX2hhcmRTb3VyY2VfaG9va3NbbmFtZV0pIHtcbiAgICAgIGNvbnN0IHJlZ2lzdHJhdGlvbiA9XG4gICAgICAgIGtub3duUGx1Z2luUmVnaXN0cmF0aW9uc1t0YXBhYmxlLmNvbnN0cnVjdG9yLm5hbWVdW25hbWVdO1xuICAgICAgZXhwb3J0cy5yZWdpc3Rlcih0YXBhYmxlLCBuYW1lLCByZWdpc3RyYXRpb25bMF0sIHJlZ2lzdHJhdGlvblsxXSk7XG4gICAgfVxuICAgIGNvbnN0IGRhc2hOYW1lID0gdGFwYWJsZS5fX2hhcmRTb3VyY2VfaG9va3NbbmFtZV0uZGFzaE5hbWU7XG4gICAgdGFwYWJsZS5wbHVnaW4oZGFzaE5hbWUsIGNhbGxiYWNrKTtcbiAgfVxufTtcblxuZXhwb3J0cy5jYWxsID0gKHRhcGFibGUsIG5hbWUsIGFyZ3MpID0+IHtcbiAgaWYgKHRhcGFibGUuaG9va3MpIHtcbiAgICBjb25zdCBob29rID0gdGFwYWJsZS5ob29rc1tuYW1lXTtcbiAgICByZXR1cm4gaG9vay5jYWxsKC4uLmFyZ3MpO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGRhc2hOYW1lID0gdGFwYWJsZS5fX2hhcmRTb3VyY2VfaG9va3NbbmFtZV0uZGFzaE5hbWU7XG4gICAgY29uc3Qgc3R5bGUgPSB0YXBhYmxlLl9faGFyZFNvdXJjZV9ob29rc1tuYW1lXS5zdHlsZTtcbiAgICByZXR1cm4gdGFwYWJsZVtjYWxsU3R5bGVzW3N0eWxlXV0oLi4uW2Rhc2hOYW1lXS5jb25jYXQoYXJncykpO1xuICB9XG59O1xuXG5leHBvcnRzLnByb21pc2UgPSAodGFwYWJsZSwgbmFtZSwgYXJncykgPT4ge1xuICBpZiAodGFwYWJsZS5ob29rcykge1xuICAgIGNvbnN0IGhvb2sgPSB0YXBhYmxlLmhvb2tzW25hbWVdO1xuICAgIHJldHVybiBob29rLnByb21pc2UoLi4uYXJncyk7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgZGFzaE5hbWUgPSB0YXBhYmxlLl9faGFyZFNvdXJjZV9ob29rc1tuYW1lXS5kYXNoTmFtZTtcbiAgICBjb25zdCBzdHlsZSA9IHRhcGFibGUuX19oYXJkU291cmNlX2hvb2tzW25hbWVdLnN0eWxlO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0YXBhYmxlW2NhbGxTdHlsZXNbc3R5bGVdXShcbiAgICAgICAgLi4uW2Rhc2hOYW1lXS5jb25jYXQoYXJncywgKGVyciwgdmFsdWUpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cbn07XG5cbmV4cG9ydHMudGFwRm9yID0gKHRhcGFibGUsIG5hbWUsIGtleSwgcmVhc29uLCBjYWxsYmFjaykgPT4ge1xuICBpZiAodGFwYWJsZS5ob29rcykge1xuICAgIHRhcGFibGUuaG9va3NbbmFtZV0uZm9yKGtleSkudGFwKHJlYXNvbiwgY2FsbGJhY2spO1xuICB9IGVsc2Uge1xuICAgIGV4cG9ydHMudGFwKHRhcGFibGUsIG5hbWUsIHJlYXNvbiwgY2FsbGJhY2spO1xuICB9XG59O1xuXG5leHBvcnRzLnRhcFByb21pc2VGb3IgPSAodGFwYWJsZSwgbmFtZSwga2V5LCByZWFzb24sIGNhbGxiYWNrKSA9PiB7XG4gIGlmICh0YXBhYmxlLmhvb2tzKSB7XG4gICAgdGFwYWJsZS5ob29rc1tuYW1lXS5mb3Ioa2V5KS50YXBQcm9taXNlKHJlYXNvbiwgY2FsbGJhY2spO1xuICB9IGVsc2Uge1xuICAgIGV4cG9ydHMudGFwUHJvbWlzZSh0YXBhYmxlLCBuYW1lLCByZWFzb24sIGNhbGxiYWNrKTtcbiAgfVxufTtcblxuZXhwb3J0cy5jYWxsRm9yID0gKHRhcGFibGUsIG5hbWUsIGtleSwgYXJncykgPT4ge1xuICBpZiAodGFwYWJsZS5ob29rcykge1xuICAgIHRhcGFibGUuaG9va3NbbmFtZV0uZm9yKGtleSkuY2FsbCguLi5hcmdzKTtcbiAgfSBlbHNlIHtcbiAgICBleHBvcnRzLmNhbGwodGFwYWJsZSwgbmFtZSwgYXJncyk7XG4gIH1cbn07XG5cbmV4cG9ydHMucHJvbWlzZUZvciA9ICh0YXBhYmxlLCBuYW1lLCBrZXksIGFyZ3MpID0+IHtcbiAgaWYgKHRhcGFibGUuaG9va3MpIHtcbiAgICB0YXBhYmxlLmhvb2tzW25hbWVdLmZvcihrZXkpLnByb21pc2UoLi4uYXJncyk7XG4gIH0gZWxzZSB7XG4gICAgZXhwb3J0cy5wcm9taXNlKHRhcGFibGUsIG5hbWUsIGFyZ3MpO1xuICB9XG59O1xuXG5leHBvcnRzLmhvb2tzID0gdGFwYWJsZSA9PiB7XG4gIGlmICh0YXBhYmxlLmhvb2tzKSB7XG4gICAgcmV0dXJuIHRhcGFibGUuaG9va3M7XG4gIH1cbiAgaWYgKCF0YXBhYmxlLl9faGFyZFNvdXJjZV9wcm94eSkge1xuICAgIHRhcGFibGUuX19oYXJkU291cmNlX3Byb3h5ID0ge307XG4gIH1cbiAgY29uc3QgcmVnaXN0cmF0aW9ucyA9IGtub3duUGx1Z2luUmVnaXN0cmF0aW9uc1t0YXBhYmxlLmNvbnN0cnVjdG9yLm5hbWVdO1xuICBpZiAocmVnaXN0cmF0aW9ucykge1xuICAgIGZvciAoY29uc3QgbmFtZSBpbiByZWdpc3RyYXRpb25zKSB7XG4gICAgICBjb25zdCByZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25zW25hbWVdO1xuICAgICAgZXhwb3J0cy5yZWdpc3Rlcih0YXBhYmxlLCBuYW1lLCByZWdpc3RyYXRpb25bMF0sIHJlZ2lzdHJhdGlvblsxXSk7XG4gICAgfVxuICB9XG4gIHJldHVybiB0YXBhYmxlLl9faGFyZFNvdXJjZV9wcm94eTtcbn07XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
