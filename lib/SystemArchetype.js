'use strict';

const pluginCompat = require('./util/plugin-compat');

class ArchetypeSystem {
  apply(compiler) {
    const compilerHooks = pluginCompat.hooks(compiler);

    const archetypeCaches = {
      // asset: assetArchetypeCache,
      // Asset: assetArchetypeCache,
      // module: moduleArchetypeCache,
      // Module: moduleArchetypeCache,
    };

    pluginCompat.register(compiler, '_hardSourceArchetypeRegister', 'sync', ['name', 'archetypeCache']);

    compilerHooks._hardSourceArchetypeRegister.tap('HardSource - ArchetypeSystem', (name, cache) => {
      archetypeCaches[name] = cache;
      archetypeCaches[name.toLowerCase()] = cache;
    });

    let freeze;
    let thaw;
    let mapMap;
    let mapFreeze;
    let mapThaw;
    let store;
    let fetch;

    pluginCompat.register(compiler, '_hardSourceMethods', 'sync', ['methods']);

    ['Asset', 'Compilation', 'Dependency', 'DependencyBlock', 'DependencyVariable', 'Module', 'ModuleAssets', 'ModuleError', 'ModuleWarning', 'Source'].forEach(archetype => {
      pluginCompat.register(compiler, `_hardSourceBeforeFreeze${archetype}`, 'syncWaterfall', ['frozen', 'item', 'extra']);
      pluginCompat.register(compiler, `_hardSourceFreeze${archetype}`, 'syncWaterfall', ['frozen', 'item', 'extra']);
      pluginCompat.register(compiler, `_hardSourceAfterFreeze${archetype}`, 'syncWaterfall', ['frozen', 'item', 'extra']);

      pluginCompat.register(compiler, `_hardSourceBeforeThaw${archetype}`, 'syncWaterfall', ['item', 'frozen', 'extra']);
      pluginCompat.register(compiler, `_hardSourceThaw${archetype}`, 'syncWaterfall', ['item', 'frozen', 'extra']);
      pluginCompat.register(compiler, `_hardSourceAfterThaw${archetype}`, 'syncWaterfall', ['item', 'frozen', 'extra']);
    });

    function run(_compiler) {
      let compiler = _compiler;
      if (_compiler.compiler) {
        compiler = _compiler.compiler;
      }
      freeze = (archetype, frozen, item, extra) => {
        if (!item) {
          return item;
        }

        frozen = pluginCompat.call(compiler, `_hardSourceBeforeFreeze${archetype}`, [frozen, item, extra]);
        frozen = pluginCompat.call(compiler, `_hardSourceFreeze${archetype}`, [frozen, item, extra]);
        frozen = pluginCompat.call(compiler, `_hardSourceAfterFreeze${archetype}`, [frozen, item, extra]);

        return frozen;
      };
      thaw = (archetype, item, frozen, extra) => {
        if (!frozen) {
          return frozen;
        }

        item = pluginCompat.call(compiler, `_hardSourceBeforeThaw${archetype}`, [item, frozen, extra]);
        item = pluginCompat.call(compiler, `_hardSourceThaw${archetype}`, [item, frozen, extra]);
        item = pluginCompat.call(compiler, `_hardSourceAfterThaw${archetype}`, [item, frozen, extra]);

        return item;
      };
      mapMap = (fn, name, output, input, extra) => {
        if (output) {
          return input.map((item, index) => fn(name, output[index], item, extra)).filter(Boolean);
        } else {
          return input.map(item => fn(name, null, item, extra)).filter(Boolean);
        }
      };
      mapFreeze = (name, frozen, items, extra) => mapMap(freeze, name, frozen, items, extra);
      mapThaw = (name, items, frozen, extra) => mapMap(thaw, name, items, frozen, extra);
      store = (archetype, id, item, extra) => {
        const cache = archetypeCaches[archetype];
        if (item) {
          const frozen = cache.get(id);
          const newFrozen = freeze(archetype, frozen, item, extra);
          if (frozen && newFrozen && newFrozen !== frozen || !frozen && newFrozen) {
            cache.set(id, newFrozen);
            return newFrozen;
          } else if (frozen) {
            return frozen;
          }
        } else {
          cache.set(id, null);
        }
      };
      fetch = (archetype, id, extra) => {
        const cache = archetypeCaches[archetype];
        const frozen = cache.get(id);
        return thaw(archetype, null, frozen, extra);
      };

      const methods = {
        freeze,
        thaw,
        mapFreeze,
        mapThaw,
        store,
        fetch
      };
      pluginCompat.call(compiler, '_hardSourceMethods', [methods]);
    }

    compilerHooks.watchRun.tap('HardSource - ArchetypeSystem', run);
    compilerHooks.run.tap('HardSource - ArchetypeSystem', run);

    compilerHooks.compilation.tap('HardSource - ArchetypeSystem', compilation => {
      compilation.__hardSourceMethods = {
        freeze,
        thaw,
        mapFreeze,
        mapThaw,
        store,
        fetch
      };
    });
  }
}

module.exports = ArchetypeSystem;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9TeXN0ZW1BcmNoZXR5cGUuanMiXSwibmFtZXMiOlsicGx1Z2luQ29tcGF0IiwicmVxdWlyZSIsIkFyY2hldHlwZVN5c3RlbSIsImFwcGx5IiwiY29tcGlsZXIiLCJjb21waWxlckhvb2tzIiwiaG9va3MiLCJhcmNoZXR5cGVDYWNoZXMiLCJyZWdpc3RlciIsIl9oYXJkU291cmNlQXJjaGV0eXBlUmVnaXN0ZXIiLCJ0YXAiLCJuYW1lIiwiY2FjaGUiLCJ0b0xvd2VyQ2FzZSIsImZyZWV6ZSIsInRoYXciLCJtYXBNYXAiLCJtYXBGcmVlemUiLCJtYXBUaGF3Iiwic3RvcmUiLCJmZXRjaCIsImZvckVhY2giLCJhcmNoZXR5cGUiLCJydW4iLCJfY29tcGlsZXIiLCJmcm96ZW4iLCJpdGVtIiwiZXh0cmEiLCJjYWxsIiwiZm4iLCJvdXRwdXQiLCJpbnB1dCIsIm1hcCIsImluZGV4IiwiZmlsdGVyIiwiQm9vbGVhbiIsIml0ZW1zIiwiaWQiLCJnZXQiLCJuZXdGcm96ZW4iLCJzZXQiLCJtZXRob2RzIiwid2F0Y2hSdW4iLCJjb21waWxhdGlvbiIsIl9faGFyZFNvdXJjZU1ldGhvZHMiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLGVBQWVDLCtCQUFyQjs7QUFFQSxNQUFNQyxlQUFOLENBQXNCO0FBQ3BCQyxRQUFNQyxRQUFOLEVBQWdCO0FBQ2QsVUFBTUMsZ0JBQWdCTCxhQUFhTSxLQUFiLENBQW1CRixRQUFuQixDQUF0Qjs7QUFFQSxVQUFNRyxrQkFBa0I7QUFDdEI7QUFDQTtBQUNBO0FBQ0E7QUFKc0IsS0FBeEI7O0FBT0FQLGlCQUFhUSxRQUFiLENBQXNCSixRQUF0QixFQUFnQyw4QkFBaEMsRUFBZ0UsTUFBaEUsRUFBd0UsQ0FDdEUsTUFEc0UsRUFFdEUsZ0JBRnNFLENBQXhFOztBQUtBQyxrQkFBY0ksNEJBQWQsQ0FBMkNDLEdBQTNDLENBQ0UsOEJBREYsRUFFRSxD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RGM7QUFFZEMsWUFGYztBQUdkRSxpQkFIYztBQUlkQyxlQUpjO0FBS2RDLGFBTGM7QUFNZEM7QUFOYyxPQUFoQjtBQVFBcEIsbUJBQWE0QixJQUFiLENBQWtCeEIsUUFBbEIsRUFBNEIsb0JBQTVCLEVBQWtELENBQUNxQyxPQUFELENBQWxEO0FBQ0Q7O0FBRURwQyxrQkFBY3FDLFFBQWQsQ0FBdUJoQyxHQUF2QixDQUEyQiw4QkFBM0IsRUFBMkRhLEdBQTNEO0FBQ0FsQixrQkFBY2tCLEdBQWQsQ0FBa0JiLEdBQWxCLENBQXNCLDhCQUF0QixFQUFzRGEsR0FBdEQ7O0FBRUFsQixrQkFBY3NDLFdBQWQsQ0FBMEJqQyxHQUExQixDQUNFLDhCQURGLEVBRUVpQyxlQUFlO0FBQ2JBLGtCQUFZQyxtQkFBWixHQUFrQztBQUNoQzlCLGNBRGdDO0FBRWhDQyxZQUZnQztBQUdoQ0UsaUJBSGdDO0FBSWhDQyxlQUpnQztBQUtoQ0MsYUFMZ0M7QUFNaENDO0FBTmdDLE9BQWxDO0FBUUQsS0FYSDtBQWFEO0FBeE1tQjs7QUEyTXRCeUIsT0FBT0MsT0FBUCxHQUFpQjVDLGVBQWpCIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9TeXN0ZW1BcmNoZXR5cGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwbHVnaW5Db21wYXQgPSByZXF1aXJlKCcuL3V0aWwvcGx1Z2luLWNvbXBhdCcpO1xuXG5jbGFzcyBBcmNoZXR5cGVTeXN0ZW0ge1xuICBhcHBseShjb21waWxlcikge1xuICAgIGNvbnN0IGNvbXBpbGVySG9va3MgPSBwbHVnaW5Db21wYXQuaG9va3MoY29tcGlsZXIpO1xuXG4gICAgY29uc3QgYXJjaGV0eXBlQ2FjaGVzID0ge1xuICAgICAgLy8gYXNzZXQ6IGFzc2V0QXJjaGV0eXBlQ2FjaGUsXG4gICAgICAvLyBBc3NldDogYXNzZXRBcmNoZXR5cGVDYWNoZSxcbiAgICAgIC8vIG1vZHVsZTogbW9kdWxlQXJjaGV0eXBlQ2FjaGUsXG4gICAgICAvLyBNb2R1bGU6IG1vZHVsZUFyY2hldHlwZUNhY2hlLFxuICAgIH07XG5cbiAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoY29tcGlsZXIsICdfaGFyZFNvdXJjZUFyY2hldHlwZVJlZ2lzdGVyJywgJ3N5bmMnLCBbXG4gICAgICAnbmFtZScsXG4gICAgICAnYXJjaGV0eXBlQ2FjaGUnLFxuICAgIF0pO1xuXG4gICAgY29tcGlsZXJIb29rcy5faGFyZFNvdXJjZUFyY2hldHlwZVJlZ2lzdGVyLnRhcChcbiAgICAgICdIYXJkU291cmNlIC0gQXJjaGV0eXBlU3lzdGVtJyxcbiAgICAgIChuYW1lLCBjYWNoZSkgPT4ge1xuICAgICAgICBhcmNoZXR5cGVDYWNoZXNbbmFtZV0gPSBjYWNoZTtcbiAgICAgICAgYXJjaGV0eXBlQ2FjaGVzW25hbWUudG9Mb3dlckNhc2UoKV0gPSBjYWNoZTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGxldCBmcmVlemU7XG4gICAgbGV0IHRoYXc7XG4gICAgbGV0IG1hcE1hcDtcbiAgICBsZXQgbWFwRnJlZXplO1xuICAgIGxldCBtYXBUaGF3O1xuICAgIGxldCBzdG9yZTtcbiAgICBsZXQgZmV0Y2g7XG5cbiAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoY29tcGlsZXIsICdfaGFyZFNvdXJjZU1ldGhvZHMnLCAnc3luYycsIFsnbWV0aG9kcyddKTtcblxuICAgIFtcbiAgICAgICdBc3NldCcsXG4gICAgICAnQ29tcGlsYXRpb24nLFxuICAgICAgJ0RlcGVuZGVuY3knLFxuICAgICAgJ0RlcGVuZGVuY3lCbG9jaycsXG4gICAgICAnRGVwZW5kZW5jeVZhcmlhYmxlJyxcbiAgICAgICdNb2R1bGUnLFxuICAgICAgJ01vZHVsZUFzc2V0cycsXG4gICAgICAnTW9kdWxlRXJyb3InLFxuICAgICAgJ01vZHVsZVdhcm5pbmcnLFxuICAgICAgJ1NvdXJjZScsXG4gICAgXS5mb3JFYWNoKGFyY2hldHlwZSA9PiB7XG4gICAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoXG4gICAgICAgIGNvbXBpbGVyLFxuICAgICAgICBgX2hhcmRTb3VyY2VCZWZvcmVGcmVlemUke2FyY2hldHlwZX1gLFxuICAgICAgICAnc3luY1dhdGVyZmFsbCcsXG4gICAgICAgIFsnZnJvemVuJywgJ2l0ZW0nLCAnZXh0cmEnXSxcbiAgICAgICk7XG4gICAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoXG4gICAgICAgIGNvbXBpbGVyLFxuICAgICAgICBgX2hhcmRTb3VyY2VGcmVlemUke2FyY2hldHlwZX1gLFxuICAgICAgICAnc3luY1dhdGVyZmFsbCcsXG4gICAgICAgIFsnZnJvemVuJywgJ2l0ZW0nLCAnZXh0cmEnXSxcbiAgICAgICk7XG4gICAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoXG4gICAgICAgIGNvbXBpbGVyLFxuICAgICAgICBgX2hhcmRTb3VyY2VBZnRlckZyZWV6ZSR7YXJjaGV0eXBlfWAsXG4gICAgICAgICdzeW5jV2F0ZXJmYWxsJyxcbiAgICAgICAgWydmcm96ZW4nLCAnaXRlbScsICdleHRyYSddLFxuICAgICAgKTtcblxuICAgICAgcGx1Z2luQ29tcGF0LnJlZ2lzdGVyKFxuICAgICAgICBjb21waWxlcixcbiAgICAgICAgYF9oYXJkU291cmNlQmVmb3JlVGhhdyR7YXJjaGV0eXBlfWAsXG4gICAgICAgICdzeW5jV2F0ZXJmYWxsJyxcbiAgICAgICAgWydpdGVtJywgJ2Zyb3plbicsICdleHRyYSddLFxuICAgICAgKTtcbiAgICAgIHBsdWdpbkNvbXBhdC5yZWdpc3RlcihcbiAgICAgICAgY29tcGlsZXIsXG4gICAgICAgIGBfaGFyZFNvdXJjZVRoYXcke2FyY2hldHlwZX1gLFxuICAgICAgICAnc3luY1dhdGVyZmFsbCcsXG4gICAgICAgIFsnaXRlbScsICdmcm96ZW4nLCAnZXh0cmEnXSxcbiAgICAgICk7XG4gICAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoXG4gICAgICAgIGNvbXBpbGVyLFxuICAgICAgICBgX2hhcmRTb3VyY2VBZnRlclRoYXcke2FyY2hldHlwZX1gLFxuICAgICAgICAnc3luY1dhdGVyZmFsbCcsXG4gICAgICAgIFsnaXRlbScsICdmcm96ZW4nLCAnZXh0cmEnXSxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBmdW5jdGlvbiBydW4oX2NvbXBpbGVyKSB7XG4gICAgICBsZXQgY29tcGlsZXIgPSBfY29tcGlsZXI7XG4gICAgICBpZiAoX2NvbXBpbGVyLmNvbXBpbGVyKSB7XG4gICAgICAgIGNvbXBpbGVyID0gX2NvbXBpbGVyLmNvbXBpbGVyO1xuICAgICAgfVxuICAgICAgZnJlZXplID0gKGFyY2hldHlwZSwgZnJvemVuLCBpdGVtLCBleHRyYSkgPT4ge1xuICAgICAgICBpZiAoIWl0ZW0pIHtcbiAgICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZyb3plbiA9IHBsdWdpbkNvbXBhdC5jYWxsKFxuICAgICAgICAgIGNvbXBpbGVyLFxuICAgICAgICAgIGBfaGFyZFNvdXJjZUJlZm9yZUZyZWV6ZSR7YXJjaGV0eXBlfWAsXG4gICAgICAgICAgW2Zyb3plbiwgaXRlbSwgZXh0cmFdLFxuICAgICAgICApO1xuICAgICAgICBmcm96ZW4gPSBwbHVnaW5Db21wYXQuY2FsbChjb21waWxlciwgYF9oYXJkU291cmNlRnJlZXplJHthcmNoZXR5cGV9YCwgW1xuICAgICAgICAgIGZyb3plbixcbiAgICAgICAgICBpdGVtLFxuICAgICAgICAgIGV4dHJhLFxuICAgICAgICBdKTtcbiAgICAgICAgZnJvemVuID0gcGx1Z2luQ29tcGF0LmNhbGwoXG4gICAgICAgICAgY29tcGlsZXIsXG4gICAgICAgICAgYF9oYXJkU291cmNlQWZ0ZXJGcmVlemUke2FyY2hldHlwZX1gLFxuICAgICAgICAgIFtmcm96ZW4sIGl0ZW0sIGV4dHJhXSxcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gZnJvemVuO1xuICAgICAgfTtcbiAgICAgIHRoYXcgPSAoYXJjaGV0eXBlLCBpdGVtLCBmcm96ZW4sIGV4dHJhKSA9PiB7XG4gICAgICAgIGlmICghZnJvemVuKSB7XG4gICAgICAgICAgcmV0dXJuIGZyb3plbjtcbiAgICAgICAgfVxuXG4gICAgICAgIGl0ZW0gPSBwbHVnaW5Db21wYXQuY2FsbChcbiAgICAgICAgICBjb21waWxlcixcbiAgICAgICAgICBgX2hhcmRTb3VyY2VCZWZvcmVUaGF3JHthcmNoZXR5cGV9YCxcbiAgICAgICAgICBbaXRlbSwgZnJvemVuLCBleHRyYV0sXG4gICAgICAgICk7XG4gICAgICAgIGl0ZW0gPSBwbHVnaW5Db21wYXQuY2FsbChjb21waWxlciwgYF9oYXJkU291cmNlVGhhdyR7YXJjaGV0eXBlfWAsIFtcbiAgICAgICAgICBpdGVtLFxuICAgICAgICAgIGZyb3plbixcbiAgICAgICAgICBleHRyYSxcbiAgICAgICAgXSk7XG4gICAgICAgIGl0ZW0gPSBwbHVnaW5Db21wYXQuY2FsbChjb21waWxlciwgYF9oYXJkU291cmNlQWZ0ZXJUaGF3JHthcmNoZXR5cGV9YCwgW1xuICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgZnJvemVuLFxuICAgICAgICAgIGV4dHJhLFxuICAgICAgICBdKTtcblxuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgIH07XG4gICAgICBtYXBNYXAgPSAoZm4sIG5hbWUsIG91dHB1dCwgaW5wdXQsIGV4dHJhKSA9PiB7XG4gICAgICAgIGlmIChvdXRwdXQpIHtcbiAgICAgICAgICByZXR1cm4gaW5wdXRcbiAgICAgICAgICAgIC5tYXAoKGl0ZW0sIGluZGV4KSA9PiBmbihuYW1lLCBvdXRwdXRbaW5kZXhdLCBpdGVtLCBleHRyYSkpXG4gICAgICAgICAgICAuZmlsdGVyKEJvb2xlYW4pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBpbnB1dC5tYXAoaXRlbSA9PiBmbihuYW1lLCBudWxsLCBpdGVtLCBleHRyYSkpLmZpbHRlcihCb29sZWFuKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIG1hcEZyZWV6ZSA9IChuYW1lLCBmcm96ZW4sIGl0ZW1zLCBleHRyYSkgPT5cbiAgICAgICAgbWFwTWFwKGZyZWV6ZSwgbmFtZSwgZnJvemVuLCBpdGVtcywgZXh0cmEpO1xuICAgICAgbWFwVGhhdyA9IChuYW1lLCBpdGVtcywgZnJvemVuLCBleHRyYSkgPT5cbiAgICAgICAgbWFwTWFwKHRoYXcsIG5hbWUsIGl0ZW1zLCBmcm96ZW4sIGV4dHJhKTtcbiAgICAgIHN0b3JlID0gKGFyY2hldHlwZSwgaWQsIGl0ZW0sIGV4dHJhKSA9PiB7XG4gICAgICAgIGNvbnN0IGNhY2hlID0gYXJjaGV0eXBlQ2FjaGVzW2FyY2hldHlwZV07XG4gICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgY29uc3QgZnJvemVuID0gY2FjaGUuZ2V0KGlkKTtcbiAgICAgICAgICBjb25zdCBuZXdGcm96ZW4gPSBmcmVlemUoYXJjaGV0eXBlLCBmcm96ZW4sIGl0ZW0sIGV4dHJhKTtcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAoZnJvemVuICYmIG5ld0Zyb3plbiAmJiBuZXdGcm96ZW4gIT09IGZyb3plbikgfHxcbiAgICAgICAgICAgICghZnJvemVuICYmIG5ld0Zyb3plbilcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIGNhY2hlLnNldChpZCwgbmV3RnJvemVuKTtcbiAgICAgICAgICAgIHJldHVybiBuZXdGcm96ZW47XG4gICAgICAgICAgfSBlbHNlIGlmIChmcm96ZW4pIHtcbiAgICAgICAgICAgIHJldHVybiBmcm96ZW47XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNhY2hlLnNldChpZCwgbnVsbCk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICBmZXRjaCA9IChhcmNoZXR5cGUsIGlkLCBleHRyYSkgPT4ge1xuICAgICAgICBjb25zdCBjYWNoZSA9IGFyY2hldHlwZUNhY2hlc1thcmNoZXR5cGVdO1xuICAgICAgICBjb25zdCBmcm96ZW4gPSBjYWNoZS5nZXQoaWQpO1xuICAgICAgICByZXR1cm4gdGhhdyhhcmNoZXR5cGUsIG51bGwsIGZyb3plbiwgZXh0cmEpO1xuICAgICAgfTtcblxuICAgICAgY29uc3QgbWV0aG9kcyA9IHtcbiAgICAgICAgZnJlZXplLFxuICAgICAgICB0aGF3LFxuICAgICAgICBtYXBGcmVlemUsXG4gICAgICAgIG1hcFRoYXcsXG4gICAgICAgIHN0b3JlLFxuICAgICAgICBmZXRjaCxcbiAgICAgIH07XG4gICAgICBwbHVnaW5Db21wYXQuY2FsbChjb21waWxlciwgJ19oYXJkU291cmNlTWV0aG9kcycsIFttZXRob2RzXSk7XG4gICAgfVxuXG4gICAgY29tcGlsZXJIb29rcy53YXRjaFJ1bi50YXAoJ0hhcmRTb3VyY2UgLSBBcmNoZXR5cGVTeXN0ZW0nLCBydW4pO1xuICAgIGNvbXBpbGVySG9va3MucnVuLnRhcCgnSGFyZFNvdXJjZSAtIEFyY2hldHlwZVN5c3RlbScsIHJ1bik7XG5cbiAgICBjb21waWxlckhvb2tzLmNvbXBpbGF0aW9uLnRhcChcbiAgICAgICdIYXJkU291cmNlIC0gQXJjaGV0eXBlU3lzdGVtJyxcbiAgICAgIGNvbXBpbGF0aW9uID0+IHtcbiAgICAgICAgY29tcGlsYXRpb24uX19oYXJkU291cmNlTWV0aG9kcyA9IHtcbiAgICAgICAgICBmcmVlemUsXG4gICAgICAgICAgdGhhdyxcbiAgICAgICAgICBtYXBGcmVlemUsXG4gICAgICAgICAgbWFwVGhhdyxcbiAgICAgICAgICBzdG9yZSxcbiAgICAgICAgICBmZXRjaCxcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEFyY2hldHlwZVN5c3RlbTtcbiJdLCJzb3VyY2VSb290IjoiL1VzZXJzL3R5bGVyYXJidXMvZGV2L3Byb3ZpZGVyL3NyYyJ9
