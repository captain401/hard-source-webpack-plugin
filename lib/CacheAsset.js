'use strict';

const crypto = require('crypto');

const pluginCompat = require('./util/plugin-compat');
const relateContext = require('./util/relate-context');
const { parityCacheFromCache, pushParityWriteOps } = require('./util/parity');

function requestHash(request) {
  return crypto.createHash('sha1').update(request).digest().hexSlice();
}

const relateNormalRequest = relateContext.relateNormalRequest;

class AssetCache {
  apply(compiler) {
    const compilerHooks = pluginCompat.hooks(compiler);

    let assetCache = {};
    let parityCache = {};

    const assetArchetypeCache = {
      _ops: [],

      get(id) {
        const hashId = requestHash(relateNormalRequest(compiler, id));
        if (assetCache[hashId]) {
          if (typeof assetCache[hashId] === 'string') {
            assetCache[hashId] = JSON.parse(assetCache[hashId]);
          }
          return assetCache[hashId];
        }
      },

      set(id, item) {
        const hashId = requestHash(relateNormalRequest(compiler, id));
        if (item) {
          assetCache[hashId] = item;
          this._ops.push({
            key: hashId,
            value: item
          });
        } else {
          assetCache[hashId] = null;
          this._ops.push({
            key: hashId,
            value: null
          });
        }
      },

      operations() {
        const ops = this._ops.slice();
        this._ops.length = 0;
        return ops;
      }
    };

    compilerHooks._hardSourceArchetypeRegister.call('Asset', assetArchetypeCache);

    let assetCacheSerializer;
    let assetParityCacheSerializer;

    compilerHooks._hardSourceCreateSerializer.tap('HardSource - AssetCache', (cacheSerializerFactory, cacheDirPath) => {
      assetCacheSerializer = cacheSerializerFactory.create({
        name: 'assets',
        type: 'file',
        cacheDirPath
      });
      assetParityCacheSerializer = cacheSerializerFactory.create({
        name: 'assets-parity',
        type: 'data',
        cacheDirPath
      });
    });

    compilerHooks._hardSourceResetCache.tap('HardSource - AssetCache', () => {
      assetCache = {};
      parityCache = {};
    });

    compilerHooks._hardSourceReadCache.tapPromise('HardSource - AssetCache', () => Promise.all([assetCacheSerializer.read().then(_assetCache => {
      assetCache = _assetCache;
    }), assetParityCacheSerializer.read().then(_parityCache => {
      parityCache = _parityCache;
    })]));

    compilerHooks._hardSourceParityCache.tap('HardSource - AssetCache', parityRoot => {
      parityCacheFromCache('Asset', parityRoot, parityCache);
    });

    compilerHooks._hardSourceWriteCache.tapPromise('HardSource - AssetCache', compilation => {
      const assetOps = assetArchetypeCache.operations();

      const parityOps = [];
      pushParityWriteOps(compilation, parityOps);

      return Promise.all([assetCacheSerializer.write(assetOps), assetParityCacheSerializer.write(parityOps)]);
    });
  }
}

module.exports = AssetCache;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9DYWNoZUFzc2V0LmpzIl0sIm5hbWVzIjpbImNyeXB0byIsInJlcXVpcmUiLCJwbHVnaW5Db21wYXQiLCJyZWxhdGVDb250ZXh0IiwicGFyaXR5Q2FjaGVGcm9tQ2FjaGUiLCJwdXNoUGFyaXR5V3JpdGVPcHMiLCJyZXF1ZXN0SGFzaCIsInJlcXVlc3QiLCJjcmVhdGVIYXNoIiwidXBkYXRlIiwiZGlnZXN0IiwiaGV4U2xpY2UiLCJyZWxhdGVOb3JtYWxSZXF1ZXN0IiwiQXNzZXRDYWNoZSIsImFwcGx5IiwiY29tcGlsZXIiLCJjb21waWxlckhvb2tzIiwiaG9va3MiLCJhc3NldENhY2hlIiwicGFyaXR5Q2FjaGUiLCJhc3NldEFyY2hldHlwZUNhY2hlIiwiX29wcyIsImdldCIsImlkIiwiaGFzaElkIiwiSlNPTiIsInBhcnNlIiwic2V0IiwiaXRlbSIsInB1c2giLCJrZXkiLCJ2YWx1ZSIsIm9wZXJhdGlvbnMiLCJvcHMiLCJzbGljZSIsImxlbmd0aCIsIl9oYXJkU291cmNlQXJjaGV0eXBlUmVnaXN0ZXIiLCJjYWxsIiwiYXNzZXRDYWNoZVNlcmlhbGl6ZXIiLCJhc3NldFBhcml0eUNhY2hlU2VyaWFsaXplciIsIl9oYXJkU291cmNlQ3JlYXRlU2VyaWFsaXplciIsInRhcCIsImNhY2hlU2VyaWFsaXplckZhY3RvcnkiLCJjYWNoZURpclBhdGgiLCJjcmVhdGUiLCJuYW1lIiwidHlwZSIsIl9oYXJkU291cmNlUmVzZXRDYWNoZSIsIl9oYXJkU291cmNlUmVhZENhY2hlIiwidGFwUHJvbWlzZSIsIlByb21pc2UiLCJhbGwiLCJyZWFkIiwidGhlbiIsIl9hc3NldENhY2hlIiwiX3Bhcml0eUNhY2hlIiwiX2hhcmRTb3VyY2VQYXJpdHlDYWNoZSIsInBhcml0eVJvb3QiLCJfaGFyZFNvdXJjZVdyaXRlQ2FjaGUiLCJjb21waWxhdGlvbiIsImFzc2V0T3BzIiwicGFyaXR5T3BzIiwid3JpdGUiLCJtb2R1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Q0VDLFFBQVFDLEdBQVIsQ0FBWSxDQUNWYixxQkFBcUJjLElBQXJCLEdBQTRCQyxJQUE1QixDQUFpQ0MsZUFBZTtBQUM5Q3BDLG1CQUFhb0MsV0FBYjtBQUNELEtBRkQsQ0FEVSxFQUlWZiwyQkFBMkJhLElBQTNCLEdBQWtDQyxJQUFsQyxDQUF1Q0UsZ0JBQWdCO0FBQ3JEcEMsb0JBQWNvQyxZQUFkO0FBQ0QsS0FGRCxDQUpVLENBQVosQ0FISjs7QUFhQXZDLGtCQUFjd0Msc0JBQWQsQ0FBcUNmLEdBQXJDLENBQ0UseUJBREYsRUFFRWdCLGNBQWM7QUFDWnJELDJCQUFxQixPQUFyQixFQUE4QnFELFVBQTlCLEVBQTBDdEMsV0FBMUM7QUFDRCxLQUpIOztBQU9BSCxrQkFBYzBDLHFCQUFkLENBQW9DVCxVQUFwQyxDQUNFLHlCQURGLEVBRUVVLGVBQWU7QUFDYixZQUFNQyxXQUFXeEMsb0JBQW9CWSxVQUFwQixFQUFqQjs7QUFFQSxZQUFNNkIsWUFBWSxFQUFsQjtBQUNBeEQseUJBQW1Cc0QsV0FBbkIsRUFBZ0NFLFNBQWhDOztBQUVBLGFBQU9YLFFBQVFDLEdBQVIsQ0FBWSxDQUNqQmIscUJBQXFCd0IsS0FBckIsQ0FBMkJGLFFBQTNCLENBRGlCLEVBRWpCckIsMkJBQTJCdUIsS0FBM0IsQ0FBaUNELFNBQWpDLENBRmlCLENBQVosQ0FBUDtBQUlELEtBWkg7QUFjRDtBQTNHYzs7QUE4R2pCRSxPQUFPQyxPQUFQLEdBQWlCbkQsVUFBakIiLCJmaWxlIjoiaGFyZC1zb3VyY2Utd2VicGFjay1wbHVnaW4vbGliL0NhY2hlQXNzZXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBjcnlwdG8gPSByZXF1aXJlKCdjcnlwdG8nKTtcblxuY29uc3QgcGx1Z2luQ29tcGF0ID0gcmVxdWlyZSgnLi91dGlsL3BsdWdpbi1jb21wYXQnKTtcbmNvbnN0IHJlbGF0ZUNvbnRleHQgPSByZXF1aXJlKCcuL3V0aWwvcmVsYXRlLWNvbnRleHQnKTtcbmNvbnN0IHsgcGFyaXR5Q2FjaGVGcm9tQ2FjaGUsIHB1c2hQYXJpdHlXcml0ZU9wcyB9ID0gcmVxdWlyZSgnLi91dGlsL3Bhcml0eScpO1xuXG5mdW5jdGlvbiByZXF1ZXN0SGFzaChyZXF1ZXN0KSB7XG4gIHJldHVybiBjcnlwdG9cbiAgICAuY3JlYXRlSGFzaCgnc2hhMScpXG4gICAgLnVwZGF0ZShyZXF1ZXN0KVxuICAgIC5kaWdlc3QoKVxuICAgIC5oZXhTbGljZSgpO1xufVxuXG5jb25zdCByZWxhdGVOb3JtYWxSZXF1ZXN0ID0gcmVsYXRlQ29udGV4dC5yZWxhdGVOb3JtYWxSZXF1ZXN0O1xuXG5jbGFzcyBBc3NldENhY2hlIHtcbiAgYXBwbHkoY29tcGlsZXIpIHtcbiAgICBjb25zdCBjb21waWxlckhvb2tzID0gcGx1Z2luQ29tcGF0Lmhvb2tzKGNvbXBpbGVyKTtcblxuICAgIGxldCBhc3NldENhY2hlID0ge307XG4gICAgbGV0IHBhcml0eUNhY2hlID0ge307XG5cbiAgICBjb25zdCBhc3NldEFyY2hldHlwZUNhY2hlID0ge1xuICAgICAgX29wczogW10sXG5cbiAgICAgIGdldChpZCkge1xuICAgICAgICBjb25zdCBoYXNoSWQgPSByZXF1ZXN0SGFzaChyZWxhdGVOb3JtYWxSZXF1ZXN0KGNvbXBpbGVyLCBpZCkpO1xuICAgICAgICBpZiAoYXNzZXRDYWNoZVtoYXNoSWRdKSB7XG4gICAgICAgICAgaWYgKHR5cGVvZiBhc3NldENhY2hlW2hhc2hJZF0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBhc3NldENhY2hlW2hhc2hJZF0gPSBKU09OLnBhcnNlKGFzc2V0Q2FjaGVbaGFzaElkXSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBhc3NldENhY2hlW2hhc2hJZF07XG4gICAgICAgIH1cbiAgICAgIH0sXG5cbiAgICAgIHNldChpZCwgaXRlbSkge1xuICAgICAgICBjb25zdCBoYXNoSWQgPSByZXF1ZXN0SGFzaChyZWxhdGVOb3JtYWxSZXF1ZXN0KGNvbXBpbGVyLCBpZCkpO1xuICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgIGFzc2V0Q2FjaGVbaGFzaElkXSA9IGl0ZW07XG4gICAgICAgICAgdGhpcy5fb3BzLnB1c2goe1xuICAgICAgICAgICAga2V5OiBoYXNoSWQsXG4gICAgICAgICAgICB2YWx1ZTogaXRlbSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhc3NldENhY2hlW2hhc2hJZF0gPSBudWxsO1xuICAgICAgICAgIHRoaXMuX29wcy5wdXNoKHtcbiAgICAgICAgICAgIGtleTogaGFzaElkLFxuICAgICAgICAgICAgdmFsdWU6IG51bGwsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG5cbiAgICAgIG9wZXJhdGlvbnMoKSB7XG4gICAgICAgIGNvbnN0IG9wcyA9IHRoaXMuX29wcy5zbGljZSgpO1xuICAgICAgICB0aGlzLl9vcHMubGVuZ3RoID0gMDtcbiAgICAgICAgcmV0dXJuIG9wcztcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIGNvbXBpbGVySG9va3MuX2hhcmRTb3VyY2VBcmNoZXR5cGVSZWdpc3Rlci5jYWxsKFxuICAgICAgJ0Fzc2V0JyxcbiAgICAgIGFzc2V0QXJjaGV0eXBlQ2FjaGUsXG4gICAgKTtcblxuICAgIGxldCBhc3NldENhY2hlU2VyaWFsaXplcjtcbiAgICBsZXQgYXNzZXRQYXJpdHlDYWNoZVNlcmlhbGl6ZXI7XG5cbiAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlQ3JlYXRlU2VyaWFsaXplci50YXAoXG4gICAgICAnSGFyZFNvdXJjZSAtIEFzc2V0Q2FjaGUnLFxuICAgICAgKGNhY2hlU2VyaWFsaXplckZhY3RvcnksIGNhY2hlRGlyUGF0aCkgPT4ge1xuICAgICAgICBhc3NldENhY2hlU2VyaWFsaXplciA9IGNhY2hlU2VyaWFsaXplckZhY3RvcnkuY3JlYXRlKHtcbiAgICAgICAgICBuYW1lOiAnYXNzZXRzJyxcbiAgICAgICAgICB0eXBlOiAnZmlsZScsXG4gICAgICAgICAgY2FjaGVEaXJQYXRoLFxuICAgICAgICB9KTtcbiAgICAgICAgYXNzZXRQYXJpdHlDYWNoZVNlcmlhbGl6ZXIgPSBjYWNoZVNlcmlhbGl6ZXJGYWN0b3J5LmNyZWF0ZSh7XG4gICAgICAgICAgbmFtZTogJ2Fzc2V0cy1wYXJpdHknLFxuICAgICAgICAgIHR5cGU6ICdkYXRhJyxcbiAgICAgICAgICBjYWNoZURpclBhdGgsXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgY29tcGlsZXJIb29rcy5faGFyZFNvdXJjZVJlc2V0Q2FjaGUudGFwKCdIYXJkU291cmNlIC0gQXNzZXRDYWNoZScsICgpID0+IHtcbiAgICAgIGFzc2V0Q2FjaGUgPSB7fTtcbiAgICAgIHBhcml0eUNhY2hlID0ge307XG4gICAgfSk7XG5cbiAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlUmVhZENhY2hlLnRhcFByb21pc2UoXG4gICAgICAnSGFyZFNvdXJjZSAtIEFzc2V0Q2FjaGUnLFxuICAgICAgKCkgPT5cbiAgICAgICAgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgIGFzc2V0Q2FjaGVTZXJpYWxpemVyLnJlYWQoKS50aGVuKF9hc3NldENhY2hlID0+IHtcbiAgICAgICAgICAgIGFzc2V0Q2FjaGUgPSBfYXNzZXRDYWNoZTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBhc3NldFBhcml0eUNhY2hlU2VyaWFsaXplci5yZWFkKCkudGhlbihfcGFyaXR5Q2FjaGUgPT4ge1xuICAgICAgICAgICAgcGFyaXR5Q2FjaGUgPSBfcGFyaXR5Q2FjaGU7XG4gICAgICAgICAgfSksXG4gICAgICAgIF0pLFxuICAgICk7XG5cbiAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlUGFyaXR5Q2FjaGUudGFwKFxuICAgICAgJ0hhcmRTb3VyY2UgLSBBc3NldENhY2hlJyxcbiAgICAgIHBhcml0eVJvb3QgPT4ge1xuICAgICAgICBwYXJpdHlDYWNoZUZyb21DYWNoZSgnQXNzZXQnLCBwYXJpdHlSb290LCBwYXJpdHlDYWNoZSk7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlV3JpdGVDYWNoZS50YXBQcm9taXNlKFxuICAgICAgJ0hhcmRTb3VyY2UgLSBBc3NldENhY2hlJyxcbiAgICAgIGNvbXBpbGF0aW9uID0+IHtcbiAgICAgICAgY29uc3QgYXNzZXRPcHMgPSBhc3NldEFyY2hldHlwZUNhY2hlLm9wZXJhdGlvbnMoKTtcblxuICAgICAgICBjb25zdCBwYXJpdHlPcHMgPSBbXTtcbiAgICAgICAgcHVzaFBhcml0eVdyaXRlT3BzKGNvbXBpbGF0aW9uLCBwYXJpdHlPcHMpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgYXNzZXRDYWNoZVNlcmlhbGl6ZXIud3JpdGUoYXNzZXRPcHMpLFxuICAgICAgICAgIGFzc2V0UGFyaXR5Q2FjaGVTZXJpYWxpemVyLndyaXRlKHBhcml0eU9wcyksXG4gICAgICAgIF0pO1xuICAgICAgfSxcbiAgICApO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQXNzZXRDYWNoZTtcbiJdLCJzb3VyY2VSb290IjoiL1VzZXJzL3R5bGVyYXJidXMvZGV2L3Byb3ZpZGVyL3NyYyJ9
