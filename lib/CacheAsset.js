'use strict';

require('source-map-support/register');

const crypto = require('crypto');

const pluginCompat = require('./util/plugin-compat');
const relateContext = require('./util/relate-context');
const { parityCacheFromCache, pushParityWriteOps } = require('./util/parity');

function requestHash(request) {
  return crypto.createHash('sha1').update(request).digest().hexSlice();
}

const relateNormalRequest = relateContext.relateNormalRequest;

class AssetCache {
  apply(compiler) {
    const compilerHooks = pluginCompat.hooks(compiler);

    let assetCache = {};
    let parityCache = {};

    const assetArchetypeCache = {
      _ops: [],

      get(id) {
        const hashId = requestHash(relateNormalRequest(compiler, id));
        if (assetCache[hashId]) {
          if (typeof assetCache[hashId] === 'string') {
            assetCache[hashId] = JSON.parse(assetCache[hashId]);
          }
          return assetCache[hashId];
        }
      },

      set(id, item) {
        const hashId = requestHash(relateNormalRequest(compiler, id));
        if (item) {
          assetCache[hashId] = item;
          this._ops.push({
            key: hashId,
            value: item
          });
        } else {
          assetCache[hashId] = null;
          this._ops.push({
            key: hashId,
            value: null
          });
        }
      },

      operations() {
        const ops = this._ops.slice();
        this._ops.length = 0;
        return ops;
      }
    };

    compilerHooks._hardSourceArchetypeRegister.call('Asset', assetArchetypeCache);

    let assetCacheSerializer;
    let assetParityCacheSerializer;

    compilerHooks._hardSourceCreateSerializer.tap('HardSource - AssetCache', (cacheSerializerFactory, cacheDirPath) => {
      assetCacheSerializer = cacheSerializerFactory.create({
        name: 'assets',
        type: 'file',
        cacheDirPath
      });
      assetParityCacheSerializer = cacheSerializerFactory.create({
        name: 'assets-parity',
        type: 'data',
        cacheDirPath
      });
    });

    compilerHooks._hardSourceResetCache.tap('HardSource - AssetCache', () => {
      assetCache = {};
      parityCache = {};
    });

    compilerHooks._hardSourceReadCache.tapPromise('HardSource - AssetCache', () => Promise.all([assetCacheSerializer.read().then(_assetCache => {
      assetCache = _assetCache;
    }), assetParityCacheSerializer.read().then(_parityCache => {
      parityCache = _parityCache;
    })]));

    compilerHooks._hardSourceParityCache.tap('HardSource - AssetCache', parityRoot => {
      parityCacheFromCache('Asset', parityRoot, parityCache);
    });

    compilerHooks._hardSourceWriteCache.tapPromise('HardSource - AssetCache', compilation => {
      const assetOps = assetArchetypeCache.operations();

      const parityOps = [];
      pushParityWriteOps(compilation, parityOps);

      return Promise.all([assetCacheSerializer.write(assetOps), assetParityCacheSerializer.write(parityOps)]);
    });
  }
}

module.exports = AssetCache;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9DYWNoZUFzc2V0LmpzIl0sIm5hbWVzIjpbImNyeXB0byIsInJlcXVpcmUiLCJwbHVnaW5Db21wYXQiLCJyZWxhdGVDb250ZXh0IiwicGFyaXR5Q2FjaGVGcm9tQ2FjaGUiLCJwdXNoUGFyaXR5V3JpdGVPcHMiLCJyZXF1ZXN0SGFzaCIsInJlcXVlc3QiLCJjcmVhdGVIYXNoIiwidXBkYXRlIiwiZGlnZXN0IiwiaGV4U2xpY2UiLCJyZWxhdGVOb3JtYWxSZXF1ZXN0IiwiQXNzZXRDYWNoZSIsImFwcGx5IiwiY29tcGlsZXIiLCJjb21waWxlckhvb2tzIiwiaG9va3MiLCJhc3NldENhY2hlIiwicGFyaXR5Q2FjaGUiLCJhc3NldEFyY2hldHlwZUNhY2hlIiwiX29wcyIsImdldCIsImlkIiwiaGFzaElkIiwiSlNPTiIsInBhcnNlIiwic2V0IiwiaXRlbSIsInB1c2giLCJrZXkiLCJ2YWx1ZSIsIm9wZXJhdGlvbnMiLCJvcHMiLCJzbGljZSIsImxlbmd0aCIsIl9oYXJkU291cmNlQXJjaGV0eXBlUmVnaXN0ZXIiLCJjYWxsIiwiYXNzZXRDYWNoZVNlcmlhbGl6ZXIiLCJhc3NldFBhcml0eUNhY2hlU2VyaWFsaXplciIsIl9oYXJkU291cmNlQ3JlYXRlU2VyaWFsaXplciIsInRhcCIsImNhY2hlU2VyaWFsaXplckZhY3RvcnkiLCJjYWNoZURpclBhdGgiLCJjcmVhdGUiLCJuYW1lIiwidHlwZSIsIl9oYXJkU291cmNlUmVzZXRDYWNoZSIsIl9oYXJkU291cmNlUmVhZENhY2hlIiwidGFwUHJvbWlzZSIsIlByb21pc2UiLCJhbGwiLCJyZWFkIiwidGhlbiIsIl9hc3NldENhY2hlIiwiX3Bhcml0eUNhY2hlIiwiX2hhcmRTb3VyY2VQYXJpdHlDYWNoZSIsInBhcml0eVJvb3QiLCJfaGFyZFNvdXJjZVdyaXRlQ2FjaGUiLCJjb21waWxhdGlvbiIsImFzc2V0T3BzIiwicGFyaXR5T3BzIiwid3JpdGUiLCJtb2R1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Q0FBbUNDLFVBQW5DLENBQ0UseUJBREYsRUFFRSxNQUNFQyxRQUFRQyxHQUFSLENBQVksQ0FDVmIscUJBQXFCYyxJQUFyQixHQUE0QkMsSUFBNUIsQ0FBaUNDLGVBQWU7QUFDOUNwQyxtQkFBYW9DLFdBQWI7QUFDRCxLQUZELENBRFUsRUFJVmYsMkJBQTJCYSxJQUEzQixHQUFrQ0MsSUFBbEMsQ0FBdUNFLGdCQUFnQjtBQUNyRHBDLG9CQUFjb0MsWUFBZDtBQUNELEtBRkQsQ0FKVSxDQUFaLENBSEo7O0FBYUF2QyxrQkFBY3dDLHNCQUFkLENBQXFDZixHQUFyQyxDQUNFLHlCQURGLEVBRUVnQixjQUFjO0FBQ1pyRCwyQkFBcUIsT0FBckIsRUFBOEJxRCxVQUE5QixFQUEwQ3RDLFdBQTFDO0FBQ0QsS0FKSDs7QUFPQUgsa0JBQWMwQyxxQkFBZCxDQUFvQ1QsVUFBcEMsQ0FDRSx5QkFERixFQUVFVSxlQUFlO0FBQ2IsWUFBTUMsV0FBV3hDLG9CQUFvQlksVUFBcEIsRUFBakI7O0FBRUEsWUFBTTZCLFlBQVksRUFBbEI7QUFDQXhELHlCQUFtQnNELFdBQW5CLEVBQWdDRSxTQUFoQzs7QUFFQSxhQUFPWCxRQUFRQyxHQUFSLENBQVksQ0FDakJiLHFCQUFxQndCLEtBQXJCLENBQTJCRixRQUEzQixDQURpQixFQUVqQnJCLDJCQUEyQnVCLEtBQTNCLENBQWlDRCxTQUFqQyxDQUZpQixDQUFaLENBQVA7QUFJRCxLQVpIO0FBY0Q7QUEzR2M7O0FBOEdqQkUsT0FBT0MsT0FBUCxHQUFpQm5ELFVBQWpCIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9DYWNoZUFzc2V0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XG5cbmNvbnN0IHBsdWdpbkNvbXBhdCA9IHJlcXVpcmUoJy4vdXRpbC9wbHVnaW4tY29tcGF0Jyk7XG5jb25zdCByZWxhdGVDb250ZXh0ID0gcmVxdWlyZSgnLi91dGlsL3JlbGF0ZS1jb250ZXh0Jyk7XG5jb25zdCB7IHBhcml0eUNhY2hlRnJvbUNhY2hlLCBwdXNoUGFyaXR5V3JpdGVPcHMgfSA9IHJlcXVpcmUoJy4vdXRpbC9wYXJpdHknKTtcblxuZnVuY3Rpb24gcmVxdWVzdEhhc2gocmVxdWVzdCkge1xuICByZXR1cm4gY3J5cHRvXG4gICAgLmNyZWF0ZUhhc2goJ3NoYTEnKVxuICAgIC51cGRhdGUocmVxdWVzdClcbiAgICAuZGlnZXN0KClcbiAgICAuaGV4U2xpY2UoKTtcbn1cblxuY29uc3QgcmVsYXRlTm9ybWFsUmVxdWVzdCA9IHJlbGF0ZUNvbnRleHQucmVsYXRlTm9ybWFsUmVxdWVzdDtcblxuY2xhc3MgQXNzZXRDYWNoZSB7XG4gIGFwcGx5KGNvbXBpbGVyKSB7XG4gICAgY29uc3QgY29tcGlsZXJIb29rcyA9IHBsdWdpbkNvbXBhdC5ob29rcyhjb21waWxlcik7XG5cbiAgICBsZXQgYXNzZXRDYWNoZSA9IHt9O1xuICAgIGxldCBwYXJpdHlDYWNoZSA9IHt9O1xuXG4gICAgY29uc3QgYXNzZXRBcmNoZXR5cGVDYWNoZSA9IHtcbiAgICAgIF9vcHM6IFtdLFxuXG4gICAgICBnZXQoaWQpIHtcbiAgICAgICAgY29uc3QgaGFzaElkID0gcmVxdWVzdEhhc2gocmVsYXRlTm9ybWFsUmVxdWVzdChjb21waWxlciwgaWQpKTtcbiAgICAgICAgaWYgKGFzc2V0Q2FjaGVbaGFzaElkXSkge1xuICAgICAgICAgIGlmICh0eXBlb2YgYXNzZXRDYWNoZVtoYXNoSWRdID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgYXNzZXRDYWNoZVtoYXNoSWRdID0gSlNPTi5wYXJzZShhc3NldENhY2hlW2hhc2hJZF0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gYXNzZXRDYWNoZVtoYXNoSWRdO1xuICAgICAgICB9XG4gICAgICB9LFxuXG4gICAgICBzZXQoaWQsIGl0ZW0pIHtcbiAgICAgICAgY29uc3QgaGFzaElkID0gcmVxdWVzdEhhc2gocmVsYXRlTm9ybWFsUmVxdWVzdChjb21waWxlciwgaWQpKTtcbiAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICBhc3NldENhY2hlW2hhc2hJZF0gPSBpdGVtO1xuICAgICAgICAgIHRoaXMuX29wcy5wdXNoKHtcbiAgICAgICAgICAgIGtleTogaGFzaElkLFxuICAgICAgICAgICAgdmFsdWU6IGl0ZW0sXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXNzZXRDYWNoZVtoYXNoSWRdID0gbnVsbDtcbiAgICAgICAgICB0aGlzLl9vcHMucHVzaCh7XG4gICAgICAgICAgICBrZXk6IGhhc2hJZCxcbiAgICAgICAgICAgIHZhbHVlOiBudWxsLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9LFxuXG4gICAgICBvcGVyYXRpb25zKCkge1xuICAgICAgICBjb25zdCBvcHMgPSB0aGlzLl9vcHMuc2xpY2UoKTtcbiAgICAgICAgdGhpcy5fb3BzLmxlbmd0aCA9IDA7XG4gICAgICAgIHJldHVybiBvcHM7XG4gICAgICB9LFxuICAgIH07XG5cbiAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlQXJjaGV0eXBlUmVnaXN0ZXIuY2FsbChcbiAgICAgICdBc3NldCcsXG4gICAgICBhc3NldEFyY2hldHlwZUNhY2hlLFxuICAgICk7XG5cbiAgICBsZXQgYXNzZXRDYWNoZVNlcmlhbGl6ZXI7XG4gICAgbGV0IGFzc2V0UGFyaXR5Q2FjaGVTZXJpYWxpemVyO1xuXG4gICAgY29tcGlsZXJIb29rcy5faGFyZFNvdXJjZUNyZWF0ZVNlcmlhbGl6ZXIudGFwKFxuICAgICAgJ0hhcmRTb3VyY2UgLSBBc3NldENhY2hlJyxcbiAgICAgIChjYWNoZVNlcmlhbGl6ZXJGYWN0b3J5LCBjYWNoZURpclBhdGgpID0+IHtcbiAgICAgICAgYXNzZXRDYWNoZVNlcmlhbGl6ZXIgPSBjYWNoZVNlcmlhbGl6ZXJGYWN0b3J5LmNyZWF0ZSh7XG4gICAgICAgICAgbmFtZTogJ2Fzc2V0cycsXG4gICAgICAgICAgdHlwZTogJ2ZpbGUnLFxuICAgICAgICAgIGNhY2hlRGlyUGF0aCxcbiAgICAgICAgfSk7XG4gICAgICAgIGFzc2V0UGFyaXR5Q2FjaGVTZXJpYWxpemVyID0gY2FjaGVTZXJpYWxpemVyRmFjdG9yeS5jcmVhdGUoe1xuICAgICAgICAgIG5hbWU6ICdhc3NldHMtcGFyaXR5JyxcbiAgICAgICAgICB0eXBlOiAnZGF0YScsXG4gICAgICAgICAgY2FjaGVEaXJQYXRoLFxuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGNvbXBpbGVySG9va3MuX2hhcmRTb3VyY2VSZXNldENhY2hlLnRhcCgnSGFyZFNvdXJjZSAtIEFzc2V0Q2FjaGUnLCAoKSA9PiB7XG4gICAgICBhc3NldENhY2hlID0ge307XG4gICAgICBwYXJpdHlDYWNoZSA9IHt9O1xuICAgIH0pO1xuXG4gICAgY29tcGlsZXJIb29rcy5faGFyZFNvdXJjZVJlYWRDYWNoZS50YXBQcm9taXNlKFxuICAgICAgJ0hhcmRTb3VyY2UgLSBBc3NldENhY2hlJyxcbiAgICAgICgpID0+XG4gICAgICAgIFByb21pc2UuYWxsKFtcbiAgICAgICAgICBhc3NldENhY2hlU2VyaWFsaXplci5yZWFkKCkudGhlbihfYXNzZXRDYWNoZSA9PiB7XG4gICAgICAgICAgICBhc3NldENhY2hlID0gX2Fzc2V0Q2FjaGU7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgYXNzZXRQYXJpdHlDYWNoZVNlcmlhbGl6ZXIucmVhZCgpLnRoZW4oX3Bhcml0eUNhY2hlID0+IHtcbiAgICAgICAgICAgIHBhcml0eUNhY2hlID0gX3Bhcml0eUNhY2hlO1xuICAgICAgICAgIH0pLFxuICAgICAgICBdKSxcbiAgICApO1xuXG4gICAgY29tcGlsZXJIb29rcy5faGFyZFNvdXJjZVBhcml0eUNhY2hlLnRhcChcbiAgICAgICdIYXJkU291cmNlIC0gQXNzZXRDYWNoZScsXG4gICAgICBwYXJpdHlSb290ID0+IHtcbiAgICAgICAgcGFyaXR5Q2FjaGVGcm9tQ2FjaGUoJ0Fzc2V0JywgcGFyaXR5Um9vdCwgcGFyaXR5Q2FjaGUpO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgY29tcGlsZXJIb29rcy5faGFyZFNvdXJjZVdyaXRlQ2FjaGUudGFwUHJvbWlzZShcbiAgICAgICdIYXJkU291cmNlIC0gQXNzZXRDYWNoZScsXG4gICAgICBjb21waWxhdGlvbiA9PiB7XG4gICAgICAgIGNvbnN0IGFzc2V0T3BzID0gYXNzZXRBcmNoZXR5cGVDYWNoZS5vcGVyYXRpb25zKCk7XG5cbiAgICAgICAgY29uc3QgcGFyaXR5T3BzID0gW107XG4gICAgICAgIHB1c2hQYXJpdHlXcml0ZU9wcyhjb21waWxhdGlvbiwgcGFyaXR5T3BzKTtcblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgIGFzc2V0Q2FjaGVTZXJpYWxpemVyLndyaXRlKGFzc2V0T3BzKSxcbiAgICAgICAgICBhc3NldFBhcml0eUNhY2hlU2VyaWFsaXplci53cml0ZShwYXJpdHlPcHMpLFxuICAgICAgICBdKTtcbiAgICAgIH0sXG4gICAgKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEFzc2V0Q2FjaGU7XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
