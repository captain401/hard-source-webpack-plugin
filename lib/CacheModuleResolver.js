'use strict';

require('source-map-support/register');

const nodeObjectHash = require('node-object-hash');

const pluginCompat = require('./util/plugin-compat');
const relateContext = require('./util/relate-context');
const parseJson = require('./util/parseJson');
const { parityCacheFromCache, pushParityWriteOps } = require('./util/parity');

class ModuleResolverCache {
  apply(compiler) {
    let moduleResolveCache = {};
    let parityCache = {};

    let moduleResolveCacheChange = [];

    let moduleResolveCacheSerializer;

    const compilerHooks = pluginCompat.hooks(compiler);

    compilerHooks._hardSourceCreateSerializer.tap('HardSource - ModuleResolverCache', (cacheSerializerFactory, cacheDirPath) => {
      moduleResolveCacheSerializer = cacheSerializerFactory.create({
        name: 'module-resolve',
        type: 'data',
        autoParse: true,
        cacheDirPath
      });
    });

    compilerHooks._hardSourceResetCache.tap('HardSource - ModuleResolverCache', () => {
      moduleResolveCache = {};
      parityCache = {};
    });

    compilerHooks._hardSourceReadCache.tapPromise('HardSource - ModuleResolverCache', ({
      contextKeys,
      contextValues,
      contextNormalPath,
      contextNormalRequest,
      contextNormalModuleId,
      copyWithDeser
    }) => {
      function contextNormalModuleResolveKey(compiler, key) {
        if (key.startsWith('__hardSource_parityToken')) {
          return key;
        }
        const parsed = parseJson(key);
        if (Array.isArray(parsed)) {
          return JSON.stringify([parsed[0], contextNormalPath(compiler, parsed[1]), parsed[2]]);
        } else {
          return JSON.stringify(Object.assign({}, parsed, {
            context: contextNormalPath(compiler, parsed.context)
          }));
        }
      }

      function contextNormalModuleResolve(compiler, resolved, key) {
        if (key.startsWith('__hardSource_parityToken')) {
          parityCache[key] = resolved;
          return;
        }
        if (typeof resolved === 'string') {
          resolved = parseJson(resolved);
        }
        if (resolved.type === 'context') {
          return Object.assign({}, resolved, {
            identifier: contextNormalModuleId(compiler, resolved.identifier),
            resource: contextNormalRequest(compiler, resolved.resource)
          });
        }
        return Object.assign({}, resolved, {
          context: contextNormalRequest(compiler, resolved.context),
          request: contextNormalRequest(compiler, resolved.request),
          userRequest: contextNormalRequest(compiler, resolved.userRequest),
          rawRequest: contextNormalRequest(compiler, resolved.rawRequest),
          resource: contextNormalRequest(compiler, resolved.resource),
          loaders: resolved.loaders.map(loader => Object.assign({}, loader, {
            loader: contextNormalPath(compiler, loader.loader)
          }))
        });
      }

      return moduleResolveCacheSerializer.read().then(contextKeys(compiler, contextNormalModuleResolveKey)).then(contextValues(compiler, contextNormalModuleResolve)).then(copyWithDeser.bind(null, moduleResolveCache));
    });

    compilerHooks._hardSourceParityCache.tap('HardSource - ModuleResolverCache', parityRoot => {
      parityCacheFromCache('ModuleResolver', parityRoot, parityCache);
    });

    compilerHooks._hardSourceVerifyCache.tapPromise('HardSource - ModuleResolverCache', () => compiler.__hardSource_missingVerify.then(() => {
      const missingCache = compiler.__hardSource_missingCache;

      // Invalidate resolve cache items.
      Object.keys(moduleResolveCache).forEach(key => {
        const resolveKey = parseJson(key);
        const resolveItem = moduleResolveCache[key];
        let normalId = 'normal';
        if (resolveItem.resolveOptions) {
          normalId = `normal-${new nodeObjectHash({ sort: false }).hash(resolveItem.resolveOptions)}`;
        }
        if (resolveItem.type === 'context') {
          const contextMissing = missingCache.context[JSON.stringify([resolveKey.context, resolveItem.resource.split('?')[0]])];
          if (!contextMissing || contextMissing.invalid) {
            resolveItem.invalid = true;
            resolveItem.invalidReason = 'resolved context invalid';
          }
        } else {
          const normalMissing = missingCache[normalId] && missingCache[normalId][JSON.stringify([resolveKey[1], resolveItem.resource.split('?')[0]])];
          if (!normalMissing || normalMissing.invalid) {
            resolveItem.invalid = true;
            resolveItem.invalidReason = `resolved normal invalid${normalMissing ? ` ${normalMissing.invalidReason}` : ': resolve entry not in cache'}`;
          }
          resolveItem.loaders.forEach(loader => {
            if (typeof loader === 'object') {
              if (loader.loader != null) {
                loader = loader.loader;
              } else {
                // Convert { "0": "b", "1": "a", "2": "r" } into "bar"
                loader = Object.assign([], loader).join('');
              }
            }
            // Loaders specified in a dependency are searched for from the
            // context of the module containing that dependency.
            let loaderMissing = missingCache.loader[JSON.stringify([resolveKey[1], loader.split('?')[0]])];
            if (!loaderMissing) {
              // webpack searches for rule based loaders from the project
              // context.
              loaderMissing = missingCache.loader[JSON.stringify([
              // compiler may be a Watching instance, which refers to the
              // compiler
              (compiler.options || compiler.compiler.options).context, loader.split('?')[0]])];
            }
            if (!loaderMissing || loaderMissing.invalid) {
              resolveItem.invalid = true;
              resolveItem.invalidReason = 'resolved loader invalid';
            }
          });
        }
      });
    }));

    compilerHooks.compilation.tap('HardSource - ModuleResolverCache', compilation => {
      compilation.__hardSourceModuleResolveCache = moduleResolveCache;
      compilation.__hardSourceModuleResolveCacheChange = moduleResolveCacheChange;
    });

    compilerHooks._hardSourceWriteCache.tapPromise('HardSource - ModuleResolverCache', (compilation, { relateNormalPath, relateNormalModuleId, relateNormalRequest }) => {
      if (compilation.compiler.parentCompilation) {
        const moduleResolveOps = [];
        pushParityWriteOps(compilation, moduleResolveOps);

        return moduleResolveCacheSerializer.write(moduleResolveOps);
      }

      const moduleResolveOps = [];

      function relateNormalModuleResolveKey(compiler, key) {
        const parsed = parseJson(key);
        if (Array.isArray(parsed)) {
          return JSON.stringify([parsed[0], relateNormalPath(compiler, parsed[1]), relateContext.relateAbsoluteRequest(parsed[1], parsed[2])]);
        } else {
          if (!parsed.request) {
            return JSON.stringify(Object.assign({}, parsed, {
              context: relateNormalPath(compiler, parsed.context),
              userRequest: relateContext.relateAbsoluteRequest(parsed.context, parsed.userRequest),
              options: Object.assign({}, parsed.options, {
                request: relateContext.relateAbsoluteRequest(parsed.context, parsed.options.request)
              })
            }));
          } else {
            return JSON.stringify(Object.assign({}, parsed, {
              context: relateNormalPath(compiler, parsed.context),
              request: relateContext.relateAbsoluteRequest(parsed.context, parsed.request)
            }));
          }
        }
      }

      function relateNormalModuleResolve(compiler, resolved) {
        if (resolved.type === 'context') {
          return Object.assign({}, resolved, {
            identifier: relateNormalModuleId(compiler, resolved.identifier),
            resource: relateNormalRequest(compiler, resolved.resource)
          });
        }
        return Object.assign({}, resolved, {
          context: relateNormalRequest(compiler, resolved.context),
          request: relateNormalRequest(compiler, resolved.request),
          userRequest: relateNormalRequest(compiler, resolved.userRequest),
          rawRequest: relateNormalRequest(compiler, resolved.rawRequest),
          resource: relateNormalRequest(compiler, resolved.resource),
          loaders: resolved.loaders.map(loader => Object.assign({}, loader, {
            loader: relateNormalPath(compiler, loader.loader)
          }))
        });
      }

      moduleResolveCacheChange.reduce((carry, value) => {
        if (!carry.includes(value)) {
          carry.push(value);
        }
        return carry;
      }, []).forEach(key => {
        // console.log(key, moduleResolveCache[key]);
        // moduleResolveCache[key] && console.log(relateNormalModuleResolveKey(compiler, key));
        // moduleResolveCache[key] && console.log(relateNormalModuleResolve(compiler, moduleResolveCache[key]));
        moduleResolveOps.push({
          key: relateNormalModuleResolveKey(compiler, key),
          value: moduleResolveCache[key] ? relateNormalModuleResolve(compiler, moduleResolveCache[key]) : null
        });
      });

      moduleResolveCacheChange = [];

      pushParityWriteOps(compilation, moduleResolveOps);

      return moduleResolveCacheSerializer.write(moduleResolveOps);
    });
  }
}

module.exports = ModuleResolverCache;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9DYWNoZU1vZHVsZVJlc29sdmVyLmpzIl0sIm5hbWVzIjpbIm5vZGVPYmplY3RIYXNoIiwicmVxdWlyZSIsInBsdWdpbkNvbXBhdCIsInJlbGF0ZUNvbnRleHQiLCJwYXJzZUpzb24iLCJwYXJpdHlDYWNoZUZyb21DYWNoZSIsInB1c2hQYXJpdHlXcml0ZU9wcyIsIk1vZHVsZVJlc29sdmVyQ2FjaGUiLCJhcHBseSIsImNvbXBpbGVyIiwibW9kdWxlUmVzb2x2ZUNhY2hlIiwicGFyaXR5Q2FjaGUiLCJtb2R1bGVSZXNvbHZlQ2FjaGVDaGFuZ2UiLCJtb2R1bGVSZXNvbHZlQ2FjaGVTZXJpYWxpemVyIiwiY29tcGlsZXJIb29rcyIsImhvb2tzIiwiX2hhcmRTb3VyY2VDcmVhdGVTZXJpYWxpemVyIiwidGFwIiwiY2FjaGVTZXJpYWxpemVyRmFjdG9yeSIsImNhY2hlRGlyUGF0aCIsImNyZWF0ZSIsIm5hbWUiLCJ0eXBlIiwiYXV0b1BhcnNlIiwiX2hhcmRTb3VyY2VSZXNldENhY2hlIiwiX2hhcmRTb3VyY2VSZWFkQ2FjaGUiLCJ0YXBQcm9taXNlIiwiY29udGV4dEtleXMiLCJjb250ZXh0VmFsdWVzIiwiY29udGV4dE5vcm1hbFBhdGgiLCJjb250ZXh0Tm9ybWFsUmVxdWVzdCIsImNvbnRleHROb3JtYWxNb2R1bGVJZCIsImNvcHlXaXRoRGVzZXIiLCJjb250ZXh0Tm9ybWFsTW9kdWxlUmVzb2x2ZUtleSIsImtleSIsInN0YXJ0c1dpdGgiLCJwYXJzZWQiLCJBcnJheSIsImlzQXJyYXkiLCJKU09OIiwic3RyaW5naWZ5IiwiT2JqZWN0IiwiYXNzaWduIiwiY29udGV4dCIsImNvbnRleHROb3JtYWxNb2R1bGVSZXNvbHZlIiwicmVzb2x2ZWQiLCJpZGVudGlmaWVyIiwicmVzb3VyY2UiLCJyZXF1ZXN0IiwidXNlclJlcXVlc3QiLCJyYXdSZXF1ZXN0IiwibG9hZGVycyIsIm1hcCIsImxvYWRlciIsInJlYWQiLCJ0aGVuIiwiYmluZCIsIl9oYXJkU291cmNlUGFyaXR5Q2FjaGUiLCJwYXJpdHlSb290IiwiX2hhcmRTb3VyY2VWZXJpZnlDYWNoZSIsIl9faGFyZFNvdXJjZV9taXNzaW5nVmVyaWZ5IiwibWlzc2luZ0NhY2hlIiwiX19oYXJkU291cmNlX21pc3NpbmdDYWNoZSIsImtleXMiLCJmb3JFYWNoIiwicmVzb2x2ZUtleSIsInJlc29sdmVJdGVtIiwibm9ybWFsSWQiLCJyZXNvbHZlT3B0aW9ucyIsInNvcnQiLCJoYXNoIiwiY29udGV4dE1pc3NpbmciLCJzcGxpdCIsImludmFsaWQiLCJpbnZhbGlkUmVhc29uIiwibm9ybWFsTWlzc2luZyIsImpvaW4iLCJsb2FkZXJNaXNzaW5nIiwib3B0aW9ucyIsImNvbXBpbGF0aW9uIiwiX19oYXJkU291cmNlTW9kdWxlUmVzb2x2ZUNhY2hlIiwiX19oYXJkU291cmNlTW9kdWxlUmVzb2x2ZUNhY2hlQ2hhbmdlIiwiX2hhcmRTb3VyY2VXcml0ZUNhY2hlIiwicmVsYXRlTm9ybWFsUGF0aCIsInJlbGF0ZU5vcm1hbE1vZHVsZUlkIiwicmVsYXRlTm9ybWFsUmVxdWVzdCIsInBhcmVudENvbXBpbGF0aW9uIiwibW9kdWxlUmVzb2x2ZU9wcyIsIndyaXRlIiwicmVsYXRlTm9ybWFsTW9kdWxlUmVzb2x2ZUtleSIsInJlbGF0ZUFic29sdXRlUmVxdWVzdCIsInJlbGF0ZU5vcm1hbE1vZHVsZVJlc29sdmUiLCJyZWR1Y2UiLCJjYXJyeSIsInZhbHVlIiwiaW5jbHVkZXMiLCJwdXNoIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLGlCQUFpQkMsUUFBUSxrQkFBUixDQUF2Qjs7QUFFQSxNQUFNQyxlQUFlRCxRQUFRLHNCQUFSLENBQXJCO0FBQ0EsTUFBTUUsZ0JBQWdCRixRQUFRLHVCQUFSLENBQXRCO0FBQ0EsTUFBTUcsWUFBWUgsUUFBUSxrQkFBUixDQUFsQjtBQUNBLE1BQU0sRUFBRUksb0JBQUYsRUFBd0JDLGtCQUF4QixL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cEIsRUFBOEJvQyxTQUFTRSxRQUF2QyxDQUx1QjtBQU1qQ0ksbUJBQVNOLFNBQVNNLE9BQVQsQ0FBaUJDLEdBQWpCLENBQXFCQyxVQUM1QlosT0FBT0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JXLE1BQWxCLEVBQTBCO0FBQ3hCQSxvQkFBUThCLGlCQUFpQjFFLFFBQWpCLEVBQTJCNEMsT0FBT0EsTUFBbEM7QUFEZ0IsV0FBMUIsQ0FETztBQU53QixTQUE1QixDQUFQO0FBWUQ7O0FBRUR6QywrQkFDR2dGLE1BREgsQ0FDVSxDQUFDQyxLQUFELEVBQVFDLEtBQVIsS0FBa0I7QUFDeEIsWUFBSSxDQUFDRCxNQUFNRSxRQUFOLENBQWVELEtBQWYsQ0FBTCxFQUE0QjtBQUMxQkQsZ0JBQU1HLElBQU4sQ0FBV0YsS0FBWDtBQUNEO0FBQ0QsZUFBT0QsS0FBUDtBQUNELE9BTkgsRUFNSyxFQU5MLEVBT0c3QixPQVBILENBT1c5QixPQUFPO0FBQ2Q7QUFDQTtBQUNBO0FBQ0FxRCx5QkFBaUJTLElBQWpCLENBQXNCO0FBQ3BCOUQsZUFBS3VELDZCQUE2QmhGLFFBQTdCLEVBQXVDeUIsR0FBdkMsQ0FEZTtBQUVwQjRELGlCQUFPcEYsbUJBQW1Cd0IsR0FBbkIsSUFDSHlELDBCQUEwQmxGLFFBQTFCLEVBQW9DQyxtQkFBbUJ3QixHQUFuQixDQUFwQyxDQURHLEdBRUg7QUFKZ0IsU0FBdEI7QUFNRCxPQWpCSDs7QUFtQkF0QixpQ0FBMkIsRUFBM0I7O0FBRUFOLHlCQUFtQnlFLFdBQW5CLEVBQWdDUSxnQkFBaEM7O0FBRUEsYUFBTzFFLDZCQUE2QjJFLEtBQTdCLENBQW1DRCxnQkFBbkMsQ0FBUDtBQUNELEtBbkdIO0FBcUdEO0FBeFN1Qjs7QUEyUzFCVSxPQUFPQyxPQUFQLEdBQWlCM0YsbUJBQWpCIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9DYWNoZU1vZHVsZVJlc29sdmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgbm9kZU9iamVjdEhhc2ggPSByZXF1aXJlKCdub2RlLW9iamVjdC1oYXNoJyk7XG5cbmNvbnN0IHBsdWdpbkNvbXBhdCA9IHJlcXVpcmUoJy4vdXRpbC9wbHVnaW4tY29tcGF0Jyk7XG5jb25zdCByZWxhdGVDb250ZXh0ID0gcmVxdWlyZSgnLi91dGlsL3JlbGF0ZS1jb250ZXh0Jyk7XG5jb25zdCBwYXJzZUpzb24gPSByZXF1aXJlKCcuL3V0aWwvcGFyc2VKc29uJyk7XG5jb25zdCB7IHBhcml0eUNhY2hlRnJvbUNhY2hlLCBwdXNoUGFyaXR5V3JpdGVPcHMgfSA9IHJlcXVpcmUoJy4vdXRpbC9wYXJpdHknKTtcblxuY2xhc3MgTW9kdWxlUmVzb2x2ZXJDYWNoZSB7XG4gIGFwcGx5KGNvbXBpbGVyKSB7XG4gICAgbGV0IG1vZHVsZVJlc29sdmVDYWNoZSA9IHt9O1xuICAgIGxldCBwYXJpdHlDYWNoZSA9IHt9O1xuXG4gICAgbGV0IG1vZHVsZVJlc29sdmVDYWNoZUNoYW5nZSA9IFtdO1xuXG4gICAgbGV0IG1vZHVsZVJlc29sdmVDYWNoZVNlcmlhbGl6ZXI7XG5cbiAgICBjb25zdCBjb21waWxlckhvb2tzID0gcGx1Z2luQ29tcGF0Lmhvb2tzKGNvbXBpbGVyKTtcblxuICAgIGNvbXBpbGVySG9va3MuX2hhcmRTb3VyY2VDcmVhdGVTZXJpYWxpemVyLnRhcChcbiAgICAgICdIYXJkU291cmNlIC0gTW9kdWxlUmVzb2x2ZXJDYWNoZScsXG4gICAgICAoY2FjaGVTZXJpYWxpemVyRmFjdG9yeSwgY2FjaGVEaXJQYXRoKSA9PiB7XG4gICAgICAgIG1vZHVsZVJlc29sdmVDYWNoZVNlcmlhbGl6ZXIgPSBjYWNoZVNlcmlhbGl6ZXJGYWN0b3J5LmNyZWF0ZSh7XG4gICAgICAgICAgbmFtZTogJ21vZHVsZS1yZXNvbHZlJyxcbiAgICAgICAgICB0eXBlOiAnZGF0YScsXG4gICAgICAgICAgYXV0b1BhcnNlOiB0cnVlLFxuICAgICAgICAgIGNhY2hlRGlyUGF0aCxcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlUmVzZXRDYWNoZS50YXAoXG4gICAgICAnSGFyZFNvdXJjZSAtIE1vZHVsZVJlc29sdmVyQ2FjaGUnLFxuICAgICAgKCkgPT4ge1xuICAgICAgICBtb2R1bGVSZXNvbHZlQ2FjaGUgPSB7fTtcbiAgICAgICAgcGFyaXR5Q2FjaGUgPSB7fTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGNvbXBpbGVySG9va3MuX2hhcmRTb3VyY2VSZWFkQ2FjaGUudGFwUHJvbWlzZShcbiAgICAgICdIYXJkU291cmNlIC0gTW9kdWxlUmVzb2x2ZXJDYWNoZScsXG4gICAgICAoe1xuICAgICAgICBjb250ZXh0S2V5cyxcbiAgICAgICAgY29udGV4dFZhbHVlcyxcbiAgICAgICAgY29udGV4dE5vcm1hbFBhdGgsXG4gICAgICAgIGNvbnRleHROb3JtYWxSZXF1ZXN0LFxuICAgICAgICBjb250ZXh0Tm9ybWFsTW9kdWxlSWQsXG4gICAgICAgIGNvcHlXaXRoRGVzZXIsXG4gICAgICB9KSA9PiB7XG4gICAgICAgIGZ1bmN0aW9uIGNvbnRleHROb3JtYWxNb2R1bGVSZXNvbHZlS2V5KGNvbXBpbGVyLCBrZXkpIHtcbiAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJ19faGFyZFNvdXJjZV9wYXJpdHlUb2tlbicpKSB7XG4gICAgICAgICAgICByZXR1cm4ga2V5O1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBwYXJzZWQgPSBwYXJzZUpzb24oa2V5KTtcbiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShwYXJzZWQpKSB7XG4gICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoW1xuICAgICAgICAgICAgICBwYXJzZWRbMF0sXG4gICAgICAgICAgICAgIGNvbnRleHROb3JtYWxQYXRoKGNvbXBpbGVyLCBwYXJzZWRbMV0pLFxuICAgICAgICAgICAgICBwYXJzZWRbMl0sXG4gICAgICAgICAgICBdKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHt9LCBwYXJzZWQsIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0OiBjb250ZXh0Tm9ybWFsUGF0aChjb21waWxlciwgcGFyc2VkLmNvbnRleHQpLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gY29udGV4dE5vcm1hbE1vZHVsZVJlc29sdmUoY29tcGlsZXIsIHJlc29sdmVkLCBrZXkpIHtcbiAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJ19faGFyZFNvdXJjZV9wYXJpdHlUb2tlbicpKSB7XG4gICAgICAgICAgICBwYXJpdHlDYWNoZVtrZXldID0gcmVzb2x2ZWQ7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh0eXBlb2YgcmVzb2x2ZWQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICByZXNvbHZlZCA9IHBhcnNlSnNvbihyZXNvbHZlZCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXNvbHZlZC50eXBlID09PSAnY29udGV4dCcpIHtcbiAgICAgICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCByZXNvbHZlZCwge1xuICAgICAgICAgICAgICBpZGVudGlmaWVyOiBjb250ZXh0Tm9ybWFsTW9kdWxlSWQoY29tcGlsZXIsIHJlc29sdmVkLmlkZW50aWZpZXIpLFxuICAgICAgICAgICAgICByZXNvdXJjZTogY29udGV4dE5vcm1hbFJlcXVlc3QoY29tcGlsZXIsIHJlc29sdmVkLnJlc291cmNlKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgcmVzb2x2ZWQsIHtcbiAgICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHROb3JtYWxSZXF1ZXN0KGNvbXBpbGVyLCByZXNvbHZlZC5jb250ZXh0KSxcbiAgICAgICAgICAgIHJlcXVlc3Q6IGNvbnRleHROb3JtYWxSZXF1ZXN0KGNvbXBpbGVyLCByZXNvbHZlZC5yZXF1ZXN0KSxcbiAgICAgICAgICAgIHVzZXJSZXF1ZXN0OiBjb250ZXh0Tm9ybWFsUmVxdWVzdChjb21waWxlciwgcmVzb2x2ZWQudXNlclJlcXVlc3QpLFxuICAgICAgICAgICAgcmF3UmVxdWVzdDogY29udGV4dE5vcm1hbFJlcXVlc3QoY29tcGlsZXIsIHJlc29sdmVkLnJhd1JlcXVlc3QpLFxuICAgICAgICAgICAgcmVzb3VyY2U6IGNvbnRleHROb3JtYWxSZXF1ZXN0KGNvbXBpbGVyLCByZXNvbHZlZC5yZXNvdXJjZSksXG4gICAgICAgICAgICBsb2FkZXJzOiByZXNvbHZlZC5sb2FkZXJzLm1hcChsb2FkZXIgPT5cbiAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih7fSwgbG9hZGVyLCB7XG4gICAgICAgICAgICAgICAgbG9hZGVyOiBjb250ZXh0Tm9ybWFsUGF0aChjb21waWxlciwgbG9hZGVyLmxvYWRlciksXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBtb2R1bGVSZXNvbHZlQ2FjaGVTZXJpYWxpemVyXG4gICAgICAgICAgLnJlYWQoKVxuICAgICAgICAgIC50aGVuKGNvbnRleHRLZXlzKGNvbXBpbGVyLCBjb250ZXh0Tm9ybWFsTW9kdWxlUmVzb2x2ZUtleSkpXG4gICAgICAgICAgLnRoZW4oY29udGV4dFZhbHVlcyhjb21waWxlciwgY29udGV4dE5vcm1hbE1vZHVsZVJlc29sdmUpKVxuICAgICAgICAgIC50aGVuKGNvcHlXaXRoRGVzZXIuYmluZChudWxsLCBtb2R1bGVSZXNvbHZlQ2FjaGUpKTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGNvbXBpbGVySG9va3MuX2hhcmRTb3VyY2VQYXJpdHlDYWNoZS50YXAoXG4gICAgICAnSGFyZFNvdXJjZSAtIE1vZHVsZVJlc29sdmVyQ2FjaGUnLFxuICAgICAgcGFyaXR5Um9vdCA9PiB7XG4gICAgICAgIHBhcml0eUNhY2hlRnJvbUNhY2hlKCdNb2R1bGVSZXNvbHZlcicsIHBhcml0eVJvb3QsIHBhcml0eUNhY2hlKTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGNvbXBpbGVySG9va3MuX2hhcmRTb3VyY2VWZXJpZnlDYWNoZS50YXBQcm9taXNlKFxuICAgICAgJ0hhcmRTb3VyY2UgLSBNb2R1bGVSZXNvbHZlckNhY2hlJyxcbiAgICAgICgpID0+XG4gICAgICAgIGNvbXBpbGVyLl9faGFyZFNvdXJjZV9taXNzaW5nVmVyaWZ5LnRoZW4oKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IG1pc3NpbmdDYWNoZSA9IGNvbXBpbGVyLl9faGFyZFNvdXJjZV9taXNzaW5nQ2FjaGU7XG5cbiAgICAgICAgICAvLyBJbnZhbGlkYXRlIHJlc29sdmUgY2FjaGUgaXRlbXMuXG4gICAgICAgICAgT2JqZWN0LmtleXMobW9kdWxlUmVzb2x2ZUNhY2hlKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXNvbHZlS2V5ID0gcGFyc2VKc29uKGtleSk7XG4gICAgICAgICAgICBjb25zdCByZXNvbHZlSXRlbSA9IG1vZHVsZVJlc29sdmVDYWNoZVtrZXldO1xuICAgICAgICAgICAgbGV0IG5vcm1hbElkID0gJ25vcm1hbCc7XG4gICAgICAgICAgICBpZiAocmVzb2x2ZUl0ZW0ucmVzb2x2ZU9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgbm9ybWFsSWQgPSBgbm9ybWFsLSR7bmV3IG5vZGVPYmplY3RIYXNoKHsgc29ydDogZmFsc2UgfSkuaGFzaChcbiAgICAgICAgICAgICAgICByZXNvbHZlSXRlbS5yZXNvbHZlT3B0aW9ucyxcbiAgICAgICAgICAgICAgKX1gO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc29sdmVJdGVtLnR5cGUgPT09ICdjb250ZXh0Jykge1xuICAgICAgICAgICAgICBjb25zdCBjb250ZXh0TWlzc2luZyA9XG4gICAgICAgICAgICAgICAgbWlzc2luZ0NhY2hlLmNvbnRleHRbXG4gICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShbXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmVLZXkuY29udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZUl0ZW0ucmVzb3VyY2Uuc3BsaXQoJz8nKVswXSxcbiAgICAgICAgICAgICAgICAgIF0pXG4gICAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgICAgaWYgKCFjb250ZXh0TWlzc2luZyB8fCBjb250ZXh0TWlzc2luZy5pbnZhbGlkKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZUl0ZW0uaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZUl0ZW0uaW52YWxpZFJlYXNvbiA9ICdyZXNvbHZlZCBjb250ZXh0IGludmFsaWQnO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBjb25zdCBub3JtYWxNaXNzaW5nID1cbiAgICAgICAgICAgICAgICBtaXNzaW5nQ2FjaGVbbm9ybWFsSWRdICYmXG4gICAgICAgICAgICAgICAgbWlzc2luZ0NhY2hlW25vcm1hbElkXVtcbiAgICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KFtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZUtleVsxXSxcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZUl0ZW0ucmVzb3VyY2Uuc3BsaXQoJz8nKVswXSxcbiAgICAgICAgICAgICAgICAgIF0pXG4gICAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgICAgaWYgKCFub3JtYWxNaXNzaW5nIHx8IG5vcm1hbE1pc3NpbmcuaW52YWxpZCkge1xuICAgICAgICAgICAgICAgIHJlc29sdmVJdGVtLmludmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHJlc29sdmVJdGVtLmludmFsaWRSZWFzb24gPSBgcmVzb2x2ZWQgbm9ybWFsIGludmFsaWQke1xuICAgICAgICAgICAgICAgICAgbm9ybWFsTWlzc2luZ1xuICAgICAgICAgICAgICAgICAgICA/IGAgJHtub3JtYWxNaXNzaW5nLmludmFsaWRSZWFzb259YFxuICAgICAgICAgICAgICAgICAgICA6ICc6IHJlc29sdmUgZW50cnkgbm90IGluIGNhY2hlJ1xuICAgICAgICAgICAgICAgIH1gO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJlc29sdmVJdGVtLmxvYWRlcnMuZm9yRWFjaChsb2FkZXIgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbG9hZGVyID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgICAgaWYgKGxvYWRlci5sb2FkZXIgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBsb2FkZXIgPSBsb2FkZXIubG9hZGVyO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gQ29udmVydCB7IFwiMFwiOiBcImJcIiwgXCIxXCI6IFwiYVwiLCBcIjJcIjogXCJyXCIgfSBpbnRvIFwiYmFyXCJcbiAgICAgICAgICAgICAgICAgICAgbG9hZGVyID0gT2JqZWN0LmFzc2lnbihbXSwgbG9hZGVyKS5qb2luKCcnKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gTG9hZGVycyBzcGVjaWZpZWQgaW4gYSBkZXBlbmRlbmN5IGFyZSBzZWFyY2hlZCBmb3IgZnJvbSB0aGVcbiAgICAgICAgICAgICAgICAvLyBjb250ZXh0IG9mIHRoZSBtb2R1bGUgY29udGFpbmluZyB0aGF0IGRlcGVuZGVuY3kuXG4gICAgICAgICAgICAgICAgbGV0IGxvYWRlck1pc3NpbmcgPVxuICAgICAgICAgICAgICAgICAgbWlzc2luZ0NhY2hlLmxvYWRlcltcbiAgICAgICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoW3Jlc29sdmVLZXlbMV0sIGxvYWRlci5zcGxpdCgnPycpWzBdXSlcbiAgICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICAgICAgaWYgKCFsb2FkZXJNaXNzaW5nKSB7XG4gICAgICAgICAgICAgICAgICAvLyB3ZWJwYWNrIHNlYXJjaGVzIGZvciBydWxlIGJhc2VkIGxvYWRlcnMgZnJvbSB0aGUgcHJvamVjdFxuICAgICAgICAgICAgICAgICAgLy8gY29udGV4dC5cbiAgICAgICAgICAgICAgICAgIGxvYWRlck1pc3NpbmcgPVxuICAgICAgICAgICAgICAgICAgICBtaXNzaW5nQ2FjaGUubG9hZGVyW1xuICAgICAgICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KFtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbXBpbGVyIG1heSBiZSBhIFdhdGNoaW5nIGluc3RhbmNlLCB3aGljaCByZWZlcnMgdG8gdGhlXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBjb21waWxlclxuICAgICAgICAgICAgICAgICAgICAgICAgKGNvbXBpbGVyLm9wdGlvbnMgfHwgY29tcGlsZXIuY29tcGlsZXIub3B0aW9ucykuY29udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRlci5zcGxpdCgnPycpWzBdLFxuICAgICAgICAgICAgICAgICAgICAgIF0pXG4gICAgICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghbG9hZGVyTWlzc2luZyB8fCBsb2FkZXJNaXNzaW5nLmludmFsaWQpIHtcbiAgICAgICAgICAgICAgICAgIHJlc29sdmVJdGVtLmludmFsaWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgcmVzb2x2ZUl0ZW0uaW52YWxpZFJlYXNvbiA9ICdyZXNvbHZlZCBsb2FkZXIgaW52YWxpZCc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSksXG4gICAgKTtcblxuICAgIGNvbXBpbGVySG9va3MuY29tcGlsYXRpb24udGFwKFxuICAgICAgJ0hhcmRTb3VyY2UgLSBNb2R1bGVSZXNvbHZlckNhY2hlJyxcbiAgICAgIGNvbXBpbGF0aW9uID0+IHtcbiAgICAgICAgY29tcGlsYXRpb24uX19oYXJkU291cmNlTW9kdWxlUmVzb2x2ZUNhY2hlID0gbW9kdWxlUmVzb2x2ZUNhY2hlO1xuICAgICAgICBjb21waWxhdGlvbi5fX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGVDaGFuZ2UgPSBtb2R1bGVSZXNvbHZlQ2FjaGVDaGFuZ2U7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlV3JpdGVDYWNoZS50YXBQcm9taXNlKFxuICAgICAgJ0hhcmRTb3VyY2UgLSBNb2R1bGVSZXNvbHZlckNhY2hlJyxcbiAgICAgIChcbiAgICAgICAgY29tcGlsYXRpb24sXG4gICAgICAgIHsgcmVsYXRlTm9ybWFsUGF0aCwgcmVsYXRlTm9ybWFsTW9kdWxlSWQsIHJlbGF0ZU5vcm1hbFJlcXVlc3QgfSxcbiAgICAgICkgPT4ge1xuICAgICAgICBpZiAoY29tcGlsYXRpb24uY29tcGlsZXIucGFyZW50Q29tcGlsYXRpb24pIHtcbiAgICAgICAgICBjb25zdCBtb2R1bGVSZXNvbHZlT3BzID0gW107XG4gICAgICAgICAgcHVzaFBhcml0eVdyaXRlT3BzKGNvbXBpbGF0aW9uLCBtb2R1bGVSZXNvbHZlT3BzKTtcblxuICAgICAgICAgIHJldHVybiBtb2R1bGVSZXNvbHZlQ2FjaGVTZXJpYWxpemVyLndyaXRlKG1vZHVsZVJlc29sdmVPcHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbW9kdWxlUmVzb2x2ZU9wcyA9IFtdO1xuXG4gICAgICAgIGZ1bmN0aW9uIHJlbGF0ZU5vcm1hbE1vZHVsZVJlc29sdmVLZXkoY29tcGlsZXIsIGtleSkge1xuICAgICAgICAgIGNvbnN0IHBhcnNlZCA9IHBhcnNlSnNvbihrZXkpO1xuICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhcnNlZCkpIHtcbiAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShbXG4gICAgICAgICAgICAgIHBhcnNlZFswXSxcbiAgICAgICAgICAgICAgcmVsYXRlTm9ybWFsUGF0aChjb21waWxlciwgcGFyc2VkWzFdKSxcbiAgICAgICAgICAgICAgcmVsYXRlQ29udGV4dC5yZWxhdGVBYnNvbHV0ZVJlcXVlc3QocGFyc2VkWzFdLCBwYXJzZWRbMl0pLFxuICAgICAgICAgICAgXSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghcGFyc2VkLnJlcXVlc3QpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oe30sIHBhcnNlZCwge1xuICAgICAgICAgICAgICAgICAgY29udGV4dDogcmVsYXRlTm9ybWFsUGF0aChjb21waWxlciwgcGFyc2VkLmNvbnRleHQpLFxuICAgICAgICAgICAgICAgICAgdXNlclJlcXVlc3Q6IHJlbGF0ZUNvbnRleHQucmVsYXRlQWJzb2x1dGVSZXF1ZXN0KFxuICAgICAgICAgICAgICAgICAgICBwYXJzZWQuY29udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgcGFyc2VkLnVzZXJSZXF1ZXN0LFxuICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IE9iamVjdC5hc3NpZ24oe30sIHBhcnNlZC5vcHRpb25zLCB7XG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3Q6IHJlbGF0ZUNvbnRleHQucmVsYXRlQWJzb2x1dGVSZXF1ZXN0KFxuICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZC5jb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZC5vcHRpb25zLnJlcXVlc3QsXG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHt9LCBwYXJzZWQsIHtcbiAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IHJlbGF0ZU5vcm1hbFBhdGgoY29tcGlsZXIsIHBhcnNlZC5jb250ZXh0KSxcbiAgICAgICAgICAgICAgICAgIHJlcXVlc3Q6IHJlbGF0ZUNvbnRleHQucmVsYXRlQWJzb2x1dGVSZXF1ZXN0KFxuICAgICAgICAgICAgICAgICAgICBwYXJzZWQuY29udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgcGFyc2VkLnJlcXVlc3QsXG4gICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIHJlbGF0ZU5vcm1hbE1vZHVsZVJlc29sdmUoY29tcGlsZXIsIHJlc29sdmVkKSB7XG4gICAgICAgICAgaWYgKHJlc29sdmVkLnR5cGUgPT09ICdjb250ZXh0Jykge1xuICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHJlc29sdmVkLCB7XG4gICAgICAgICAgICAgIGlkZW50aWZpZXI6IHJlbGF0ZU5vcm1hbE1vZHVsZUlkKGNvbXBpbGVyLCByZXNvbHZlZC5pZGVudGlmaWVyKSxcbiAgICAgICAgICAgICAgcmVzb3VyY2U6IHJlbGF0ZU5vcm1hbFJlcXVlc3QoY29tcGlsZXIsIHJlc29sdmVkLnJlc291cmNlKSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgcmVzb2x2ZWQsIHtcbiAgICAgICAgICAgIGNvbnRleHQ6IHJlbGF0ZU5vcm1hbFJlcXVlc3QoY29tcGlsZXIsIHJlc29sdmVkLmNvbnRleHQpLFxuICAgICAgICAgICAgcmVxdWVzdDogcmVsYXRlTm9ybWFsUmVxdWVzdChjb21waWxlciwgcmVzb2x2ZWQucmVxdWVzdCksXG4gICAgICAgICAgICB1c2VyUmVxdWVzdDogcmVsYXRlTm9ybWFsUmVxdWVzdChjb21waWxlciwgcmVzb2x2ZWQudXNlclJlcXVlc3QpLFxuICAgICAgICAgICAgcmF3UmVxdWVzdDogcmVsYXRlTm9ybWFsUmVxdWVzdChjb21waWxlciwgcmVzb2x2ZWQucmF3UmVxdWVzdCksXG4gICAgICAgICAgICByZXNvdXJjZTogcmVsYXRlTm9ybWFsUmVxdWVzdChjb21waWxlciwgcmVzb2x2ZWQucmVzb3VyY2UpLFxuICAgICAgICAgICAgbG9hZGVyczogcmVzb2x2ZWQubG9hZGVycy5tYXAobG9hZGVyID0+XG4gICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oe30sIGxvYWRlciwge1xuICAgICAgICAgICAgICAgIGxvYWRlcjogcmVsYXRlTm9ybWFsUGF0aChjb21waWxlciwgbG9hZGVyLmxvYWRlciksXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIG1vZHVsZVJlc29sdmVDYWNoZUNoYW5nZVxuICAgICAgICAgIC5yZWR1Y2UoKGNhcnJ5LCB2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFjYXJyeS5pbmNsdWRlcyh2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgY2FycnkucHVzaCh2YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gY2Fycnk7XG4gICAgICAgICAgfSwgW10pXG4gICAgICAgICAgLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGtleSwgbW9kdWxlUmVzb2x2ZUNhY2hlW2tleV0pO1xuICAgICAgICAgICAgLy8gbW9kdWxlUmVzb2x2ZUNhY2hlW2tleV0gJiYgY29uc29sZS5sb2cocmVsYXRlTm9ybWFsTW9kdWxlUmVzb2x2ZUtleShjb21waWxlciwga2V5KSk7XG4gICAgICAgICAgICAvLyBtb2R1bGVSZXNvbHZlQ2FjaGVba2V5XSAmJiBjb25zb2xlLmxvZyhyZWxhdGVOb3JtYWxNb2R1bGVSZXNvbHZlKGNvbXBpbGVyLCBtb2R1bGVSZXNvbHZlQ2FjaGVba2V5XSkpO1xuICAgICAgICAgICAgbW9kdWxlUmVzb2x2ZU9wcy5wdXNoKHtcbiAgICAgICAgICAgICAga2V5OiByZWxhdGVOb3JtYWxNb2R1bGVSZXNvbHZlS2V5KGNvbXBpbGVyLCBrZXkpLFxuICAgICAgICAgICAgICB2YWx1ZTogbW9kdWxlUmVzb2x2ZUNhY2hlW2tleV1cbiAgICAgICAgICAgICAgICA/IHJlbGF0ZU5vcm1hbE1vZHVsZVJlc29sdmUoY29tcGlsZXIsIG1vZHVsZVJlc29sdmVDYWNoZVtrZXldKVxuICAgICAgICAgICAgICAgIDogbnVsbCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuXG4gICAgICAgIG1vZHVsZVJlc29sdmVDYWNoZUNoYW5nZSA9IFtdO1xuXG4gICAgICAgIHB1c2hQYXJpdHlXcml0ZU9wcyhjb21waWxhdGlvbiwgbW9kdWxlUmVzb2x2ZU9wcyk7XG5cbiAgICAgICAgcmV0dXJuIG1vZHVsZVJlc29sdmVDYWNoZVNlcmlhbGl6ZXIud3JpdGUobW9kdWxlUmVzb2x2ZU9wcyk7XG4gICAgICB9LFxuICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNb2R1bGVSZXNvbHZlckNhY2hlO1xuIl0sInNvdXJjZVJvb3QiOiIvVXNlcnMvdHlsZXJhcmJ1cy9kZXYvcHJvdmlkZXIvc3JjIn0=
