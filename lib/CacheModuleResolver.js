'use strict';

const nodeObjectHash = require('node-object-hash');

const serial = require('./util/serial');
const pluginCompat = require('./util/plugin-compat');
const relateContext = require('./util/relate-context');
const parseJson = require('./util/parseJson');
const { parityCacheFromCache, pushParityWriteOps } = require('./util/parity');

const serialJsonKey = {
  freeze(arg, value, extra) {
    return JSON.parse(arg);
  },
  thaw(arg, frozen, extra) {
    return JSON.stringify(arg);
  }
};

const serialJson = {
  freeze(arg, value, extra) {
    return JSON.stringify(arg);
  },
  thaw(arg, frozen, extra) {
    return JSON.parse(arg);
  }
};

const serialObjectAssign = serial.objectAssign;

const serialResolveOptionsKey = serialObjectAssign({
  context: serial.path,
  userRequest: serial.request,
  options: serialObjectAssign({
    request: serial.request
  })
});

const serialResolveKey = serialObjectAssign({
  context: serial.path,
  request: serial.request
});

const serialNormalModuleResolveKey = serial.pipe(serialJsonKey, {
  freeze(arg, key, extra) {
    if (Array.isArray(arg)) {
      return [arg[0], serial.path.freeze(arg[1], arg[1], extra), serial.request.freeze(arg[2], arg[2], extra)];
    } else if (!arg.request) {
      return serialResolveOptionsKey.freeze(arg, arg, extra);
    } else {
      return serialResolveKey.freeze(arg, arg, extra);
    }
  },
  thaw(arg, frozen, extra) {
    if (Array.isArray(arg)) {
      return [arg[0], serial.path.thaw(arg[1], arg[1], extra), serial.request.thaw(arg[2], arg[2], extra)];
    } else if (!arg.request) {
      return serialResolveOptionsKey.thaw(arg, arg, extra);
    } else {
      return serialResolveKey.thaw(arg, arg, extra);
    }
  }
}, serialJson);

const serialNormalModuleId = {
  freeze(arg, module, extra) {
    return id.substring(0, 24) + serial.request.freeze(id.substring(24), id, extra);
  },
  thaw(arg, frozen, extra) {
    return id.substring(0, 24) + serial.request.thaw(id.substring(24), id, extra);
  }
};

const serialResolveContext = serialObjectAssign({
  identifier: serialNormalModuleId,
  resource: serialNormalModuleId
});

const serialResolveNormal = serialObjectAssign({
  context: serial.path,
  request: serial.request,
  userRequest: serial.request,
  rawRequest: serial.request,
  resource: serial.request,
  loaders: serial.loaders,
  resourceResolveData: serial.objectAssign({
    context: serial.created({
      issuer: serial.request,
      resolveOptions: serial.identity
    }),
    path: serial.path,
    request: serial.request,
    descriptionFilePath: serial.path,
    descriptionFileRoot: serial.path
  })
});

const serialResolve = {
  freeze(arg, module, extra) {
    if (arg.type === 'context') {
      return serialResolveContext.freeze(arg, arg, extra);
    }
    return serialResolveNormal.freeze(arg, arg, extra);
  },
  thaw(arg, frozen, extra) {
    if (arg.type === 'context') {
      return serialResolveContext.thaw(arg, arg, extra);
    }
    return serialResolveNormal.thaw(arg, arg, extra);
  }
};

class ModuleResolverCache {
  apply(compiler) {
    let moduleResolveCache = {};
    let parityCache = {};

    let moduleResolveCacheChange = [];

    let moduleResolveCacheSerializer;

    const compilerHooks = pluginCompat.hooks(compiler);

    compilerHooks._hardSourceCreateSerializer.tap('HardSource - ModuleResolverCache', (cacheSerializerFactory, cacheDirPath) => {
      moduleResolveCacheSerializer = cacheSerializerFactory.create({
        name: 'module-resolve',
        type: 'data',
        autoParse: true,
        cacheDirPath
      });
    });

    compilerHooks._hardSourceResetCache.tap('HardSource - ModuleResolverCache', () => {
      moduleResolveCache = {};
      parityCache = {};
    });

    compilerHooks._hardSourceReadCache.tapPromise('HardSource - ModuleResolverCache', ({
      contextKeys,
      contextValues,
      contextNormalPath,
      contextNormalRequest,
      contextNormalModuleId,
      copyWithDeser
    }) => {
      function contextNormalModuleResolveKey(compiler, key) {
        if (key.startsWith('__hardSource_parityToken')) {
          return key;
        }
        const parsed = parseJson(key);
        if (Array.isArray(parsed)) {
          return JSON.stringify([parsed[0], contextNormalPath(compiler, parsed[1]), parsed[2]]);
        } else {
          return JSON.stringify(Object.assign({}, parsed, {
            context: contextNormalPath(compiler, parsed.context)
          }));
        }
      }

      function contextNormalModuleResolve(compiler, resolved, key) {
        if (key.startsWith('__hardSource_parityToken')) {
          parityCache[key] = resolved;
          return;
        }
        if (typeof resolved === 'string') {
          resolved = parseJson(resolved);
        }
        if (resolved.type === 'context') {
          return Object.assign({}, resolved, {
            identifier: contextNormalModuleId(compiler, resolved.identifier),
            resource: contextNormalRequest(compiler, resolved.resource)
          });
        }
        return serialResolveNormal.thaw(resolved, resolved, {
          compiler
        });
      }

      return moduleResolveCacheSerializer.read().then(contextKeys(compiler, contextNormalModuleResolveKey)).then(contextValues(compiler, contextNormalModuleResolve)).then(copyWithDeser.bind(null, moduleResolveCache));
    });

    compilerHooks._hardSourceParityCache.tap('HardSource - ModuleResolverCache', parityRoot => {
      parityCacheFromCache('ModuleResolver', parityRoot, parityCache);
    });

    compilerHooks._hardSourceVerifyCache.tapPromise('HardSource - ModuleResolverCache', () => compiler.__hardSource_missingVerify.then(() => {
      const missingCache = compiler.__hardSource_missingCache;

      // Invalidate resolve cache items.
      Object.keys(moduleResolveCache).forEach(key => {
        const resolveKey = parseJson(key);
        const resolveItem = moduleResolveCache[key];
        let normalId = 'normal';
        if (resolveItem.resolveOptions) {
          normalId = `normal-${new nodeObjectHash({ sort: false }).hash(resolveItem.resolveOptions)}`;
        }
        if (resolveItem.type === 'context') {
          const contextMissing = missingCache.context[JSON.stringify([resolveKey.context, resolveItem.resource.split('?')[0]])];
          if (!contextMissing || contextMissing.invalid) {
            resolveItem.invalid = true;
            resolveItem.invalidReason = 'resolved context invalid';
          }
        } else {
          const normalMissing = missingCache[normalId] && missingCache[normalId][JSON.stringify([resolveKey[1], resolveItem.resource.split('?')[0]])];
          if (!normalMissing || normalMissing.invalid) {
            resolveItem.invalid = true;
            resolveItem.invalidReason = `resolved normal invalid${normalMissing ? ` ${normalMissing.invalidReason}` : ': resolve entry not in cache'}`;
          }
          resolveItem.loaders.forEach(loader => {
            if (typeof loader === 'object') {
              if (loader.loader != null) {
                loader = loader.loader;
              } else {
                // Convert { "0": "b", "1": "a", "2": "r" } into "bar"
                loader = Object.assign([], loader).join('');
              }
            }
            // Loaders specified in a dependency are searched for from the
            // context of the module containing that dependency.
            let loaderMissing = missingCache.loader[JSON.stringify([resolveKey[1], loader.split('?')[0]])];
            if (!loaderMissing) {
              // webpack searches for rule based loaders from the project
              // context.
              loaderMissing = missingCache.loader[JSON.stringify([
              // compiler may be a Watching instance, which refers to the
              // compiler
              (compiler.options || compiler.compiler.options).context, loader.split('?')[0]])];
            }
            if (!loaderMissing || loaderMissing.invalid) {
              resolveItem.invalid = true;
              resolveItem.invalidReason = 'resolved loader invalid';
            }
          });
        }
      });
    }));

    compilerHooks.compilation.tap('HardSource - ModuleResolverCache', compilation => {
      compilation.__hardSourceModuleResolveCache = moduleResolveCache;
      compilation.__hardSourceModuleResolveCacheChange = moduleResolveCacheChange;
    });

    compilerHooks._hardSourceWriteCache.tapPromise('HardSource - ModuleResolverCache', (compilation, { relateNormalPath, relateNormalModuleId, relateNormalRequest }) => {
      if (compilation.compiler.parentCompilation) {
        const moduleResolveOps = [];
        pushParityWriteOps(compilation, moduleResolveOps);

        return moduleResolveCacheSerializer.write(moduleResolveOps);
      }

      const moduleResolveOps = [];

      function relateNormalModuleResolveKey(compiler, key) {
        const parsed = parseJson(key);
        if (Array.isArray(parsed)) {
          return JSON.stringify([parsed[0], relateNormalPath(compiler, parsed[1]), relateContext.relateAbsoluteRequest(parsed[1], parsed[2])]);
        } else {
          if (!parsed.request) {
            return JSON.stringify(Object.assign({}, parsed, {
              context: relateNormalPath(compiler, parsed.context),
              userRequest: relateContext.relateAbsoluteRequest(parsed.context, parsed.userRequest),
              options: Object.assign({}, parsed.options, {
                request: relateContext.relateAbsoluteRequest(parsed.context, parsed.options.request)
              })
            }));
          } else {
            return JSON.stringify(Object.assign({}, parsed, {
              context: relateNormalPath(compiler, parsed.context),
              request: relateContext.relateAbsoluteRequest(parsed.context, parsed.request)
            }));
          }
        }
      }

      function relateNormalModuleResolve(compiler, resolved) {
        if (resolved.type === 'context') {
          return Object.assign({}, resolved, {
            identifier: relateNormalModuleId(compiler, resolved.identifier),
            resource: relateNormalRequest(compiler, resolved.resource)
          });
        }
        return serialResolveNormal.freeze(resolved, resolved, {
          compiler
        });
      }

      moduleResolveCacheChange.reduce((carry, value) => {
        if (!carry.includes(value)) {
          carry.push(value);
        }
        return carry;
      }, []).forEach(key => {
        // console.log(key, moduleResolveCache[key]);
        // moduleResolveCache[key] && console.log(relateNormalModuleResolveKey(compiler, key));
        // moduleResolveCache[key] && console.log(relateNormalModuleResolve(compiler, moduleResolveCache[key]));
        moduleResolveOps.push({
          key: relateNormalModuleResolveKey(compiler, key),
          value: moduleResolveCache[key] ? relateNormalModuleResolve(compiler, moduleResolveCache[key]) : null
        });
      });

      moduleResolveCacheChange = [];

      pushParityWriteOps(compilation, moduleResolveOps);

      return moduleResolveCacheSerializer.write(moduleResolveOps);
    });
  }
}

module.exports = ModuleResolverCache;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9DYWNoZU1vZHVsZVJlc29sdmVyLmpzIl0sIm5hbWVzIjpbIm5vZGVPYmplY3RIYXNoIiwicmVxdWlyZSIsInNlcmlhbCIsInBsdWdpbkNvbXBhdCIsInJlbGF0ZUNvbnRleHQiLCJwYXJzZUpzb24iLCJwYXJpdHlDYWNoZUZyb21DYWNoZSIsInB1c2hQYXJpdHlXcml0ZU9wcyIsInNlcmlhbEpzb25LZXkiLCJmcmVlemUiLCJhcmciLCJ2YWx1ZSIsImV4dHJhIiwiSlNPTiIsInBhcnNlIiwidGhhdyIsImZyb3plbiIsInN0cmluZ2lmeSIsInNlcmlhbEpzb24iLCJzZXJpYWxPYmplY3RBc3NpZ24iLCJvYmplY3RBc3NpZ24iLCJzZXJpYWxSZXNvbHZlT3B0aW9uc0tleSIsImNvbnRleHQiLCJwYXRoIiwidXNlclJlcXVlc3QiLCJyZXF1ZXN0Iiwib3B0aW9ucyIsInNlcmlhbFJlc29sdmVLZXkiLCJzZXJpYWxOb3JtYWxNb2R1bGVSZXNvbHZlS2V5IiwicGlwZSIsImtleSIsIkFycmF5IiwiaXNBcnJheSIsInNlcmlhbE5vcm1hbE1vZHVsZUlkIiwibW9kdWxlIiwiaWQiLCJzdWJzdHJpbmciLCJzZXJpYWxSZXNvbHZlQ29udGV4dCIsImlkZW50aWZpZXIiLCJyZXNvdXJjZSIsInNlcmlhbFJlc29sdmVOb3JtYWwiLCJyYXdSZXF1ZXN0IiwibG9hZGVycyIsInJlc291cmNlUmVzb2x2ZURhdGEiLCJjcmVhdGVkIiwiaXNzdWVyIiwicmVzb2x2ZU9wdGlvbnMiLCJpZGVudGl0eSIsImRlc2NyaXB0aW9uRmlsZVBhdGgiLCJkZXNjcmlwdGlvbkZpbGVSb290Iiwic2VyaWFsUmVzb2x2ZSIsInR5cGUiLCJNb2R1bGVSZXNvbHZlckNhY2hlIiwiYXBwbHkiLCJjb21waWxlciIsIm1vZHVsZVJlc29sdmVDYWNoZSIsInBhcml0eUNhY2hlIiwibW9kdWxlUmVzb2x2ZUNhY2hlQ2hhbmdlIiwibW9kdWxlUmVzb2x2ZUNhY2hlU2VyaWFsaXplciIsImNvbXBpbGVySG9va3MiLCJob29rcyIsIl9oYXJkU291cmNlQ3JlYXRlU2VyaWFsaXplciIsInRhcCIsImNhY2hlU2VyaWFsaXplckZhY3RvcnkiLCJjYWNoZURpclBhdGgiLCJjcmVhdGUiLCJuYW1lIiwiYXV0b1BhcnNlIiwiX2hhcmRTb3VyY2VSZXNldENhY2hlIiwiX2hhcmRTb3VyY2VSZWFkQ2FjaGUiLCJ0YXBQcm9taXNlIiwiY29udGV4dEtleXMiLCJjb250ZXh0VmFsdWVzIiwiY29udGV4dE5vcm1hbFBhdGgiLCJjb250ZXh0Tm9ybWFsUmVxdWVzdCIsImNvbnRleHROb3JtYWxNb2R1bGVJZCIsImNvcHlXaXRoRGVzZXIiLCJjb250ZXh0Tm9ybWFsTW9kdWxlUmVzb2x2ZUtleSIsInN0YXJ0c1dpdGgiLCJwYXJzZWQiLCJPYmplY3QiLCJhc3NpZ24iLCJjb250ZXh0Tm9ybWFsTW9kdWxlUmVzb2x2ZSIsInJlc29sdmVkIiwicmVhZCIsInRoZW4iLCJiaW5kIiwiX2hhcmRTb3VyY2VQYXJpdHlDYWNoZSIsInBhcml0eVJvb3QiLCJfaGFyZFNvdXJjZVZlcmlmeUNhY2hlIiwiX19oYXJkU291cmNlX21pc3NpbmdWZXJpZnkiLCJtaXNzaW5nQ2FjaGUiLCJfX2hhcmRTb3VyY2VfbWlzc2luZ0NhY2hlIiwia2V5cyIsImZvckVhY2giLCJyZXNvbHZlS2V5IiwicmVzb2x2ZUl0ZW0iLCJub3JtYWxJZCIsInNvcnQiLCJoYXNoIiwiY29udGV4dE1pc3NpbmciLCJzcGxpdCIsImludmFsaWQiLCJpbnZhbGlkUmVhc29uIiwibm9ybWFsTWlzc2luZyIsImxvYWRlciIsImpvaW4iLCJsb2FkZXJNaXNzaW5nIiwiY29tcGlsYXRpb24iLCJfX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGUiLCJfX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGVDaGFuZ2UiLCJfaGFyZFNvdXJjZVdyaXRlQ2FjaGUiLCJyZWxhdGVOb3JtYWxQYXRoIiwicmVsYXRlTm9ybWFsTW9kdWxlSWQiLCJyZWxhdGVOb3JtYWxSZXF1ZXN0IiwicGFyZW50Q29tcGlsYXRpb24iLCJtb2R1bGVSZXNvbHZlT3BzIiwid3JpdGUiLCJyZWxhdGVOb3JtYWxNb2R1bGVSZXNvbHZlS2V5IiwicmVsYXRlQWJzb2x1dGVSZXF1ZXN0IiwicmVsYXRlTm9ybWFsTW9kdWxlUmVzb2x2ZSIsInJlZHVjZSIsImNhcnJ5IiwiaW5jbHVkZXMiLCJwdXNoIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxpQkFBaUJDLFFBQVEsa0JBQVIsQ0FBdkI7O0FBRUEsTUFBTUMsU0FBU0Qsd0JBQWY7QUFDQSxNQUFNRSxlQUFlRiwrQkFBckI7QUFDQSxNQUFNRyxnQkFBZ0JILGdDQUF0QjtBQUNBLE1BQU1JLFlBQVlKLDJCQUFsQjtBQUNBLE1BQU0sRUFBRUssb0JBQUYsRUFBd0JDLGtCQUF4QixLQUErQ04sd0JBQXJEOztBQUVBLE1BQU1PLGdCQUFnQjtBQUNwQkMsU0FBT0MsR0FBUCxFQUFZQyxLQUFaLEVBQW1CQyxLQUFuQixFQUEwQjtBQUN4QixXQUFPQyxLQUFLQyxLQUFMLENBQVdKLEdBQVgsQ0FBUDtBQUNELEdBSG1CO0FBSXBCSyxPQUFLTCxHQUFMLEVBQVVNLE1BQVYsRUFBa0JKLEtBQWxCLEVBQXlCO0FBQ3ZCLFdBQU9DLEtBQUtJLFNBQUwsQ0FBZVAsR0FBZixDQUFQO0FBQ0Q7QUFObUIsQ0FBdEI7O0FBU0EsTUFBTVEsYUFBYTtBQUNqQlQsU0FBT0MsR0FBUCxFQUFZQyxLQUFaLEVBQW1CQyxLQUFuQixFQUEwQjtBQUN4QixXQUFPQyxLQUFLSSxTQUFMLENBQWVQLEdBQWYsQ0FBUDtBQUNELEdBSGdCO0FBSWpCSyxPQUFLTCxHQUFMLEVBQVVNLE1BQVYsRUFBa0JKLEtBQWxCLEVBQXlCO0FBQ3ZCLFdBQU9DLEtBQUtDLEtBQUwsQ0FBV0osR0FBWCxDQUFQO0FBQ0Q7QUFOZ0IsQ0FBbkI7O0FBU0EsTUFBTVMscUJBQXFCakIsT0FBT2tCLFlBQWxDOztBQUVBLE1BQU1DLDBCQUEwQkYs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RyxXQUFuQixFQUFnQ1EsZ0JBQWhDOztBQUVBLGFBQU8xRCw2QkFBNkIyRCxLQUE3QixDQUFtQ0QsZ0JBQW5DLENBQVA7QUFDRCxLQTFGSDtBQTRGRDtBQXRSdUI7O0FBeVIxQmxGLE9BQU8yRixPQUFQLEdBQWlCekUsbUJBQWpCIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9DYWNoZU1vZHVsZVJlc29sdmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgbm9kZU9iamVjdEhhc2ggPSByZXF1aXJlKCdub2RlLW9iamVjdC1oYXNoJyk7XG5cbmNvbnN0IHNlcmlhbCA9IHJlcXVpcmUoJy4vdXRpbC9zZXJpYWwnKTtcbmNvbnN0IHBsdWdpbkNvbXBhdCA9IHJlcXVpcmUoJy4vdXRpbC9wbHVnaW4tY29tcGF0Jyk7XG5jb25zdCByZWxhdGVDb250ZXh0ID0gcmVxdWlyZSgnLi91dGlsL3JlbGF0ZS1jb250ZXh0Jyk7XG5jb25zdCBwYXJzZUpzb24gPSByZXF1aXJlKCcuL3V0aWwvcGFyc2VKc29uJyk7XG5jb25zdCB7IHBhcml0eUNhY2hlRnJvbUNhY2hlLCBwdXNoUGFyaXR5V3JpdGVPcHMgfSA9IHJlcXVpcmUoJy4vdXRpbC9wYXJpdHknKTtcblxuY29uc3Qgc2VyaWFsSnNvbktleSA9IHtcbiAgZnJlZXplKGFyZywgdmFsdWUsIGV4dHJhKSB7XG4gICAgcmV0dXJuIEpTT04ucGFyc2UoYXJnKTtcbiAgfSxcbiAgdGhhdyhhcmcsIGZyb3plbiwgZXh0cmEpIHtcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYXJnKTtcbiAgfSxcbn07XG5cbmNvbnN0IHNlcmlhbEpzb24gPSB7XG4gIGZyZWV6ZShhcmcsIHZhbHVlLCBleHRyYSkge1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShhcmcpO1xuICB9LFxuICB0aGF3KGFyZywgZnJvemVuLCBleHRyYSkge1xuICAgIHJldHVybiBKU09OLnBhcnNlKGFyZyk7XG4gIH0sXG59O1xuXG5jb25zdCBzZXJpYWxPYmplY3RBc3NpZ24gPSBzZXJpYWwub2JqZWN0QXNzaWduO1xuXG5jb25zdCBzZXJpYWxSZXNvbHZlT3B0aW9uc0tleSA9IHNlcmlhbE9iamVjdEFzc2lnbih7XG4gIGNvbnRleHQ6IHNlcmlhbC5wYXRoLFxuICB1c2VyUmVxdWVzdDogc2VyaWFsLnJlcXVlc3QsXG4gIG9wdGlvbnM6IHNlcmlhbE9iamVjdEFzc2lnbih7XG4gICAgcmVxdWVzdDogc2VyaWFsLnJlcXVlc3QsXG4gIH0pLFxufSk7XG5cbmNvbnN0IHNlcmlhbFJlc29sdmVLZXkgPSBzZXJpYWxPYmplY3RBc3NpZ24oe1xuICBjb250ZXh0OiBzZXJpYWwucGF0aCxcbiAgcmVxdWVzdDogc2VyaWFsLnJlcXVlc3QsXG59KTtcblxuY29uc3Qgc2VyaWFsTm9ybWFsTW9kdWxlUmVzb2x2ZUtleSA9IHNlcmlhbC5waXBlKFxuICBzZXJpYWxKc29uS2V5LFxuICB7XG4gICAgZnJlZXplKGFyZywga2V5LCBleHRyYSkge1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYXJnKSkge1xuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgIGFyZ1swXSxcbiAgICAgICAgICBzZXJpYWwucGF0aC5mcmVlemUoYXJnWzFdLCBhcmdbMV0sIGV4dHJhKSxcbiAgICAgICAgICBzZXJpYWwucmVxdWVzdC5mcmVlemUoYXJnWzJdLCBhcmdbMl0sIGV4dHJhKSxcbiAgICAgICAgXTtcbiAgICAgIH0gZWxzZSBpZiAoIWFyZy5yZXF1ZXN0KSB7XG4gICAgICAgIHJldHVybiBzZXJpYWxSZXNvbHZlT3B0aW9uc0tleS5mcmVlemUoYXJnLCBhcmcsIGV4dHJhKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBzZXJpYWxSZXNvbHZlS2V5LmZyZWV6ZShhcmcsIGFyZywgZXh0cmEpO1xuICAgICAgfVxuICAgIH0sXG4gICAgdGhhdyhhcmcsIGZyb3plbiwgZXh0cmEpIHtcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGFyZykpIHtcbiAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICBhcmdbMF0sXG4gICAgICAgICAgc2VyaWFsLnBhdGgudGhhdyhhcmdbMV0sIGFyZ1sxXSwgZXh0cmEpLFxuICAgICAgICAgIHNlcmlhbC5yZXF1ZXN0LnRoYXcoYXJnWzJdLCBhcmdbMl0sIGV4dHJhKSxcbiAgICAgICAgXTtcbiAgICAgIH0gZWxzZSBpZiAoIWFyZy5yZXF1ZXN0KSB7XG4gICAgICAgIHJldHVybiBzZXJpYWxSZXNvbHZlT3B0aW9uc0tleS50aGF3KGFyZywgYXJnLCBleHRyYSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gc2VyaWFsUmVzb2x2ZUtleS50aGF3KGFyZywgYXJnLCBleHRyYSk7XG4gICAgICB9XG4gICAgfSxcbiAgfSxcbiAgc2VyaWFsSnNvbixcbik7XG5cbmNvbnN0IHNlcmlhbE5vcm1hbE1vZHVsZUlkID0ge1xuICBmcmVlemUoYXJnLCBtb2R1bGUsIGV4dHJhKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIGlkLnN1YnN0cmluZygwLCAyNCkgKyBzZXJpYWwucmVxdWVzdC5mcmVlemUoaWQuc3Vic3RyaW5nKDI0KSwgaWQsIGV4dHJhKVxuICAgICk7XG4gIH0sXG4gIHRoYXcoYXJnLCBmcm96ZW4sIGV4dHJhKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIGlkLnN1YnN0cmluZygwLCAyNCkgKyBzZXJpYWwucmVxdWVzdC50aGF3KGlkLnN1YnN0cmluZygyNCksIGlkLCBleHRyYSlcbiAgICApO1xuICB9LFxufTtcblxuY29uc3Qgc2VyaWFsUmVzb2x2ZUNvbnRleHQgPSBzZXJpYWxPYmplY3RBc3NpZ24oe1xuICBpZGVudGlmaWVyOiBzZXJpYWxOb3JtYWxNb2R1bGVJZCxcbiAgcmVzb3VyY2U6IHNlcmlhbE5vcm1hbE1vZHVsZUlkLFxufSk7XG5cbmNvbnN0IHNlcmlhbFJlc29sdmVOb3JtYWwgPSBzZXJpYWxPYmplY3RBc3NpZ24oe1xuICBjb250ZXh0OiBzZXJpYWwucGF0aCxcbiAgcmVxdWVzdDogc2VyaWFsLnJlcXVlc3QsXG4gIHVzZXJSZXF1ZXN0OiBzZXJpYWwucmVxdWVzdCxcbiAgcmF3UmVxdWVzdDogc2VyaWFsLnJlcXVlc3QsXG4gIHJlc291cmNlOiBzZXJpYWwucmVxdWVzdCxcbiAgbG9hZGVyczogc2VyaWFsLmxvYWRlcnMsXG4gIHJlc291cmNlUmVzb2x2ZURhdGE6IHNlcmlhbC5vYmplY3RBc3NpZ24oe1xuICAgIGNvbnRleHQ6IHNlcmlhbC5jcmVhdGVkKHtcbiAgICAgIGlzc3Vlcjogc2VyaWFsLnJlcXVlc3QsXG4gICAgICByZXNvbHZlT3B0aW9uczogc2VyaWFsLmlkZW50aXR5LFxuICAgIH0pLFxuICAgIHBhdGg6IHNlcmlhbC5wYXRoLFxuICAgIHJlcXVlc3Q6IHNlcmlhbC5yZXF1ZXN0LFxuICAgIGRlc2NyaXB0aW9uRmlsZVBhdGg6IHNlcmlhbC5wYXRoLFxuICAgIGRlc2NyaXB0aW9uRmlsZVJvb3Q6IHNlcmlhbC5wYXRoLFxuICB9KSxcbn0pO1xuXG5jb25zdCBzZXJpYWxSZXNvbHZlID0ge1xuICBmcmVlemUoYXJnLCBtb2R1bGUsIGV4dHJhKSB7XG4gICAgaWYgKGFyZy50eXBlID09PSAnY29udGV4dCcpIHtcbiAgICAgIHJldHVybiBzZXJpYWxSZXNvbHZlQ29udGV4dC5mcmVlemUoYXJnLCBhcmcsIGV4dHJhKTtcbiAgICB9XG4gICAgcmV0dXJuIHNlcmlhbFJlc29sdmVOb3JtYWwuZnJlZXplKGFyZywgYXJnLCBleHRyYSk7XG4gIH0sXG4gIHRoYXcoYXJnLCBmcm96ZW4sIGV4dHJhKSB7XG4gICAgaWYgKGFyZy50eXBlID09PSAnY29udGV4dCcpIHtcbiAgICAgIHJldHVybiBzZXJpYWxSZXNvbHZlQ29udGV4dC50aGF3KGFyZywgYXJnLCBleHRyYSk7XG4gICAgfVxuICAgIHJldHVybiBzZXJpYWxSZXNvbHZlTm9ybWFsLnRoYXcoYXJnLCBhcmcsIGV4dHJhKTtcbiAgfSxcbn07XG5cbmNsYXNzIE1vZHVsZVJlc29sdmVyQ2FjaGUge1xuICBhcHBseShjb21waWxlcikge1xuICAgIGxldCBtb2R1bGVSZXNvbHZlQ2FjaGUgPSB7fTtcbiAgICBsZXQgcGFyaXR5Q2FjaGUgPSB7fTtcblxuICAgIGxldCBtb2R1bGVSZXNvbHZlQ2FjaGVDaGFuZ2UgPSBbXTtcblxuICAgIGxldCBtb2R1bGVSZXNvbHZlQ2FjaGVTZXJpYWxpemVyO1xuXG4gICAgY29uc3QgY29tcGlsZXJIb29rcyA9IHBsdWdpbkNvbXBhdC5ob29rcyhjb21waWxlcik7XG5cbiAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlQ3JlYXRlU2VyaWFsaXplci50YXAoXG4gICAgICAnSGFyZFNvdXJjZSAtIE1vZHVsZVJlc29sdmVyQ2FjaGUnLFxuICAgICAgKGNhY2hlU2VyaWFsaXplckZhY3RvcnksIGNhY2hlRGlyUGF0aCkgPT4ge1xuICAgICAgICBtb2R1bGVSZXNvbHZlQ2FjaGVTZXJpYWxpemVyID0gY2FjaGVTZXJpYWxpemVyRmFjdG9yeS5jcmVhdGUoe1xuICAgICAgICAgIG5hbWU6ICdtb2R1bGUtcmVzb2x2ZScsXG4gICAgICAgICAgdHlwZTogJ2RhdGEnLFxuICAgICAgICAgIGF1dG9QYXJzZTogdHJ1ZSxcbiAgICAgICAgICBjYWNoZURpclBhdGgsXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgY29tcGlsZXJIb29rcy5faGFyZFNvdXJjZVJlc2V0Q2FjaGUudGFwKFxuICAgICAgJ0hhcmRTb3VyY2UgLSBNb2R1bGVSZXNvbHZlckNhY2hlJyxcbiAgICAgICgpID0+IHtcbiAgICAgICAgbW9kdWxlUmVzb2x2ZUNhY2hlID0ge307XG4gICAgICAgIHBhcml0eUNhY2hlID0ge307XG4gICAgICB9LFxuICAgICk7XG5cbiAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlUmVhZENhY2hlLnRhcFByb21pc2UoXG4gICAgICAnSGFyZFNvdXJjZSAtIE1vZHVsZVJlc29sdmVyQ2FjaGUnLFxuICAgICAgKHtcbiAgICAgICAgY29udGV4dEtleXMsXG4gICAgICAgIGNvbnRleHRWYWx1ZXMsXG4gICAgICAgIGNvbnRleHROb3JtYWxQYXRoLFxuICAgICAgICBjb250ZXh0Tm9ybWFsUmVxdWVzdCxcbiAgICAgICAgY29udGV4dE5vcm1hbE1vZHVsZUlkLFxuICAgICAgICBjb3B5V2l0aERlc2VyLFxuICAgICAgfSkgPT4ge1xuICAgICAgICBmdW5jdGlvbiBjb250ZXh0Tm9ybWFsTW9kdWxlUmVzb2x2ZUtleShjb21waWxlciwga2V5KSB7XG4gICAgICAgICAgaWYgKGtleS5zdGFydHNXaXRoKCdfX2hhcmRTb3VyY2VfcGFyaXR5VG9rZW4nKSkge1xuICAgICAgICAgICAgcmV0dXJuIGtleTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgcGFyc2VkID0gcGFyc2VKc29uKGtleSk7XG4gICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocGFyc2VkKSkge1xuICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KFtcbiAgICAgICAgICAgICAgcGFyc2VkWzBdLFxuICAgICAgICAgICAgICBjb250ZXh0Tm9ybWFsUGF0aChjb21waWxlciwgcGFyc2VkWzFdKSxcbiAgICAgICAgICAgICAgcGFyc2VkWzJdLFxuICAgICAgICAgICAgXSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih7fSwgcGFyc2VkLCB7XG4gICAgICAgICAgICAgICAgY29udGV4dDogY29udGV4dE5vcm1hbFBhdGgoY29tcGlsZXIsIHBhcnNlZC5jb250ZXh0KSxcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGNvbnRleHROb3JtYWxNb2R1bGVSZXNvbHZlKGNvbXBpbGVyLCByZXNvbHZlZCwga2V5KSB7XG4gICAgICAgICAgaWYgKGtleS5zdGFydHNXaXRoKCdfX2hhcmRTb3VyY2VfcGFyaXR5VG9rZW4nKSkge1xuICAgICAgICAgICAgcGFyaXR5Q2FjaGVba2V5XSA9IHJlc29sdmVkO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAodHlwZW9mIHJlc29sdmVkID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgcmVzb2x2ZWQgPSBwYXJzZUpzb24ocmVzb2x2ZWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzb2x2ZWQudHlwZSA9PT0gJ2NvbnRleHQnKSB7XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgcmVzb2x2ZWQsIHtcbiAgICAgICAgICAgICAgaWRlbnRpZmllcjogY29udGV4dE5vcm1hbE1vZHVsZUlkKGNvbXBpbGVyLCByZXNvbHZlZC5pZGVudGlmaWVyKSxcbiAgICAgICAgICAgICAgcmVzb3VyY2U6IGNvbnRleHROb3JtYWxSZXF1ZXN0KGNvbXBpbGVyLCByZXNvbHZlZC5yZXNvdXJjZSksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHNlcmlhbFJlc29sdmVOb3JtYWwudGhhdyhyZXNvbHZlZCwgcmVzb2x2ZWQsIHtcbiAgICAgICAgICAgIGNvbXBpbGVyLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1vZHVsZVJlc29sdmVDYWNoZVNlcmlhbGl6ZXJcbiAgICAgICAgICAucmVhZCgpXG4gICAgICAgICAgLnRoZW4oY29udGV4dEtleXMoY29tcGlsZXIsIGNvbnRleHROb3JtYWxNb2R1bGVSZXNvbHZlS2V5KSlcbiAgICAgICAgICAudGhlbihjb250ZXh0VmFsdWVzKGNvbXBpbGVyLCBjb250ZXh0Tm9ybWFsTW9kdWxlUmVzb2x2ZSkpXG4gICAgICAgICAgLnRoZW4oY29weVdpdGhEZXNlci5iaW5kKG51bGwsIG1vZHVsZVJlc29sdmVDYWNoZSkpO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgY29tcGlsZXJIb29rcy5faGFyZFNvdXJjZVBhcml0eUNhY2hlLnRhcChcbiAgICAgICdIYXJkU291cmNlIC0gTW9kdWxlUmVzb2x2ZXJDYWNoZScsXG4gICAgICBwYXJpdHlSb290ID0+IHtcbiAgICAgICAgcGFyaXR5Q2FjaGVGcm9tQ2FjaGUoJ01vZHVsZVJlc29sdmVyJywgcGFyaXR5Um9vdCwgcGFyaXR5Q2FjaGUpO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgY29tcGlsZXJIb29rcy5faGFyZFNvdXJjZVZlcmlmeUNhY2hlLnRhcFByb21pc2UoXG4gICAgICAnSGFyZFNvdXJjZSAtIE1vZHVsZVJlc29sdmVyQ2FjaGUnLFxuICAgICAgKCkgPT5cbiAgICAgICAgY29tcGlsZXIuX19oYXJkU291cmNlX21pc3NpbmdWZXJpZnkudGhlbigoKSA9PiB7XG4gICAgICAgICAgY29uc3QgbWlzc2luZ0NhY2hlID0gY29tcGlsZXIuX19oYXJkU291cmNlX21pc3NpbmdDYWNoZTtcblxuICAgICAgICAgIC8vIEludmFsaWRhdGUgcmVzb2x2ZSBjYWNoZSBpdGVtcy5cbiAgICAgICAgICBPYmplY3Qua2V5cyhtb2R1bGVSZXNvbHZlQ2FjaGUpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVLZXkgPSBwYXJzZUpzb24oa2V5KTtcbiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVJdGVtID0gbW9kdWxlUmVzb2x2ZUNhY2hlW2tleV07XG4gICAgICAgICAgICBsZXQgbm9ybWFsSWQgPSAnbm9ybWFsJztcbiAgICAgICAgICAgIGlmIChyZXNvbHZlSXRlbS5yZXNvbHZlT3B0aW9ucykge1xuICAgICAgICAgICAgICBub3JtYWxJZCA9IGBub3JtYWwtJHtuZXcgbm9kZU9iamVjdEhhc2goeyBzb3J0OiBmYWxzZSB9KS5oYXNoKFxuICAgICAgICAgICAgICAgIHJlc29sdmVJdGVtLnJlc29sdmVPcHRpb25zLFxuICAgICAgICAgICAgICApfWA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocmVzb2x2ZUl0ZW0udHlwZSA9PT0gJ2NvbnRleHQnKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGNvbnRleHRNaXNzaW5nID1cbiAgICAgICAgICAgICAgICBtaXNzaW5nQ2FjaGUuY29udGV4dFtcbiAgICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KFtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZUtleS5jb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlSXRlbS5yZXNvdXJjZS5zcGxpdCgnPycpWzBdLFxuICAgICAgICAgICAgICAgICAgXSlcbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgICBpZiAoIWNvbnRleHRNaXNzaW5nIHx8IGNvbnRleHRNaXNzaW5nLmludmFsaWQpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlSXRlbS5pbnZhbGlkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICByZXNvbHZlSXRlbS5pbnZhbGlkUmVhc29uID0gJ3Jlc29sdmVkIGNvbnRleHQgaW52YWxpZCc7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnN0IG5vcm1hbE1pc3NpbmcgPVxuICAgICAgICAgICAgICAgIG1pc3NpbmdDYWNoZVtub3JtYWxJZF0gJiZcbiAgICAgICAgICAgICAgICBtaXNzaW5nQ2FjaGVbbm9ybWFsSWRdW1xuICAgICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoW1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlS2V5WzFdLFxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlSXRlbS5yZXNvdXJjZS5zcGxpdCgnPycpWzBdLFxuICAgICAgICAgICAgICAgICAgXSlcbiAgICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgICBpZiAoIW5vcm1hbE1pc3NpbmcgfHwgbm9ybWFsTWlzc2luZy5pbnZhbGlkKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZUl0ZW0uaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZUl0ZW0uaW52YWxpZFJlYXNvbiA9IGByZXNvbHZlZCBub3JtYWwgaW52YWxpZCR7XG4gICAgICAgICAgICAgICAgICBub3JtYWxNaXNzaW5nXG4gICAgICAgICAgICAgICAgICAgID8gYCAke25vcm1hbE1pc3NpbmcuaW52YWxpZFJlYXNvbn1gXG4gICAgICAgICAgICAgICAgICAgIDogJzogcmVzb2x2ZSBlbnRyeSBub3QgaW4gY2FjaGUnXG4gICAgICAgICAgICAgICAgfWA7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcmVzb2x2ZUl0ZW0ubG9hZGVycy5mb3JFYWNoKGxvYWRlciA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsb2FkZXIgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgICBpZiAobG9hZGVyLmxvYWRlciAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGxvYWRlciA9IGxvYWRlci5sb2FkZXI7XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IHsgXCIwXCI6IFwiYlwiLCBcIjFcIjogXCJhXCIsIFwiMlwiOiBcInJcIiB9IGludG8gXCJiYXJcIlxuICAgICAgICAgICAgICAgICAgICBsb2FkZXIgPSBPYmplY3QuYXNzaWduKFtdLCBsb2FkZXIpLmpvaW4oJycpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBMb2FkZXJzIHNwZWNpZmllZCBpbiBhIGRlcGVuZGVuY3kgYXJlIHNlYXJjaGVkIGZvciBmcm9tIHRoZVxuICAgICAgICAgICAgICAgIC8vIGNvbnRleHQgb2YgdGhlIG1vZHVsZSBjb250YWluaW5nIHRoYXQgZGVwZW5kZW5jeS5cbiAgICAgICAgICAgICAgICBsZXQgbG9hZGVyTWlzc2luZyA9XG4gICAgICAgICAgICAgICAgICBtaXNzaW5nQ2FjaGUubG9hZGVyW1xuICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShbcmVzb2x2ZUtleVsxXSwgbG9hZGVyLnNwbGl0KCc/JylbMF1dKVxuICAgICAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgICAgICBpZiAoIWxvYWRlck1pc3NpbmcpIHtcbiAgICAgICAgICAgICAgICAgIC8vIHdlYnBhY2sgc2VhcmNoZXMgZm9yIHJ1bGUgYmFzZWQgbG9hZGVycyBmcm9tIHRoZSBwcm9qZWN0XG4gICAgICAgICAgICAgICAgICAvLyBjb250ZXh0LlxuICAgICAgICAgICAgICAgICAgbG9hZGVyTWlzc2luZyA9XG4gICAgICAgICAgICAgICAgICAgIG1pc3NpbmdDYWNoZS5sb2FkZXJbXG4gICAgICAgICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoW1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29tcGlsZXIgbWF5IGJlIGEgV2F0Y2hpbmcgaW5zdGFuY2UsIHdoaWNoIHJlZmVycyB0byB0aGVcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbXBpbGVyXG4gICAgICAgICAgICAgICAgICAgICAgICAoY29tcGlsZXIub3B0aW9ucyB8fCBjb21waWxlci5jb21waWxlci5vcHRpb25zKS5jb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGVyLnNwbGl0KCc/JylbMF0sXG4gICAgICAgICAgICAgICAgICAgICAgXSlcbiAgICAgICAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFsb2FkZXJNaXNzaW5nIHx8IGxvYWRlck1pc3NpbmcuaW52YWxpZCkge1xuICAgICAgICAgICAgICAgICAgcmVzb2x2ZUl0ZW0uaW52YWxpZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICByZXNvbHZlSXRlbS5pbnZhbGlkUmVhc29uID0gJ3Jlc29sdmVkIGxvYWRlciBpbnZhbGlkJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9KSxcbiAgICApO1xuXG4gICAgY29tcGlsZXJIb29rcy5jb21waWxhdGlvbi50YXAoXG4gICAgICAnSGFyZFNvdXJjZSAtIE1vZHVsZVJlc29sdmVyQ2FjaGUnLFxuICAgICAgY29tcGlsYXRpb24gPT4ge1xuICAgICAgICBjb21waWxhdGlvbi5fX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGUgPSBtb2R1bGVSZXNvbHZlQ2FjaGU7XG4gICAgICAgIGNvbXBpbGF0aW9uLl9faGFyZFNvdXJjZU1vZHVsZVJlc29sdmVDYWNoZUNoYW5nZSA9IG1vZHVsZVJlc29sdmVDYWNoZUNoYW5nZTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGNvbXBpbGVySG9va3MuX2hhcmRTb3VyY2VXcml0ZUNhY2hlLnRhcFByb21pc2UoXG4gICAgICAnSGFyZFNvdXJjZSAtIE1vZHVsZVJlc29sdmVyQ2FjaGUnLFxuICAgICAgKFxuICAgICAgICBjb21waWxhdGlvbixcbiAgICAgICAgeyByZWxhdGVOb3JtYWxQYXRoLCByZWxhdGVOb3JtYWxNb2R1bGVJZCwgcmVsYXRlTm9ybWFsUmVxdWVzdCB9LFxuICAgICAgKSA9PiB7XG4gICAgICAgIGlmIChjb21waWxhdGlvbi5jb21waWxlci5wYXJlbnRDb21waWxhdGlvbikge1xuICAgICAgICAgIGNvbnN0IG1vZHVsZVJlc29sdmVPcHMgPSBbXTtcbiAgICAgICAgICBwdXNoUGFyaXR5V3JpdGVPcHMoY29tcGlsYXRpb24sIG1vZHVsZVJlc29sdmVPcHMpO1xuXG4gICAgICAgICAgcmV0dXJuIG1vZHVsZVJlc29sdmVDYWNoZVNlcmlhbGl6ZXIud3JpdGUobW9kdWxlUmVzb2x2ZU9wcyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBtb2R1bGVSZXNvbHZlT3BzID0gW107XG5cbiAgICAgICAgZnVuY3Rpb24gcmVsYXRlTm9ybWFsTW9kdWxlUmVzb2x2ZUtleShjb21waWxlciwga2V5KSB7XG4gICAgICAgICAgY29uc3QgcGFyc2VkID0gcGFyc2VKc29uKGtleSk7XG4gICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocGFyc2VkKSkge1xuICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KFtcbiAgICAgICAgICAgICAgcGFyc2VkWzBdLFxuICAgICAgICAgICAgICByZWxhdGVOb3JtYWxQYXRoKGNvbXBpbGVyLCBwYXJzZWRbMV0pLFxuICAgICAgICAgICAgICByZWxhdGVDb250ZXh0LnJlbGF0ZUFic29sdXRlUmVxdWVzdChwYXJzZWRbMV0sIHBhcnNlZFsyXSksXG4gICAgICAgICAgICBdKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCFwYXJzZWQucmVxdWVzdCkge1xuICAgICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih7fSwgcGFyc2VkLCB7XG4gICAgICAgICAgICAgICAgICBjb250ZXh0OiByZWxhdGVOb3JtYWxQYXRoKGNvbXBpbGVyLCBwYXJzZWQuY29udGV4dCksXG4gICAgICAgICAgICAgICAgICB1c2VyUmVxdWVzdDogcmVsYXRlQ29udGV4dC5yZWxhdGVBYnNvbHV0ZVJlcXVlc3QoXG4gICAgICAgICAgICAgICAgICAgIHBhcnNlZC5jb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICBwYXJzZWQudXNlclJlcXVlc3QsXG4gICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgb3B0aW9uczogT2JqZWN0LmFzc2lnbih7fSwgcGFyc2VkLm9wdGlvbnMsIHtcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdDogcmVsYXRlQ29udGV4dC5yZWxhdGVBYnNvbHV0ZVJlcXVlc3QoXG4gICAgICAgICAgICAgICAgICAgICAgcGFyc2VkLmNvbnRleHQsXG4gICAgICAgICAgICAgICAgICAgICAgcGFyc2VkLm9wdGlvbnMucmVxdWVzdCxcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oe30sIHBhcnNlZCwge1xuICAgICAgICAgICAgICAgICAgY29udGV4dDogcmVsYXRlTm9ybWFsUGF0aChjb21waWxlciwgcGFyc2VkLmNvbnRleHQpLFxuICAgICAgICAgICAgICAgICAgcmVxdWVzdDogcmVsYXRlQ29udGV4dC5yZWxhdGVBYnNvbHV0ZVJlcXVlc3QoXG4gICAgICAgICAgICAgICAgICAgIHBhcnNlZC5jb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICBwYXJzZWQucmVxdWVzdCxcbiAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gcmVsYXRlTm9ybWFsTW9kdWxlUmVzb2x2ZShjb21waWxlciwgcmVzb2x2ZWQpIHtcbiAgICAgICAgICBpZiAocmVzb2x2ZWQudHlwZSA9PT0gJ2NvbnRleHQnKSB7XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgcmVzb2x2ZWQsIHtcbiAgICAgICAgICAgICAgaWRlbnRpZmllcjogcmVsYXRlTm9ybWFsTW9kdWxlSWQoY29tcGlsZXIsIHJlc29sdmVkLmlkZW50aWZpZXIpLFxuICAgICAgICAgICAgICByZXNvdXJjZTogcmVsYXRlTm9ybWFsUmVxdWVzdChjb21waWxlciwgcmVzb2x2ZWQucmVzb3VyY2UpLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBzZXJpYWxSZXNvbHZlTm9ybWFsLmZyZWV6ZShyZXNvbHZlZCwgcmVzb2x2ZWQsIHtcbiAgICAgICAgICAgIGNvbXBpbGVyLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgbW9kdWxlUmVzb2x2ZUNhY2hlQ2hhbmdlXG4gICAgICAgICAgLnJlZHVjZSgoY2FycnksIHZhbHVlKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWNhcnJ5LmluY2x1ZGVzKHZhbHVlKSkge1xuICAgICAgICAgICAgICBjYXJyeS5wdXNoKHZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBjYXJyeTtcbiAgICAgICAgICB9LCBbXSlcbiAgICAgICAgICAuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coa2V5LCBtb2R1bGVSZXNvbHZlQ2FjaGVba2V5XSk7XG4gICAgICAgICAgICAvLyBtb2R1bGVSZXNvbHZlQ2FjaGVba2V5XSAmJiBjb25zb2xlLmxvZyhyZWxhdGVOb3JtYWxNb2R1bGVSZXNvbHZlS2V5KGNvbXBpbGVyLCBrZXkpKTtcbiAgICAgICAgICAgIC8vIG1vZHVsZVJlc29sdmVDYWNoZVtrZXldICYmIGNvbnNvbGUubG9nKHJlbGF0ZU5vcm1hbE1vZHVsZVJlc29sdmUoY29tcGlsZXIsIG1vZHVsZVJlc29sdmVDYWNoZVtrZXldKSk7XG4gICAgICAgICAgICBtb2R1bGVSZXNvbHZlT3BzLnB1c2goe1xuICAgICAgICAgICAgICBrZXk6IHJlbGF0ZU5vcm1hbE1vZHVsZVJlc29sdmVLZXkoY29tcGlsZXIsIGtleSksXG4gICAgICAgICAgICAgIHZhbHVlOiBtb2R1bGVSZXNvbHZlQ2FjaGVba2V5XVxuICAgICAgICAgICAgICAgID8gcmVsYXRlTm9ybWFsTW9kdWxlUmVzb2x2ZShjb21waWxlciwgbW9kdWxlUmVzb2x2ZUNhY2hlW2tleV0pXG4gICAgICAgICAgICAgICAgOiBudWxsLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgbW9kdWxlUmVzb2x2ZUNhY2hlQ2hhbmdlID0gW107XG5cbiAgICAgICAgcHVzaFBhcml0eVdyaXRlT3BzKGNvbXBpbGF0aW9uLCBtb2R1bGVSZXNvbHZlT3BzKTtcblxuICAgICAgICByZXR1cm4gbW9kdWxlUmVzb2x2ZUNhY2hlU2VyaWFsaXplci53cml0ZShtb2R1bGVSZXNvbHZlT3BzKTtcbiAgICAgIH0sXG4gICAgKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE1vZHVsZVJlc29sdmVyQ2FjaGU7XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
