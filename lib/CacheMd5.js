'use strict';

const crypto = require('crypto');
const path = require('path');

const lodash = require('lodash');

const bulkFsTask = require('./util/bulk-fs-task');
const pluginCompat = require('./util/plugin-compat');
const promisify = require('./util/promisify');
const values = require('./util/Object.values');
const { parityCacheFromCache, pushParityWriteOps } = require('./util/parity');

class Md5Cache {
  apply(compiler) {
    let md5Cache = {};
    let parityCache = {};

    const fileMd5s = {};
    const cachedMd5s = {};
    let fileTimestamps = {};
    const contextMd5s = {};
    let contextTimestamps = {};

    let md5CacheSerializer;

    let latestStats = {};
    let latestMd5s = {};
    let unbuildMd5s = {};

    let fileDependencies = [];
    let contextDependencies = [];

    let stat;
    let readdir;
    let readFile;
    let mtime;
    let md5;
    let fileStamp;
    let contextStamp;
    let contextStamps;

    function bindFS() {
      stat = promisify(compiler.inputFileSystem.stat, {
        context: compiler.inputFileSystem
      });
      // stat = promisify(fs.stat, {context: fs});

      readdir = promisify(compiler.inputFileSystem.readdir, {
        context: compiler.inputFileSystem
      });

      readFile = promisify(compiler.inputFileSystem.readFile, {
        context: compiler.inputFileSystem
      });

      mtime = file => stat(file).then(stat => +stat.mtime).catch(() => 0);

      md5 = file => readFile(file).then(contents => crypto.createHash('md5').update(contents, 'utf8').digest('hex')).catch(() => '');

      fileStamp = (file, stats) => {
        if (compiler.__hardSource_fileTimestamps[file]) {
          return compiler.__hardSource_fileTimestamps[file];
        } else {
          if (!stats[file]) {
            stats[file] = stat(file);
          }
          return stats[file].then(stat => {
            const mtime = +stat.mtime;
            compiler.__hardSource_fileTimestamps[file] = mtime;
            return mtime;
          });
        }
      };

      contextStamp = (dir, stats) => {
        const context = {};

        let selfTime = 0;

        function walk(dir) {
          return readdir(dir).then(items => Promise.all(items.map(item => {
            const file = path.join(dir, item);
            if (!stats[file]) {
              stats[file] = stat(file);
            }
            return stats[file].then(stat => {
              if (stat.isDirectory()) {
                return walk(path.join(dir, item)).then(items2 => items2.map(item2 => path.join(item, item2)));
              }
              if (+stat.mtime > selfTime) {
                selfTime = +stat.mtime;
              }
              return item;
            }, () => {
              return;
            });
          }))).catch(() => []).then(items => items.reduce((carry, item) => carry.concat(item), []).filter(Boolean));
        }

        return walk(dir).then(items => {
          items.sort();
          const selfHash = crypto.createHash('md5');
          items.forEach(item => {
            selfHash.update(item);
          });
          context.mtime = selfTime;
          context.hash = selfHash.digest('hex');
          return context;
        });
      };

      contextStamps = (contextDependencies, stats) => {
        stats = stats || {};
        const contexts = {};
        contextDependencies.forEach(context => {
          contexts[context] = { files: [], mtime: 0, hash: '' };
        });

        const compilerContextTs = compiler.contextTimestamps;

        contextDependencies.forEach(contextPath => {
          const _context = contextStamp(contextPath, stats);
          if (!_context.then) {
            contexts[contextPath] = _context;
          } else {
            contexts[contextPath] = _context.then(context => {
              contexts[contextPath] = context;
              return context;
            });
          }
        });
        return contexts;
      };
    }

    if (compiler.inputFileSystem) {
      bindFS();
    } else {
      pluginCompat.tap(compiler, 'afterEnvironment', 'HardSource - Md5Cache', bindFS);
    }

    pluginCompat.tap(compiler, '_hardSourceCreateSerializer', 'HardSource - Md5Cache', (cacheSerializerFactory, cacheDirPath) => {
      md5CacheSerializer = cacheSerializerFactory.create({
        name: 'md5',
        type: 'data',
        autoParse: true,
        cacheDirPath
      });
    });

    pluginCompat.tap(compiler, '_hardSourceResetCache', 'HardSource - Md5Cache', () => {
      md5Cache = {};
      parityCache = {};
      fileTimestamps = {};
      contextTimestamps = {};
    });

    pluginCompat.tapPromise(compiler, '_hardSourceReadCache', 'HardSource - Md5Cache', ({ contextKeys, contextNormalPath }) => md5CacheSerializer.read().then(_md5Cache => {
      Object.keys(_md5Cache).forEach(key => {
        if (key.startsWith('__hardSource_parityToken')) {
          parityCache[key] = _md5Cache[key];
          delete _md5Cache[key];
        }
      });
      return _md5Cache;
    }).then(contextKeys(compiler, contextNormalPath)).then(_md5Cache => {
      Object.keys(_md5Cache).forEach(key => {
        if (typeof _md5Cache[key] === 'string') {
          _md5Cache[key] = JSON.parse(_md5Cache[key]);
        }

        if (_md5Cache[key] && _md5Cache[key].hash) {
          cachedMd5s[key] = _md5Cache[key].hash;
        }
      });
      md5Cache = _md5Cache;
    }).then(() => {
      const dependencies = Object.keys(md5Cache);
      fileDependencies = dependencies.filter(file => md5Cache[file].isFile);
      contextDependencies = dependencies.filter(file => md5Cache[file].isDirectory);
    }));

    pluginCompat.tap(compiler, '_hardSourceParityCache', 'HardSource - Md5Cache', parityRoot => {
      parityCacheFromCache('Md5', parityRoot, parityCache);
    });

    pluginCompat.tapPromise(compiler, '_hardSourceVerifyCache', 'HardSource - Md5Cache', () => {
      latestStats = {};
      latestMd5s = {};
      unbuildMd5s = {};

      const stats = {};
      // var md5s = latestMd5s;

      // Prepare objects to mark md5s to delete if they are not used.
      for (const key in cachedMd5s) {
        unbuildMd5s[key] = null;
      }

      return Promise.all([(() => {
        const compilerFileTs = compiler.__hardSource_fileTimestamps = {};
        const fileTs = fileTimestamps = {};

        return bulkFsTask(fileDependencies, (file, task) => {
          if (compiler.__hardSource_fileTimestamps[file]) {
            return compiler.__hardSource_fileTimestamps[file];
          } else {
            compiler.inputFileSystem.stat(file, task((err, value) => {
              if (err) {
                return 0;
              }

              const mtime = +value.mtime;
              compiler.__hardSource_fileTimestamps[file] = mtime;
              return mtime;
            }));
          }
        }).then(mtimes => {
          const bulk = lodash.zip(fileDependencies, mtimes);
          return bulkFsTask(bulk, (item, task) => {
            const file = item[0];
            const mtime = item[1];

            fileTs[file] = mtime || 0;
            if (!compiler.__hardSource_fileTimestamps[file]) {
              compiler.__hardSource_fileTimestamps[file] = mtime;
            }

            compiler.inputFileSystem.readFile(file, task(function (err, body) {
              if (err) {
                fileMd5s[file] = '';
                return;
              }

              const hash = crypto.createHash('md5').update(body, 'utf8').digest('hex');

              fileMd5s[file] = hash;
            }));
          });
        });
      })(), (() => {
        compiler.contextTimestamps = compiler.contextTimestamps || {};
        const contextTs = contextTimestamps = {};
        const contexts = contextStamps(contextDependencies, stats);
        return Promise.all(values(contexts)).then(function () {
          for (var contextPath in contexts) {
            var context = contexts[contextPath];

            if (!compiler.contextTimestamps[contextPath]) {
              compiler.contextTimestamps[contextPath] = context.mtime;
            }
            contextTimestamps[contextPath] = context.mtime;
            fileMd5s[contextPath] = context.hash;
          }
        });
      })()]);
    });

    pluginCompat.tap(compiler, 'compilation', 'HardSource - Md5Cache', compilation => {
      compilation.__hardSourceFileMd5s = fileMd5s;
      compilation.__hardSourceCachedMd5s = cachedMd5s;
      compilation.__hardSourceFileTimestamps = fileTimestamps;
    });

    pluginCompat.tapPromise(compiler, '_hardSourceWriteCache', 'HardSource - Md5Cache', (compilation, { relateNormalPath, contextNormalPath }) => {
      const moduleOps = [];
      const dataOps = [];
      const md5Ops = [];
      const assetOps = [];
      const moduleResolveOps = [];
      const missingOps = [];
      const resolverOps = [];

      let buildingMd5s = {};

      function buildMd5Ops(dependencies) {
        dependencies.forEach(file => {
          function updateMd5CacheItem(value) {
            if (!md5Cache[file] || md5Cache[file] && md5Cache[file].hash !== value.hash) {
              md5Cache[file] = value;
              cachedMd5s[file] = value.hash;

              md5Ops.push({
                key: relateNormalPath(compiler, file),
                value: value
              });
            } else if (!value.mtime && md5Cache[file] && md5Cache[file].mtime !== value.mtime) {
              md5Cache[file] = value;
              cachedMd5s[file] = value.hash;
            }
          }

          const building = buildingMd5s[file];
          if (!building.then) {
            updateMd5CacheItem(building);
          } else {
            buildingMd5s[file] = building.then(updateMd5CacheItem);
          }
        });
      }

      const fileDependencies = Array.from(compilation.fileDependencies).map(file => contextNormalPath(compiler, file));

      const MD5_TIME_PRECISION_BUFFER = 2000;

      fileDependencies.forEach(file => {
        if (buildingMd5s[file]) {
          return;
        }
        delete unbuildMd5s[file];

        if (fileMd5s[file]) {
          buildingMd5s[file] = {
            // Subtract a small buffer from now for file systems that record
            // lower precision mtimes.
            mtime: Date.now() - MD5_TIME_PRECISION_BUFFER,
            hash: fileMd5s[file],
            isFile: true,
            isDirectory: false
          };
        } else {
          buildingMd5s[file] = md5(file).then(hash => ({
            mtime: Date.now() - MD5_TIME_PRECISION_BUFFER,
            hash,
            isFile: true,
            isDirectory: false
          }));
        }
      });

      buildMd5Ops(fileDependencies);

      const contextDependencies = Array.from(compilation.contextDependencies).map(file => contextNormalPath(compiler, file));

      const contexts = contextStamps(contextDependencies);
      contextDependencies.forEach(file => {
        if (buildingMd5s[file]) {
          return;
        }
        delete unbuildMd5s[file];

        let context = contexts[file];
        if (!context.then) {
          // Subtract a small buffer from now for file systems that record lower
          // precision mtimes.
          context.mtime = Date.now() - MD5_TIME_PRECISION_BUFFER;
          context.isFile = false;
          context.isDirectory = true;
        } else {
          context = context.then(context => {
            context.mtime = Date.now() - MD5_TIME_PRECISION_BUFFER;
            context.isFile = false;
            context.isDirectory = true;
            return context;
          });
        }
        buildingMd5s[file] = context;
      });

      buildMd5Ops(contextDependencies);

      const writeMd5Ops = Promise.all(Object.keys(buildingMd5s).map(key => buildingMd5s[key])).then(() => {
        if (!compilation.compiler.parentCompilation) {
          for (const key in unbuildMd5s) {
            md5Ops.push({
              key: relateNormalPath(compiler, key),
              value: unbuildMd5s[key]
            });
          }
        }

        pushParityWriteOps(compilation, md5Ops);
      });

      return writeMd5Ops.then(() => md5CacheSerializer.write(md5Ops));
    });
  }
}

module.exports = Md5Cache;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9DYWNoZU1kNS5qcyJdLCJuYW1lcyI6WyJjcnlwdG8iLCJyZXF1aXJlIiwicGF0aCIsImxvZGFzaCIsImJ1bGtGc1Rhc2siLCJwbHVnaW5Db21wYXQiLCJwcm9taXNpZnkiLCJ2YWx1ZXMiLCJwYXJpdHlDYWNoZUZyb21DYWNoZSIsInB1c2hQYXJpdHlXcml0ZU9wcyIsIk1kNUNhY2hlIiwiYXBwbHkiLCJjb21waWxlciIsIm1kNUNhY2hlIiwicGFyaXR5Q2FjaGUiLCJmaWxlTWQ1cyIsImNhY2hlZE1kNXMiLCJmaWxlVGltZXN0YW1wcyIsImNvbnRleHRNZDVzIiwiY29udGV4dFRpbWVzdGFtcHMiLCJtZDVDYWNoZVNlcmlhbGl6ZXIiLCJsYXRlc3RTdGF0cyIsImxhdGVzdE1kNXMiLCJ1bmJ1aWxkTWQ1cyIsImZpbGVEZXBlbmRlbmNpZXMiLCJjb250ZXh0RGVwZW5kZW5jaWVzIiwic3RhdCIsInJlYWRkaXIiLCJyZWFkRmlsZSIsIm10aW1lIiwibWQ1IiwiZmlsZVN0YW1wIiwiY29udGV4dFN0YW1wIiwiY29udGV4dFN0YW1wcyIsImJpbmRGUyIsImlucHV0RmlsZVN5c3RlbSIsImNvbnRleHQiLCJmaWxlIiwidGhlbiIsImNhdGNoIiwiY29udGVudHMiLCJjcmVhdGVIYXNoIiwidXBkYXRlIiwiZGlnZXN0Iiwic3RhdHMiLCJfX2hhcmRTb3VyY2VfZmlsZVRpbWVzdGFtcHMiLCJkaXIiLCJzZWxmVGltZSIsIndhbGsiLCJpdGVtcyIsIlByb21pc2UiLCJhbGwiLCJtYXAiLCJpdGVtIiwiam9pbiIsImlzRGlyZWN0b3J5IiwiaXRlbXMyIiwiaXRlbTIiLCJyZWR1Y2UiLCJjYXJyeSIsImNvbmNhdCIsImZpbHRlciIsIkJvb2xlYW4iLCJzb3J0Iiwic2VsZkhhc2giLCJmb3JFYWNoIiwiaGFzaCIsImNvbnRleHRzIiwiZmlsZXMiLCJjb21waWxlckNvbnRleHRUcyIsImNvbnRleHRQYXRoIiwiX2NvbnRleHQiLCJ0YXAiLCJjYWNoZVNlcmlhbGl6ZXJGYWN0b3J5IiwiY2FjaGVEaXJQYXRoIiwiY3JlYXRlIiwibmFtZSIsInR5cGUiLCJhdXRvUGFyc2UiLCJ0YXBQcm9taXNlIiwiY29udGV4dEtleXMiLCJjb250ZXh0Tm9ybWFsUGF0aCIsInJlYWQiLCJfbWQ1Q2FjaGUiLCJPYmplY3QiLCJrZXlzIiwia2V5Iiwic3RhcnRzV2l0aCIsIkpTT04iLCJwYXJzZSIsImRlcGVuZGVuY2llcyIsImlzRmlsZSIsInBhcml0eVJvb3QiLCJjb21waWxlckZpbGVUcyIsImZpbGVUcyIsInRhc2siLCJlcnIiLCJ2YWx1ZSIsIm10aW1lcyIsImJ1bGsiLCJ6aXAiLCJib2R5IiwiY29udGV4dFRzIiwiY29tcGlsYXRpb24iLCJfX2hhcmRTb3VyY2VGaWxlTWQ1cyIsIl9faGFyZFNvdXJjZUNhY2hlZE1kNXMiLCJfX2hhcmRTb3VyY2VGaWxlVGltZXN0YW1wcyIsInJlbGF0ZU5vcm1hbFBhdGgiLCJtb2R1bGVPcHMiLCJkYXRhT3BzIiwibWQ1T3BzIiwiYXNzZXRPcHMiLCJtb2R1bGVSZXNvbHZlT3BzIiwibWlzc2luZ09wcyIsInJlc29sdmVyT3BzIiwiYnVpbGRpbmdNZDVzIiwiYnVpbGRNZDVPcHMiLCJ1cGRhdGVNZDVDYWNoZUl0ZW0iLCJwdXNoIiwiYnVpbGRpbmciLCJBcnJheSIsImZyb20iLCJNRDVfVElNRV9QUkVDSVNJT05fQlVGRkVSIiwiRGF0ZSIsIm5vdyIsIndyaXRlTWQ1T3BzIiwicGFyZW50Q29tcGlsYXRpb24iLCJ3cml0ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTUEsU0FBU0MsUUFBUSxRQUFSLENBQWY7QUFDQSxNQUFNQyxPQUFPRCxRQUFRLE1BQVIsQ0FBYjs7QUFFQSxNQUFNRSxTQUFTRixRQUFRLFFBQVIsQ0FBZjs7QUFFQSxNQUFNRyxhQUFhSCw4QkFBbkI7QUFDQSxNQUFNSSxlQUFlSiwrQkFBckI7QUFDQSxNQUFNSyxZQUFZTCwyQkFBbEI7QUFD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O0FBQzNDLGVBQUssTUFBTXhDLEdBQVgsSUFBa0IvRCxXQUFsQixFQUErQjtBQUM3QnVGLG1CQUFPUSxJQUFQLENBQVk7QUFDVmhDLG1CQUFLcUIsaUJBQWlCL0YsUUFBakIsRUFBMkIwRSxHQUEzQixDQURLO0FBRVZXLHFCQUFPMUUsWUFBWStELEdBQVo7QUFGRyxhQUFaO0FBSUQ7QUFDRjs7QUFFRDdFLDJCQUFtQjhGLFdBQW5CLEVBQWdDTyxNQUFoQztBQUNELE9BYm1CLENBQXBCOztBQWVBLGFBQU9lLFlBQVl2RixJQUFaLENBQWlCLE1BQU1sQixtQkFBbUIyRyxLQUFuQixDQUF5QmpCLE1BQXpCLENBQXZCLENBQVA7QUFDRCxLQWhJSDtBQWtJRDtBQWxkWTs7QUFxZGZrQixPQUFPQyxPQUFQLEdBQWlCdkgsUUFBakIiLCJmaWxlIjoiaGFyZC1zb3VyY2Utd2VicGFjay1wbHVnaW4vbGliL0NhY2hlTWQ1LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXG5jb25zdCBsb2Rhc2ggPSByZXF1aXJlKCdsb2Rhc2gnKTtcblxuY29uc3QgYnVsa0ZzVGFzayA9IHJlcXVpcmUoJy4vdXRpbC9idWxrLWZzLXRhc2snKTtcbmNvbnN0IHBsdWdpbkNvbXBhdCA9IHJlcXVpcmUoJy4vdXRpbC9wbHVnaW4tY29tcGF0Jyk7XG5jb25zdCBwcm9taXNpZnkgPSByZXF1aXJlKCcuL3V0aWwvcHJvbWlzaWZ5Jyk7XG5jb25zdCB2YWx1ZXMgPSByZXF1aXJlKCcuL3V0aWwvT2JqZWN0LnZhbHVlcycpO1xuY29uc3QgeyBwYXJpdHlDYWNoZUZyb21DYWNoZSwgcHVzaFBhcml0eVdyaXRlT3BzIH0gPSByZXF1aXJlKCcuL3V0aWwvcGFyaXR5Jyk7XG5cbmNsYXNzIE1kNUNhY2hlIHtcbiAgYXBwbHkoY29tcGlsZXIpIHtcbiAgICBsZXQgbWQ1Q2FjaGUgPSB7fTtcbiAgICBsZXQgcGFyaXR5Q2FjaGUgPSB7fTtcblxuICAgIGNvbnN0IGZpbGVNZDVzID0ge307XG4gICAgY29uc3QgY2FjaGVkTWQ1cyA9IHt9O1xuICAgIGxldCBmaWxlVGltZXN0YW1wcyA9IHt9O1xuICAgIGNvbnN0IGNvbnRleHRNZDVzID0ge307XG4gICAgbGV0IGNvbnRleHRUaW1lc3RhbXBzID0ge307XG5cbiAgICBsZXQgbWQ1Q2FjaGVTZXJpYWxpemVyO1xuXG4gICAgbGV0IGxhdGVzdFN0YXRzID0ge307XG4gICAgbGV0IGxhdGVzdE1kNXMgPSB7fTtcbiAgICBsZXQgdW5idWlsZE1kNXMgPSB7fTtcblxuICAgIGxldCBmaWxlRGVwZW5kZW5jaWVzID0gW107XG4gICAgbGV0IGNvbnRleHREZXBlbmRlbmNpZXMgPSBbXTtcblxuICAgIGxldCBzdGF0O1xuICAgIGxldCByZWFkZGlyO1xuICAgIGxldCByZWFkRmlsZTtcbiAgICBsZXQgbXRpbWU7XG4gICAgbGV0IG1kNTtcbiAgICBsZXQgZmlsZVN0YW1wO1xuICAgIGxldCBjb250ZXh0U3RhbXA7XG4gICAgbGV0IGNvbnRleHRTdGFtcHM7XG5cbiAgICBmdW5jdGlvbiBiaW5kRlMoKSB7XG4gICAgICBzdGF0ID0gcHJvbWlzaWZ5KGNvbXBpbGVyLmlucHV0RmlsZVN5c3RlbS5zdGF0LCB7XG4gICAgICAgIGNvbnRleHQ6IGNvbXBpbGVyLmlucHV0RmlsZVN5c3RlbSxcbiAgICAgIH0pO1xuICAgICAgLy8gc3RhdCA9IHByb21pc2lmeShmcy5zdGF0LCB7Y29udGV4dDogZnN9KTtcblxuICAgICAgcmVhZGRpciA9IHByb21pc2lmeShjb21waWxlci5pbnB1dEZpbGVTeXN0ZW0ucmVhZGRpciwge1xuICAgICAgICBjb250ZXh0OiBjb21waWxlci5pbnB1dEZpbGVTeXN0ZW0sXG4gICAgICB9KTtcblxuICAgICAgcmVhZEZpbGUgPSBwcm9taXNpZnkoY29tcGlsZXIuaW5wdXRGaWxlU3lzdGVtLnJlYWRGaWxlLCB7XG4gICAgICAgIGNvbnRleHQ6IGNvbXBpbGVyLmlucHV0RmlsZVN5c3RlbSxcbiAgICAgIH0pO1xuXG4gICAgICBtdGltZSA9IGZpbGUgPT5cbiAgICAgICAgc3RhdChmaWxlKVxuICAgICAgICAgIC50aGVuKHN0YXQgPT4gK3N0YXQubXRpbWUpXG4gICAgICAgICAgLmNhdGNoKCgpID0+IDApO1xuXG4gICAgICBtZDUgPSBmaWxlID0+XG4gICAgICAgIHJlYWRGaWxlKGZpbGUpXG4gICAgICAgICAgLnRoZW4oY29udGVudHMgPT5cbiAgICAgICAgICAgIGNyeXB0b1xuICAgICAgICAgICAgICAuY3JlYXRlSGFzaCgnbWQ1JylcbiAgICAgICAgICAgICAgLnVwZGF0ZShjb250ZW50cywgJ3V0ZjgnKVxuICAgICAgICAgICAgICAuZGlnZXN0KCdoZXgnKSxcbiAgICAgICAgICApXG4gICAgICAgICAgLmNhdGNoKCgpID0+ICcnKTtcblxuICAgICAgZmlsZVN0YW1wID0gKGZpbGUsIHN0YXRzKSA9PiB7XG4gICAgICAgIGlmIChjb21waWxlci5fX2hhcmRTb3VyY2VfZmlsZVRpbWVzdGFtcHNbZmlsZV0pIHtcbiAgICAgICAgICByZXR1cm4gY29tcGlsZXIuX19oYXJkU291cmNlX2ZpbGVUaW1lc3RhbXBzW2ZpbGVdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICghc3RhdHNbZmlsZV0pIHtcbiAgICAgICAgICAgIHN0YXRzW2ZpbGVdID0gc3RhdChmaWxlKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHN0YXRzW2ZpbGVdLnRoZW4oc3RhdCA9PiB7XG4gICAgICAgICAgICBjb25zdCBtdGltZSA9ICtzdGF0Lm10aW1lO1xuICAgICAgICAgICAgY29tcGlsZXIuX19oYXJkU291cmNlX2ZpbGVUaW1lc3RhbXBzW2ZpbGVdID0gbXRpbWU7XG4gICAgICAgICAgICByZXR1cm4gbXRpbWU7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIGNvbnRleHRTdGFtcCA9IChkaXIsIHN0YXRzKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSB7fTtcblxuICAgICAgICBsZXQgc2VsZlRpbWUgPSAwO1xuXG4gICAgICAgIGZ1bmN0aW9uIHdhbGsoZGlyKSB7XG4gICAgICAgICAgcmV0dXJuIHJlYWRkaXIoZGlyKVxuICAgICAgICAgICAgLnRoZW4oaXRlbXMgPT5cbiAgICAgICAgICAgICAgUHJvbWlzZS5hbGwoXG4gICAgICAgICAgICAgICAgaXRlbXMubWFwKGl0ZW0gPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc3QgZmlsZSA9IHBhdGguam9pbihkaXIsIGl0ZW0pO1xuICAgICAgICAgICAgICAgICAgaWYgKCFzdGF0c1tmaWxlXSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0c1tmaWxlXSA9IHN0YXQoZmlsZSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICByZXR1cm4gc3RhdHNbZmlsZV0udGhlbihcbiAgICAgICAgICAgICAgICAgICAgc3RhdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXQuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdhbGsocGF0aC5qb2luKGRpciwgaXRlbSkpLnRoZW4oaXRlbXMyID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zMi5tYXAoaXRlbTIgPT4gcGF0aC5qb2luKGl0ZW0sIGl0ZW0yKSksXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICBpZiAoK3N0YXQubXRpbWUgPiBzZWxmVGltZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZlRpbWUgPSArc3RhdC5tdGltZTtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGl0ZW07XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLmNhdGNoKCgpID0+IFtdKVxuICAgICAgICAgICAgLnRoZW4oaXRlbXMgPT5cbiAgICAgICAgICAgICAgaXRlbXNcbiAgICAgICAgICAgICAgICAucmVkdWNlKChjYXJyeSwgaXRlbSkgPT4gY2FycnkuY29uY2F0KGl0ZW0pLCBbXSlcbiAgICAgICAgICAgICAgICAuZmlsdGVyKEJvb2xlYW4pLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB3YWxrKGRpcikudGhlbihpdGVtcyA9PiB7XG4gICAgICAgICAgaXRlbXMuc29ydCgpO1xuICAgICAgICAgIGNvbnN0IHNlbGZIYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goJ21kNScpO1xuICAgICAgICAgIGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgICBzZWxmSGFzaC51cGRhdGUoaXRlbSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgY29udGV4dC5tdGltZSA9IHNlbGZUaW1lO1xuICAgICAgICAgIGNvbnRleHQuaGFzaCA9IHNlbGZIYXNoLmRpZ2VzdCgnaGV4Jyk7XG4gICAgICAgICAgcmV0dXJuIGNvbnRleHQ7XG4gICAgICAgIH0pO1xuICAgICAgfTtcblxuICAgICAgY29udGV4dFN0YW1wcyA9IChjb250ZXh0RGVwZW5kZW5jaWVzLCBzdGF0cykgPT4ge1xuICAgICAgICBzdGF0cyA9IHN0YXRzIHx8IHt9O1xuICAgICAgICBjb25zdCBjb250ZXh0cyA9IHt9O1xuICAgICAgICBjb250ZXh0RGVwZW5kZW5jaWVzLmZvckVhY2goY29udGV4dCA9PiB7XG4gICAgICAgICAgY29udGV4dHNbY29udGV4dF0gPSB7IGZpbGVzOiBbXSwgbXRpbWU6IDAsIGhhc2g6ICcnIH07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGNvbXBpbGVyQ29udGV4dFRzID0gY29tcGlsZXIuY29udGV4dFRpbWVzdGFtcHM7XG5cbiAgICAgICAgY29udGV4dERlcGVuZGVuY2llcy5mb3JFYWNoKGNvbnRleHRQYXRoID0+IHtcbiAgICAgICAgICBjb25zdCBfY29udGV4dCA9IGNvbnRleHRTdGFtcChjb250ZXh0UGF0aCwgc3RhdHMpO1xuICAgICAgICAgIGlmICghX2NvbnRleHQudGhlbikge1xuICAgICAgICAgICAgY29udGV4dHNbY29udGV4dFBhdGhdID0gX2NvbnRleHQ7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnRleHRzW2NvbnRleHRQYXRoXSA9IF9jb250ZXh0LnRoZW4oY29udGV4dCA9PiB7XG4gICAgICAgICAgICAgIGNvbnRleHRzW2NvbnRleHRQYXRoXSA9IGNvbnRleHQ7XG4gICAgICAgICAgICAgIHJldHVybiBjb250ZXh0O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGNvbnRleHRzO1xuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoY29tcGlsZXIuaW5wdXRGaWxlU3lzdGVtKSB7XG4gICAgICBiaW5kRlMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGx1Z2luQ29tcGF0LnRhcChcbiAgICAgICAgY29tcGlsZXIsXG4gICAgICAgICdhZnRlckVudmlyb25tZW50JyxcbiAgICAgICAgJ0hhcmRTb3VyY2UgLSBNZDVDYWNoZScsXG4gICAgICAgIGJpbmRGUyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcGx1Z2luQ29tcGF0LnRhcChcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlQ3JlYXRlU2VyaWFsaXplcicsXG4gICAgICAnSGFyZFNvdXJjZSAtIE1kNUNhY2hlJyxcbiAgICAgIChjYWNoZVNlcmlhbGl6ZXJGYWN0b3J5LCBjYWNoZURpclBhdGgpID0+IHtcbiAgICAgICAgbWQ1Q2FjaGVTZXJpYWxpemVyID0gY2FjaGVTZXJpYWxpemVyRmFjdG9yeS5jcmVhdGUoe1xuICAgICAgICAgIG5hbWU6ICdtZDUnLFxuICAgICAgICAgIHR5cGU6ICdkYXRhJyxcbiAgICAgICAgICBhdXRvUGFyc2U6IHRydWUsXG4gICAgICAgICAgY2FjaGVEaXJQYXRoLFxuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZVJlc2V0Q2FjaGUnLFxuICAgICAgJ0hhcmRTb3VyY2UgLSBNZDVDYWNoZScsXG4gICAgICAoKSA9PiB7XG4gICAgICAgIG1kNUNhY2hlID0ge307XG4gICAgICAgIHBhcml0eUNhY2hlID0ge307XG4gICAgICAgIGZpbGVUaW1lc3RhbXBzID0ge307XG4gICAgICAgIGNvbnRleHRUaW1lc3RhbXBzID0ge307XG4gICAgICB9LFxuICAgICk7XG5cbiAgICBwbHVnaW5Db21wYXQudGFwUHJvbWlzZShcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlUmVhZENhY2hlJyxcbiAgICAgICdIYXJkU291cmNlIC0gTWQ1Q2FjaGUnLFxuICAgICAgKHsgY29udGV4dEtleXMsIGNvbnRleHROb3JtYWxQYXRoIH0pID0+XG4gICAgICAgIG1kNUNhY2hlU2VyaWFsaXplclxuICAgICAgICAgIC5yZWFkKClcbiAgICAgICAgICAudGhlbihfbWQ1Q2FjaGUgPT4ge1xuICAgICAgICAgICAgT2JqZWN0LmtleXMoX21kNUNhY2hlKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICAgIGlmIChrZXkuc3RhcnRzV2l0aCgnX19oYXJkU291cmNlX3Bhcml0eVRva2VuJykpIHtcbiAgICAgICAgICAgICAgICBwYXJpdHlDYWNoZVtrZXldID0gX21kNUNhY2hlW2tleV07XG4gICAgICAgICAgICAgICAgZGVsZXRlIF9tZDVDYWNoZVtrZXldO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBfbWQ1Q2FjaGU7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAudGhlbihjb250ZXh0S2V5cyhjb21waWxlciwgY29udGV4dE5vcm1hbFBhdGgpKVxuICAgICAgICAgIC50aGVuKF9tZDVDYWNoZSA9PiB7XG4gICAgICAgICAgICBPYmplY3Qua2V5cyhfbWQ1Q2FjaGUpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBfbWQ1Q2FjaGVba2V5XSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICBfbWQ1Q2FjaGVba2V5XSA9IEpTT04ucGFyc2UoX21kNUNhY2hlW2tleV0pO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgaWYgKF9tZDVDYWNoZVtrZXldICYmIF9tZDVDYWNoZVtrZXldLmhhc2gpIHtcbiAgICAgICAgICAgICAgICBjYWNoZWRNZDVzW2tleV0gPSBfbWQ1Q2FjaGVba2V5XS5oYXNoO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIG1kNUNhY2hlID0gX21kNUNhY2hlO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGVwZW5kZW5jaWVzID0gT2JqZWN0LmtleXMobWQ1Q2FjaGUpO1xuICAgICAgICAgICAgZmlsZURlcGVuZGVuY2llcyA9IGRlcGVuZGVuY2llcy5maWx0ZXIoXG4gICAgICAgICAgICAgIGZpbGUgPT4gbWQ1Q2FjaGVbZmlsZV0uaXNGaWxlLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGNvbnRleHREZXBlbmRlbmNpZXMgPSBkZXBlbmRlbmNpZXMuZmlsdGVyKFxuICAgICAgICAgICAgICBmaWxlID0+IG1kNUNhY2hlW2ZpbGVdLmlzRGlyZWN0b3J5LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KSxcbiAgICApO1xuXG4gICAgcGx1Z2luQ29tcGF0LnRhcChcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlUGFyaXR5Q2FjaGUnLFxuICAgICAgJ0hhcmRTb3VyY2UgLSBNZDVDYWNoZScsXG4gICAgICBwYXJpdHlSb290ID0+IHtcbiAgICAgICAgcGFyaXR5Q2FjaGVGcm9tQ2FjaGUoJ01kNScsIHBhcml0eVJvb3QsIHBhcml0eUNhY2hlKTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIHBsdWdpbkNvbXBhdC50YXBQcm9taXNlKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnX2hhcmRTb3VyY2VWZXJpZnlDYWNoZScsXG4gICAgICAnSGFyZFNvdXJjZSAtIE1kNUNhY2hlJyxcbiAgICAgICgpID0+IHtcbiAgICAgICAgbGF0ZXN0U3RhdHMgPSB7fTtcbiAgICAgICAgbGF0ZXN0TWQ1cyA9IHt9O1xuICAgICAgICB1bmJ1aWxkTWQ1cyA9IHt9O1xuXG4gICAgICAgIGNvbnN0IHN0YXRzID0ge307XG4gICAgICAgIC8vIHZhciBtZDVzID0gbGF0ZXN0TWQ1cztcblxuICAgICAgICAvLyBQcmVwYXJlIG9iamVjdHMgdG8gbWFyayBtZDVzIHRvIGRlbGV0ZSBpZiB0aGV5IGFyZSBub3QgdXNlZC5cbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gY2FjaGVkTWQ1cykge1xuICAgICAgICAgIHVuYnVpbGRNZDVzW2tleV0gPSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAoKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29tcGlsZXJGaWxlVHMgPSAoY29tcGlsZXIuX19oYXJkU291cmNlX2ZpbGVUaW1lc3RhbXBzID0ge30pO1xuICAgICAgICAgICAgY29uc3QgZmlsZVRzID0gKGZpbGVUaW1lc3RhbXBzID0ge30pO1xuXG4gICAgICAgICAgICByZXR1cm4gYnVsa0ZzVGFzayhmaWxlRGVwZW5kZW5jaWVzLCAoZmlsZSwgdGFzaykgPT4ge1xuICAgICAgICAgICAgICBpZiAoY29tcGlsZXIuX19oYXJkU291cmNlX2ZpbGVUaW1lc3RhbXBzW2ZpbGVdKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBpbGVyLl9faGFyZFNvdXJjZV9maWxlVGltZXN0YW1wc1tmaWxlXTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb21waWxlci5pbnB1dEZpbGVTeXN0ZW0uc3RhdChcbiAgICAgICAgICAgICAgICAgIGZpbGUsXG4gICAgICAgICAgICAgICAgICB0YXNrKChlcnIsIHZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG10aW1lID0gK3ZhbHVlLm10aW1lO1xuICAgICAgICAgICAgICAgICAgICBjb21waWxlci5fX2hhcmRTb3VyY2VfZmlsZVRpbWVzdGFtcHNbZmlsZV0gPSBtdGltZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG10aW1lO1xuICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkudGhlbihtdGltZXMgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBidWxrID0gbG9kYXNoLnppcChmaWxlRGVwZW5kZW5jaWVzLCBtdGltZXMpO1xuICAgICAgICAgICAgICByZXR1cm4gYnVsa0ZzVGFzayhidWxrLCAoaXRlbSwgdGFzaykgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGZpbGUgPSBpdGVtWzBdO1xuICAgICAgICAgICAgICAgIGNvbnN0IG10aW1lID0gaXRlbVsxXTtcblxuICAgICAgICAgICAgICAgIGZpbGVUc1tmaWxlXSA9IG10aW1lIHx8IDA7XG4gICAgICAgICAgICAgICAgaWYgKCFjb21waWxlci5fX2hhcmRTb3VyY2VfZmlsZVRpbWVzdGFtcHNbZmlsZV0pIHtcbiAgICAgICAgICAgICAgICAgIGNvbXBpbGVyLl9faGFyZFNvdXJjZV9maWxlVGltZXN0YW1wc1tmaWxlXSA9IG10aW1lO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGNvbXBpbGVyLmlucHV0RmlsZVN5c3RlbS5yZWFkRmlsZShcbiAgICAgICAgICAgICAgICAgIGZpbGUsXG4gICAgICAgICAgICAgICAgICB0YXNrKGZ1bmN0aW9uKGVyciwgYm9keSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgZmlsZU1kNXNbZmlsZV0gPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBoYXNoID0gY3J5cHRvXG4gICAgICAgICAgICAgICAgICAgICAgLmNyZWF0ZUhhc2goJ21kNScpXG4gICAgICAgICAgICAgICAgICAgICAgLnVwZGF0ZShib2R5LCAndXRmOCcpXG4gICAgICAgICAgICAgICAgICAgICAgLmRpZ2VzdCgnaGV4Jyk7XG5cbiAgICAgICAgICAgICAgICAgICAgZmlsZU1kNXNbZmlsZV0gPSBoYXNoO1xuICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KSgpLFxuICAgICAgICAgICgoKSA9PiB7XG4gICAgICAgICAgICBjb21waWxlci5jb250ZXh0VGltZXN0YW1wcyA9IGNvbXBpbGVyLmNvbnRleHRUaW1lc3RhbXBzIHx8IHt9O1xuICAgICAgICAgICAgY29uc3QgY29udGV4dFRzID0gKGNvbnRleHRUaW1lc3RhbXBzID0ge30pO1xuICAgICAgICAgICAgY29uc3QgY29udGV4dHMgPSBjb250ZXh0U3RhbXBzKGNvbnRleHREZXBlbmRlbmNpZXMsIHN0YXRzKTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbCh2YWx1ZXMoY29udGV4dHMpKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICBmb3IgKHZhciBjb250ZXh0UGF0aCBpbiBjb250ZXh0cykge1xuICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gY29udGV4dHNbY29udGV4dFBhdGhdO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFjb21waWxlci5jb250ZXh0VGltZXN0YW1wc1tjb250ZXh0UGF0aF0pIHtcbiAgICAgICAgICAgICAgICAgIGNvbXBpbGVyLmNvbnRleHRUaW1lc3RhbXBzW2NvbnRleHRQYXRoXSA9IGNvbnRleHQubXRpbWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnRleHRUaW1lc3RhbXBzW2NvbnRleHRQYXRoXSA9IGNvbnRleHQubXRpbWU7XG4gICAgICAgICAgICAgICAgZmlsZU1kNXNbY29udGV4dFBhdGhdID0gY29udGV4dC5oYXNoO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KSgpLFxuICAgICAgICBdKTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdjb21waWxhdGlvbicsXG4gICAgICAnSGFyZFNvdXJjZSAtIE1kNUNhY2hlJyxcbiAgICAgIGNvbXBpbGF0aW9uID0+IHtcbiAgICAgICAgY29tcGlsYXRpb24uX19oYXJkU291cmNlRmlsZU1kNXMgPSBmaWxlTWQ1cztcbiAgICAgICAgY29tcGlsYXRpb24uX19oYXJkU291cmNlQ2FjaGVkTWQ1cyA9IGNhY2hlZE1kNXM7XG4gICAgICAgIGNvbXBpbGF0aW9uLl9faGFyZFNvdXJjZUZpbGVUaW1lc3RhbXBzID0gZmlsZVRpbWVzdGFtcHM7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICBwbHVnaW5Db21wYXQudGFwUHJvbWlzZShcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlV3JpdGVDYWNoZScsXG4gICAgICAnSGFyZFNvdXJjZSAtIE1kNUNhY2hlJyxcbiAgICAgIChjb21waWxhdGlvbiwgeyByZWxhdGVOb3JtYWxQYXRoLCBjb250ZXh0Tm9ybWFsUGF0aCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IG1vZHVsZU9wcyA9IFtdO1xuICAgICAgICBjb25zdCBkYXRhT3BzID0gW107XG4gICAgICAgIGNvbnN0IG1kNU9wcyA9IFtdO1xuICAgICAgICBjb25zdCBhc3NldE9wcyA9IFtdO1xuICAgICAgICBjb25zdCBtb2R1bGVSZXNvbHZlT3BzID0gW107XG4gICAgICAgIGNvbnN0IG1pc3NpbmdPcHMgPSBbXTtcbiAgICAgICAgY29uc3QgcmVzb2x2ZXJPcHMgPSBbXTtcblxuICAgICAgICBsZXQgYnVpbGRpbmdNZDVzID0ge307XG5cbiAgICAgICAgZnVuY3Rpb24gYnVpbGRNZDVPcHMoZGVwZW5kZW5jaWVzKSB7XG4gICAgICAgICAgZGVwZW5kZW5jaWVzLmZvckVhY2goZmlsZSA9PiB7XG4gICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVNZDVDYWNoZUl0ZW0odmFsdWUpIHtcbiAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICFtZDVDYWNoZVtmaWxlXSB8fFxuICAgICAgICAgICAgICAgIChtZDVDYWNoZVtmaWxlXSAmJiBtZDVDYWNoZVtmaWxlXS5oYXNoICE9PSB2YWx1ZS5oYXNoKVxuICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBtZDVDYWNoZVtmaWxlXSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIGNhY2hlZE1kNXNbZmlsZV0gPSB2YWx1ZS5oYXNoO1xuXG4gICAgICAgICAgICAgICAgbWQ1T3BzLnB1c2goe1xuICAgICAgICAgICAgICAgICAga2V5OiByZWxhdGVOb3JtYWxQYXRoKGNvbXBpbGVyLCBmaWxlKSxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgICAgICAgICAhdmFsdWUubXRpbWUgJiZcbiAgICAgICAgICAgICAgICBtZDVDYWNoZVtmaWxlXSAmJlxuICAgICAgICAgICAgICAgIG1kNUNhY2hlW2ZpbGVdLm10aW1lICE9PSB2YWx1ZS5tdGltZVxuICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBtZDVDYWNoZVtmaWxlXSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIGNhY2hlZE1kNXNbZmlsZV0gPSB2YWx1ZS5oYXNoO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGJ1aWxkaW5nID0gYnVpbGRpbmdNZDVzW2ZpbGVdO1xuICAgICAgICAgICAgaWYgKCFidWlsZGluZy50aGVuKSB7XG4gICAgICAgICAgICAgIHVwZGF0ZU1kNUNhY2hlSXRlbShidWlsZGluZyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBidWlsZGluZ01kNXNbZmlsZV0gPSBidWlsZGluZy50aGVuKHVwZGF0ZU1kNUNhY2hlSXRlbSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBmaWxlRGVwZW5kZW5jaWVzID0gQXJyYXkuZnJvbShjb21waWxhdGlvbi5maWxlRGVwZW5kZW5jaWVzKS5tYXAoXG4gICAgICAgICAgZmlsZSA9PiBjb250ZXh0Tm9ybWFsUGF0aChjb21waWxlciwgZmlsZSksXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgTUQ1X1RJTUVfUFJFQ0lTSU9OX0JVRkZFUiA9IDIwMDA7XG5cbiAgICAgICAgZmlsZURlcGVuZGVuY2llcy5mb3JFYWNoKGZpbGUgPT4ge1xuICAgICAgICAgIGlmIChidWlsZGluZ01kNXNbZmlsZV0pIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgZGVsZXRlIHVuYnVpbGRNZDVzW2ZpbGVdO1xuXG4gICAgICAgICAgaWYgKGZpbGVNZDVzW2ZpbGVdKSB7XG4gICAgICAgICAgICBidWlsZGluZ01kNXNbZmlsZV0gPSB7XG4gICAgICAgICAgICAgIC8vIFN1YnRyYWN0IGEgc21hbGwgYnVmZmVyIGZyb20gbm93IGZvciBmaWxlIHN5c3RlbXMgdGhhdCByZWNvcmRcbiAgICAgICAgICAgICAgLy8gbG93ZXIgcHJlY2lzaW9uIG10aW1lcy5cbiAgICAgICAgICAgICAgbXRpbWU6IERhdGUubm93KCkgLSBNRDVfVElNRV9QUkVDSVNJT05fQlVGRkVSLFxuICAgICAgICAgICAgICBoYXNoOiBmaWxlTWQ1c1tmaWxlXSxcbiAgICAgICAgICAgICAgaXNGaWxlOiB0cnVlLFxuICAgICAgICAgICAgICBpc0RpcmVjdG9yeTogZmFsc2UsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBidWlsZGluZ01kNXNbZmlsZV0gPSBtZDUoZmlsZSkudGhlbihoYXNoID0+ICh7XG4gICAgICAgICAgICAgIG10aW1lOiBEYXRlLm5vdygpIC0gTUQ1X1RJTUVfUFJFQ0lTSU9OX0JVRkZFUixcbiAgICAgICAgICAgICAgaGFzaCxcbiAgICAgICAgICAgICAgaXNGaWxlOiB0cnVlLFxuICAgICAgICAgICAgICBpc0RpcmVjdG9yeTogZmFsc2UsXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBidWlsZE1kNU9wcyhmaWxlRGVwZW5kZW5jaWVzKTtcblxuICAgICAgICBjb25zdCBjb250ZXh0RGVwZW5kZW5jaWVzID0gQXJyYXkuZnJvbShcbiAgICAgICAgICBjb21waWxhdGlvbi5jb250ZXh0RGVwZW5kZW5jaWVzLFxuICAgICAgICApLm1hcChmaWxlID0+IGNvbnRleHROb3JtYWxQYXRoKGNvbXBpbGVyLCBmaWxlKSk7XG5cbiAgICAgICAgY29uc3QgY29udGV4dHMgPSBjb250ZXh0U3RhbXBzKGNvbnRleHREZXBlbmRlbmNpZXMpO1xuICAgICAgICBjb250ZXh0RGVwZW5kZW5jaWVzLmZvckVhY2goZmlsZSA9PiB7XG4gICAgICAgICAgaWYgKGJ1aWxkaW5nTWQ1c1tmaWxlXSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBkZWxldGUgdW5idWlsZE1kNXNbZmlsZV07XG5cbiAgICAgICAgICBsZXQgY29udGV4dCA9IGNvbnRleHRzW2ZpbGVdO1xuICAgICAgICAgIGlmICghY29udGV4dC50aGVuKSB7XG4gICAgICAgICAgICAvLyBTdWJ0cmFjdCBhIHNtYWxsIGJ1ZmZlciBmcm9tIG5vdyBmb3IgZmlsZSBzeXN0ZW1zIHRoYXQgcmVjb3JkIGxvd2VyXG4gICAgICAgICAgICAvLyBwcmVjaXNpb24gbXRpbWVzLlxuICAgICAgICAgICAgY29udGV4dC5tdGltZSA9IERhdGUubm93KCkgLSBNRDVfVElNRV9QUkVDSVNJT05fQlVGRkVSO1xuICAgICAgICAgICAgY29udGV4dC5pc0ZpbGUgPSBmYWxzZTtcbiAgICAgICAgICAgIGNvbnRleHQuaXNEaXJlY3RvcnkgPSB0cnVlO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC50aGVuKGNvbnRleHQgPT4ge1xuICAgICAgICAgICAgICBjb250ZXh0Lm10aW1lID0gRGF0ZS5ub3coKSAtIE1ENV9USU1FX1BSRUNJU0lPTl9CVUZGRVI7XG4gICAgICAgICAgICAgIGNvbnRleHQuaXNGaWxlID0gZmFsc2U7XG4gICAgICAgICAgICAgIGNvbnRleHQuaXNEaXJlY3RvcnkgPSB0cnVlO1xuICAgICAgICAgICAgICByZXR1cm4gY29udGV4dDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBidWlsZGluZ01kNXNbZmlsZV0gPSBjb250ZXh0O1xuICAgICAgICB9KTtcblxuICAgICAgICBidWlsZE1kNU9wcyhjb250ZXh0RGVwZW5kZW5jaWVzKTtcblxuICAgICAgICBjb25zdCB3cml0ZU1kNU9wcyA9IFByb21pc2UuYWxsKFxuICAgICAgICAgIE9iamVjdC5rZXlzKGJ1aWxkaW5nTWQ1cykubWFwKGtleSA9PiBidWlsZGluZ01kNXNba2V5XSksXG4gICAgICAgICkudGhlbigoKSA9PiB7XG4gICAgICAgICAgaWYgKCFjb21waWxhdGlvbi5jb21waWxlci5wYXJlbnRDb21waWxhdGlvbikge1xuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdW5idWlsZE1kNXMpIHtcbiAgICAgICAgICAgICAgbWQ1T3BzLnB1c2goe1xuICAgICAgICAgICAgICAgIGtleTogcmVsYXRlTm9ybWFsUGF0aChjb21waWxlciwga2V5KSxcbiAgICAgICAgICAgICAgICB2YWx1ZTogdW5idWlsZE1kNXNba2V5XSxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcHVzaFBhcml0eVdyaXRlT3BzKGNvbXBpbGF0aW9uLCBtZDVPcHMpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gd3JpdGVNZDVPcHMudGhlbigoKSA9PiBtZDVDYWNoZVNlcmlhbGl6ZXIud3JpdGUobWQ1T3BzKSk7XG4gICAgICB9LFxuICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNZDVDYWNoZTtcbiJdLCJzb3VyY2VSb290IjoiL1VzZXJzL3R5bGVyYXJidXMvZGV2L3Byb3ZpZGVyL3NyYyJ9
