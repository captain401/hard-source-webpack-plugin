'use strict';

require('source-map-support/register');

const pluginCompat = require('./util/plugin-compat');

/**
 * Exclude modules with CssDependency. These modules are what mini-css keys
 * child compilations on. Excluding them the child compilations and their
 * assets are built every build. This has a minor performance cost as the bulk
 * of the work for css is still cached.
 */
class ExcludeMiniCssModulePlugin {
  apply(compiler) {
    let CssDependency;

    pluginCompat.tap(compiler, 'make', 'SupportMiniCssExtractPlugin', ({ dependencyFactories }) => {
      const Dependencies = dependencyFactories.keys();
      for (const Dep of Dependencies) {
        if (Dep.name === 'CssDependency') {
          CssDependency = Dep;
          break;
        }
      }
    });

    pluginCompat.tap(compiler, '_hardSourceAfterFreezeModule', 'HardMiniCssExtractPlugin', (frozen, module, extra) => {
      if (CssDependency && module.dependencies.some(dep => dep instanceof CssDependency)) {
        return null;
      }
      return frozen;
    });
  }
}

module.exports = ExcludeMiniCssModulePlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9FeGNsdWRlTWluaUNzc01vZHVsZVBsdWdpbi5qcyJdLCJuYW1lcyI6WyJwbHVnaW5Db21wYXQiLCJyZXF1aXJlIiwiRXhjbHVkZU1pbmlDc3NNb2R1bGVQbHVnaW4iLCJhcHBseSIsImNvbXBpbGVyIiwiQ3NzRGVwZW5kZW5jeSIsInRhcCIsImRlcGVuZGVuY3lGYWN0b3JpZXMiLCJEZXBlbmRlbmNpZXMiLCJrZXlzIiwiRGVwIiwibmFtZSIsImZyb3plbiIsIm1vZHVsZSIsImV4dHJhIiwiZGVwZW5kZW5jaWVzIiwic29tZSIsImRlcCIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxlQUFlQyxRQUFRLHNCQUFSLENBQXJCOztBQUVBOzs7Ozs7QUFNQSxNQUFNQywwQkFBTixDQUFpQztBQUMvQkMsUUFBTUMsUUFBTixFQUFnQjtBQUNkLFFBQUlDLGFBQUo7O0FBRUFMLGlCQUFhTSxHQUFiLENBQ0VGLFFBREYsRUFFRSxNQUZGLEVBR0UsNkJBSEYsRUFJRSxDQUFDLEVBQUVHLG1CQUFGLEVBQUQsS0FBNkI7QUFDM0IsWUFBTUMsZUFBZUQsb0JBQW9CRSxJQUFwQixFQUFyQjtBQUNBLFdBQUssTUFBTUMsR0FBWCxJQUFrQkYsWUFBbEIsRUFBZ0M7QUFDOUIsWUFBSUUsSUFBSUMsSUFBSixLQUFhLGVBQWpCLEVBQWtDO0FBQ2hDTiwwQkFBZ0JLLEdBQWhCO0FBQ0E7QUFDRDtBQUNGO0FBQ0YsS0FaSDs7QUFlQVYsaUJBQWFNLEdBQWIsQ0FDRUYsUUFERixFQUVFLDhCQUZGLEVBR0UsMEJBSEYsRUFJRSxDQUFDUSxNQUFELEVBQVNDLE1BQVQsRUFBaUJDLEtBQWpCLEtBQTJCO0FBQ3pCLFVBQ0VULGlCQUNBUSxPQUFPRSxZQUFQLENBQW9CQyxJQUFwQixDQUF5QkMsT0FBT0EsZUFBZVosYUFBL0MsQ0FGRixFQUdFO0FBQ0EsZUFBTyxJQUFQO0FBQ0Q7QUFDRCxhQUFPTyxNQUFQO0FBQ0QsS0FaSDtBQWNEO0FBakM4Qjs7QUFvQ2pDQyxPQUFPSyxPQUFQLEdBQWlCaEIsMEJBQWpCIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9FeGNsdWRlTWluaUNzc01vZHVsZVBsdWdpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHBsdWdpbkNvbXBhdCA9IHJlcXVpcmUoJy4vdXRpbC9wbHVnaW4tY29tcGF0Jyk7XG5cbi8qKlxuICogRXhjbHVkZSBtb2R1bGVzIHdpdGggQ3NzRGVwZW5kZW5jeS4gVGhlc2UgbW9kdWxlcyBhcmUgd2hhdCBtaW5pLWNzcyBrZXlzXG4gKiBjaGlsZCBjb21waWxhdGlvbnMgb24uIEV4Y2x1ZGluZyB0aGVtIHRoZSBjaGlsZCBjb21waWxhdGlvbnMgYW5kIHRoZWlyXG4gKiBhc3NldHMgYXJlIGJ1aWx0IGV2ZXJ5IGJ1aWxkLiBUaGlzIGhhcyBhIG1pbm9yIHBlcmZvcm1hbmNlIGNvc3QgYXMgdGhlIGJ1bGtcbiAqIG9mIHRoZSB3b3JrIGZvciBjc3MgaXMgc3RpbGwgY2FjaGVkLlxuICovXG5jbGFzcyBFeGNsdWRlTWluaUNzc01vZHVsZVBsdWdpbiB7XG4gIGFwcGx5KGNvbXBpbGVyKSB7XG4gICAgbGV0IENzc0RlcGVuZGVuY3k7XG5cbiAgICBwbHVnaW5Db21wYXQudGFwKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnbWFrZScsXG4gICAgICAnU3VwcG9ydE1pbmlDc3NFeHRyYWN0UGx1Z2luJyxcbiAgICAgICh7IGRlcGVuZGVuY3lGYWN0b3JpZXMgfSkgPT4ge1xuICAgICAgICBjb25zdCBEZXBlbmRlbmNpZXMgPSBkZXBlbmRlbmN5RmFjdG9yaWVzLmtleXMoKTtcbiAgICAgICAgZm9yIChjb25zdCBEZXAgb2YgRGVwZW5kZW5jaWVzKSB7XG4gICAgICAgICAgaWYgKERlcC5uYW1lID09PSAnQ3NzRGVwZW5kZW5jeScpIHtcbiAgICAgICAgICAgIENzc0RlcGVuZGVuY3kgPSBEZXA7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgKTtcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZUFmdGVyRnJlZXplTW9kdWxlJyxcbiAgICAgICdIYXJkTWluaUNzc0V4dHJhY3RQbHVnaW4nLFxuICAgICAgKGZyb3plbiwgbW9kdWxlLCBleHRyYSkgPT4ge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgQ3NzRGVwZW5kZW5jeSAmJlxuICAgICAgICAgIG1vZHVsZS5kZXBlbmRlbmNpZXMuc29tZShkZXAgPT4gZGVwIGluc3RhbmNlb2YgQ3NzRGVwZW5kZW5jeSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZyb3plbjtcbiAgICAgIH0sXG4gICAgKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEV4Y2x1ZGVNaW5pQ3NzTW9kdWxlUGx1Z2luO1xuIl0sInNvdXJjZVJvb3QiOiIvVXNlcnMvdHlsZXJhcmJ1cy9kZXYvcHJvdmlkZXIvc3JjIn0=
