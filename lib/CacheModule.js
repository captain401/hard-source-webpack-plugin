'use strict';

require('source-map-support/register');

const pluginCompat = require('./util/plugin-compat');
const relateContext = require('./util/relate-context');
const { parityCacheFromCache, pushParityWriteOps } = require('./util/parity');

const relateNormalPath = relateContext.relateNormalPath;

function relateNormalRequest(compiler, key) {
  return key.split('!').map(subkey => relateNormalPath(compiler, subkey)).join('!');
}

function relateNormalModuleId(compiler, id) {
  return id.substring(0, 24) + relateNormalRequest(compiler, id.substring(24));
}

class ModuleCache {
  apply(compiler) {
    const compilerHooks = pluginCompat.hooks(compiler);

    let moduleCache = {};
    let parityCache = {};

    const moduleArchetypeCache = {
      _ops: [],

      get(id) {
        if (moduleCache[id] && !moduleCache[id].invalid) {
          if (typeof moduleCache[id] === 'string') {
            moduleCache[id] = JSON.parse(moduleCache[id]);
          }
          return moduleCache[id];
        }
      },

      set(id, item) {
        moduleCache[id] = item;
        if (item) {
          this._ops.push(id);
        } else if (moduleCache[id]) {
          if (typeof moduleCache[id] === 'string') {
            moduleCache[id] = JSON.parse(moduleCache[id]);
          }
          moduleCache[id].invalid = true;
          moduleCache[id].invalidReason = 'overwritten';

          this._ops.push(id);
        }
      },

      operations() {
        const _this = this;
        const ops = this._ops.map(id => ({
          key: relateNormalModuleId(compiler, id),
          value: _this.get(id) || null
        }));
        this._ops.length = 0;
        return ops;
      }
    };

    compilerHooks._hardSourceArchetypeRegister.call('Module', moduleArchetypeCache);

    let moduleCacheSerializer;

    compilerHooks._hardSourceCreateSerializer.tap('HardSource - ModuleCache', (cacheSerializerFactory, cacheDirPath) => {
      moduleCacheSerializer = cacheSerializerFactory.create({
        name: 'module',
        type: 'data',
        cacheDirPath,
        autoParse: true
      });
    });

    compilerHooks._hardSourceResetCache.tap('HardSource - ModuleCache', () => {
      moduleCache = {};
    });

    compilerHooks._hardSourceReadCache.tapPromise('HardSource - ModuleCache', ({ contextKeys, contextNormalModuleId, copyWithDeser }) => moduleCacheSerializer.read().then(_moduleCache => {
      Object.keys(_moduleCache).forEach(key => {
        if (key.startsWith('__hardSource_parityToken')) {
          parityCache[key] = _moduleCache[key];
          delete _moduleCache[key];
        }
      });
      return _moduleCache;
    }).then(contextKeys(compiler, contextNormalModuleId)).then(copyWithDeser.bind(null, moduleCache)));

    compilerHooks._hardSourceParityCache.tap('HardSource - ModuleCache', parityRoot => {
      parityCacheFromCache('Module', parityRoot, parityCache);
    });

    compilerHooks.compilation.tap('HardSource - ModuleCache', compilation => {
      compilation.__hardSourceModuleCache = moduleCache;
    });

    compilerHooks._hardSourceWriteCache.tapPromise('HardSource - ModuleCache', compilation => {
      const moduleOps = moduleArchetypeCache.operations();

      if (!compilation.compiler.parentCompilation) {
        // Add ops to remove no longer valid modules. If they were replaced with a
        // up to date module, they will already have replaced this item so we
        // won't accidentally delete up to date modules.
        Object.keys(moduleCache).forEach(key => {
          const cacheItem = moduleCache[key];
          if (cacheItem && cacheItem.invalid) {
            // console.log('invalid', cacheItem.invalidReason);
            moduleCache[key] = null;
            moduleOps.push({
              key,
              value: null
            });
          }
        });
      }

      pushParityWriteOps(compilation, moduleOps);

      return moduleCacheSerializer.write(moduleOps);
    });
  }
}

module.exports = ModuleCache;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9DYWNoZU1vZHVsZS5qcyJdLCJuYW1lcyI6WyJwbHVnaW5Db21wYXQiLCJyZXF1aXJlIiwicmVsYXRlQ29udGV4dCIsInBhcml0eUNhY2hlRnJvbUNhY2hlIiwicHVzaFBhcml0eVdyaXRlT3BzIiwicmVsYXRlTm9ybWFsUGF0aCIsInJlbGF0ZU5vcm1hbFJlcXVlc3QiLCJjb21waWxlciIsImtleSIsInNwbGl0IiwibWFwIiwic3Via2V5Iiwiam9pbiIsInJlbGF0ZU5vcm1hbE1vZHVsZUlkIiwiaWQiLCJzdWJzdHJpbmciLCJNb2R1bGVDYWNoZSIsImFwcGx5IiwiY29tcGlsZXJIb29rcyIsImhvb2tzIiwibW9kdWxlQ2FjaGUiLCJwYXJpdHlDYWNoZSIsIm1vZHVsZUFyY2hldHlwZUNhY2hlIiwiX29wcyIsImdldCIsImludmFsaWQiLCJKU09OIiwicGFyc2UiLCJzZXQiLCJpdGVtIiwicHVzaCIsImludmFsaWRSZWFzb24iLCJvcGVyYXRpb25zIiwiX3RoaXMiLCJvcHMiLCJ2YWx1ZSIsImxlbmd0aCIsIl9oYXJkU291cmNlQXJjaGV0eXBlUmVnaXN0ZXIiLCJjYWxsIiwibW9kdWxlQ2FjaGVTZXJpYWxpemVyIiwiX2hhcmRTb3VyY2VDcmVhdGVTZXJpYWxpemVyIiwidGFwIiwiY2FjaGVTZXJpYWxpemVyRmFjdG9yeSIsImNhY2hlRGlyUGF0aCIsImNyZWF0ZSIsIm5hbWUiLCJ0eXBlIiwiYXV0b1BhcnNlIiwiX2hhcmRTb3VyY2VSZXNldENhY2hlIiwiX2hhcmRTb3VyY2VSZWFkQ2FjaGUiLCJ0YXBQcm9taXNlIiwiY29udGV4dEtleXMiLCJjb250ZXh0Tm9ybWFsTW9kdWxlSWQiLCJjb3B5V2l0aERlc2VyIiwicmVhZCIsInRoZW4iLCJfbW9kdWxlQ2FjaGUiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsInN0YXJ0c1dpdGgiLCJiaW5kIiwiX2hhcmRTb3VyY2VQYXJpdHlDYWNoZSIsInBhcml0eVJvb3QiLCJjb21waWxhdGlvbiIsIl9faGFyZFNvdXJjZU1vZHVsZUNhY2hlIiwiX2hhcmRTb3VyY2VXcml0ZUNhY2hlIiwibW9kdWxlT3BzIiwicGFyZW50Q29tcGlsYXRpb24iLCJjYWNoZUl0ZW0iLCJ3cml0ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxlQUFlQyxRQUFRLHNCQUFSLENBQXJCO0FBQ0EsTUFBTUMsZ0JBQWdCRCxRQUFRLHVCQUFSLENBQXRCO0FBQ0EsTUFBTSxFQUFFRSxvQkFBRixFQUF3QkMsa0JBQXhCLEtBQStDSCxRQUFRLGVBQVIsQ0FBckQ7O0FBRUEsTUFBTUksbUJBQW1CSCxjQUFjRyxnQkFBdkM7O0FBRUEsU0FBU0MsbUJBQVQsQ0FBNkJDLFFBQTdCLEVBQXVDQyxHQUF2QyxFQUE0QztBQUMxQyxTQUFPQSxJQUNKQyxLQURJLENBQ0UsR0FERixFQUVKQyxHQUZJLENBRUFDLFVBQVVOLGlCQUFpQkUsUUFBakIsRUFBMkJJLE1BQTNCLENBRlYsRUFHSkMsSUFISSxDQUdDLEdBSEQsQ0FBUDtBQUlEOztBQUVELFNBQVNDLG9CQUFULENBQThCTixRQUE5QixFQUF3Q08sRUFBeEMsRUFBNEM7QUFDMUMsU0FBT0EsR0FBR0MsU0FBSCxDQUFhLENBQWIsRUFBZ0IsRUFBaEIsSUFBc0JULG9CQUFvQkMsUUFBcEIsRUFBOEJPLEdBQUdDLFNBQUgsQ0FBYSxFQUFiLENBQTlCLENBQTdCO0FBQ0Q7O0FBRUQsTUFBTUMsV0FBTixDQUFrQjtBQUNoQkMsUUFBTVYsUUFBTixFQUFnQjtBQUNkLFVBQU1XLGdCQUFnQmxCLGFBQWFtQixLQUFiLENBQW1CWixRQUFuQixDQUF0Qjs7QUFFQSxRQUFJYSxjQUFjLEVBQWxCO0FBQ0EsUUFBSUMsY0FBYyxFQUFsQjs7QUFFQSxVQUFNQyx1QkFBdUI7QUFDM0JDLFlBQU0sRUFEcUI7O0FBRzNCQyxVQUFJVixFQUFKLEVBQVE7QUFDTixZQUFJTSxZQUFZTixFQUFaLEtBQW1CLENBQUNNLFlBQVlOLEVB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QkFBcUIsUUFBckIsRUFBK0I0RCxVQUEvQixFQUEyQzFDLFdBQTNDO0FBQ0QsS0FKSDs7QUFPQUgsa0JBQWM4QyxXQUFkLENBQTBCdkIsR0FBMUIsQ0FBOEIsMEJBQTlCLEVBQTBEdUIsZUFBZTtBQUN2RUEsa0JBQVlDLHVCQUFaLEdBQXNDN0MsV0FBdEM7QUFDRCxLQUZEOztBQUlBRixrQkFBY2dELHFCQUFkLENBQW9DaEIsVUFBcEMsQ0FDRSwwQkFERixFQUVFYyxlQUFlO0FBQ2IsWUFBTUcsWUFBWTdDLHFCQUFxQlUsVUFBckIsRUFBbEI7O0FBRUEsVUFBSSxDQUFDZ0MsWUFBWXpELFFBQVosQ0FBcUI2RCxpQkFBMUIsRUFBNkM7QUFDM0M7QUFDQTtBQUNBO0FBQ0FYLGVBQU9DLElBQVAsQ0FBWXRDLFdBQVosRUFBeUJ1QyxPQUF6QixDQUFpQ25ELE9BQU87QUFDdEMsZ0JBQU02RCxZQUFZakQsWUFBWVosR0FBWixDQUFsQjtBQUNBLGNBQUk2RCxhQUFhQSxVQUFVNUMsT0FBM0IsRUFBb0M7QUFDbEM7QUFDQUwsd0JBQVlaLEdBQVosSUFBbUIsSUFBbkI7QUFDQTJELHNCQUFVckMsSUFBVixDQUFlO0FBQ2J0QixpQkFEYTtBQUViMkIscUJBQU87QUFGTSxhQUFmO0FBSUQ7QUFDRixTQVZEO0FBV0Q7O0FBRUQvQix5QkFBbUI0RCxXQUFuQixFQUFnQ0csU0FBaEM7O0FBRUEsYUFBTzVCLHNCQUFzQitCLEtBQXRCLENBQTRCSCxTQUE1QixDQUFQO0FBQ0QsS0F6Qkg7QUEyQkQ7QUE1SGU7O0FBK0hsQkksT0FBT0MsT0FBUCxHQUFpQnhELFdBQWpCIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9DYWNoZU1vZHVsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHBsdWdpbkNvbXBhdCA9IHJlcXVpcmUoJy4vdXRpbC9wbHVnaW4tY29tcGF0Jyk7XG5jb25zdCByZWxhdGVDb250ZXh0ID0gcmVxdWlyZSgnLi91dGlsL3JlbGF0ZS1jb250ZXh0Jyk7XG5jb25zdCB7IHBhcml0eUNhY2hlRnJvbUNhY2hlLCBwdXNoUGFyaXR5V3JpdGVPcHMgfSA9IHJlcXVpcmUoJy4vdXRpbC9wYXJpdHknKTtcblxuY29uc3QgcmVsYXRlTm9ybWFsUGF0aCA9IHJlbGF0ZUNvbnRleHQucmVsYXRlTm9ybWFsUGF0aDtcblxuZnVuY3Rpb24gcmVsYXRlTm9ybWFsUmVxdWVzdChjb21waWxlciwga2V5KSB7XG4gIHJldHVybiBrZXlcbiAgICAuc3BsaXQoJyEnKVxuICAgIC5tYXAoc3Via2V5ID0+IHJlbGF0ZU5vcm1hbFBhdGgoY29tcGlsZXIsIHN1YmtleSkpXG4gICAgLmpvaW4oJyEnKTtcbn1cblxuZnVuY3Rpb24gcmVsYXRlTm9ybWFsTW9kdWxlSWQoY29tcGlsZXIsIGlkKSB7XG4gIHJldHVybiBpZC5zdWJzdHJpbmcoMCwgMjQpICsgcmVsYXRlTm9ybWFsUmVxdWVzdChjb21waWxlciwgaWQuc3Vic3RyaW5nKDI0KSk7XG59XG5cbmNsYXNzIE1vZHVsZUNhY2hlIHtcbiAgYXBwbHkoY29tcGlsZXIpIHtcbiAgICBjb25zdCBjb21waWxlckhvb2tzID0gcGx1Z2luQ29tcGF0Lmhvb2tzKGNvbXBpbGVyKTtcblxuICAgIGxldCBtb2R1bGVDYWNoZSA9IHt9O1xuICAgIGxldCBwYXJpdHlDYWNoZSA9IHt9O1xuXG4gICAgY29uc3QgbW9kdWxlQXJjaGV0eXBlQ2FjaGUgPSB7XG4gICAgICBfb3BzOiBbXSxcblxuICAgICAgZ2V0KGlkKSB7XG4gICAgICAgIGlmIChtb2R1bGVDYWNoZVtpZF0gJiYgIW1vZHVsZUNhY2hlW2lkXS5pbnZhbGlkKSB7XG4gICAgICAgICAgaWYgKHR5cGVvZiBtb2R1bGVDYWNoZVtpZF0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBtb2R1bGVDYWNoZVtpZF0gPSBKU09OLnBhcnNlKG1vZHVsZUNhY2hlW2lkXSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBtb2R1bGVDYWNoZVtpZF07XG4gICAgICAgIH1cbiAgICAgIH0sXG5cbiAgICAgIHNldChpZCwgaXRlbSkge1xuICAgICAgICBtb2R1bGVDYWNoZVtpZF0gPSBpdGVtO1xuICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgIHRoaXMuX29wcy5wdXNoKGlkKTtcbiAgICAgICAgfSBlbHNlIGlmIChtb2R1bGVDYWNoZVtpZF0pIHtcbiAgICAgICAgICBpZiAodHlwZW9mIG1vZHVsZUNhY2hlW2lkXSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIG1vZHVsZUNhY2hlW2lkXSA9IEpTT04ucGFyc2UobW9kdWxlQ2FjaGVbaWRdKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbW9kdWxlQ2FjaGVbaWRdLmludmFsaWQgPSB0cnVlO1xuICAgICAgICAgIG1vZHVsZUNhY2hlW2lkXS5pbnZhbGlkUmVhc29uID0gJ292ZXJ3cml0dGVuJztcblxuICAgICAgICAgIHRoaXMuX29wcy5wdXNoKGlkKTtcbiAgICAgICAgfVxuICAgICAgfSxcblxuICAgICAgb3BlcmF0aW9ucygpIHtcbiAgICAgICAgY29uc3QgX3RoaXMgPSB0aGlzO1xuICAgICAgICBjb25zdCBvcHMgPSB0aGlzLl9vcHMubWFwKGlkID0+ICh7XG4gICAgICAgICAga2V5OiByZWxhdGVOb3JtYWxNb2R1bGVJZChjb21waWxlciwgaWQpLFxuICAgICAgICAgIHZhbHVlOiBfdGhpcy5nZXQoaWQpIHx8IG51bGwsXG4gICAgICAgIH0pKTtcbiAgICAgICAgdGhpcy5fb3BzLmxlbmd0aCA9IDA7XG4gICAgICAgIHJldHVybiBvcHM7XG4gICAgICB9LFxuICAgIH07XG5cbiAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlQXJjaGV0eXBlUmVnaXN0ZXIuY2FsbChcbiAgICAgICdNb2R1bGUnLFxuICAgICAgbW9kdWxlQXJjaGV0eXBlQ2FjaGUsXG4gICAgKTtcblxuICAgIGxldCBtb2R1bGVDYWNoZVNlcmlhbGl6ZXI7XG5cbiAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlQ3JlYXRlU2VyaWFsaXplci50YXAoXG4gICAgICAnSGFyZFNvdXJjZSAtIE1vZHVsZUNhY2hlJyxcbiAgICAgIChjYWNoZVNlcmlhbGl6ZXJGYWN0b3J5LCBjYWNoZURpclBhdGgpID0+IHtcbiAgICAgICAgbW9kdWxlQ2FjaGVTZXJpYWxpemVyID0gY2FjaGVTZXJpYWxpemVyRmFjdG9yeS5jcmVhdGUoe1xuICAgICAgICAgIG5hbWU6ICdtb2R1bGUnLFxuICAgICAgICAgIHR5cGU6ICdkYXRhJyxcbiAgICAgICAgICBjYWNoZURpclBhdGgsXG4gICAgICAgICAgYXV0b1BhcnNlOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGNvbXBpbGVySG9va3MuX2hhcmRTb3VyY2VSZXNldENhY2hlLnRhcCgnSGFyZFNvdXJjZSAtIE1vZHVsZUNhY2hlJywgKCkgPT4ge1xuICAgICAgbW9kdWxlQ2FjaGUgPSB7fTtcbiAgICB9KTtcblxuICAgIGNvbXBpbGVySG9va3MuX2hhcmRTb3VyY2VSZWFkQ2FjaGUudGFwUHJvbWlzZShcbiAgICAgICdIYXJkU291cmNlIC0gTW9kdWxlQ2FjaGUnLFxuICAgICAgKHsgY29udGV4dEtleXMsIGNvbnRleHROb3JtYWxNb2R1bGVJZCwgY29weVdpdGhEZXNlciB9KSA9PlxuICAgICAgICBtb2R1bGVDYWNoZVNlcmlhbGl6ZXJcbiAgICAgICAgICAucmVhZCgpXG4gICAgICAgICAgLnRoZW4oX21vZHVsZUNhY2hlID0+IHtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKF9tb2R1bGVDYWNoZSkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJ19faGFyZFNvdXJjZV9wYXJpdHlUb2tlbicpKSB7XG4gICAgICAgICAgICAgICAgcGFyaXR5Q2FjaGVba2V5XSA9IF9tb2R1bGVDYWNoZVtrZXldO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBfbW9kdWxlQ2FjaGVba2V5XTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gX21vZHVsZUNhY2hlO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLnRoZW4oY29udGV4dEtleXMoY29tcGlsZXIsIGNvbnRleHROb3JtYWxNb2R1bGVJZCkpXG4gICAgICAgICAgLnRoZW4oY29weVdpdGhEZXNlci5iaW5kKG51bGwsIG1vZHVsZUNhY2hlKSksXG4gICAgKTtcblxuICAgIGNvbXBpbGVySG9va3MuX2hhcmRTb3VyY2VQYXJpdHlDYWNoZS50YXAoXG4gICAgICAnSGFyZFNvdXJjZSAtIE1vZHVsZUNhY2hlJyxcbiAgICAgIHBhcml0eVJvb3QgPT4ge1xuICAgICAgICBwYXJpdHlDYWNoZUZyb21DYWNoZSgnTW9kdWxlJywgcGFyaXR5Um9vdCwgcGFyaXR5Q2FjaGUpO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgY29tcGlsZXJIb29rcy5jb21waWxhdGlvbi50YXAoJ0hhcmRTb3VyY2UgLSBNb2R1bGVDYWNoZScsIGNvbXBpbGF0aW9uID0+IHtcbiAgICAgIGNvbXBpbGF0aW9uLl9faGFyZFNvdXJjZU1vZHVsZUNhY2hlID0gbW9kdWxlQ2FjaGU7XG4gICAgfSk7XG5cbiAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlV3JpdGVDYWNoZS50YXBQcm9taXNlKFxuICAgICAgJ0hhcmRTb3VyY2UgLSBNb2R1bGVDYWNoZScsXG4gICAgICBjb21waWxhdGlvbiA9PiB7XG4gICAgICAgIGNvbnN0IG1vZHVsZU9wcyA9IG1vZHVsZUFyY2hldHlwZUNhY2hlLm9wZXJhdGlvbnMoKTtcblxuICAgICAgICBpZiAoIWNvbXBpbGF0aW9uLmNvbXBpbGVyLnBhcmVudENvbXBpbGF0aW9uKSB7XG4gICAgICAgICAgLy8gQWRkIG9wcyB0byByZW1vdmUgbm8gbG9uZ2VyIHZhbGlkIG1vZHVsZXMuIElmIHRoZXkgd2VyZSByZXBsYWNlZCB3aXRoIGFcbiAgICAgICAgICAvLyB1cCB0byBkYXRlIG1vZHVsZSwgdGhleSB3aWxsIGFscmVhZHkgaGF2ZSByZXBsYWNlZCB0aGlzIGl0ZW0gc28gd2VcbiAgICAgICAgICAvLyB3b24ndCBhY2NpZGVudGFsbHkgZGVsZXRlIHVwIHRvIGRhdGUgbW9kdWxlcy5cbiAgICAgICAgICBPYmplY3Qua2V5cyhtb2R1bGVDYWNoZSkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2FjaGVJdGVtID0gbW9kdWxlQ2FjaGVba2V5XTtcbiAgICAgICAgICAgIGlmIChjYWNoZUl0ZW0gJiYgY2FjaGVJdGVtLmludmFsaWQpIHtcbiAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2ludmFsaWQnLCBjYWNoZUl0ZW0uaW52YWxpZFJlYXNvbik7XG4gICAgICAgICAgICAgIG1vZHVsZUNhY2hlW2tleV0gPSBudWxsO1xuICAgICAgICAgICAgICBtb2R1bGVPcHMucHVzaCh7XG4gICAgICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgICAgIHZhbHVlOiBudWxsLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHB1c2hQYXJpdHlXcml0ZU9wcyhjb21waWxhdGlvbiwgbW9kdWxlT3BzKTtcblxuICAgICAgICByZXR1cm4gbW9kdWxlQ2FjaGVTZXJpYWxpemVyLndyaXRlKG1vZHVsZU9wcyk7XG4gICAgICB9LFxuICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNb2R1bGVDYWNoZTtcbiJdLCJzb3VyY2VSb290IjoiL1VzZXJzL3R5bGVyYXJidXMvZGV2L3Byb3ZpZGVyL3NyYyJ9
