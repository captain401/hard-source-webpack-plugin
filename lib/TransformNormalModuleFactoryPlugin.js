'use strict';

const fs = require('fs');
const path = require('path');

const cachePrefix = require('./util').cachePrefix;
const pluginCompat = require('./util/plugin-compat');
const relateContext = require('./util/relate-context');

let NS;

NS = path.dirname(fs.realpathSync(__dirname));

class NormalModuleFactoryPlugin {
  apply(compiler) {
    const compilerHooks = pluginCompat.hooks(compiler);

    let fetch;

    compilerHooks._hardSourceMethods.tap('HardSource - TransformNormalModuleFactoryPlugin', methods => {
      fetch = methods.fetch;
    });

    compilerHooks.compilation.tap('HardSource - TransformNormalModuleFactoryPlugin', (compilation, { normalModuleFactory, contextModuleFactory }) => {
      // if (!active) {return;}

      // compilation.fileTimestamps = fileTimestamps;
      // compilation.contextTimestamps = contextTimestamps;

      // compilation.__hardSourceFileMd5s = fileMd5s;
      // compilation.__hardSourceCachedMd5s = cachedMd5s;

      const compilationHooks = pluginCompat.hooks(compilation);
      compilationHooks.buildModule.tap('HardSource - TransformNormalModuleFactoryPlugin', module => {
        if (module.constructor.name === 'NormalModule') {
          module.__originalCreateLoaderContext = module.__originalCreateLoaderContext || module.createLoaderContext;
          module.__hardSource_resolved = {};
          module.createLoaderContext = (...args) => {
            const loaderContext = module.__originalCreateLoaderContext(...args);
            const _resolve = loaderContext.resolve;
            loaderContext.resolve = (context, request, callback) => {
              _resolve.call(loaderContext, context, request, (err, result) => {
                if (err) {
                  callback(err, result);
                } else {
                  module.__hardSource_resolved[JSON.stringify({ context, request })] = {
                    resource: result,
                    resolveOptions: module.resolveOptions
                  };
                  callback(err, result);
                }
              });
            };
            return loaderContext;
          };
        }
      });

      const normalModuleFactoryHooks = pluginCompat.hooks(normalModuleFactory);

      // Webpack 2 can use different parsers based on config rule sets.
      normalModuleFactoryHooks.parser.for('javascript/auto').tap('HardSource - TransformNormalModuleFactoryPlugin', (parser, options) => {
        // Store the options somewhere that can not conflict with another plugin
        // on the parser so we can look it up and store those options with a
        // cached module resolution.
        parser[`${NS}/parser-options`] = options;
      });

      normalModuleFactoryHooks.resolver.tap('HardSource - TransformNormalModuleFactoryPlugin', fn => (request, cb) => {
        const identifierPrefix = cachePrefix(compilation);
        if (identifierPrefix === null) {
          return fn.call(null, request, cb);
        }

        const cacheId = JSON.stringify([identifierPrefix, request.context, request.request]);
        const absCacheId = JSON.stringify([identifierPrefix, request.context, relateContext.relateAbsoluteRequest(request.context, request.request)]);

        request.contextInfo.resolveOptions = request.resolveOptions;

        const next = () => {
          const originalRequest = request;
          return fn.call(null, request, function (err, request) {
            if (err) {
              return cb(err);
            }
            if (!request.source) {
              compilation.__hardSourceModuleResolveCacheChange.push(cacheId);
              compilation.__hardSourceModuleResolveCache[cacheId] = Object.assign({}, request, {
                parser: null,
                generator: null,
                parserOptions: request.parser[`${NS}/parser-options`],
                type: request.settings && request.settings.type,
                settings: request.settings,
                resourceResolveData: request.resourceResolveData,
                dependencies: null
              });
            }
            cb(...arguments);
          });
        };

        const fromCache = () => {
          const result = Object.assign({}, compilation.__hardSourceModuleResolveCache[cacheId] || compilation.__hardSourceModuleResolveCache[absCacheId]);
          result.dependencies = request.dependencies;

          if (!result.parser || !result.parser.parse) {
            result.parser = result.settings ? normalModuleFactory.getParser(result.type, result.settings.parser) : normalModuleFactory.getParser(result.parserOptions);
          }
          if (!result.generator && normalModuleFactory.getGenerator) {
            result.generator = normalModuleFactory.getGenerator(result.type, result.settings.generator);
          }

          result.loaders = result.loaders.map(loader => {
            if (typeof loader === 'object' && loader.ident) {
              const ruleSet = normalModuleFactory.ruleSet;
              return {
                loader: loader.loader,
                ident: loader.ident,
                options: ruleSet.references[loader.ident]
              };
            }
            return loader;
          });

          return cb(null, result);
        };

        if (compilation.__hardSourceModuleResolveCache[cacheId] && !compilation.__hardSourceModuleResolveCache[cacheId].invalid || compilation.__hardSourceModuleResolveCache[absCacheId] && !compilation.__hardSourceModuleResolveCache[absCacheId].invalid) {
          return fromCache();
        }

        next();
      });

      normalModuleFactoryHooks.createModule.tap('HardSourceWebpackPlugin', ({ request }) => {
        if (compilation.cache && compilation.cache[`m${request}`] && compilation.cache[`m${request}`].cacheItem && !compilation.cache[`m${request}`].cacheItem.invalid) {
          return compilation.cache[`m${request}`];
        }

        const identifierPrefix = cachePrefix(compilation);
        if (identifierPrefix === null) {
          return;
        }

        const identifier = identifierPrefix + request;

        const module = fetch('Module', identifier, {
          compilation,
          normalModuleFactory: normalModuleFactory,
          contextModuleFactory: contextModuleFactory
        });

        if (module) {
          return module;
        }
      });
    });
  }
}

module.exports = NormalModuleFactoryPlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9UcmFuc2Zvcm1Ob3JtYWxNb2R1bGVGYWN0b3J5UGx1Z2luLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsInBhdGgiLCJjYWNoZVByZWZpeCIsInBsdWdpbkNvbXBhdCIsInJlbGF0ZUNvbnRleHQiLCJOUyIsImRpcm5hbWUiLCJyZWFscGF0aFN5bmMiLCJfX2Rpcm5hbWUiLCJOb3JtYWxNb2R1bGVGYWN0b3J5UGx1Z2luIiwiYXBwbHkiLCJjb21waWxlciIsImNvbXBpbGVySG9va3MiLCJob29rcyIsImZldGNoIiwiX2hhcmRTb3VyY2VNZXRob2RzIiwidGFwIiwibWV0aG9kcyIsImNvbXBpbGF0aW9uIiwibm9ybWFsTW9kdWxlRmFjdG9yeSIsImNvbnRleHRNb2R1bGVGYWN0b3J5IiwiY29tcGlsYXRpb25Ib29rcyIsImJ1aWxkTW9kdWxlIiwibW9kdWxlIiwiY29uc3RydWN0b3IiLCJuYW1lIiwiX19vcmlnaW5hbENyZWF0ZUxvYWRlckNvbnRleHQiLCJjcmVhdGVMb2FkZXJDb250ZXh0IiwiX19oYXJkU291cmNlX3Jlc29sdmVkIiwiYXJncyIsImxvYWRlckNvbnRleHQiLCJfcmVzb2x2ZSIsInJlc29sdmUiLCJjb250ZXh0IiwicmVxdWVzdCIsImNhbGxiYWNrIiwiY2FsbCIsImVyciIsInJlc3VsdCIsIkpTT04iLCJzdHJpbmdpZnkiLCJyZXNvdXJjZSIsInJlc29sdmVPcHRpb25zIiwibm9ybWFsTW9kdWxlRmFjdG9yeUhvb2tzIiwicGFyc2VyIiwiZm9yIiwib3B0aW9ucyIsInJlc29sdmVyIiwiZm4iLCJjYiIsImlkZW50aWZpZXJQcmVmaXgiLCJjYWNoZUlkIiwiYWJzQ2FjaGVJZCIsInJlbGF0ZUFic29sdXRlUmVxdWVzdCIsImNvbnRleHRJbmZvIiwibmV4dCIsIm9yaWdpbmFsUmVxdWVzdCIsInNvdXJjZSIsIl9faGFyZFNvdXJjZU1vZHVsZVJlc29sdmVDYWNoZUNoYW5nZSIsInB1c2giLCJfX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGUiLCJPYmplY3QiLCJhc3NpZ24iLCJnZW5lcmF0b3IiLCJwYXJzZXJPcHRpb25zIiwidHlwZSIsInNldHRpbmdzIiwicmVzb3VyY2VSZXNvbHZlRGF0YSIsImRlcGVuZGVuY2llcyIsImFyZ3VtZW50cyIsImZyb21DYWNoZSIsInBhcnNlIiwiZ2V0UGFyc2VyIiwiZ2V0R2VuZXJhdG9yIiwibG9hZGVycyIsIm1hcCIsImxvYWRlciIsImlkZW50IiwicnVsZVNldCIsInJlZmVyZW5jZXMiLCJpbnZhbGlkIiwiY3JlYXRlTW9kdWxlIiwiY2FjaGUiLCJjYWNoZUl0ZW0iLCJpZGVudGlmaWVyIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxLQUFLQyxRQUFRLElBQVIsQ0FBWDtBQUNBLE1BQU1DLE9BQU9ELFFBQVEsTUFBUixDQUFiOztBQUVBLE1BQU1FLGNBQWNGLGtCQUFrQkUsV0FBdEM7QUFDQSxNQUFNQyxlQUFlSCwrQkFBckI7QUFDQSxNQUFNSSxnQkFBZ0JKLGdDQUF0Qjs7QUFFQSxJQUFJSyxFQUFKOztBQUVBQSxLQUFLSixLQUFLSyxPQUFMLENBQWFQLEdBQUdRLFlBQUgsQ0FBZ0JDLFNBQWhCLENBQWIsQ0FBTDs7QUFFQSxNQUFNQyx5QkFBTixDQUFnQztBQUM5QkMsUUFBTUMsUUFBTixFQUFnQjtBQUNkLFVBQU1DLGdCQUFnQlQsYUFBYVUsS0FBYixDQUFtQkYsUUFBbkIsQ0FBdEI7O0FBRUEsUUFBSUcsS0FBSjs7QUFFQUYsa0JBQWNHLGtCQUFkLENBQWlDQyxHQUFqQyxDQUNFLGlEQURGLEVBRUVDLFdBQVc7QUFDVEgsY0FBUUcsUUFBUUgsS0FBaEI7QUFDRCxLQUpIOztBQU9BRixrQkFBY00sV0FBZCxDQUEwQkYsR0FBMUIsQ0FDRSxpREFERixFQUVFLENBQUNFLFdBQUQsRUFBYyxFQUFFQyxtQkFBRixFQUF1QkMsb0JBQXZCLEVBQWQsS0FBZ0U7QUFDOUQ7O0FBRUE7QUFDQTs7QUFFQTtBQUNBOztB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QUFDakUsWUFBWWdFLEtBQVosQ0FBbUIsSUFBR2hELE9BQVEsRUFBOUIsRUFBaUNpRCxTQUFqQyxDQUEyQ0gsT0FKOUMsRUFLRTtBQUNBLGlCQUFPOUQsWUFBWWdFLEtBQVosQ0FBbUIsSUFBR2hELE9BQVEsRUFBOUIsQ0FBUDtBQUNEOztBQUVELGNBQU1nQixtQkFBbUJoRCxZQUFZZ0IsV0FBWixDQUF6QjtBQUNBLFlBQUlnQyxxQkFBcUIsSUFBekIsRUFBK0I7QUFDN0I7QUFDRDs7QUFFRCxjQUFNa0MsYUFBYWxDLG1CQUFtQmhCLE9BQXRDOztBQUVBLGNBQU1YLFNBQVNULE1BQU0sUUFBTixFQUFnQnNFLFVBQWhCLEVBQTRCO0FBQ3pDbEUscUJBRHlDO0FBRXpDQywrQkFBcUJBLG1CQUZvQjtBQUd6Q0MsZ0NBQXNCQTtBQUhtQixTQUE1QixDQUFmOztBQU1BLFlBQUlHLE1BQUosRUFBWTtBQUNWLGlCQUFPQSxNQUFQO0FBQ0Q7QUFDRixPQTVCSDtBQThCRCxLQXZNSDtBQXlNRDtBQXRONkI7O0FBeU5oQ0EsT0FBTzhELE9BQVAsR0FBaUI1RSx5QkFBakIiLCJmaWxlIjoiaGFyZC1zb3VyY2Utd2VicGFjay1wbHVnaW4vbGliL1RyYW5zZm9ybU5vcm1hbE1vZHVsZUZhY3RvcnlQbHVnaW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXG5jb25zdCBjYWNoZVByZWZpeCA9IHJlcXVpcmUoJy4vdXRpbCcpLmNhY2hlUHJlZml4O1xuY29uc3QgcGx1Z2luQ29tcGF0ID0gcmVxdWlyZSgnLi91dGlsL3BsdWdpbi1jb21wYXQnKTtcbmNvbnN0IHJlbGF0ZUNvbnRleHQgPSByZXF1aXJlKCcuL3V0aWwvcmVsYXRlLWNvbnRleHQnKTtcblxubGV0IE5TO1xuXG5OUyA9IHBhdGguZGlybmFtZShmcy5yZWFscGF0aFN5bmMoX19kaXJuYW1lKSk7XG5cbmNsYXNzIE5vcm1hbE1vZHVsZUZhY3RvcnlQbHVnaW4ge1xuICBhcHBseShjb21waWxlcikge1xuICAgIGNvbnN0IGNvbXBpbGVySG9va3MgPSBwbHVnaW5Db21wYXQuaG9va3MoY29tcGlsZXIpO1xuXG4gICAgbGV0IGZldGNoO1xuXG4gICAgY29tcGlsZXJIb29rcy5faGFyZFNvdXJjZU1ldGhvZHMudGFwKFxuICAgICAgJ0hhcmRTb3VyY2UgLSBUcmFuc2Zvcm1Ob3JtYWxNb2R1bGVGYWN0b3J5UGx1Z2luJyxcbiAgICAgIG1ldGhvZHMgPT4ge1xuICAgICAgICBmZXRjaCA9IG1ldGhvZHMuZmV0Y2g7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICBjb21waWxlckhvb2tzLmNvbXBpbGF0aW9uLnRhcChcbiAgICAgICdIYXJkU291cmNlIC0gVHJhbnNmb3JtTm9ybWFsTW9kdWxlRmFjdG9yeVBsdWdpbicsXG4gICAgICAoY29tcGlsYXRpb24sIHsgbm9ybWFsTW9kdWxlRmFjdG9yeSwgY29udGV4dE1vZHVsZUZhY3RvcnkgfSkgPT4ge1xuICAgICAgICAvLyBpZiAoIWFjdGl2ZSkge3JldHVybjt9XG5cbiAgICAgICAgLy8gY29tcGlsYXRpb24uZmlsZVRpbWVzdGFtcHMgPSBmaWxlVGltZXN0YW1wcztcbiAgICAgICAgLy8gY29tcGlsYXRpb24uY29udGV4dFRpbWVzdGFtcHMgPSBjb250ZXh0VGltZXN0YW1wcztcblxuICAgICAgICAvLyBjb21waWxhdGlvbi5fX2hhcmRTb3VyY2VGaWxlTWQ1cyA9IGZpbGVNZDVzO1xuICAgICAgICAvLyBjb21waWxhdGlvbi5fX2hhcmRTb3VyY2VDYWNoZWRNZDVzID0gY2FjaGVkTWQ1cztcblxuICAgICAgICBjb25zdCBjb21waWxhdGlvbkhvb2tzID0gcGx1Z2luQ29tcGF0Lmhvb2tzKGNvbXBpbGF0aW9uKTtcbiAgICAgICAgY29tcGlsYXRpb25Ib29rcy5idWlsZE1vZHVsZS50YXAoXG4gICAgICAgICAgJ0hhcmRTb3VyY2UgLSBUcmFuc2Zvcm1Ob3JtYWxNb2R1bGVGYWN0b3J5UGx1Z2luJyxcbiAgICAgICAgICBtb2R1bGUgPT4ge1xuICAgICAgICAgICAgaWYgKG1vZHVsZS5jb25zdHJ1Y3Rvci5uYW1lID09PSAnTm9ybWFsTW9kdWxlJykge1xuICAgICAgICAgICAgICBtb2R1bGUuX19vcmlnaW5hbENyZWF0ZUxvYWRlckNvbnRleHQgPVxuICAgICAgICAgICAgICAgIG1vZHVsZS5fX29yaWdpbmFsQ3JlYXRlTG9hZGVyQ29udGV4dCB8fFxuICAgICAgICAgICAgICAgIG1vZHVsZS5jcmVhdGVMb2FkZXJDb250ZXh0O1xuICAgICAgICAgICAgICBtb2R1bGUuX19oYXJkU291cmNlX3Jlc29sdmVkID0ge307XG4gICAgICAgICAgICAgIG1vZHVsZS5jcmVhdGVMb2FkZXJDb250ZXh0ID0gKC4uLmFyZ3MpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBsb2FkZXJDb250ZXh0ID0gbW9kdWxlLl9fb3JpZ2luYWxDcmVhdGVMb2FkZXJDb250ZXh0KFxuICAgICAgICAgICAgICAgICAgLi4uYXJncyxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGNvbnN0IF9yZXNvbHZlID0gbG9hZGVyQ29udGV4dC5yZXNvbHZlO1xuICAgICAgICAgICAgICAgIGxvYWRlckNvbnRleHQucmVzb2x2ZSA9IChjb250ZXh0LCByZXF1ZXN0LCBjYWxsYmFjaykgPT4ge1xuICAgICAgICAgICAgICAgICAgX3Jlc29sdmUuY2FsbChcbiAgICAgICAgICAgICAgICAgICAgbG9hZGVyQ29udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgICAgICAgICAgICAgKGVyciwgcmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyLCByZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGUuX19oYXJkU291cmNlX3Jlc29sdmVkW1xuICAgICAgICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7IGNvbnRleHQsIHJlcXVlc3QgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIF0gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlOiByZXN1bHQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVPcHRpb25zOiBtb2R1bGUucmVzb2x2ZU9wdGlvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyLCByZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICByZXR1cm4gbG9hZGVyQ29udGV4dDtcbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IG5vcm1hbE1vZHVsZUZhY3RvcnlIb29rcyA9IHBsdWdpbkNvbXBhdC5ob29rcyhcbiAgICAgICAgICBub3JtYWxNb2R1bGVGYWN0b3J5LFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIFdlYnBhY2sgMiBjYW4gdXNlIGRpZmZlcmVudCBwYXJzZXJzIGJhc2VkIG9uIGNvbmZpZyBydWxlIHNldHMuXG4gICAgICAgIG5vcm1hbE1vZHVsZUZhY3RvcnlIb29rcy5wYXJzZXJcbiAgICAgICAgICAuZm9yKCdqYXZhc2NyaXB0L2F1dG8nKVxuICAgICAgICAgIC50YXAoXG4gICAgICAgICAgICAnSGFyZFNvdXJjZSAtIFRyYW5zZm9ybU5vcm1hbE1vZHVsZUZhY3RvcnlQbHVnaW4nLFxuICAgICAgICAgICAgKHBhcnNlciwgb3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgICAvLyBTdG9yZSB0aGUgb3B0aW9ucyBzb21ld2hlcmUgdGhhdCBjYW4gbm90IGNvbmZsaWN0IHdpdGggYW5vdGhlciBwbHVnaW5cbiAgICAgICAgICAgICAgLy8gb24gdGhlIHBhcnNlciBzbyB3ZSBjYW4gbG9vayBpdCB1cCBhbmQgc3RvcmUgdGhvc2Ugb3B0aW9ucyB3aXRoIGFcbiAgICAgICAgICAgICAgLy8gY2FjaGVkIG1vZHVsZSByZXNvbHV0aW9uLlxuICAgICAgICAgICAgICBwYXJzZXJbYCR7TlN9L3BhcnNlci1vcHRpb25zYF0gPSBvcHRpb25zO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICApO1xuXG4gICAgICAgIG5vcm1hbE1vZHVsZUZhY3RvcnlIb29rcy5yZXNvbHZlci50YXAoXG4gICAgICAgICAgJ0hhcmRTb3VyY2UgLSBUcmFuc2Zvcm1Ob3JtYWxNb2R1bGVGYWN0b3J5UGx1Z2luJyxcbiAgICAgICAgICBmbiA9PiAocmVxdWVzdCwgY2IpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGlkZW50aWZpZXJQcmVmaXggPSBjYWNoZVByZWZpeChjb21waWxhdGlvbik7XG4gICAgICAgICAgICBpZiAoaWRlbnRpZmllclByZWZpeCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXR1cm4gZm4uY2FsbChudWxsLCByZXF1ZXN0LCBjYik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGNhY2hlSWQgPSBKU09OLnN0cmluZ2lmeShbXG4gICAgICAgICAgICAgIGlkZW50aWZpZXJQcmVmaXgsXG4gICAgICAgICAgICAgIHJlcXVlc3QuY29udGV4dCxcbiAgICAgICAgICAgICAgcmVxdWVzdC5yZXF1ZXN0LFxuICAgICAgICAgICAgXSk7XG4gICAgICAgICAgICBjb25zdCBhYnNDYWNoZUlkID0gSlNPTi5zdHJpbmdpZnkoW1xuICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4LFxuICAgICAgICAgICAgICByZXF1ZXN0LmNvbnRleHQsXG4gICAgICAgICAgICAgIHJlbGF0ZUNvbnRleHQucmVsYXRlQWJzb2x1dGVSZXF1ZXN0KFxuICAgICAgICAgICAgICAgIHJlcXVlc3QuY29udGV4dCxcbiAgICAgICAgICAgICAgICByZXF1ZXN0LnJlcXVlc3QsXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICBdKTtcblxuICAgICAgICAgICAgcmVxdWVzdC5jb250ZXh0SW5mby5yZXNvbHZlT3B0aW9ucyA9IHJlcXVlc3QucmVzb2x2ZU9wdGlvbnM7XG5cbiAgICAgICAgICAgIGNvbnN0IG5leHQgPSAoKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsUmVxdWVzdCA9IHJlcXVlc3Q7XG4gICAgICAgICAgICAgIHJldHVybiBmbi5jYWxsKG51bGwsIHJlcXVlc3QsIGZ1bmN0aW9uKGVyciwgcmVxdWVzdCkge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBjYihlcnIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXJlcXVlc3Quc291cmNlKSB7XG4gICAgICAgICAgICAgICAgICBjb21waWxhdGlvbi5fX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGVDaGFuZ2UucHVzaChcbiAgICAgICAgICAgICAgICAgICAgY2FjaGVJZCxcbiAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICBjb21waWxhdGlvbi5fX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGVbXG4gICAgICAgICAgICAgICAgICAgIGNhY2hlSWRcbiAgICAgICAgICAgICAgICAgIF0gPSBPYmplY3QuYXNzaWduKHt9LCByZXF1ZXN0LCB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnNlcjogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgZ2VuZXJhdG9yOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICBwYXJzZXJPcHRpb25zOiByZXF1ZXN0LnBhcnNlcltgJHtOU30vcGFyc2VyLW9wdGlvbnNgXSxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogcmVxdWVzdC5zZXR0aW5ncyAmJiByZXF1ZXN0LnNldHRpbmdzLnR5cGUsXG4gICAgICAgICAgICAgICAgICAgIHNldHRpbmdzOiByZXF1ZXN0LnNldHRpbmdzLFxuICAgICAgICAgICAgICAgICAgICByZXNvdXJjZVJlc29sdmVEYXRhOiByZXF1ZXN0LnJlc291cmNlUmVzb2x2ZURhdGEsXG4gICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY2llczogbnVsbCxcbiAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYiguLi5hcmd1bWVudHMpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGNvbnN0IGZyb21DYWNoZSA9ICgpID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gT2JqZWN0LmFzc2lnbihcbiAgICAgICAgICAgICAgICB7fSxcbiAgICAgICAgICAgICAgICBjb21waWxhdGlvbi5fX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGVbY2FjaGVJZF0gfHxcbiAgICAgICAgICAgICAgICAgIGNvbXBpbGF0aW9uLl9faGFyZFNvdXJjZU1vZHVsZVJlc29sdmVDYWNoZVthYnNDYWNoZUlkXSxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgcmVzdWx0LmRlcGVuZGVuY2llcyA9IHJlcXVlc3QuZGVwZW5kZW5jaWVzO1xuXG4gICAgICAgICAgICAgIGlmICghcmVzdWx0LnBhcnNlciB8fCAhcmVzdWx0LnBhcnNlci5wYXJzZSkge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wYXJzZXIgPSByZXN1bHQuc2V0dGluZ3NcbiAgICAgICAgICAgICAgICAgID8gbm9ybWFsTW9kdWxlRmFjdG9yeS5nZXRQYXJzZXIoXG4gICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnNldHRpbmdzLnBhcnNlcixcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgOiBub3JtYWxNb2R1bGVGYWN0b3J5LmdldFBhcnNlcihyZXN1bHQucGFyc2VyT3B0aW9ucyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKCFyZXN1bHQuZ2VuZXJhdG9yICYmIG5vcm1hbE1vZHVsZUZhY3RvcnkuZ2V0R2VuZXJhdG9yKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LmdlbmVyYXRvciA9IG5vcm1hbE1vZHVsZUZhY3RvcnkuZ2V0R2VuZXJhdG9yKFxuICAgICAgICAgICAgICAgICAgcmVzdWx0LnR5cGUsXG4gICAgICAgICAgICAgICAgICByZXN1bHQuc2V0dGluZ3MuZ2VuZXJhdG9yLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICByZXN1bHQubG9hZGVycyA9IHJlc3VsdC5sb2FkZXJzLm1hcChsb2FkZXIgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbG9hZGVyID09PSAnb2JqZWN0JyAmJiBsb2FkZXIuaWRlbnQpIHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHJ1bGVTZXQgPSBub3JtYWxNb2R1bGVGYWN0b3J5LnJ1bGVTZXQ7XG4gICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBsb2FkZXI6IGxvYWRlci5sb2FkZXIsXG4gICAgICAgICAgICAgICAgICAgIGlkZW50OiBsb2FkZXIuaWRlbnQsXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IHJ1bGVTZXQucmVmZXJlbmNlc1tsb2FkZXIuaWRlbnRdLFxuICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxvYWRlcjtcbiAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgcmV0dXJuIGNiKG51bGwsIHJlc3VsdCk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgIChjb21waWxhdGlvbi5fX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGVbY2FjaGVJZF0gJiZcbiAgICAgICAgICAgICAgICAhY29tcGlsYXRpb24uX19oYXJkU291cmNlTW9kdWxlUmVzb2x2ZUNhY2hlW2NhY2hlSWRdLmludmFsaWQpIHx8XG4gICAgICAgICAgICAgIChjb21waWxhdGlvbi5fX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGVbYWJzQ2FjaGVJZF0gJiZcbiAgICAgICAgICAgICAgICAhY29tcGlsYXRpb24uX19oYXJkU291cmNlTW9kdWxlUmVzb2x2ZUNhY2hlW2Fic0NhY2hlSWRdLmludmFsaWQpXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGZyb21DYWNoZSgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgICAgfSxcbiAgICAgICAgKTtcblxuICAgICAgICBub3JtYWxNb2R1bGVGYWN0b3J5SG9va3MuY3JlYXRlTW9kdWxlLnRhcChcbiAgICAgICAgICAnSGFyZFNvdXJjZVdlYnBhY2tQbHVnaW4nLFxuICAgICAgICAgICh7IHJlcXVlc3QgfSkgPT4ge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICBjb21waWxhdGlvbi5jYWNoZSAmJlxuICAgICAgICAgICAgICBjb21waWxhdGlvbi5jYWNoZVtgbSR7cmVxdWVzdH1gXSAmJlxuICAgICAgICAgICAgICBjb21waWxhdGlvbi5jYWNoZVtgbSR7cmVxdWVzdH1gXS5jYWNoZUl0ZW0gJiZcbiAgICAgICAgICAgICAgIWNvbXBpbGF0aW9uLmNhY2hlW2BtJHtyZXF1ZXN0fWBdLmNhY2hlSXRlbS5pbnZhbGlkXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGNvbXBpbGF0aW9uLmNhY2hlW2BtJHtyZXF1ZXN0fWBdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBpZGVudGlmaWVyUHJlZml4ID0gY2FjaGVQcmVmaXgoY29tcGlsYXRpb24pO1xuICAgICAgICAgICAgaWYgKGlkZW50aWZpZXJQcmVmaXggPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBpZGVudGlmaWVyID0gaWRlbnRpZmllclByZWZpeCArIHJlcXVlc3Q7XG5cbiAgICAgICAgICAgIGNvbnN0IG1vZHVsZSA9IGZldGNoKCdNb2R1bGUnLCBpZGVudGlmaWVyLCB7XG4gICAgICAgICAgICAgIGNvbXBpbGF0aW9uLFxuICAgICAgICAgICAgICBub3JtYWxNb2R1bGVGYWN0b3J5OiBub3JtYWxNb2R1bGVGYWN0b3J5LFxuICAgICAgICAgICAgICBjb250ZXh0TW9kdWxlRmFjdG9yeTogY29udGV4dE1vZHVsZUZhY3RvcnksXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKG1vZHVsZSkge1xuICAgICAgICAgICAgICByZXR1cm4gbW9kdWxlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgICk7XG4gICAgICB9LFxuICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBOb3JtYWxNb2R1bGVGYWN0b3J5UGx1Z2luO1xuIl0sInNvdXJjZVJvb3QiOiIvVXNlcnMvdHlsZXJhcmJ1cy9kZXYvcHJvdmlkZXIvc3JjIn0=
