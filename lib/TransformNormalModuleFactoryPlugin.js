'use strict';

require('source-map-support/register');

const fs = require('fs');
const path = require('path');

const cachePrefix = require('./util').cachePrefix;
const pluginCompat = require('./util/plugin-compat');
const relateContext = require('./util/relate-context');

let NS;

NS = path.dirname(fs.realpathSync(__dirname));

class NormalModuleFactoryPlugin {
  apply(compiler) {
    const compilerHooks = pluginCompat.hooks(compiler);

    let fetch;

    compilerHooks._hardSourceMethods.tap('HardSource - TransformNormalModuleFactoryPlugin', methods => {
      fetch = methods.fetch;
    });

    compilerHooks.compilation.tap('HardSource - TransformNormalModuleFactoryPlugin', (compilation, { normalModuleFactory, contextModuleFactory }) => {
      // if (!active) {return;}

      // compilation.fileTimestamps = fileTimestamps;
      // compilation.contextTimestamps = contextTimestamps;

      // compilation.__hardSourceFileMd5s = fileMd5s;
      // compilation.__hardSourceCachedMd5s = cachedMd5s;

      const normalModuleFactoryHooks = pluginCompat.hooks(normalModuleFactory);

      // Webpack 2 can use different parsers based on config rule sets.
      normalModuleFactoryHooks.parser.for('javascript/auto').tap('HardSource - TransformNormalModuleFactoryPlugin', (parser, options) => {
        // Store the options somewhere that can not conflict with another plugin
        // on the parser so we can look it up and store those options with a
        // cached module resolution.
        parser[`${NS}/parser-options`] = options;
      });

      normalModuleFactoryHooks.resolver.tap('HardSource - TransformNormalModuleFactoryPlugin', fn => (request, cb) => {
        const identifierPrefix = cachePrefix(compilation);
        if (identifierPrefix === null) {
          return fn.call(null, request, cb);
        }

        const cacheId = JSON.stringify([identifierPrefix, request.context, request.request]);
        const absCacheId = JSON.stringify([identifierPrefix, request.context, relateContext.relateAbsoluteRequest(request.context, request.request)]);

        request.contextInfo.resolveOptions = request.resolveOptions;

        const next = () => {
          const originalRequest = request;
          return fn.call(null, request, function (err, request) {
            if (err) {
              return cb(err);
            }
            if (!request.source) {
              compilation.__hardSourceModuleResolveCacheChange.push(cacheId);
              compilation.__hardSourceModuleResolveCache[cacheId] = Object.assign({}, request, {
                parser: null,
                generator: null,
                parserOptions: request.parser[`${NS}/parser-options`],
                type: request.settings && request.settings.type,
                settings: request.settings,
                dependencies: null
              });
            }
            cb(...arguments);
          });
        };

        const fromCache = () => {
          const result = Object.assign({}, compilation.__hardSourceModuleResolveCache[cacheId] || compilation.__hardSourceModuleResolveCache[absCacheId]);
          result.dependencies = request.dependencies;

          if (!result.parser || !result.parser.parse) {
            result.parser = result.settings ? normalModuleFactory.getParser(result.type, result.settings.parser) : normalModuleFactory.getParser(result.parserOptions);
          }
          if (!result.generator && normalModuleFactory.getGenerator) {
            result.generator = normalModuleFactory.getGenerator(result.type, result.settings.generator);
          }

          result.loaders = result.loaders.map(loader => {
            if (typeof loader === 'object' && loader.ident) {
              const ruleSet = normalModuleFactory.ruleSet;
              return {
                loader: loader.loader,
                ident: loader.ident,
                options: ruleSet.references[loader.ident]
              };
            }
            return loader;
          });

          return cb(null, result);
        };

        if (compilation.__hardSourceModuleResolveCache[cacheId] && !compilation.__hardSourceModuleResolveCache[cacheId].invalid || compilation.__hardSourceModuleResolveCache[absCacheId] && !compilation.__hardSourceModuleResolveCache[absCacheId].invalid) {
          return fromCache();
        }

        next();
      });

      normalModuleFactoryHooks.createModule.tap('HardSourceWebpackPlugin', ({ request }) => {
        if (compilation.cache && compilation.cache[`m${request}`] && compilation.cache[`m${request}`].cacheItem && !compilation.cache[`m${request}`].cacheItem.invalid) {
          return compilation.cache[`m${request}`];
        }

        const identifierPrefix = cachePrefix(compilation);
        if (identifierPrefix === null) {
          return;
        }

        const identifier = identifierPrefix + request;

        const module = fetch('Module', identifier, {
          compilation,
          normalModuleFactory: normalModuleFactory,
          contextModuleFactory: contextModuleFactory
        });

        if (module) {
          return module;
        }
      });
    });
  }
}

module.exports = NormalModuleFactoryPlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9UcmFuc2Zvcm1Ob3JtYWxNb2R1bGVGYWN0b3J5UGx1Z2luLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsInBhdGgiLCJjYWNoZVByZWZpeCIsInBsdWdpbkNvbXBhdCIsInJlbGF0ZUNvbnRleHQiLCJOUyIsImRpcm5hbWUiLCJyZWFscGF0aFN5bmMiLCJfX2Rpcm5hbWUiLCJOb3JtYWxNb2R1bGVGYWN0b3J5UGx1Z2luIiwiYXBwbHkiLCJjb21waWxlciIsImNvbXBpbGVySG9va3MiLCJob29rcyIsImZldGNoIiwiX2hhcmRTb3VyY2VNZXRob2RzIiwidGFwIiwibWV0aG9kcyIsImNvbXBpbGF0aW9uIiwibm9ybWFsTW9kdWxlRmFjdG9yeSIsImNvbnRleHRNb2R1bGVGYWN0b3J5Iiwibm9ybWFsTW9kdWxlRmFjdG9yeUhvb2tzIiwicGFyc2VyIiwiZm9yIiwib3B0aW9ucyIsInJlc29sdmVyIiwiZm4iLCJyZXF1ZXN0IiwiY2IiLCJpZGVudGlmaWVyUHJlZml4IiwiY2FsbCIsImNhY2hlSWQiLCJKU09OIiwic3RyaW5naWZ5IiwiY29udGV4dCIsImFic0NhY2hlSWQiLCJyZWxhdGVBYnNvbHV0ZVJlcXVlc3QiLCJjb250ZXh0SW5mbyIsInJlc29sdmVPcHRpb25zIiwibmV4dCIsIm9yaWdpbmFsUmVxdWVzdCIsImVyciIsInNvdXJjZSIsIl9faGFyZFNvdXJjZU1vZHVsZVJlc29sdmVDYWNoZUNoYW5nZSIsInB1c2giLCJfX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGUiLCJPYmplY3QiLCJhc3NpZ24iLCJnZW5lcmF0b3IiLCJwYXJzZXJPcHRpb25zIiwidHlwZSIsInNldHRpbmdzIiwiZGVwZW5kZW5jaWVzIiwiYXJndW1lbnRzIiwiZnJvbUNhY2hlIiwicmVzdWx0IiwicGFyc2UiLCJnZXRQYXJzZXIiLCJnZXRHZW5lcmF0b3IiLCJsb2FkZXJzIiwibWFwIiwibG9hZGVyIiwiaWRlbnQiLCJydWxlU2V0IiwicmVmZXJlbmNlcyIsImludmFsaWQiLCJjcmVhdGVNb2R1bGUiLCJjYWNoZSIsImNhY2hlSXRlbSIsImlkZW50aWZpZXIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsS0FBS0MsUUFBUSxJQUFSLENBQVg7QUFDQSxNQUFNQyxPQUFPRCxRQUFRLE1BQVIsQ0FBYjs7QUFFQSxNQUFNRSxjQUFjRixRQUFRLFFBQVIsRUFBa0JFLFdBQXRDO0FBQ0EsTUFBTUMsZUFBZUgsUUFBUSxzQkFBUixDQUFyQjtBQUNBLE1BQU1JLGdCQUFnQkosUUFBUSx1QkFBUixDQUF0Qjs7QUFFQSxJQUFJSyxFQUFKOztBQUVBQSxLQUFLSixLQUFLSyxPQUFMLENBQWFQLEdBQUdRLFlBQUgsQ0FBZ0JDLFNBQWhCLENBQWIsQ0FBTDs7QUFFQSxNQUFNQyx5QkFBTixDQUFnQztBQUM5QkMsUUFBTUMsUUFBTixFQUFnQjtBQUNkLFVBQU1DLGdCQUFnQlQsYUFBYVUsS0FBYixDQUFtQkYsUUFBbkIsQ0FBdEI7O0FBRUEsUUFBSUcsS0FBSjs7QUFFQUYsa0JBQWNHLGtCQUFkLENBQWlDQyxHQUFqQyxDQUNFLGlEQURGLEVBRUVDLFdBQVc7QUFDVEgsY0FBUUcsUUFBUUgsS0FBaEI7QUFDRCxLQUpIOztBQU9BRixrQkFBY00sV0FBZCxDQUEwQkYsR0FBMUIsQ0FDRSxpREFERixFQUVFLENBQUNFLFdBQUQsRUFBYyxFQUFFQyxtQkFBRixFQUF1QkMsb0JBQXZCLEVBQWQsS0FBZ0U7QUFDOUQ7O0FBRUE7QUFDQTs7QUFFQTtBQUNBOztBQUVBLFlBQU1DLDJCQUEyQmxCLGFBQWFVLEtBQWIsQ0FDL0JNLG1CQUQrQixDQUFqQzs7QUFJQTtBQUNBRSwrQkFBeUJDLE1BQXpCLENBQ0dDLEdBREgsQ0FDTyxpQkFEUCxFQUVHUCxHQUZILENBR0ksaURBSEosRUFJSSxDQUFDTSxNQUFELEVBQVNFLE9BQVQsS0FBcUI7QUFDbkI7QUFDQTtBQUNBO0FBQ0FGLGVBQVEsR0FBRWpCLEVB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QkFBcUIsSUFBekIsRUFBK0I7QUFDN0I7QUFDRDs7QUFFRCxjQUFNd0MsYUFBYXhDLG1CQUFtQkYsT0FBdEM7O0FBRUEsY0FBTTJDLFNBQVN4RCxNQUFNLFFBQU4sRUFBZ0J1RCxVQUFoQixFQUE0QjtBQUN6Q25ELHFCQUR5QztBQUV6Q0MsK0JBQXFCQSxtQkFGb0I7QUFHekNDLGdDQUFzQkE7QUFIbUIsU0FBNUIsQ0FBZjs7QUFNQSxZQUFJa0QsTUFBSixFQUFZO0FBQ1YsaUJBQU9BLE1BQVA7QUFDRDtBQUNGLE9BNUJIO0FBOEJELEtBOUpIO0FBZ0tEO0FBN0s2Qjs7QUFnTGhDQSxPQUFPQyxPQUFQLEdBQWlCOUQseUJBQWpCIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9UcmFuc2Zvcm1Ob3JtYWxNb2R1bGVGYWN0b3J5UGx1Z2luLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuY29uc3QgY2FjaGVQcmVmaXggPSByZXF1aXJlKCcuL3V0aWwnKS5jYWNoZVByZWZpeDtcbmNvbnN0IHBsdWdpbkNvbXBhdCA9IHJlcXVpcmUoJy4vdXRpbC9wbHVnaW4tY29tcGF0Jyk7XG5jb25zdCByZWxhdGVDb250ZXh0ID0gcmVxdWlyZSgnLi91dGlsL3JlbGF0ZS1jb250ZXh0Jyk7XG5cbmxldCBOUztcblxuTlMgPSBwYXRoLmRpcm5hbWUoZnMucmVhbHBhdGhTeW5jKF9fZGlybmFtZSkpO1xuXG5jbGFzcyBOb3JtYWxNb2R1bGVGYWN0b3J5UGx1Z2luIHtcbiAgYXBwbHkoY29tcGlsZXIpIHtcbiAgICBjb25zdCBjb21waWxlckhvb2tzID0gcGx1Z2luQ29tcGF0Lmhvb2tzKGNvbXBpbGVyKTtcblxuICAgIGxldCBmZXRjaDtcblxuICAgIGNvbXBpbGVySG9va3MuX2hhcmRTb3VyY2VNZXRob2RzLnRhcChcbiAgICAgICdIYXJkU291cmNlIC0gVHJhbnNmb3JtTm9ybWFsTW9kdWxlRmFjdG9yeVBsdWdpbicsXG4gICAgICBtZXRob2RzID0+IHtcbiAgICAgICAgZmV0Y2ggPSBtZXRob2RzLmZldGNoO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgY29tcGlsZXJIb29rcy5jb21waWxhdGlvbi50YXAoXG4gICAgICAnSGFyZFNvdXJjZSAtIFRyYW5zZm9ybU5vcm1hbE1vZHVsZUZhY3RvcnlQbHVnaW4nLFxuICAgICAgKGNvbXBpbGF0aW9uLCB7IG5vcm1hbE1vZHVsZUZhY3RvcnksIGNvbnRleHRNb2R1bGVGYWN0b3J5IH0pID0+IHtcbiAgICAgICAgLy8gaWYgKCFhY3RpdmUpIHtyZXR1cm47fVxuXG4gICAgICAgIC8vIGNvbXBpbGF0aW9uLmZpbGVUaW1lc3RhbXBzID0gZmlsZVRpbWVzdGFtcHM7XG4gICAgICAgIC8vIGNvbXBpbGF0aW9uLmNvbnRleHRUaW1lc3RhbXBzID0gY29udGV4dFRpbWVzdGFtcHM7XG5cbiAgICAgICAgLy8gY29tcGlsYXRpb24uX19oYXJkU291cmNlRmlsZU1kNXMgPSBmaWxlTWQ1cztcbiAgICAgICAgLy8gY29tcGlsYXRpb24uX19oYXJkU291cmNlQ2FjaGVkTWQ1cyA9IGNhY2hlZE1kNXM7XG5cbiAgICAgICAgY29uc3Qgbm9ybWFsTW9kdWxlRmFjdG9yeUhvb2tzID0gcGx1Z2luQ29tcGF0Lmhvb2tzKFxuICAgICAgICAgIG5vcm1hbE1vZHVsZUZhY3RvcnksXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gV2VicGFjayAyIGNhbiB1c2UgZGlmZmVyZW50IHBhcnNlcnMgYmFzZWQgb24gY29uZmlnIHJ1bGUgc2V0cy5cbiAgICAgICAgbm9ybWFsTW9kdWxlRmFjdG9yeUhvb2tzLnBhcnNlclxuICAgICAgICAgIC5mb3IoJ2phdmFzY3JpcHQvYXV0bycpXG4gICAgICAgICAgLnRhcChcbiAgICAgICAgICAgICdIYXJkU291cmNlIC0gVHJhbnNmb3JtTm9ybWFsTW9kdWxlRmFjdG9yeVBsdWdpbicsXG4gICAgICAgICAgICAocGFyc2VyLCBvcHRpb25zKSA9PiB7XG4gICAgICAgICAgICAgIC8vIFN0b3JlIHRoZSBvcHRpb25zIHNvbWV3aGVyZSB0aGF0IGNhbiBub3QgY29uZmxpY3Qgd2l0aCBhbm90aGVyIHBsdWdpblxuICAgICAgICAgICAgICAvLyBvbiB0aGUgcGFyc2VyIHNvIHdlIGNhbiBsb29rIGl0IHVwIGFuZCBzdG9yZSB0aG9zZSBvcHRpb25zIHdpdGggYVxuICAgICAgICAgICAgICAvLyBjYWNoZWQgbW9kdWxlIHJlc29sdXRpb24uXG4gICAgICAgICAgICAgIHBhcnNlcltgJHtOU30vcGFyc2VyLW9wdGlvbnNgXSA9IG9wdGlvbnM7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICk7XG5cbiAgICAgICAgbm9ybWFsTW9kdWxlRmFjdG9yeUhvb2tzLnJlc29sdmVyLnRhcChcbiAgICAgICAgICAnSGFyZFNvdXJjZSAtIFRyYW5zZm9ybU5vcm1hbE1vZHVsZUZhY3RvcnlQbHVnaW4nLFxuICAgICAgICAgIGZuID0+IChyZXF1ZXN0LCBjYikgPT4ge1xuICAgICAgICAgICAgY29uc3QgaWRlbnRpZmllclByZWZpeCA9IGNhY2hlUHJlZml4KGNvbXBpbGF0aW9uKTtcbiAgICAgICAgICAgIGlmIChpZGVudGlmaWVyUHJlZml4ID09PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJldHVybiBmbi5jYWxsKG51bGwsIHJlcXVlc3QsIGNiKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgY2FjaGVJZCA9IEpTT04uc3RyaW5naWZ5KFtcbiAgICAgICAgICAgICAgaWRlbnRpZmllclByZWZpeCxcbiAgICAgICAgICAgICAgcmVxdWVzdC5jb250ZXh0LFxuICAgICAgICAgICAgICByZXF1ZXN0LnJlcXVlc3QsXG4gICAgICAgICAgICBdKTtcbiAgICAgICAgICAgIGNvbnN0IGFic0NhY2hlSWQgPSBKU09OLnN0cmluZ2lmeShbXG4gICAgICAgICAgICAgIGlkZW50aWZpZXJQcmVmaXgsXG4gICAgICAgICAgICAgIHJlcXVlc3QuY29udGV4dCxcbiAgICAgICAgICAgICAgcmVsYXRlQ29udGV4dC5yZWxhdGVBYnNvbHV0ZVJlcXVlc3QoXG4gICAgICAgICAgICAgICAgcmVxdWVzdC5jb250ZXh0LFxuICAgICAgICAgICAgICAgIHJlcXVlc3QucmVxdWVzdCxcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIF0pO1xuXG4gICAgICAgICAgICByZXF1ZXN0LmNvbnRleHRJbmZvLnJlc29sdmVPcHRpb25zID0gcmVxdWVzdC5yZXNvbHZlT3B0aW9ucztcblxuICAgICAgICAgICAgY29uc3QgbmV4dCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxSZXF1ZXN0ID0gcmVxdWVzdDtcbiAgICAgICAgICAgICAgcmV0dXJuIGZuLmNhbGwobnVsbCwgcmVxdWVzdCwgZnVuY3Rpb24oZXJyLCByZXF1ZXN0KSB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghcmVxdWVzdC5zb3VyY2UpIHtcbiAgICAgICAgICAgICAgICAgIGNvbXBpbGF0aW9uLl9faGFyZFNvdXJjZU1vZHVsZVJlc29sdmVDYWNoZUNoYW5nZS5wdXNoKFxuICAgICAgICAgICAgICAgICAgICBjYWNoZUlkLFxuICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgIGNvbXBpbGF0aW9uLl9faGFyZFNvdXJjZU1vZHVsZVJlc29sdmVDYWNoZVtcbiAgICAgICAgICAgICAgICAgICAgY2FjaGVJZFxuICAgICAgICAgICAgICAgICAgXSA9IE9iamVjdC5hc3NpZ24oe30sIHJlcXVlc3QsIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyc2VyOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICBnZW5lcmF0b3I6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIHBhcnNlck9wdGlvbnM6IHJlcXVlc3QucGFyc2VyW2Ake05TfS9wYXJzZXItb3B0aW9uc2BdLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiByZXF1ZXN0LnNldHRpbmdzICYmIHJlcXVlc3Quc2V0dGluZ3MudHlwZSxcbiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3M6IHJlcXVlc3Quc2V0dGluZ3MsXG4gICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY2llczogbnVsbCxcbiAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYiguLi5hcmd1bWVudHMpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGNvbnN0IGZyb21DYWNoZSA9ICgpID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gT2JqZWN0LmFzc2lnbihcbiAgICAgICAgICAgICAgICB7fSxcbiAgICAgICAgICAgICAgICBjb21waWxhdGlvbi5fX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGVbY2FjaGVJZF0gfHxcbiAgICAgICAgICAgICAgICAgIGNvbXBpbGF0aW9uLl9faGFyZFNvdXJjZU1vZHVsZVJlc29sdmVDYWNoZVthYnNDYWNoZUlkXSxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgcmVzdWx0LmRlcGVuZGVuY2llcyA9IHJlcXVlc3QuZGVwZW5kZW5jaWVzO1xuXG4gICAgICAgICAgICAgIGlmICghcmVzdWx0LnBhcnNlciB8fCAhcmVzdWx0LnBhcnNlci5wYXJzZSkge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wYXJzZXIgPSByZXN1bHQuc2V0dGluZ3NcbiAgICAgICAgICAgICAgICAgID8gbm9ybWFsTW9kdWxlRmFjdG9yeS5nZXRQYXJzZXIoXG4gICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnNldHRpbmdzLnBhcnNlcixcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgOiBub3JtYWxNb2R1bGVGYWN0b3J5LmdldFBhcnNlcihyZXN1bHQucGFyc2VyT3B0aW9ucyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKCFyZXN1bHQuZ2VuZXJhdG9yICYmIG5vcm1hbE1vZHVsZUZhY3RvcnkuZ2V0R2VuZXJhdG9yKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LmdlbmVyYXRvciA9IG5vcm1hbE1vZHVsZUZhY3RvcnkuZ2V0R2VuZXJhdG9yKFxuICAgICAgICAgICAgICAgICAgcmVzdWx0LnR5cGUsXG4gICAgICAgICAgICAgICAgICByZXN1bHQuc2V0dGluZ3MuZ2VuZXJhdG9yLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICByZXN1bHQubG9hZGVycyA9IHJlc3VsdC5sb2FkZXJzLm1hcChsb2FkZXIgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbG9hZGVyID09PSAnb2JqZWN0JyAmJiBsb2FkZXIuaWRlbnQpIHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHJ1bGVTZXQgPSBub3JtYWxNb2R1bGVGYWN0b3J5LnJ1bGVTZXQ7XG4gICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBsb2FkZXI6IGxvYWRlci5sb2FkZXIsXG4gICAgICAgICAgICAgICAgICAgIGlkZW50OiBsb2FkZXIuaWRlbnQsXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IHJ1bGVTZXQucmVmZXJlbmNlc1tsb2FkZXIuaWRlbnRdLFxuICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxvYWRlcjtcbiAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgcmV0dXJuIGNiKG51bGwsIHJlc3VsdCk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgIChjb21waWxhdGlvbi5fX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGVbY2FjaGVJZF0gJiZcbiAgICAgICAgICAgICAgICAhY29tcGlsYXRpb24uX19oYXJkU291cmNlTW9kdWxlUmVzb2x2ZUNhY2hlW2NhY2hlSWRdLmludmFsaWQpIHx8XG4gICAgICAgICAgICAgIChjb21waWxhdGlvbi5fX2hhcmRTb3VyY2VNb2R1bGVSZXNvbHZlQ2FjaGVbYWJzQ2FjaGVJZF0gJiZcbiAgICAgICAgICAgICAgICAhY29tcGlsYXRpb24uX19oYXJkU291cmNlTW9kdWxlUmVzb2x2ZUNhY2hlW2Fic0NhY2hlSWRdLmludmFsaWQpXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGZyb21DYWNoZSgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgICAgfSxcbiAgICAgICAgKTtcblxuICAgICAgICBub3JtYWxNb2R1bGVGYWN0b3J5SG9va3MuY3JlYXRlTW9kdWxlLnRhcChcbiAgICAgICAgICAnSGFyZFNvdXJjZVdlYnBhY2tQbHVnaW4nLFxuICAgICAgICAgICh7IHJlcXVlc3QgfSkgPT4ge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICBjb21waWxhdGlvbi5jYWNoZSAmJlxuICAgICAgICAgICAgICBjb21waWxhdGlvbi5jYWNoZVtgbSR7cmVxdWVzdH1gXSAmJlxuICAgICAgICAgICAgICBjb21waWxhdGlvbi5jYWNoZVtgbSR7cmVxdWVzdH1gXS5jYWNoZUl0ZW0gJiZcbiAgICAgICAgICAgICAgIWNvbXBpbGF0aW9uLmNhY2hlW2BtJHtyZXF1ZXN0fWBdLmNhY2hlSXRlbS5pbnZhbGlkXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGNvbXBpbGF0aW9uLmNhY2hlW2BtJHtyZXF1ZXN0fWBdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBpZGVudGlmaWVyUHJlZml4ID0gY2FjaGVQcmVmaXgoY29tcGlsYXRpb24pO1xuICAgICAgICAgICAgaWYgKGlkZW50aWZpZXJQcmVmaXggPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBpZGVudGlmaWVyID0gaWRlbnRpZmllclByZWZpeCArIHJlcXVlc3Q7XG5cbiAgICAgICAgICAgIGNvbnN0IG1vZHVsZSA9IGZldGNoKCdNb2R1bGUnLCBpZGVudGlmaWVyLCB7XG4gICAgICAgICAgICAgIGNvbXBpbGF0aW9uLFxuICAgICAgICAgICAgICBub3JtYWxNb2R1bGVGYWN0b3J5OiBub3JtYWxNb2R1bGVGYWN0b3J5LFxuICAgICAgICAgICAgICBjb250ZXh0TW9kdWxlRmFjdG9yeTogY29udGV4dE1vZHVsZUZhY3RvcnksXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKG1vZHVsZSkge1xuICAgICAgICAgICAgICByZXR1cm4gbW9kdWxlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgICk7XG4gICAgICB9LFxuICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBOb3JtYWxNb2R1bGVGYWN0b3J5UGx1Z2luO1xuIl0sInNvdXJjZVJvb3QiOiIvVXNlcnMvdHlsZXJhcmJ1cy9kZXYvcHJvdmlkZXIvc3JjIn0=
