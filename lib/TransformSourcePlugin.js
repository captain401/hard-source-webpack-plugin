'use strict';

const relateContext = require('./util/relate-context');
const pluginCompat = require('./util/plugin-compat');

const SourceSchemas3 = [['CachedSource', 'source'], ['ConcatSource'], ['LineToLineMappedSource', 'value', 'name', 'originalSource'], ['OriginalSource', 'value', 'name'], ['RawSource', 'value'], ['ReplaceSource', 'source', 'name'], ['SourceMapSource', 'value', 'name', 'sourceMap', 'originalSource', 'innerSourceMap']];

try {
  SourceSchemas3[0].Source = require('webpack-sources/lib/CachedSource');
} catch (_) {}
try {
  SourceSchemas3[1].Source = require('webpack-sources/lib/ConcatSource');
} catch (_) {}
try {
  SourceSchemas3[2].Source = require('webpack-sources/lib/LineToLineMappedSource');
} catch (_) {}
try {
  SourceSchemas3[3].Source = require('webpack-sources/lib/OriginalSource');
} catch (_) {}
try {
  SourceSchemas3[4].Source = require('webpack-sources/lib/RawSource');
} catch (_) {}
try {
  SourceSchemas3[5].Source = require('webpack-sources/lib/ReplaceSource');
} catch (_) {}
try {
  SourceSchemas3[6].Source = require('webpack-sources/lib/SourceMapSource');
} catch (_) {}

const freezeArgument = {
  value(arg, { _value }, extra, methods) {
    return _value;
  },
  name(arg, { _name }, { compilation }, methods) {
    try {
      return relateContext.relateNormalPath(compilation.compiler, _name);
    } catch (e) {
      console.error(e.stack);
      process.exit();
    }
  },
  sourceMap(arg, { _sourceMap }, extra, methods) {
    return _sourceMap;
  },
  originalSource(arg, { _originalSource }, extra, methods) {
    return _originalSource;
  },
  innerSourceMap(arg, { _innerSourceMap }, extra, methods) {
    return _innerSourceMap;
  },
  source(arg, { constructor, _source }, extra, methods) {
    if (constructor.name === 'ReplaceSource') {
      return;
    }
    return methods.freeze('Source', null, _source, extra);
  }
};

const thawArgument = {
  name(arg, source, { compilation }, methods) {
    try {
      return relateContext.contextNormalPath(compilation.compiler, arg);
    } catch (e) {
      console.error(e.stack);
      process.exit();
    }
  },
  source(arg, { type }, extra, methods) {
    if (type === 'ReplaceSource') {
      return extra.source;
    }
    return methods.thaw('Source', null, arg, extra);
  },
  value(arg, frozen, extra, methods) {
    if (arg && arg.type === 'Buffer') {
      return new Buffer(arg.data);
    }
    return arg;
  }
};

function freezeSource(source, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (source.constructor.name === schemas[i].Source.name) {
      const frozen = {
        type: schemas[i][0]
      };
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = source[schemas[i][j]];
        if (freezeArgument[schemas[i][j]]) {
          arg = freezeArgument[schemas[i][j]](arg, source, extra, methods);
        }
        frozen[schemas[i][j]] = arg;
      }
      return frozen;
    }
  }

  throw new Error(`Unfrozen ${source.constructor.name}.`);
}

function thawSource(frozen, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (frozen.type === schemas[i][0]) {
      const Source = schemas[i].Source;
      const args = [];
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = frozen[schemas[i][j]];
        if (thawArgument[schemas[i][j]]) {
          arg = thawArgument[schemas[i][j]](arg, frozen, extra, methods);
        }
        args.push(arg);
      }
      try {
        return new Source(...args);
      } catch (_) {
        return new (Function.prototype.bind.apply(Source, [null].concat(args)))();
      }
    }
  }
}

class TransformSourcePlugin {
  apply(compiler) {
    let methods;

    pluginCompat.tap(compiler, '_hardSourceMethods', 'TransformSourcePlugin', _methods => {
      methods = _methods;
    });

    pluginCompat.tap(compiler, '_hardSourceFreezeSource', 'TransformSourcePlugin freeze', (frozen, source, extra) => {
      if (typeof source === 'string') {
        return {
          type: 'String',
          value: source
        };
      } else if (Buffer.isBuffer && Buffer.isBuffer(source)) {
        // Serialization layer might transform it into JSON or handle it as binary
        // data
        return source;
      }

      extra.schemas = SourceSchemas3;
      frozen = freezeSource(source, extra, methods);
      if (frozen.type === 'ReplaceSource') {
        frozen.replacements = source.replacements;
      } else if (frozen.type === 'CachedSource') {
        frozen.cachedSource = source._cachedSource;
        frozen.cachedSize = source._cachedSize;
        frozen.cachedMaps = source._cachedMaps;
      } else if (frozen.type === 'ConcatSource') {
        frozen.children = methods.mapFreeze('Source', null, source.children, extra);
      }
      return frozen;
    });

    pluginCompat.tap(compiler, '_hardSourceThawSource', 'TransformSourcePlugin thaw', (source, frozen, extra) => {
      if (frozen.type === 'String') {
        return frozen.value;
      } else if (frozen.type === 'Buffer') {
        return new Buffer(frozen.data);
      } else if (Buffer.isBuffer && Buffer.isBuffer(frozen)) {
        return frozen;
      }

      extra.schemas = SourceSchemas3;
      source = thawSource(frozen, extra, methods);
      if (frozen.type === 'ReplaceSource') {
        source.replacements = frozen.replacements;
      } else if (frozen.type === 'CachedSource') {
        source._cachedSource = frozen.cachedSource;
        source._cachedSize = frozen.cachedSize;
        source._cachedMaps = frozen.cachedMaps;
      } else if (frozen.type === 'ConcatSource') {
        source.children = methods.mapThaw('Source', null, frozen.children, extra);
      }
      return source;
    });
  }
}

module.exports = TransformSourcePlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9UcmFuc2Zvcm1Tb3VyY2VQbHVnaW4uanMiXSwibmFtZXMiOlsicmVsYXRlQ29udGV4dCIsInJlcXVpcmUiLCJwbHVnaW5Db21wYXQiLCJTb3VyY2VTY2hlbWFzMyIsIlNvdXJjZSIsIl8iLCJmcmVlemVBcmd1bWVudCIsInZhbHVlIiwiYXJnIiwiX3ZhbHVlIiwiZXh0cmEiLCJtZXRob2RzIiwibmFtZSIsIl9uYW1lIiwiY29tcGlsYXRpb24iLCJyZWxhdGVOb3JtYWxQYXRoIiwiY29tcGlsZXIiLCJlIiwiY29uc29sZSIsImVycm9yIiwic3RhY2siLCJwcm9jZXNzIiwiZXhpdCIsInNvdXJjZU1hcCIsIl9zb3VyY2VNYXAiLCJvcmlnaW5hbFNvdXJjZSIsIl9vcmlnaW5hbFNvdXJjZSIsImlubmVyU291cmNlTWFwIiwiX2lubmVyU291cmNlTWFwIiwic291cmNlIiwiY29uc3RydWN0b3IiLCJfc291cmNlIiwiZnJlZXplIiwidGhhd0FyZ3VtZW50IiwiY29udGV4dE5vcm1hbFBhdGgiLCJ0eXBlIiwidGhhdyIsImZyb3plbiIsIkJ1ZmZlciIsImRhdGEiLCJmcmVlemVTb3VyY2UiLCJzY2hlbWFzIiwiaSIsImxlbmd0aCIsImoiLCJFcnJvciIsInRoYXdTb3VyY2UiLCJhcmdzIiwicHVzaCIsIkZ1bmN0aW9uIiwicHJvdG90eXBlIiwiYmluZCIsImFwcGx5IiwiY29uY2F0IiwiVHJhbnNmb3JtU291cmNlUGx1Z2luIiwidGFwIiwiX21ldGhvZHMiLCJpc0J1ZmZlciIsInJlcGxhY2VtZW50cyIsImNhY2hlZFNvdXJjZSIsIl9jYWNoZWRTb3VyY2UiLCJjYWNoZWRTaXplIiwiX2NhY2hlZFNpemUiLCJjYWNoZWRNYXBzIiwiX2NhY2hlZE1hcHMiLCJjaGlsZHJlbiIsIm1hcEZyZWV6ZSIsIm1hcFRoYXciLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLGdCQUFnQkMsZ0NBQXRCO0FBQ0EsTUFBTUMsZUFBZUQsK0JBQXJCOztBQUVBLE1BQU1FLGlCQUFpQixDQUNyQixDQUFDLGNBQUQsRUFBaUIsUUFBakIsQ0FEcUIsRUFFckIsQ0FBQyxjQUFELENBRnFCLEVBR3JCLENBQUMsd0JBQUQsRUFBMkIsT0FBM0IsRUFBb0MsTUFBcEMsRUFBNEMsZ0JBQTVDLENBSHFCLEVBSXJCLENBQUMsZ0JBQUQsRUFBbUIsT0FBbkIsRUFBNEIsTUFBNUIsQ0FKcUIsRUFLckIsQ0FBQyxXQUFELEVBQWMsT0FBZCxDQUxxQixFQU1yQixDQUFDLGVBQUQsRUFBa0IsUUFBbEIsRUFBNEIsTUFBNUIsQ0FOcUIsRUFPckIsQ0FDRSxpQkFERixFQUVFLE9BRkYsRUFHRSxNQUhGLEVBSUUsV0FKRixFQUtFLGdCQUxGLEVBTUUsZ0JBTkYsQ0FQcUIsQ0FBdkI7O0FBaUJBLElBQUk7QUFDRkEsaUJBQWUsQ0FBZixFQUFrQkMsTUFBbEIsR0FBMkJILFFBQVEsa0NBQVIsQ0FBM0I7QUFDRCxDQUZELENBRUUsT0FBT0ksQ0FBUCxFQUFVLENBQUU7QUFDZCxJQUFJO0FBQ0ZGLGlCQUFlLENBQWYsRUFBa0JDLE1BQWxCLEdBQTJCSCxRQUFRLGtDQUFSLENBQTNCO0FBQ0QsQ0FGRCxDQUVFLE9BQU9JLENBQVAsRUFBVSxDQUFFO0FBQ2QsSUFBSTtBQUNGRixpQkFBZSxDQUFmLEVBQWtCQyxNQUFsQixHQUEyQkgsUUFBUSw0Q0FBUixDQUEzQjtBQUNELENBRkQsQ0FFRSxPQUFPSSxDQUFQLEVBQVUsQ0FBRTtBQUNkLElBQUk7QUFDRkYsaUJBQWUsQ0FBZixFQUFrQkMsTUFBbEIsR0FBMkJILFFBQVEsb0NBQVIsQ0FBM0I7QUFDRCxDQUZELENBRUUsT0FBT0ksQ0FBUCxFQUFVLENBQUU7QUFDZCxJQUFJO0FBQ0ZGLGlCQUFlLENBQWYsRUFBa0JDLE1BQWxCLEdBQTJCSCxRQUFRLCtCQUFSLENBQTNCO0FBQ0QsQ0FGRCxDQUVFLE9BQU9JLENBQVAsRUFBVSxDQUFFO0FBQ2QsSUFBSTtBQUNGRixpQkFBZSxDQUFmLEVBQWtCQyxNQUFsQixHQUEyQkgsUUFBUSxtQ0FBUixDQUEzQjtBQUNELENBRkQsQ0FFRSxPQUFPSSxDQUFQLEVBQVUsQ0FBRTtBQUNkLElBQUk7QUFDRkYsaUJBQWUsQ0FBZixFQUFrQkMsTUFBbEIsR0FBMkJILFFBQVEscUNBQVIsQ0FBM0I7QUFDRCxDQUZELENBRUUsT0FBT0ksQ0FBUCxFQUFVLENBQUU7O0FBRWQsTUFBTUMsaUJBQWlCO0FBQ3JCQyxRQUFNQyxHQUFOLEVBQVcsRUFBRUMsTUFBRixFQUFYLEVBQXVCQyxLQUF2QixFQUE4QkMsT0FBOUIsRUFBdUM7QUFDckMsV0FBT0YsTUFBUDtBQUNELEdBSG9CO0FBSXJCRyxPQUFLSixHQUFMLEVBQVUsRUFBRUssS0FBRixFQUFWLEVBQXFCLEVBQUVDLFdBQUYsRUFBckIsRUFBc0NILE9BQXRDLEVBQStDO0FBQzdDLFFBQUk7QUFDRixhQUFPWCxjQUFjZSxnQkFBZCxDQUErQkQsWUFBWUUsUUFBM0MsRUFBcURILEtBQXJELENBQVA7QUFDRCxLQUZELENBRUUsT0FBT0ksQ0FBUCxFQUFVO0FBQ1ZDLGNBQVFDLEtBQVIsQ0FBY0YsRUFBRUcsS0FBaEI7QUFDQUMsY0FBUUMsSUFBUjtBQUNEO0FBQ0YsR0FYb0I7QUFZckJDLFlBQVVmLEdBQVYsRUFBZSxFQUFFZ0IsVUFBRixFQUFmLEVBQStCZCxLQUEvQixFQUFzQ0MsT0FBdEMsRUFBK0M7QUFDN0MsV0FBT2EsVUFBUDtBQUNELEdBZG9CO0FBZXJCQyxpQkFBZWpCLEdBQWYsRUFBb0IsRUFBRWtCLGVBQUYsRUFBcEIsRUFBeUNoQixLQUF6QyxFQUFnREMsT0FBaEQsRUFBeUQ7QUFDdkQsV0FBT2UsZUFBUDtBQUNELEdBakJvQjtBQWtCckJDLGlCQUFlbkIsR0FBZixFQUFvQixFQUFFb0IsZUFBRixFQUFwQixFQUF5Q2xCLEtBQXpDLEVBQWdEQyxPQUFoRCxFQUF5RDtBQUN2RCxXQUFPaUIsZUFBUDtBQUNELEdBcEJvQjtBQXFCckJDLFNBQU9yQixHQUFQLEVBQVksRUFBRXNCLFdBQUYsRUFBZUMsT0FBZixFQUFaLEVBQXNDckIsS0FBdEMsRUFBNkNDLE9BQTdDLEVBQXNEO0FBQ3BELFFBQUltQixZQUFZbEIsSUFBWixLQUFxQixlQUF6QixFQUEwQztBQUN4QztBQUNEO0FBQ0QsV0FBT0QsUUFBUXFCLE1BQVIsQ0FBZSxRQUFmLEVBQXlCLElBQXpCLEVBQStCRCxPQUEvQixFQUF3Q3JCLEtBQXhDLENBQVA7QUFDRDtBQTFCb0IsQ0FBdkI7O0FBNkJBLE1BQU11QixlQUFlO0FBQ25CckIsT0FBS0osR0FBTCxFQUFVcUIsTUFBVixFQUFrQixFQUFFZixXQUFGLEVBQWxCLEVBQW1DSCxPQUFuQyxFQUE0QztBQUMxQyxRQUFJO0FBQ0YsYUFBT1gsY0FBY2tDLGlCQUFkLENBQWdDcEIsWUFBWUUsUUFBNUMsRUFBc0RSLEdBQXRELENBQVA7QUFDRCxLQUZELENBRUUsT0FBT1MsQ0FBUCxFQUFVO0FBQ1ZDLGNBQVFDLEtBQVIsQ0FBY0YsRUFBRUcsS0FBaEI7QUFDQUMsY0FBUUMsSUFBUjtBQUNEO0FBQ0YsR0FSa0I7QUFTbkJPLFNBQU9yQixHQUFQLEVBQVksRUFBRTJCLElBQUYsRUFBWixFQUFzQnpCLEtBQXRCLEVBQTZCQyxPQUE3QixFQUFzQztBQUNwQyxRQUFJd0IsU0FBUyxlQUFiLEVBQThCO0FBQzVCLGFBQU96QixNQUFNbUIsTUFBYjtBQUNEO0FBQ0QsV0FBT2xCLFFBQVF5QixJQUFSLENBQWEsUUFBYixFQUF1QixJQUF2QixFQUE2QjVCLEdBQTdCLEVBQWtDRSxLQUFsQyxDQUFQO0FBQ0QsR0Fka0I7QUFlbkJILFFBQU1DLEdBQU4sRUFBVzZCLE1BQVgsRUFBbUIzQixLQUFuQixFQUEwQkMsT0FBMUIsRUFBbUM7QUFDakMsUUFBSUgsT0FBT0EsSUFBSTJCLElBQUosS0FBYSxRQUF4QixFQUFrQztBQUNoQyxhQUFPLElBQUlHLE1BQUosQ0FBVzlCLElBQUkrQixJQUFmLENBQVA7QUFDRDtBQUNELFdBQU8vQixHQUFQO0FBQ0Q7QUFwQmtCLENBQXJCOztBQXVCQSxTQUFTZ0MsWUFBVCxDQUFzQlgsTUFBdEIsRUFBOEJuQixLQUE5QixFQUFxQ0MsT0FBckMsRUFBOEM7QUFDNUMsUUFBTThCLFVBQVUvQixNQUFNK0IsT0FBdEI7QUFDQSxPQUFLLElBQUlDLElBQUksQ0FBYixFQUFnQkEsSUFBSUQsUUFBUUUsTUFBNUIsRUFBb0NELEdBQXBDLEVBQXlDO0FBQ3ZDLFFBQUliLE9BQU9DLFdBQVAsQ0FBbUJsQixJQUFuQixLQUE0QjZCLFFBQVFDLENBQVIsRUFBV3RDLE1BQVgsQ0FBa0JRLElBQWxELEVBQXdEO0FBQ3RELFlBQU15QixTQUFTO0FBQ2JGLGNBQU1NLFFBQVFDLENBQVIsRUFBVyxDQUFYO0FBRE8sT0FBZjtBQUdBLFdBQUssSUFBSUUsSUFBSSxDQUFiLEVBQWdCQSxJQUFJSCxRQUFRQyxDQUFSLEVBQVdDLE1BQS9CLEVBQXVDQyxHQUF2QyxFQUE0QztBQUMxQyxZQUFJcEMsTUFBTXFCLE9BQU9ZLFFBQVFDLENBQVIsRUFBV0UsQ0FBWCxDQUFQLENBQVY7QUFDQSxZQUFJdEMsZUFBZW1DLFFBQVFDLENBQVIsRUFBV0UsQ0FBWCxDQUFmLENBQUosRUFBbUM7QUFDakNwQyxnQkFBTUYsZUFBZW1DLFFBQVFDLENBQVIsRUFBV0UsQ0FBWCxDQUFmLEVBQThCcEMsR0FBOUIsRUFBbUNxQixNQUFuQyxFQUEyQ25CLEtBQTNDLEVBQWtEQyxPQUFsRCxDQUFOO0FBQ0Q7QUFDRDBCLGVBQU9JLFFBQVFDLENBQVIsRUFBV0UsQ0FBWCxDQUFQLElBQXdCcEMsR0FBeEI7QUFDRDtBQUNELGFBQU82QixNQUFQO0FBQ0Q7QUFDRjs7QUFFRCxRQUFNLElBQUlRLEtBQUosQ0FBVyxZQUFXaEIsT0FBT0MsV0FBUCxDQUFtQmxCLElBQUssR0FBOUMsQ0FBTjtBQUNEOztBQUVELFNBQVNrQyxVQUFULENBQW9CVCxNQUFwQixFQUE0QjNCLEtBQTVCLEVBQW1DQyxPQUFuQyxFQUE0QztBQUMxQyxRQUFNOEIsVUFBVS9CLE1BQU0rQixPQUF0QjtBQUNBLE9BQUssSUFBSUMsSUFBSSxDQUFiLEVBQWdCQSxJQUFJRCxRQUFRRSxNQUE1QixFQUFvQ0QsR0FBcEMsRUFBeUM7QUFDdkMsUUFBSUwsT0FBT0YsSUFBUCxLQUFnQk0sUUFBUUMsQ0FBUixFQUFXLENBQVgsQ0FBcEIsRUFBbUM7QUFDakMsWUFBTXRDLFNBQVNxQyxRQUFRQyxDQUFSLEVBQVd0QyxNQUExQjtBQUNBLFlBQU0yQyxPQUFPLEVBQWI7QUFDQSxXQUFLLElBQUlILElBQUksQ0FBYixFQUFnQkEsSUFBSUgsUUFBUUMsQ0FBUixFQUFXQyxNQUEvQixFQUF1Q0MsR0FBdkMsRUFBNEM7QUFDMUMsWUFBSXBDLE1BQU02QixPQUFPSSxRQUFRQyxDQUFSLEVBQVdFLENBQVgsQ0FBUCxDQUFWO0FBQ0EsWUFBSVgsYUFBYVEsUUFBUUMsQ0FBUixFQUFXRSxDQUFYLENBQWIsQ0FBSixFQUFpQztBQUMvQnBDLGdCQUFNeUIsYUFBYVEsUUFBUUMsQ0FBUixFQUFXRSxDQUFYLENBQWIsRUFBNEJwQyxHQUE1QixFQUFpQzZCLE1BQWpDLEVBQXlDM0IsS0FBekMsRUFBZ0RDLE9BQWhELENBQU47QUFDRDtBQUNEb0MsYUFBS0MsSUFBTCxDQUFVeEMsR0FBVjtBQUNEO0FBQ0QsVUFBSTtBQUNGLGVBQU8sSUFBSUosTUFBSixDQUFXLEdBQUcyQyxJQUFkLENBQVA7QUFDRCxPQUZELENBRUUsT0FBTzFDLENBQVAsRUFBVTtBQUNWLGVBQU8sS0FBSzRDLFNBQVNDLFNBQVQsQ0FBbUJDLElBQW5CLENBQXdCQyxLQUF4QixDQUNWaEQsTUFEVSxFQUVWLENBQUMsSUFBRCxFQUFPaUQsTUFBUCxDQUFjTixJQUFkLENBRlUsQ0FBTCxHQUFQO0FBSUQ7QUFDRjtBQUNGO0FBQ0Y7O0FBRUQsTUFBTU8scUJBQU4sQ0FBNEI7QUFDMUJGLFFBQU1wQyxRQUFOLEVBQWdCO0FBQ2QsUUFBSUwsT0FBSjs7QUFFQVQsaUJBQWFxRCxHQUFiLENBQ0V2QyxRQURGLEVBRUUsb0JBRkYsRUFHRSx1QkFIRixFQUlFd0MsWUFBWTtBQUNWN0MsZ0JBQVU2QyxRQUFWO0FBQ0QsS0FOSDs7QUFTQXRELGlCQUFhcUQsR0FBYixDQUNFdkMsUUFERixFQUVFLHlCQUZGLEVBR0UsOEJBSEYsRUFJRSxDQUFDcUIsTUFBRCxFQUFTUixNQUFULEVBQWlCbkIsS0FBakIsS0FBMkI7QUFDekIsVUFBSSxPQUFPbUIsTUFBUCxLQUFrQixRQUF0QixFQUFnQztBQUM5QixlQUFPO0FBQ0xNLGdCQUFNLFFBREQ7QUFFTDVCLGlCQUFPc0I7QUFGRixTQUFQO0FBSUQsT0FMRCxNQUtPLElBQUlTLE9BQU9tQixRQUFQLElBQW1CbkIsT0FBT21CLFFBQVAsQ0FBZ0I1QixNQUFoQixDQUF2QixFQUFnRDtBQUNyRDtBQUNBO0FBQ0EsZUFBT0EsTUFBUDtBQUNEOztBQUVEbkIsWUFBTStCLE9BQU4sR0FBZ0J0QyxjQUFoQjtBQUNBa0MsZUFBU0csYUFBYVgsTUFBYixFQUFxQm5CLEtBQXJCLEVBQTRCQyxPQUE1QixDQUFUO0FBQ0EsVUFBSTBCLE9BQU9GLElBQVAsS0FBZ0IsZUFBcEIsRUFBcUM7QUFDbkNFLGVBQU9xQixZQUFQLEdBQXNCN0IsT0FBTzZCLFlBQTdCO0FBQ0QsT0FGRCxNQUVPLElBQUlyQixPQUFPRixJQUFQLEtBQWdCLGNBQXBCLEVBQW9DO0FBQ3pDRSxlQUFPc0IsWUFBUCxHQUFzQjlCLE9BQU8rQixhQUE3QjtBQUNBdkIsZUFBT3dCLFVBQVAsR0FBb0JoQyxPQUFPaUMsV0FBM0I7QUFDQXpCLGVBQU8wQixVQUFQLEdBQW9CbEMsT0FBT21DLFdBQTNCO0FBQ0QsT0FKTSxNQUlBLElBQUkzQixPQUFPRixJQUFQLEtBQWdCLGNBQXBCLEVBQW9DO0FBQ3pDRSxlQUFPNEIsUUFBUCxHQUFrQnRELFFBQVF1RCxTQUFSLENBQ2hCLFFBRGdCLEVBRWhCLElBRmdCLEVBR2hCckMsT0FBT29DLFFBSFMsRUFJaEJ2RCxLQUpnQixDQUFsQjtBQU1EO0FBQ0QsYUFBTzJCLE1BQVA7QUFDRCxLQWpDSDs7QUFvQ0FuQyxpQkFBYXFELEdBQWIsQ0FDRXZDLFFBREYsRUFFRSx1QkFGRixFQUdFLDRCQUhGLEVBSUUsQ0FBQ2EsTUFBRCxFQUFTUSxNQUFULEVBQWlCM0IsS0FBakIsS0FBMkI7QUFDekIsVUFBSTJCLE9BQU9GLElBQVAsS0FBZ0IsUUFBcEIsRUFBOEI7QUFDNUIsZUFBT0UsT0FBTzlCLEtBQWQ7QUFDRCxPQUZELE1BRU8sSUFBSThCLE9BQU9GLElBQVAsS0FBZ0IsUUFBcEIsRUFBOEI7QUFDbkMsZUFBTyxJQUFJRyxNQUFKLENBQVdELE9BQU9FLElBQWxCLENBQVA7QUFDRCxPQUZNLE1BRUEsSUFBSUQsT0FBT21CLFFBQVAsSUFBbUJuQixPQUFPbUIsUUFBUCxDQUFnQnBCLE1BQWhCLENBQXZCLEVBQWdEO0FBQ3JELGVBQU9BLE1BQVA7QUFDRDs7QUFFRDNCLFlBQU0rQixPQUFOLEdBQWdCdEMsY0FBaEI7QUFDQTBCLGVBQVNpQixXQUFXVCxNQUFYLEVBQW1CM0IsS0FBbkIsRUFBMEJDLE9BQTFCLENBQVQ7QUFDQSxVQUFJMEIsT0FBT0YsSUFBUCxLQUFnQixlQUFwQixFQUFxQztBQUNuQ04sZUFBTzZCLFlBQVAsR0FBc0JyQixPQUFPcUIsWUFBN0I7QUFDRCxPQUZELE1BRU8sSUFBSXJCLE9BQU9GLElBQVAsS0FBZ0IsY0FBcEIsRUFBb0M7QUFDekNOLGVBQU8rQixhQUFQLEdBQXVCdkIsT0FBT3NCLFlBQTlCO0FBQ0E5QixlQUFPaUMsV0FBUCxHQUFxQnpCLE9BQU93QixVQUE1QjtBQUNBaEMsZUFBT21DLFdBQVAsR0FBcUIzQixPQUFPMEIsVUFBNUI7QUFDRCxPQUpNLE1BSUEsSUFBSTFCLE9BQU9GLElBQVAsS0FBZ0IsY0FBcEIsRUFBb0M7QUFDekNOLGVBQU9vQyxRQUFQLEdBQWtCdEQsUUFBUXdELE9BQVIsQ0FDaEIsUUFEZ0IsRUFFaEIsSUFGZ0IsRUFHaEI5QixPQUFPNEIsUUFIUyxFQUloQnZELEtBSmdCLENBQWxCO0FBTUQ7QUFDRCxhQUFPbUIsTUFBUDtBQUNELEtBOUJIO0FBZ0NEO0FBakZ5Qjs7QUFvRjVCdUMsT0FBT0MsT0FBUCxHQUFpQmYscUJBQWpCIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9UcmFuc2Zvcm1Tb3VyY2VQbHVnaW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCByZWxhdGVDb250ZXh0ID0gcmVxdWlyZSgnLi91dGlsL3JlbGF0ZS1jb250ZXh0Jyk7XG5jb25zdCBwbHVnaW5Db21wYXQgPSByZXF1aXJlKCcuL3V0aWwvcGx1Z2luLWNvbXBhdCcpO1xuXG5jb25zdCBTb3VyY2VTY2hlbWFzMyA9IFtcbiAgWydDYWNoZWRTb3VyY2UnLCAnc291cmNlJ10sXG4gIFsnQ29uY2F0U291cmNlJ10sXG4gIFsnTGluZVRvTGluZU1hcHBlZFNvdXJjZScsICd2YWx1ZScsICduYW1lJywgJ29yaWdpbmFsU291cmNlJ10sXG4gIFsnT3JpZ2luYWxTb3VyY2UnLCAndmFsdWUnLCAnbmFtZSddLFxuICBbJ1Jhd1NvdXJjZScsICd2YWx1ZSddLFxuICBbJ1JlcGxhY2VTb3VyY2UnLCAnc291cmNlJywgJ25hbWUnXSxcbiAgW1xuICAgICdTb3VyY2VNYXBTb3VyY2UnLFxuICAgICd2YWx1ZScsXG4gICAgJ25hbWUnLFxuICAgICdzb3VyY2VNYXAnLFxuICAgICdvcmlnaW5hbFNvdXJjZScsXG4gICAgJ2lubmVyU291cmNlTWFwJyxcbiAgXSxcbl07XG5cbnRyeSB7XG4gIFNvdXJjZVNjaGVtYXMzWzBdLlNvdXJjZSA9IHJlcXVpcmUoJ3dlYnBhY2stc291cmNlcy9saWIvQ2FjaGVkU291cmNlJyk7XG59IGNhdGNoIChfKSB7fVxudHJ5IHtcbiAgU291cmNlU2NoZW1hczNbMV0uU291cmNlID0gcmVxdWlyZSgnd2VicGFjay1zb3VyY2VzL2xpYi9Db25jYXRTb3VyY2UnKTtcbn0gY2F0Y2ggKF8pIHt9XG50cnkge1xuICBTb3VyY2VTY2hlbWFzM1syXS5Tb3VyY2UgPSByZXF1aXJlKCd3ZWJwYWNrLXNvdXJjZXMvbGliL0xpbmVUb0xpbmVNYXBwZWRTb3VyY2UnKTtcbn0gY2F0Y2ggKF8pIHt9XG50cnkge1xuICBTb3VyY2VTY2hlbWFzM1szXS5Tb3VyY2UgPSByZXF1aXJlKCd3ZWJwYWNrLXNvdXJjZXMvbGliL09yaWdpbmFsU291cmNlJyk7XG59IGNhdGNoIChfKSB7fVxudHJ5IHtcbiAgU291cmNlU2NoZW1hczNbNF0uU291cmNlID0gcmVxdWlyZSgnd2VicGFjay1zb3VyY2VzL2xpYi9SYXdTb3VyY2UnKTtcbn0gY2F0Y2ggKF8pIHt9XG50cnkge1xuICBTb3VyY2VTY2hlbWFzM1s1XS5Tb3VyY2UgPSByZXF1aXJlKCd3ZWJwYWNrLXNvdXJjZXMvbGliL1JlcGxhY2VTb3VyY2UnKTtcbn0gY2F0Y2ggKF8pIHt9XG50cnkge1xuICBTb3VyY2VTY2hlbWFzM1s2XS5Tb3VyY2UgPSByZXF1aXJlKCd3ZWJwYWNrLXNvdXJjZXMvbGliL1NvdXJjZU1hcFNvdXJjZScpO1xufSBjYXRjaCAoXykge31cblxuY29uc3QgZnJlZXplQXJndW1lbnQgPSB7XG4gIHZhbHVlKGFyZywgeyBfdmFsdWUgfSwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgICByZXR1cm4gX3ZhbHVlO1xuICB9LFxuICBuYW1lKGFyZywgeyBfbmFtZSB9LCB7IGNvbXBpbGF0aW9uIH0sIG1ldGhvZHMpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIHJlbGF0ZUNvbnRleHQucmVsYXRlTm9ybWFsUGF0aChjb21waWxhdGlvbi5jb21waWxlciwgX25hbWUpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZS5zdGFjayk7XG4gICAgICBwcm9jZXNzLmV4aXQoKTtcbiAgICB9XG4gIH0sXG4gIHNvdXJjZU1hcChhcmcsIHsgX3NvdXJjZU1hcCB9LCBleHRyYSwgbWV0aG9kcykge1xuICAgIHJldHVybiBfc291cmNlTWFwO1xuICB9LFxuICBvcmlnaW5hbFNvdXJjZShhcmcsIHsgX29yaWdpbmFsU291cmNlIH0sIGV4dHJhLCBtZXRob2RzKSB7XG4gICAgcmV0dXJuIF9vcmlnaW5hbFNvdXJjZTtcbiAgfSxcbiAgaW5uZXJTb3VyY2VNYXAoYXJnLCB7IF9pbm5lclNvdXJjZU1hcCB9LCBleHRyYSwgbWV0aG9kcykge1xuICAgIHJldHVybiBfaW5uZXJTb3VyY2VNYXA7XG4gIH0sXG4gIHNvdXJjZShhcmcsIHsgY29uc3RydWN0b3IsIF9zb3VyY2UgfSwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgICBpZiAoY29uc3RydWN0b3IubmFtZSA9PT0gJ1JlcGxhY2VTb3VyY2UnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHJldHVybiBtZXRob2RzLmZyZWV6ZSgnU291cmNlJywgbnVsbCwgX3NvdXJjZSwgZXh0cmEpO1xuICB9LFxufTtcblxuY29uc3QgdGhhd0FyZ3VtZW50ID0ge1xuICBuYW1lKGFyZywgc291cmNlLCB7IGNvbXBpbGF0aW9uIH0sIG1ldGhvZHMpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIHJlbGF0ZUNvbnRleHQuY29udGV4dE5vcm1hbFBhdGgoY29tcGlsYXRpb24uY29tcGlsZXIsIGFyZyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5lcnJvcihlLnN0YWNrKTtcbiAgICAgIHByb2Nlc3MuZXhpdCgpO1xuICAgIH1cbiAgfSxcbiAgc291cmNlKGFyZywgeyB0eXBlIH0sIGV4dHJhLCBtZXRob2RzKSB7XG4gICAgaWYgKHR5cGUgPT09ICdSZXBsYWNlU291cmNlJykge1xuICAgICAgcmV0dXJuIGV4dHJhLnNvdXJjZTtcbiAgICB9XG4gICAgcmV0dXJuIG1ldGhvZHMudGhhdygnU291cmNlJywgbnVsbCwgYXJnLCBleHRyYSk7XG4gIH0sXG4gIHZhbHVlKGFyZywgZnJvemVuLCBleHRyYSwgbWV0aG9kcykge1xuICAgIGlmIChhcmcgJiYgYXJnLnR5cGUgPT09ICdCdWZmZXInKSB7XG4gICAgICByZXR1cm4gbmV3IEJ1ZmZlcihhcmcuZGF0YSk7XG4gICAgfVxuICAgIHJldHVybiBhcmc7XG4gIH0sXG59O1xuXG5mdW5jdGlvbiBmcmVlemVTb3VyY2Uoc291cmNlLCBleHRyYSwgbWV0aG9kcykge1xuICBjb25zdCBzY2hlbWFzID0gZXh0cmEuc2NoZW1hcztcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzY2hlbWFzLmxlbmd0aDsgaSsrKSB7XG4gICAgaWYgKHNvdXJjZS5jb25zdHJ1Y3Rvci5uYW1lID09PSBzY2hlbWFzW2ldLlNvdXJjZS5uYW1lKSB7XG4gICAgICBjb25zdCBmcm96ZW4gPSB7XG4gICAgICAgIHR5cGU6IHNjaGVtYXNbaV1bMF0sXG4gICAgICB9O1xuICAgICAgZm9yIChsZXQgaiA9IDE7IGogPCBzY2hlbWFzW2ldLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGxldCBhcmcgPSBzb3VyY2Vbc2NoZW1hc1tpXVtqXV07XG4gICAgICAgIGlmIChmcmVlemVBcmd1bWVudFtzY2hlbWFzW2ldW2pdXSkge1xuICAgICAgICAgIGFyZyA9IGZyZWV6ZUFyZ3VtZW50W3NjaGVtYXNbaV1bal1dKGFyZywgc291cmNlLCBleHRyYSwgbWV0aG9kcyk7XG4gICAgICAgIH1cbiAgICAgICAgZnJvemVuW3NjaGVtYXNbaV1bal1dID0gYXJnO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZyb3plbjtcbiAgICB9XG4gIH1cblxuICB0aHJvdyBuZXcgRXJyb3IoYFVuZnJvemVuICR7c291cmNlLmNvbnN0cnVjdG9yLm5hbWV9LmApO1xufVxuXG5mdW5jdGlvbiB0aGF3U291cmNlKGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgY29uc3Qgc2NoZW1hcyA9IGV4dHJhLnNjaGVtYXM7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgc2NoZW1hcy5sZW5ndGg7IGkrKykge1xuICAgIGlmIChmcm96ZW4udHlwZSA9PT0gc2NoZW1hc1tpXVswXSkge1xuICAgICAgY29uc3QgU291cmNlID0gc2NoZW1hc1tpXS5Tb3VyY2U7XG4gICAgICBjb25zdCBhcmdzID0gW107XG4gICAgICBmb3IgKGxldCBqID0gMTsgaiA8IHNjaGVtYXNbaV0ubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgbGV0IGFyZyA9IGZyb3plbltzY2hlbWFzW2ldW2pdXTtcbiAgICAgICAgaWYgKHRoYXdBcmd1bWVudFtzY2hlbWFzW2ldW2pdXSkge1xuICAgICAgICAgIGFyZyA9IHRoYXdBcmd1bWVudFtzY2hlbWFzW2ldW2pdXShhcmcsIGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpO1xuICAgICAgICB9XG4gICAgICAgIGFyZ3MucHVzaChhcmcpO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIG5ldyBTb3VyY2UoLi4uYXJncyk7XG4gICAgICB9IGNhdGNoIChfKSB7XG4gICAgICAgIHJldHVybiBuZXcgKEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kLmFwcGx5KFxuICAgICAgICAgIFNvdXJjZSxcbiAgICAgICAgICBbbnVsbF0uY29uY2F0KGFyZ3MpLFxuICAgICAgICApKSgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5jbGFzcyBUcmFuc2Zvcm1Tb3VyY2VQbHVnaW4ge1xuICBhcHBseShjb21waWxlcikge1xuICAgIGxldCBtZXRob2RzO1xuXG4gICAgcGx1Z2luQ29tcGF0LnRhcChcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlTWV0aG9kcycsXG4gICAgICAnVHJhbnNmb3JtU291cmNlUGx1Z2luJyxcbiAgICAgIF9tZXRob2RzID0+IHtcbiAgICAgICAgbWV0aG9kcyA9IF9tZXRob2RzO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgcGx1Z2luQ29tcGF0LnRhcChcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlRnJlZXplU291cmNlJyxcbiAgICAgICdUcmFuc2Zvcm1Tb3VyY2VQbHVnaW4gZnJlZXplJyxcbiAgICAgIChmcm96ZW4sIHNvdXJjZSwgZXh0cmEpID0+IHtcbiAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR5cGU6ICdTdHJpbmcnLFxuICAgICAgICAgICAgdmFsdWU6IHNvdXJjZSxcbiAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2UgaWYgKEJ1ZmZlci5pc0J1ZmZlciAmJiBCdWZmZXIuaXNCdWZmZXIoc291cmNlKSkge1xuICAgICAgICAgIC8vIFNlcmlhbGl6YXRpb24gbGF5ZXIgbWlnaHQgdHJhbnNmb3JtIGl0IGludG8gSlNPTiBvciBoYW5kbGUgaXQgYXMgYmluYXJ5XG4gICAgICAgICAgLy8gZGF0YVxuICAgICAgICAgIHJldHVybiBzb3VyY2U7XG4gICAgICAgIH1cblxuICAgICAgICBleHRyYS5zY2hlbWFzID0gU291cmNlU2NoZW1hczM7XG4gICAgICAgIGZyb3plbiA9IGZyZWV6ZVNvdXJjZShzb3VyY2UsIGV4dHJhLCBtZXRob2RzKTtcbiAgICAgICAgaWYgKGZyb3plbi50eXBlID09PSAnUmVwbGFjZVNvdXJjZScpIHtcbiAgICAgICAgICBmcm96ZW4ucmVwbGFjZW1lbnRzID0gc291cmNlLnJlcGxhY2VtZW50cztcbiAgICAgICAgfSBlbHNlIGlmIChmcm96ZW4udHlwZSA9PT0gJ0NhY2hlZFNvdXJjZScpIHtcbiAgICAgICAgICBmcm96ZW4uY2FjaGVkU291cmNlID0gc291cmNlLl9jYWNoZWRTb3VyY2U7XG4gICAgICAgICAgZnJvemVuLmNhY2hlZFNpemUgPSBzb3VyY2UuX2NhY2hlZFNpemU7XG4gICAgICAgICAgZnJvemVuLmNhY2hlZE1hcHMgPSBzb3VyY2UuX2NhY2hlZE1hcHM7XG4gICAgICAgIH0gZWxzZSBpZiAoZnJvemVuLnR5cGUgPT09ICdDb25jYXRTb3VyY2UnKSB7XG4gICAgICAgICAgZnJvemVuLmNoaWxkcmVuID0gbWV0aG9kcy5tYXBGcmVlemUoXG4gICAgICAgICAgICAnU291cmNlJyxcbiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBzb3VyY2UuY2hpbGRyZW4sXG4gICAgICAgICAgICBleHRyYSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmcm96ZW47XG4gICAgICB9LFxuICAgICk7XG5cbiAgICBwbHVnaW5Db21wYXQudGFwKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnX2hhcmRTb3VyY2VUaGF3U291cmNlJyxcbiAgICAgICdUcmFuc2Zvcm1Tb3VyY2VQbHVnaW4gdGhhdycsXG4gICAgICAoc291cmNlLCBmcm96ZW4sIGV4dHJhKSA9PiB7XG4gICAgICAgIGlmIChmcm96ZW4udHlwZSA9PT0gJ1N0cmluZycpIHtcbiAgICAgICAgICByZXR1cm4gZnJvemVuLnZhbHVlO1xuICAgICAgICB9IGVsc2UgaWYgKGZyb3plbi50eXBlID09PSAnQnVmZmVyJykge1xuICAgICAgICAgIHJldHVybiBuZXcgQnVmZmVyKGZyb3plbi5kYXRhKTtcbiAgICAgICAgfSBlbHNlIGlmIChCdWZmZXIuaXNCdWZmZXIgJiYgQnVmZmVyLmlzQnVmZmVyKGZyb3plbikpIHtcbiAgICAgICAgICByZXR1cm4gZnJvemVuO1xuICAgICAgICB9XG5cbiAgICAgICAgZXh0cmEuc2NoZW1hcyA9IFNvdXJjZVNjaGVtYXMzO1xuICAgICAgICBzb3VyY2UgPSB0aGF3U291cmNlKGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpO1xuICAgICAgICBpZiAoZnJvemVuLnR5cGUgPT09ICdSZXBsYWNlU291cmNlJykge1xuICAgICAgICAgIHNvdXJjZS5yZXBsYWNlbWVudHMgPSBmcm96ZW4ucmVwbGFjZW1lbnRzO1xuICAgICAgICB9IGVsc2UgaWYgKGZyb3plbi50eXBlID09PSAnQ2FjaGVkU291cmNlJykge1xuICAgICAgICAgIHNvdXJjZS5fY2FjaGVkU291cmNlID0gZnJvemVuLmNhY2hlZFNvdXJjZTtcbiAgICAgICAgICBzb3VyY2UuX2NhY2hlZFNpemUgPSBmcm96ZW4uY2FjaGVkU2l6ZTtcbiAgICAgICAgICBzb3VyY2UuX2NhY2hlZE1hcHMgPSBmcm96ZW4uY2FjaGVkTWFwcztcbiAgICAgICAgfSBlbHNlIGlmIChmcm96ZW4udHlwZSA9PT0gJ0NvbmNhdFNvdXJjZScpIHtcbiAgICAgICAgICBzb3VyY2UuY2hpbGRyZW4gPSBtZXRob2RzLm1hcFRoYXcoXG4gICAgICAgICAgICAnU291cmNlJyxcbiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBmcm96ZW4uY2hpbGRyZW4sXG4gICAgICAgICAgICBleHRyYSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzb3VyY2U7XG4gICAgICB9LFxuICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBUcmFuc2Zvcm1Tb3VyY2VQbHVnaW47XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
