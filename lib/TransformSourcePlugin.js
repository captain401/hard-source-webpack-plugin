'use strict';

require('source-map-support/register');

const relateContext = require('./util/relate-context');
const pluginCompat = require('./util/plugin-compat');

const SourceSchemas3 = [['CachedSource', 'source'], ['ConcatSource'], ['LineToLineMappedSource', 'value', 'name', 'originalSource'], ['OriginalSource', 'value', 'name'], ['RawSource', 'value'], ['ReplaceSource', 'source', 'name'], ['SourceMapSource', 'value', 'name', 'sourceMap', 'originalSource', 'innerSourceMap']];

try {
  SourceSchemas3[0].Source = require('webpack-sources/lib/CachedSource');
} catch (_) {}
try {
  SourceSchemas3[1].Source = require('webpack-sources/lib/ConcatSource');
} catch (_) {}
try {
  SourceSchemas3[2].Source = require('webpack-sources/lib/LineToLineMappedSource');
} catch (_) {}
try {
  SourceSchemas3[3].Source = require('webpack-sources/lib/OriginalSource');
} catch (_) {}
try {
  SourceSchemas3[4].Source = require('webpack-sources/lib/RawSource');
} catch (_) {}
try {
  SourceSchemas3[5].Source = require('webpack-sources/lib/ReplaceSource');
} catch (_) {}
try {
  SourceSchemas3[6].Source = require('webpack-sources/lib/SourceMapSource');
} catch (_) {}

const freezeArgument = {
  value(arg, { _value }, extra, methods) {
    return _value;
  },
  name(arg, { _name }, { compilation }, methods) {
    try {
      return relateContext.relateNormalPath(compilation.compiler, _name);
    } catch (e) {
      console.error(e.stack);
      process.exit();
    }
  },
  sourceMap(arg, { _sourceMap }, extra, methods) {
    return _sourceMap;
  },
  originalSource(arg, { _originalSource }, extra, methods) {
    return _originalSource;
  },
  innerSourceMap(arg, { _innerSourceMap }, extra, methods) {
    return _innerSourceMap;
  },
  source(arg, { constructor, _source }, extra, methods) {
    if (constructor.name === 'ReplaceSource') {
      return;
    }
    return methods.freeze('Source', null, _source, extra);
  }
};

const thawArgument = {
  name(arg, source, { compilation }, methods) {
    try {
      return relateContext.contextNormalPath(compilation.compiler, arg);
    } catch (e) {
      console.error(e.stack);
      process.exit();
    }
  },
  source(arg, { type }, extra, methods) {
    if (type === 'ReplaceSource') {
      return extra.source;
    }
    return methods.thaw('Source', null, arg, extra);
  },
  value(arg, frozen, extra, methods) {
    if (arg && arg.type === 'Buffer') {
      return new Buffer(arg.data);
    }
    return arg;
  }
};

function freezeSource(source, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (source.constructor.name === schemas[i].Source.name) {
      const frozen = {
        type: schemas[i][0]
      };
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = source[schemas[i][j]];
        if (freezeArgument[schemas[i][j]]) {
          arg = freezeArgument[schemas[i][j]](arg, source, extra, methods);
        }
        frozen[schemas[i][j]] = arg;
      }
      return frozen;
    }
  }

  throw new Error(`Unfrozen ${source.constructor.name}.`);
}

function thawSource(frozen, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (frozen.type === schemas[i][0]) {
      const Source = schemas[i].Source;
      const args = [];
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = frozen[schemas[i][j]];
        if (thawArgument[schemas[i][j]]) {
          arg = thawArgument[schemas[i][j]](arg, frozen, extra, methods);
        }
        args.push(arg);
      }
      try {
        return new Source(...args);
      } catch (_) {
        return new (Function.prototype.bind.apply(Source, [null].concat(args)))();
      }
    }
  }
}

class TransformSourcePlugin {
  apply(compiler) {
    let methods;

    pluginCompat.tap(compiler, '_hardSourceMethods', 'TransformSourcePlugin', _methods => {
      methods = _methods;
    });

    pluginCompat.tap(compiler, '_hardSourceFreezeSource', 'TransformSourcePlugin freeze', (frozen, source, extra) => {
      if (typeof source === 'string') {
        return {
          type: 'String',
          value: source
        };
      } else if (Buffer.isBuffer && Buffer.isBuffer(source)) {
        // Serialization layer might transform it into JSON or handle it as binary
        // data
        return source;
      }

      extra.schemas = SourceSchemas3;
      frozen = freezeSource(source, extra, methods);
      if (frozen.type === 'ReplaceSource') {
        frozen.replacements = source.replacements;
      } else if (frozen.type === 'CachedSource') {
        frozen.cachedSource = source._cachedSource;
        frozen.cachedSize = source._cachedSize;
        frozen.cachedMaps = source._cachedMaps;
      } else if (frozen.type === 'ConcatSource') {
        frozen.children = methods.mapFreeze('Source', null, source.children, extra);
      }
      return frozen;
    });

    pluginCompat.tap(compiler, '_hardSourceThawSource', 'TransformSourcePlugin thaw', (source, frozen, extra) => {
      if (frozen.type === 'String') {
        return frozen.value;
      } else if (frozen.type === 'Buffer') {
        return new Buffer(frozen.data);
      } else if (Buffer.isBuffer && Buffer.isBuffer(frozen)) {
        return frozen;
      }

      extra.schemas = SourceSchemas3;
      source = thawSource(frozen, extra, methods);
      if (frozen.type === 'ReplaceSource') {
        source.replacements = frozen.replacements;
      } else if (frozen.type === 'CachedSource') {
        source._cachedSource = frozen.cachedSource;
        source._cachedSize = frozen.cachedSize;
        source._cachedMaps = frozen.cachedMaps;
      } else if (frozen.type === 'ConcatSource') {
        source.children = methods.mapThaw('Source', null, frozen.children, extra);
      }
      return source;
    });
  }
}

module.exports = TransformSourcePlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9UcmFuc2Zvcm1Tb3VyY2VQbHVnaW4uanMiXSwibmFtZXMiOlsicmVsYXRlQ29udGV4dCIsInJlcXVpcmUiLCJwbHVnaW5Db21wYXQiLCJTb3VyY2VTY2hlbWFzMyIsIlNvdXJjZSIsIl8iLCJmcmVlemVBcmd1bWVudCIsInZhbHVlIiwiYXJnIiwiX3ZhbHVlIiwiZXh0cmEiLCJtZXRob2RzIiwibmFtZSIsIl9uYW1lIiwiY29tcGlsYXRpb24iLCJyZWxhdGVOb3JtYWxQYXRoIiwiY29tcGlsZXIiLCJlIiwiY29uc29sZSIsImVycm9yIiwic3RhY2siLCJwcm9jZXNzIiwiZXhpdCIsInNvdXJjZU1hcCIsIl9zb3VyY2VNYXAiLCJvcmlnaW5hbFNvdXJjZSIsIl9vcmlnaW5hbFNvdXJjZSIsImlubmVyU291cmNlTWFwIiwiX2lubmVyU291cmNlTWFwIiwic291cmNlIiwiY29uc3RydWN0b3IiLCJfc291cmNlIiwiZnJlZXplIiwidGhhd0FyZ3VtZW50IiwiY29udGV4dE5vcm1hbFBhdGgiLCJ0eXBlIiwidGhhdyIsImZyb3plbiIsIkJ1ZmZlciIsImRhdGEiLCJmcmVlemVTb3VyY2UiLCJzY2hlbWFzIiwiaSIsImxlbmd0aCIsImoiLCJFcnJvciIsInRoYXdTb3VyY2UiLCJhcmdzIiwicHVzaCIsIkZ1bmN0aW9uIiwicHJvdG90eXBlIiwiYmluZCIsImFwcGx5IiwiY29uY2F0IiwiVHJhbnNmb3JtU291cmNlUGx1Z2luIiwidGFwIiwiX21ldGhvZHMiLCJpc0J1ZmZlciIsInJlcGxhY2VtZW50cyIsImNhY2hlZFNvdXJjZSIsIl9jYWNoZWRTb3VyY2UiLCJjYWNoZWRTaXplIiwiX2NhY2hlZFNpemUiLCJjYWNoZWRNYXBzIiwiX2NhY2hlZE1hcHMiLCJjaGlsZHJlbiIsIm1hcEZyZWV6ZSIsIm1hcFRoYXciLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsZ0JBQWdC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LXNvdXJjZS13ZWJwYWNrLXBsdWdpbi9saWIvVHJhbnNmb3JtU291cmNlUGx1Z2luLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcmVsYXRlQ29udGV4dCA9IHJlcXVpcmUoJy4vdXRpbC9yZWxhdGUtY29udGV4dCcpO1xuY29uc3QgcGx1Z2luQ29tcGF0ID0gcmVxdWlyZSgnLi91dGlsL3BsdWdpbi1jb21wYXQnKTtcblxuY29uc3QgU291cmNlU2NoZW1hczMgPSBbXG4gIFsnQ2FjaGVkU291cmNlJywgJ3NvdXJjZSddLFxuICBbJ0NvbmNhdFNvdXJjZSddLFxuICBbJ0xpbmVUb0xpbmVNYXBwZWRTb3VyY2UnLCAndmFsdWUnLCAnbmFtZScsICdvcmlnaW5hbFNvdXJjZSddLFxuICBbJ09yaWdpbmFsU291cmNlJywgJ3ZhbHVlJywgJ25hbWUnXSxcbiAgWydSYXdTb3VyY2UnLCAndmFsdWUnXSxcbiAgWydSZXBsYWNlU291cmNlJywgJ3NvdXJjZScsICduYW1lJ10sXG4gIFtcbiAgICAnU291cmNlTWFwU291cmNlJyxcbiAgICAndmFsdWUnLFxuICAgICduYW1lJyxcbiAgICAnc291cmNlTWFwJyxcbiAgICAnb3JpZ2luYWxTb3VyY2UnLFxuICAgICdpbm5lclNvdXJjZU1hcCcsXG4gIF0sXG5dO1xuXG50cnkge1xuICBTb3VyY2VTY2hlbWFzM1swXS5Tb3VyY2UgPSByZXF1aXJlKCd3ZWJwYWNrLXNvdXJjZXMvbGliL0NhY2hlZFNvdXJjZScpO1xufSBjYXRjaCAoXykge31cbnRyeSB7XG4gIFNvdXJjZVNjaGVtYXMzWzFdLlNvdXJjZSA9IHJlcXVpcmUoJ3dlYnBhY2stc291cmNlcy9saWIvQ29uY2F0U291cmNlJyk7XG59IGNhdGNoIChfKSB7fVxudHJ5IHtcbiAgU291cmNlU2NoZW1hczNbMl0uU291cmNlID0gcmVxdWlyZSgnd2VicGFjay1zb3VyY2VzL2xpYi9MaW5lVG9MaW5lTWFwcGVkU291cmNlJyk7XG59IGNhdGNoIChfKSB7fVxudHJ5IHtcbiAgU291cmNlU2NoZW1hczNbM10uU291cmNlID0gcmVxdWlyZSgnd2VicGFjay1zb3VyY2VzL2xpYi9PcmlnaW5hbFNvdXJjZScpO1xufSBjYXRjaCAoXykge31cbnRyeSB7XG4gIFNvdXJjZVNjaGVtYXMzWzRdLlNvdXJjZSA9IHJlcXVpcmUoJ3dlYnBhY2stc291cmNlcy9saWIvUmF3U291cmNlJyk7XG59IGNhdGNoIChfKSB7fVxudHJ5IHtcbiAgU291cmNlU2NoZW1hczNbNV0uU291cmNlID0gcmVxdWlyZSgnd2VicGFjay1zb3VyY2VzL2xpYi9SZXBsYWNlU291cmNlJyk7XG59IGNhdGNoIChfKSB7fVxudHJ5IHtcbiAgU291cmNlU2NoZW1hczNbNl0uU291cmNlID0gcmVxdWlyZSgnd2VicGFjay1zb3VyY2VzL2xpYi9Tb3VyY2VNYXBTb3VyY2UnKTtcbn0gY2F0Y2ggKF8pIHt9XG5cbmNvbnN0IGZyZWV6ZUFyZ3VtZW50ID0ge1xuICB2YWx1ZShhcmcsIHsgX3ZhbHVlIH0sIGV4dHJhLCBtZXRob2RzKSB7XG4gICAgcmV0dXJuIF92YWx1ZTtcbiAgfSxcbiAgbmFtZShhcmcsIHsgX25hbWUgfSwgeyBjb21waWxhdGlvbiB9LCBtZXRob2RzKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiByZWxhdGVDb250ZXh0LnJlbGF0ZU5vcm1hbFBhdGgoY29tcGlsYXRpb24uY29tcGlsZXIsIF9uYW1lKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGUuc3RhY2spO1xuICAgICAgcHJvY2Vzcy5leGl0KCk7XG4gICAgfVxuICB9LFxuICBzb3VyY2VNYXAoYXJnLCB7IF9zb3VyY2VNYXAgfSwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgICByZXR1cm4gX3NvdXJjZU1hcDtcbiAgfSxcbiAgb3JpZ2luYWxTb3VyY2UoYXJnLCB7IF9vcmlnaW5hbFNvdXJjZSB9LCBleHRyYSwgbWV0aG9kcykge1xuICAgIHJldHVybiBfb3JpZ2luYWxTb3VyY2U7XG4gIH0sXG4gIGlubmVyU291cmNlTWFwKGFyZywgeyBfaW5uZXJTb3VyY2VNYXAgfSwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgICByZXR1cm4gX2lubmVyU291cmNlTWFwO1xuICB9LFxuICBzb3VyY2UoYXJnLCB7IGNvbnN0cnVjdG9yLCBfc291cmNlIH0sIGV4dHJhLCBtZXRob2RzKSB7XG4gICAgaWYgKGNvbnN0cnVjdG9yLm5hbWUgPT09ICdSZXBsYWNlU291cmNlJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICByZXR1cm4gbWV0aG9kcy5mcmVlemUoJ1NvdXJjZScsIG51bGwsIF9zb3VyY2UsIGV4dHJhKTtcbiAgfSxcbn07XG5cbmNvbnN0IHRoYXdBcmd1bWVudCA9IHtcbiAgbmFtZShhcmcsIHNvdXJjZSwgeyBjb21waWxhdGlvbiB9LCBtZXRob2RzKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiByZWxhdGVDb250ZXh0LmNvbnRleHROb3JtYWxQYXRoKGNvbXBpbGF0aW9uLmNvbXBpbGVyLCBhcmcpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZS5zdGFjayk7XG4gICAgICBwcm9jZXNzLmV4aXQoKTtcbiAgICB9XG4gIH0sXG4gIHNvdXJjZShhcmcsIHsgdHlwZSB9LCBleHRyYSwgbWV0aG9kcykge1xuICAgIGlmICh0eXBlID09PSAnUmVwbGFjZVNvdXJjZScpIHtcbiAgICAgIHJldHVybiBleHRyYS5zb3VyY2U7XG4gICAgfVxuICAgIHJldHVybiBtZXRob2RzLnRoYXcoJ1NvdXJjZScsIG51bGwsIGFyZywgZXh0cmEpO1xuICB9LFxuICB2YWx1ZShhcmcsIGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgICBpZiAoYXJnICYmIGFyZy50eXBlID09PSAnQnVmZmVyJykge1xuICAgICAgcmV0dXJuIG5ldyBCdWZmZXIoYXJnLmRhdGEpO1xuICAgIH1cbiAgICByZXR1cm4gYXJnO1xuICB9LFxufTtcblxuZnVuY3Rpb24gZnJlZXplU291cmNlKHNvdXJjZSwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgY29uc3Qgc2NoZW1hcyA9IGV4dHJhLnNjaGVtYXM7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgc2NoZW1hcy5sZW5ndGg7IGkrKykge1xuICAgIGlmIChzb3VyY2UuY29uc3RydWN0b3IubmFtZSA9PT0gc2NoZW1hc1tpXS5Tb3VyY2UubmFtZSkge1xuICAgICAgY29uc3QgZnJvemVuID0ge1xuICAgICAgICB0eXBlOiBzY2hlbWFzW2ldWzBdLFxuICAgICAgfTtcbiAgICAgIGZvciAobGV0IGogPSAxOyBqIDwgc2NoZW1hc1tpXS5sZW5ndGg7IGorKykge1xuICAgICAgICBsZXQgYXJnID0gc291cmNlW3NjaGVtYXNbaV1bal1dO1xuICAgICAgICBpZiAoZnJlZXplQXJndW1lbnRbc2NoZW1hc1tpXVtqXV0pIHtcbiAgICAgICAgICBhcmcgPSBmcmVlemVBcmd1bWVudFtzY2hlbWFzW2ldW2pdXShhcmcsIHNvdXJjZSwgZXh0cmEsIG1ldGhvZHMpO1xuICAgICAgICB9XG4gICAgICAgIGZyb3plbltzY2hlbWFzW2ldW2pdXSA9IGFyZztcbiAgICAgIH1cbiAgICAgIHJldHVybiBmcm96ZW47XG4gICAgfVxuICB9XG5cbiAgdGhyb3cgbmV3IEVycm9yKGBVbmZyb3plbiAke3NvdXJjZS5jb25zdHJ1Y3Rvci5uYW1lfS5gKTtcbn1cblxuZnVuY3Rpb24gdGhhd1NvdXJjZShmcm96ZW4sIGV4dHJhLCBtZXRob2RzKSB7XG4gIGNvbnN0IHNjaGVtYXMgPSBleHRyYS5zY2hlbWFzO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHNjaGVtYXMubGVuZ3RoOyBpKyspIHtcbiAgICBpZiAoZnJvemVuLnR5cGUgPT09IHNjaGVtYXNbaV1bMF0pIHtcbiAgICAgIGNvbnN0IFNvdXJjZSA9IHNjaGVtYXNbaV0uU291cmNlO1xuICAgICAgY29uc3QgYXJncyA9IFtdO1xuICAgICAgZm9yIChsZXQgaiA9IDE7IGogPCBzY2hlbWFzW2ldLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGxldCBhcmcgPSBmcm96ZW5bc2NoZW1hc1tpXVtqXV07XG4gICAgICAgIGlmICh0aGF3QXJndW1lbnRbc2NoZW1hc1tpXVtqXV0pIHtcbiAgICAgICAgICBhcmcgPSB0aGF3QXJndW1lbnRbc2NoZW1hc1tpXVtqXV0oYXJnLCBmcm96ZW4sIGV4dHJhLCBtZXRob2RzKTtcbiAgICAgICAgfVxuICAgICAgICBhcmdzLnB1c2goYXJnKTtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBuZXcgU291cmNlKC4uLmFyZ3MpO1xuICAgICAgfSBjYXRjaCAoXykge1xuICAgICAgICByZXR1cm4gbmV3IChGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5hcHBseShcbiAgICAgICAgICBTb3VyY2UsXG4gICAgICAgICAgW251bGxdLmNvbmNhdChhcmdzKSxcbiAgICAgICAgKSkoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgVHJhbnNmb3JtU291cmNlUGx1Z2luIHtcbiAgYXBwbHkoY29tcGlsZXIpIHtcbiAgICBsZXQgbWV0aG9kcztcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZU1ldGhvZHMnLFxuICAgICAgJ1RyYW5zZm9ybVNvdXJjZVBsdWdpbicsXG4gICAgICBfbWV0aG9kcyA9PiB7XG4gICAgICAgIG1ldGhvZHMgPSBfbWV0aG9kcztcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZUZyZWV6ZVNvdXJjZScsXG4gICAgICAnVHJhbnNmb3JtU291cmNlUGx1Z2luIGZyZWV6ZScsXG4gICAgICAoZnJvemVuLCBzb3VyY2UsIGV4dHJhKSA9PiB7XG4gICAgICAgIGlmICh0eXBlb2Ygc291cmNlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0eXBlOiAnU3RyaW5nJyxcbiAgICAgICAgICAgIHZhbHVlOiBzb3VyY2UsXG4gICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIGlmIChCdWZmZXIuaXNCdWZmZXIgJiYgQnVmZmVyLmlzQnVmZmVyKHNvdXJjZSkpIHtcbiAgICAgICAgICAvLyBTZXJpYWxpemF0aW9uIGxheWVyIG1pZ2h0IHRyYW5zZm9ybSBpdCBpbnRvIEpTT04gb3IgaGFuZGxlIGl0IGFzIGJpbmFyeVxuICAgICAgICAgIC8vIGRhdGFcbiAgICAgICAgICByZXR1cm4gc291cmNlO1xuICAgICAgICB9XG5cbiAgICAgICAgZXh0cmEuc2NoZW1hcyA9IFNvdXJjZVNjaGVtYXMzO1xuICAgICAgICBmcm96ZW4gPSBmcmVlemVTb3VyY2Uoc291cmNlLCBleHRyYSwgbWV0aG9kcyk7XG4gICAgICAgIGlmIChmcm96ZW4udHlwZSA9PT0gJ1JlcGxhY2VTb3VyY2UnKSB7XG4gICAgICAgICAgZnJvemVuLnJlcGxhY2VtZW50cyA9IHNvdXJjZS5yZXBsYWNlbWVudHM7XG4gICAgICAgIH0gZWxzZSBpZiAoZnJvemVuLnR5cGUgPT09ICdDYWNoZWRTb3VyY2UnKSB7XG4gICAgICAgICAgZnJvemVuLmNhY2hlZFNvdXJjZSA9IHNvdXJjZS5fY2FjaGVkU291cmNlO1xuICAgICAgICAgIGZyb3plbi5jYWNoZWRTaXplID0gc291cmNlLl9jYWNoZWRTaXplO1xuICAgICAgICAgIGZyb3plbi5jYWNoZWRNYXBzID0gc291cmNlLl9jYWNoZWRNYXBzO1xuICAgICAgICB9IGVsc2UgaWYgKGZyb3plbi50eXBlID09PSAnQ29uY2F0U291cmNlJykge1xuICAgICAgICAgIGZyb3plbi5jaGlsZHJlbiA9IG1ldGhvZHMubWFwRnJlZXplKFxuICAgICAgICAgICAgJ1NvdXJjZScsXG4gICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgc291cmNlLmNoaWxkcmVuLFxuICAgICAgICAgICAgZXh0cmEsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZnJvemVuO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgcGx1Z2luQ29tcGF0LnRhcChcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlVGhhd1NvdXJjZScsXG4gICAgICAnVHJhbnNmb3JtU291cmNlUGx1Z2luIHRoYXcnLFxuICAgICAgKHNvdXJjZSwgZnJvemVuLCBleHRyYSkgPT4ge1xuICAgICAgICBpZiAoZnJvemVuLnR5cGUgPT09ICdTdHJpbmcnKSB7XG4gICAgICAgICAgcmV0dXJuIGZyb3plbi52YWx1ZTtcbiAgICAgICAgfSBlbHNlIGlmIChmcm96ZW4udHlwZSA9PT0gJ0J1ZmZlcicpIHtcbiAgICAgICAgICByZXR1cm4gbmV3IEJ1ZmZlcihmcm96ZW4uZGF0YSk7XG4gICAgICAgIH0gZWxzZSBpZiAoQnVmZmVyLmlzQnVmZmVyICYmIEJ1ZmZlci5pc0J1ZmZlcihmcm96ZW4pKSB7XG4gICAgICAgICAgcmV0dXJuIGZyb3plbjtcbiAgICAgICAgfVxuXG4gICAgICAgIGV4dHJhLnNjaGVtYXMgPSBTb3VyY2VTY2hlbWFzMztcbiAgICAgICAgc291cmNlID0gdGhhd1NvdXJjZShmcm96ZW4sIGV4dHJhLCBtZXRob2RzKTtcbiAgICAgICAgaWYgKGZyb3plbi50eXBlID09PSAnUmVwbGFjZVNvdXJjZScpIHtcbiAgICAgICAgICBzb3VyY2UucmVwbGFjZW1lbnRzID0gZnJvemVuLnJlcGxhY2VtZW50cztcbiAgICAgICAgfSBlbHNlIGlmIChmcm96ZW4udHlwZSA9PT0gJ0NhY2hlZFNvdXJjZScpIHtcbiAgICAgICAgICBzb3VyY2UuX2NhY2hlZFNvdXJjZSA9IGZyb3plbi5jYWNoZWRTb3VyY2U7XG4gICAgICAgICAgc291cmNlLl9jYWNoZWRTaXplID0gZnJvemVuLmNhY2hlZFNpemU7XG4gICAgICAgICAgc291cmNlLl9jYWNoZWRNYXBzID0gZnJvemVuLmNhY2hlZE1hcHM7XG4gICAgICAgIH0gZWxzZSBpZiAoZnJvemVuLnR5cGUgPT09ICdDb25jYXRTb3VyY2UnKSB7XG4gICAgICAgICAgc291cmNlLmNoaWxkcmVuID0gbWV0aG9kcy5tYXBUaGF3KFxuICAgICAgICAgICAgJ1NvdXJjZScsXG4gICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgZnJvemVuLmNoaWxkcmVuLFxuICAgICAgICAgICAgZXh0cmEsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc291cmNlO1xuICAgICAgfSxcbiAgICApO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gVHJhbnNmb3JtU291cmNlUGx1Z2luO1xuIl0sInNvdXJjZVJvb3QiOiIvVXNlcnMvdHlsZXJhcmJ1cy9kZXYvcHJvdmlkZXIvc3JjIn0=
