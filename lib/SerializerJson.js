'use strict';

require('source-map-support/register');

const fs = require('fs');

const promisify = require('./util/promisify');

const fsReadFile = promisify(fs.readFile, { context: fs });
const fsWriteFile = promisify(fs.writeFile, { context: fs });

class JsonSerializer {
  constructor({ cacheDirPath }) {
    this.path = cacheDirPath;
    if (!/\.json$/.test(this.path)) {
      this.path += '.json';
    }
  }

  read() {
    const cacheDirPath = this.path;
    return fsReadFile(cacheDirPath, 'utf8').catch(() => '{}').then(JSON.parse);
  }

  write(moduleOps) {
    const cacheDirPath = this.path;
    return this.read().then(cache => {
      for (let i = 0; i < moduleOps.length; i++) {
        const op = moduleOps[i];
        cache[op.key] = op.value;
      }
      return cache;
    }).then(JSON.stringify).then(cache => fsWriteFile(cacheDirPath, cache));
  }
}

module.exports = JsonSerializer;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9TZXJpYWxpemVySnNvbi5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwcm9taXNpZnkiLCJmc1JlYWRGaWxlIiwicmVhZEZpbGUiLCJjb250ZXh0IiwiZnNXcml0ZUZpbGUiLCJ3cml0ZUZpbGUiLCJKc29uU2VyaWFsaXplciIsImNvbnN0cnVjdG9yIiwiY2FjaGVEaXJQYXRoIiwicGF0aCIsInRlc3QiLCJyZWFkIiwiY2F0Y2giLCJ0aGVuIiwiSlNPTiIsInBhcnNlIiwid3JpdGUiLCJtb2R1bGVPcHMiLCJjYWNoZSIsImkiLCJsZW5ndGgiLCJvcCIsImtleSIsInZhbHVlIiwic3RyaW5naWZ5IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLEtBQUtDLFFBQVEsSUFBUixDQUFYOztBQUVBLE1BQU1DLFlBQVlELFFBQVEsa0JBQVIsQ0FBbEI7O0FBRUEsTUFBTUUsYUFBYUQsVUFBVUYsR0FBR0ksUUFBYixFQUF1QixFQUFFQyxTQUFTTCxFQUFYLEVBQXZCLENBQW5CO0FBQ0EsTUFBTU0sY0FBY0osVUFBVUYsR0FBR08sU0FBYixFQUF3QixFQUFFRixTQUFTTCxFQUFYLEVBQXhCLENBQXBCOztBQUVBLE1BQU1RLGNBQU4sQ0FBcUI7QUFDbkJDLGNBQVksRUFBRUMsWUFBRixFQUFaLEVBQThCO0FBQzVCLFNBQUtDLElBQUwsR0FBWUQsWUFBWjtBQUNBLFFBQUksQ0FBQyxVQUFVRSxJQUFWLENBQWUsS0FBS0QsSUFBcEIsQ0FBTCxFQUFnQztBQUM5QixXQUFLQSxJQUFMLElBQWEsT0FBYjtBQUNEO0FBQ0Y7O0FBRURFLFNBQU87QUFDTCxVQUFNSCxlQUFlLEtBQUtDLElBQTFCO0FBQ0EsV0FBT1IsV0FBV08sWUFBWCxFQUF5QixNQUF6QixFQUNKSSxLQURJLENBQ0UsTUFBTSxJQURSLEVBRUpDLElBRkksQ0FFQ0MsS0FBS0MsS0FGTixDQUFQO0FBR0Q7O0FBRURDLFFBQU1DLFNBQU4sRUFBaUI7QUFDZixVQUFNVCxlQUFlLEtBQUtDLElBQTFCO0FBQ0EsV0FBTyxLQUFLRSxJQUFMLEdBQ0pFLElBREksQ0FDQ0ssU0FBUztBQUNiLFdBQUssSUFBSUMsSUFBSSxDQUFiLEVBQWdCQSxJQUFJRixVQUFVRyxNQUE5QixFQUFzQ0QsR0FBdEMsRUFBMkM7QUFDekMsY0FBTUUsS0FBS0osVUFBVUUsQ0FBVixDQUFYO0FBQ0FELGNBQU1HLEdBQUdDLEdBQVQsSUFBZ0JELEdBQUdFLEtBQW5CO0FBQ0Q7QUFDRCxhQUFPTCxLQUFQO0FBQ0QsS0FQSSxFQVFKTCxJQVJJLENBUUNDLEtBQUtVLFNBUk4sRUFTSlgsSUFUSSxDQVNDSyxTQUFTZCxZQUFZSSxZQUFaLEVBQTBCVSxLQUExQixDQVRWLENBQVA7QUFVRDtBQTNCa0I7O0FBOEJyQk8sT0FBT0MsT0FBUCxHQUFpQnBCLGNBQWpCIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9TZXJpYWxpemVySnNvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcblxuY29uc3QgcHJvbWlzaWZ5ID0gcmVxdWlyZSgnLi91dGlsL3Byb21pc2lmeScpO1xuXG5jb25zdCBmc1JlYWRGaWxlID0gcHJvbWlzaWZ5KGZzLnJlYWRGaWxlLCB7IGNvbnRleHQ6IGZzIH0pO1xuY29uc3QgZnNXcml0ZUZpbGUgPSBwcm9taXNpZnkoZnMud3JpdGVGaWxlLCB7IGNvbnRleHQ6IGZzIH0pO1xuXG5jbGFzcyBKc29uU2VyaWFsaXplciB7XG4gIGNvbnN0cnVjdG9yKHsgY2FjaGVEaXJQYXRoIH0pIHtcbiAgICB0aGlzLnBhdGggPSBjYWNoZURpclBhdGg7XG4gICAgaWYgKCEvXFwuanNvbiQvLnRlc3QodGhpcy5wYXRoKSkge1xuICAgICAgdGhpcy5wYXRoICs9ICcuanNvbic7XG4gICAgfVxuICB9XG5cbiAgcmVhZCgpIHtcbiAgICBjb25zdCBjYWNoZURpclBhdGggPSB0aGlzLnBhdGg7XG4gICAgcmV0dXJuIGZzUmVhZEZpbGUoY2FjaGVEaXJQYXRoLCAndXRmOCcpXG4gICAgICAuY2F0Y2goKCkgPT4gJ3t9JylcbiAgICAgIC50aGVuKEpTT04ucGFyc2UpO1xuICB9XG5cbiAgd3JpdGUobW9kdWxlT3BzKSB7XG4gICAgY29uc3QgY2FjaGVEaXJQYXRoID0gdGhpcy5wYXRoO1xuICAgIHJldHVybiB0aGlzLnJlYWQoKVxuICAgICAgLnRoZW4oY2FjaGUgPT4ge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1vZHVsZU9wcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGNvbnN0IG9wID0gbW9kdWxlT3BzW2ldO1xuICAgICAgICAgIGNhY2hlW29wLmtleV0gPSBvcC52YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY2FjaGU7XG4gICAgICB9KVxuICAgICAgLnRoZW4oSlNPTi5zdHJpbmdpZnkpXG4gICAgICAudGhlbihjYWNoZSA9PiBmc1dyaXRlRmlsZShjYWNoZURpclBhdGgsIGNhY2hlKSk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBKc29uU2VyaWFsaXplcjtcbiJdLCJzb3VyY2VSb290IjoiL1VzZXJzL3R5bGVyYXJidXMvZGV2L3Byb3ZpZGVyL3NyYyJ9
