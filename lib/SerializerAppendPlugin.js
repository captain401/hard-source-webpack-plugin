'use strict';

const join = require('path').join;

const pluginCompat = require('./util/plugin-compat');

let AppendSerializer;

const _blockSizeByName = {
  data: 4 * 1024,
  md5: 128,
  'missing-resolve': 256,
  module: 4 * 1024,
  'module-resolve': 1024,
  resolver: 256
};

class SerializerAppendPlugin {
  apply(compiler) {
    pluginCompat.tap(compiler, 'hardSourceCacheFactory', 'AppendSerializer', factory => info => {
      if (info.type === 'data') {
        return SerializerAppendPlugin.createSerializer(info);
      }
      return factory(info);
    });
  }
}

SerializerAppendPlugin.createSerializer = ({
  cacheDirPath,
  name,
  autoParse
}) => {
  if (!AppendSerializer) {
    AppendSerializer = require('./SerializerAppend');
  }

  return new AppendSerializer({
    cacheDirPath: join(cacheDirPath, name),
    blockSize: _blockSizeByName[name],
    autoParse: autoParse
  });
};

module.exports = SerializerAppendPlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9TZXJpYWxpemVyQXBwZW5kUGx1Z2luLmpzIl0sIm5hbWVzIjpbImpvaW4iLCJyZXF1aXJlIiwicGx1Z2luQ29tcGF0IiwiQXBwZW5kU2VyaWFsaXplciIsIl9ibG9ja1NpemVCeU5hbWUiLCJkYXRhIiwibWQ1IiwibW9kdWxlIiwicmVzb2x2ZXIiLCJTZXJpYWxpemVyQXBwZW5kUGx1Z2luIiwiYXBwbHkiLCJjb21waWxlciIsInRhcCIsImZhY3RvcnkiLCJpbmZvIiwidHlwZSIsImNyZWF0ZVNlcmlhbGl6ZXIiLCJjYWNoZURpclBhdGgiLCJuYW1lIiwiYXV0b1BhcnNlIiwiYmxvY2tTaXplIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxPQUFPQyxRQUFRLE1BQVIsRUFBZ0JELElBQTdCOztBQUVBLE1BQU1FLGVBQWVELCtCQUFyQjs7QUFFQSxJQUFJRSxnQkFBSjs7QUFFQSxNQUFNQyxtQkFBbUI7QUFDdkJDLFFBQU0sSUFBSSxJQURhO0FBRXZCQyxPQUFLLEdBRmtCO0FBR3ZCLHFCQUFtQixHQUhJO0FBSXZCQyxVQUFRLElBQUksSUFKVztBQUt2QixvQkFBa0IsSUFMSztBQU12QkMsWUFBVTtBQU5hLENBQXpCOztBQVNBLE1BQU1DLHNCQUFOLENBQTZCO0FBQzNCQyxRQUFNQyxRQUFOLEVBQWdCO0FBQ2RULGlCQUFhVSxHQUFiLENBQ0VELFFBREYsRUFFRSx3QkFGRixFQUdFLGtCQUhGLEVBSUVFLFdBQVdDLFFBQVE7QUFDakIsVUFBSUEsS0FBS0MsSUFBTCxLQUFjLE1BQWxCLEVBQTBCO0FBQ3hCLGVBQU9OLHVCQUF1Qk8sZ0JBQXZCLENBQXdDRixJQUF4QyxDQUFQO0FBQ0Q7QUFDRCxhQUFPRCxRQUFRQyxJQUFSLENBQVA7QUFDRCxLQVRIO0FBV0Q7QUFiMEI7O0FBZ0I3QkwsdUJBQXVCTyxnQkFBdkIsR0FBMEMsQ0FBQztBQUN6Q0MsY0FEeUM7QUFFekNDLE1BRnlDO0FBR3pDQztBQUh5QyxDQUFELEtBSXBDO0FBQ0osTUFBSSxDQUFDaEIsZ0JBQUwsRUFBdUI7QUFDckJBLHVCQUFtQkYsNkJBQW5CO0FBQ0Q7O0FBRUQsU0FBTyxJQUFJRSxnQkFBSixDQUFxQjtBQUMxQmMsa0JBQWNqQixLQUFLaUIsWUFBTCxFQUFtQkMsSUFBbkIsQ0FEWTtBQUUxQkUsZUFBV2hCLGlCQUFpQmMsSUFBakIsQ0FGZTtBQUcxQkMsZUFBV0E7QUFIZSxHQUFyQixDQUFQO0FBS0QsQ0FkRDs7QUFnQkFaLE9BQU9jLE9BQVAsR0FBaUJaLHNCQUFqQiIsImZpbGUiOiJoYXJkLXNvdXJjZS13ZWJwYWNrLXBsdWdpbi9saWIvU2VyaWFsaXplckFwcGVuZFBsdWdpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGpvaW4gPSByZXF1aXJlKCdwYXRoJykuam9pbjtcblxuY29uc3QgcGx1Z2luQ29tcGF0ID0gcmVxdWlyZSgnLi91dGlsL3BsdWdpbi1jb21wYXQnKTtcblxubGV0IEFwcGVuZFNlcmlhbGl6ZXI7XG5cbmNvbnN0IF9ibG9ja1NpemVCeU5hbWUgPSB7XG4gIGRhdGE6IDQgKiAxMDI0LFxuICBtZDU6IDEyOCxcbiAgJ21pc3NpbmctcmVzb2x2ZSc6IDI1NixcbiAgbW9kdWxlOiA0ICogMTAyNCxcbiAgJ21vZHVsZS1yZXNvbHZlJzogMTAyNCxcbiAgcmVzb2x2ZXI6IDI1Nixcbn07XG5cbmNsYXNzIFNlcmlhbGl6ZXJBcHBlbmRQbHVnaW4ge1xuICBhcHBseShjb21waWxlcikge1xuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdoYXJkU291cmNlQ2FjaGVGYWN0b3J5JyxcbiAgICAgICdBcHBlbmRTZXJpYWxpemVyJyxcbiAgICAgIGZhY3RvcnkgPT4gaW5mbyA9PiB7XG4gICAgICAgIGlmIChpbmZvLnR5cGUgPT09ICdkYXRhJykge1xuICAgICAgICAgIHJldHVybiBTZXJpYWxpemVyQXBwZW5kUGx1Z2luLmNyZWF0ZVNlcmlhbGl6ZXIoaW5mbyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhY3RvcnkoaW5mbyk7XG4gICAgICB9LFxuICAgICk7XG4gIH1cbn1cblxuU2VyaWFsaXplckFwcGVuZFBsdWdpbi5jcmVhdGVTZXJpYWxpemVyID0gKHtcbiAgY2FjaGVEaXJQYXRoLFxuICBuYW1lLFxuICBhdXRvUGFyc2UsXG59KSA9PiB7XG4gIGlmICghQXBwZW5kU2VyaWFsaXplcikge1xuICAgIEFwcGVuZFNlcmlhbGl6ZXIgPSByZXF1aXJlKCcuL1NlcmlhbGl6ZXJBcHBlbmQnKTtcbiAgfVxuXG4gIHJldHVybiBuZXcgQXBwZW5kU2VyaWFsaXplcih7XG4gICAgY2FjaGVEaXJQYXRoOiBqb2luKGNhY2hlRGlyUGF0aCwgbmFtZSksXG4gICAgYmxvY2tTaXplOiBfYmxvY2tTaXplQnlOYW1lW25hbWVdLFxuICAgIGF1dG9QYXJzZTogYXV0b1BhcnNlLFxuICB9KTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gU2VyaWFsaXplckFwcGVuZFBsdWdpbjtcbiJdLCJzb3VyY2VSb290IjoiL1VzZXJzL3R5bGVyYXJidXMvZGV2L3Byb3ZpZGVyL3NyYyJ9
