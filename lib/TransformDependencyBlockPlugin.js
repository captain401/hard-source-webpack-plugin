'use strict';

const DependenciesBlockVariable = require('webpack/lib/DependenciesBlockVariable');

const pluginCompat = require('./util/plugin-compat');

const BlockSchemas3 = [['AMDRequireDependenciesBlock', 'expr', 'arrayRange', 'functionRange', 'errorCallbackRange', 'module', 'loc'], ['ImportDependenciesBlock', 'request', 'range', 'chunkName', 'module', 'loc'], ['RequireEnsureDependenciesBlock', 'expr', 'successExpression', 'errorExpression', 'chunkName', 'chunkNameRange', 'module', 'loc'], ['AsyncDependenciesBlock', 'name', 'module']];

const BlockSchemas4 = [['AMDRequireDependenciesBlock', 'expr', 'arrayRange', 'functionRange', 'errorCallbackRange', 'module', 'loc', 'request'], ['ImportDependenciesBlock', 'request', 'range', 'groupOptions', 'module', 'loc', 'originModule'], ['RequireEnsureDependenciesBlock', 'expr', 'successExpression', 'errorExpression', 'chunkName', 'chunkNameRange', 'module', 'loc'], ['AsyncDependenciesBlock', 'groupOptions', 'module', 'loc', 'request']];

try {
  BlockSchemas3[0].DependencyBlock = require('webpack/lib/dependencies/AMDRequireDependenciesBlock');
  BlockSchemas4[0].DependencyBlock = require('webpack/lib/dependencies/AMDRequireDependenciesBlock');
} catch (_) {}
try {
  BlockSchemas3[1].DependencyBlock = require('webpack/lib/dependencies/ImportDependenciesBlock');
  BlockSchemas4[1].DependencyBlock = require('webpack/lib/dependencies/ImportDependenciesBlock');
} catch (_) {}
try {
  BlockSchemas3[2].DependencyBlock = require('webpack/lib/dependencies/RequireEnsureDependenciesBlock');
  BlockSchemas4[2].DependencyBlock = require('webpack/lib/dependencies/RequireEnsureDependenciesBlock');
} catch (_) {}
try {
  BlockSchemas3[3].DependencyBlock = require('webpack/lib/AsyncDependenciesBlock');
  BlockSchemas4[3].DependencyBlock = require('webpack/lib/AsyncDependenciesBlock');
} catch (_) {}

const freezeArgument = {
  chunkName(arg, { chunkName }, extra, methods) {
    return chunkName;
  },
  name(arg, { name }, extra, methods) {
    return name;
  },
  groupOptions(arg, { groupOptions }) {
    return groupOptions;
  },
  module(arg, block, extra, methods) {},
  originModule(arg, block, extra, methods) {}
};

const thawArgument = {
  module(arg, frozen, extra, methods) {
    return extra.module;
  },
  originModule(arg, block, extra, methods) {
    return extra.module;
  }
};

function freezeDependencyBlock(dependencyBlock, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (dependencyBlock.constructor === schemas[i].DependencyBlock) {
      const frozen = {
        type: schemas[i][0]
      };
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = dependencyBlock[schemas[i][j]];
        if (freezeArgument[schemas[i][j]]) {
          arg = freezeArgument[schemas[i][j]](arg, dependencyBlock, extra, methods);
        }
        frozen[schemas[i][j]] = arg;
      }
      return frozen;
    }
  }
}

function thawDependencyBlock(frozen, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (frozen.type === schemas[i][0]) {
      const DependencyBlock = schemas[i].DependencyBlock;
      const args = [];
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = frozen[schemas[i][j]];
        if (thawArgument[schemas[i][j]]) {
          arg = thawArgument[schemas[i][j]](arg, frozen, extra, methods);
        }
        args.push(arg);
      }
      try {
        return new DependencyBlock(...args);
      } catch (_) {
        return new (Function.prototype.bind.apply(DependencyBlock, [null].concat(args)))();
      }
    }
  }
}

function assertFrozen({ length }, original, typeName, freeze) {
  if (length !== original.length) {
    const didNotFreeze = original.filter(item => !freeze(item));
    if (didNotFreeze.length > 0) {
      throw new Error(`Unfrozen ${typeName} (${didNotFreeze.length} / ${original.length}): ${didNotFreeze.map(({ constructor }) => constructor.name).filter((name, i, names) => !names.slice(0, i).includes(name)).join(', ')}`);
    }
  }
}

class TransformDependencyBlockPlugin {
  constructor(options) {
    this.options = options;
  }

  apply(compiler) {
    let schemas = BlockSchemas4;
    if (this.options.schema < 4) {
      schemas = BlockSchemas3;
    }

    let methods;

    pluginCompat.tap(compiler, '_hardSourceMethods', 'TransformDependencyBlockPlugin', _methods => {
      methods = _methods;
    });

    let freeze;
    let mapFreeze;
    let mapThaw;

    pluginCompat.tap(compiler, '_hardSourceMethods', 'TransformDependencyBlockPlugin', methods => {
      // store = methods.store;
      // fetch = methods.fetch;
      freeze = methods.freeze;
      // thaw = methods.thaw;
      mapFreeze = methods.mapFreeze;
      mapThaw = methods.mapThaw;
    });

    pluginCompat.tap(compiler, '_hardSourceFreezeDependencyVariable', 'TransformDependencyBlockPlugin', (frozen, { name, expression, dependencies }, extra) => ({
      type: 'DependenciesBlockVariable',
      name: name,
      expression: expression,
      dependencies: mapFreeze('Dependency', null, dependencies, extra)
    }));

    pluginCompat.tap(compiler, '_hardSourceFreezeDependencyBlock', 'TransformDependencyBlockPlugin', (frozen, block, extra) => {
      extra.schemas = schemas;
      const _frozen = freezeDependencyBlock(block, extra, methods);
      if (_frozen) {
        if (block.dependencies && block.dependencies.length > 0 || block.variables && block.variables.length > 0 || block.blocks && block.blocks.length > 0) {
          _frozen.dependencies = mapFreeze('Dependency', null, block.dependencies, extra);
          assertFrozen(_frozen.dependencies, block.dependencies, 'dependencies', item => freeze('Dependency', null, item, extra));
          _frozen.variables = mapFreeze('DependencyVariable', null, block.variables, extra);
          assertFrozen(_frozen.variables, block.variables, 'dependency variables', item => freeze('DependencyVariable', null, item, extra));
          _frozen.blocks = mapFreeze('DependencyBlock', null, block.blocks, extra);
          assertFrozen(_frozen.blocks, block.blocks, 'blocks', item => freeze('DependencyBlock', null, item, extra));
        }
        if (block.parent) {
          _frozen.parent = true;
        }
        return _frozen;
      }

      const _frozenBlock = {
        type: 'DependenciesBlock',
        dependencies: mapFreeze('Dependency', null, block.dependencies, extra),
        variables: mapFreeze('DependencyVariable', null, block.variables, extra),
        blocks: mapFreeze('DependencyBlock', null, block.blocks, extra)
      };

      assertFrozen(_frozenBlock.dependencies, block.dependencies, 'dependencies', item => freeze('Dependency', null, item, extra));
      assertFrozen(_frozenBlock.variables, block.variables, 'dependency variables', item => freeze('DependencyVariable', null, item, extra));
      assertFrozen(_frozenBlock.blocks, block.blocks, 'blocks', item => freeze('DependencyBlock', null, item, extra));

      return _frozenBlock;
    });

    pluginCompat.tap(compiler, '_hardSourceThawDependencyVariable', 'TransformDependencyBlockPlugin', (variable, { name, expression, dependencies }, extra) => new DependenciesBlockVariable(name, expression, mapThaw('Dependency', null, dependencies, extra)));

    pluginCompat.tap(compiler, '_hardSourceThawDependencyBlock', 'TransformDependencyBlockPlugin', (block, frozen, extra) => {
      extra.schemas = schemas;
      const _thawed = thawDependencyBlock(frozen, extra, methods);
      if (_thawed) {
        if (_thawed.dependencies) {
          var blockExtra = {
            state: extra.state,
            module: extra.module,
            parent: _thawed,
            compilation: extra.compilation
          };
          _thawed.dependencies = mapThaw('Dependency', null, frozen.dependencies, blockExtra);
          _thawed.variables = mapThaw('DependencyVariable', null, frozen.variables, blockExtra);
          mapThaw('DependencyBlock', null, frozen.blocks, blockExtra);
        }
        if (frozen.parent) {
          extra.parent.addBlock(_thawed);
        }
        return _thawed;
      }

      if (block) {
        var blockExtra = {
          state: extra.state,
          module: extra.module,
          parent: block,
          compilation: extra.compilation
        };
        block.dependencies = mapThaw('Dependency', null, frozen.dependencies, blockExtra);
        block.variables = mapThaw('DependencyVariable', null, frozen.variables, blockExtra);
        block.blocks = mapThaw('DependencyBlock', null, frozen.blocks, blockExtra);
      }

      return block;
    });
  }
}

module.exports = TransformDependencyBlockPlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9UcmFuc2Zvcm1EZXBlbmRlbmN5QmxvY2tQbHVnaW4uanMiXSwibmFtZXMiOlsiRGVwZW5kZW5jaWVzQmxvY2tWYXJpYWJsZSIsInJlcXVpcmUiLCJwbHVnaW5Db21wYXQiLCJCbG9ja1NjaGVtYXMzIiwiQmxvY2tTY2hlbWFzNCIsIkRlcGVuZGVuY3lCbG9jayIsIl8iLCJmcmVlemVBcmd1bWVudCIsImNodW5rTmFtZSIsImFyZyIsImV4dHJhIiwibWV0aG9kcyIsIm5hbWUiLCJncm91cE9wdGlvbnMiLCJtb2R1bGUiLCJibG9jayIsIm9yaWdpbk1vZHVsZSIsInRoYXdBcmd1bWVudCIsImZyb3plbiIsImZyZWV6ZURlcGVuZGVuY3lCbG9jayIsImRlcGVuZGVuY3lCbG9jayIsInNjaGVtYXMiLCJpIiwibGVuZ3RoIiwiY29uc3RydWN0b3IiLCJ0eXBlIiwiaiIsInRoYXdEZXBlbmRlbmN5QmxvY2siLCJhcmdzIiwicHVzaCIsIkZ1bmN0aW9uIiwicHJvdG90eXBlIiwiYmluZCIsImFwcGx5IiwiY29uY2F0IiwiYXNzZXJ0RnJvemVuIiwib3JpZ2luYWwiLCJ0eXBlTmFtZSIsImZyZWV6ZSIsImRpZE5vdEZyZWV6ZSIsImZpbHRlciIsIml0ZW0iLCJFcnJvciIsIm1hcCIsIm5hbWVzIiwic2xpY2UiLCJpbmNsdWRlcyIsImpvaW4iLCJUcmFuc2Zvcm1EZXBlbmRlbmN5QmxvY2tQbHVnaW4iLCJvcHRpb25zIiwiY29tcGlsZXIiLCJzY2hlbWEiLCJ0YXAiLCJfbWV0aG9kcyIsIm1hcEZyZWV6ZSIsIm1hcFRoYXciLCJleHByZXNzaW9uIiwiZGVwZW5kZW5jaWVzIiwiX2Zyb3plbiIsInZhcmlhYmxlcyIsImJsb2NrcyIsInBhcmVudCIsIl9mcm96ZW5CbG9jayIsInZhcmlhYmxlIiwiX3RoYXdlZCIsImJsb2NrRXh0cmEiLCJzdGF0ZSIsImNvbXBpbGF0aW9uIiwiYWRkQmxvY2siLCJleHBvcnRzIl0s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LEVBRWIsSUFGYSxFQUdickMsT0FBTzBDLE1BSE0sRUFJYkssVUFKYSxDQUFmO0FBTUQ7O0FBRUQsYUFBT2xELEtBQVA7QUFDRCxLQS9ESDtBQWlFRDtBQTNOa0M7O0FBOE5yQ0QsT0FBT3VELE9BQVAsR0FBaUJyQiw4QkFBakIiLCJmaWxlIjoiaGFyZC1zb3VyY2Utd2VicGFjay1wbHVnaW4vbGliL1RyYW5zZm9ybURlcGVuZGVuY3lCbG9ja1BsdWdpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IERlcGVuZGVuY2llc0Jsb2NrVmFyaWFibGUgPSByZXF1aXJlKCd3ZWJwYWNrL2xpYi9EZXBlbmRlbmNpZXNCbG9ja1ZhcmlhYmxlJyk7XG5cbmNvbnN0IHBsdWdpbkNvbXBhdCA9IHJlcXVpcmUoJy4vdXRpbC9wbHVnaW4tY29tcGF0Jyk7XG5cbmNvbnN0IEJsb2NrU2NoZW1hczMgPSBbXG4gIFtcbiAgICAnQU1EUmVxdWlyZURlcGVuZGVuY2llc0Jsb2NrJyxcbiAgICAnZXhwcicsXG4gICAgJ2FycmF5UmFuZ2UnLFxuICAgICdmdW5jdGlvblJhbmdlJyxcbiAgICAnZXJyb3JDYWxsYmFja1JhbmdlJyxcbiAgICAnbW9kdWxlJyxcbiAgICAnbG9jJyxcbiAgXSxcbiAgWydJbXBvcnREZXBlbmRlbmNpZXNCbG9jaycsICdyZXF1ZXN0JywgJ3JhbmdlJywgJ2NodW5rTmFtZScsICdtb2R1bGUnLCAnbG9jJ10sXG4gIFtcbiAgICAnUmVxdWlyZUVuc3VyZURlcGVuZGVuY2llc0Jsb2NrJyxcbiAgICAnZXhwcicsXG4gICAgJ3N1Y2Nlc3NFeHByZXNzaW9uJyxcbiAgICAnZXJyb3JFeHByZXNzaW9uJyxcbiAgICAnY2h1bmtOYW1lJyxcbiAgICAnY2h1bmtOYW1lUmFuZ2UnLFxuICAgICdtb2R1bGUnLFxuICAgICdsb2MnLFxuICBdLFxuICBbJ0FzeW5jRGVwZW5kZW5jaWVzQmxvY2snLCAnbmFtZScsICdtb2R1bGUnXSxcbl07XG5cbmNvbnN0IEJsb2NrU2NoZW1hczQgPSBbXG4gIFtcbiAgICAnQU1EUmVxdWlyZURlcGVuZGVuY2llc0Jsb2NrJyxcbiAgICAnZXhwcicsXG4gICAgJ2FycmF5UmFuZ2UnLFxuICAgICdmdW5jdGlvblJhbmdlJyxcbiAgICAnZXJyb3JDYWxsYmFja1JhbmdlJyxcbiAgICAnbW9kdWxlJyxcbiAgICAnbG9jJyxcbiAgICAncmVxdWVzdCcsXG4gIF0sXG4gIFtcbiAgICAnSW1wb3J0RGVwZW5kZW5jaWVzQmxvY2snLFxuICAgICdyZXF1ZXN0JyxcbiAgICAncmFuZ2UnLFxuICAgICdncm91cE9wdGlvbnMnLFxuICAgICdtb2R1bGUnLFxuICAgICdsb2MnLFxuICAgICdvcmlnaW5Nb2R1bGUnLFxuICBdLFxuICBbXG4gICAgJ1JlcXVpcmVFbnN1cmVEZXBlbmRlbmNpZXNCbG9jaycsXG4gICAgJ2V4cHInLFxuICAgICdzdWNjZXNzRXhwcmVzc2lvbicsXG4gICAgJ2Vycm9yRXhwcmVzc2lvbicsXG4gICAgJ2NodW5rTmFtZScsXG4gICAgJ2NodW5rTmFtZVJhbmdlJyxcbiAgICAnbW9kdWxlJyxcbiAgICAnbG9jJyxcbiAgXSxcbiAgWydBc3luY0RlcGVuZGVuY2llc0Jsb2NrJywgJ2dyb3VwT3B0aW9ucycsICdtb2R1bGUnLCAnbG9jJywgJ3JlcXVlc3QnXSxcbl07XG5cbnRyeSB7XG4gIEJsb2NrU2NoZW1hczNbMF0uRGVwZW5kZW5jeUJsb2NrID0gcmVxdWlyZSgnd2VicGFjay9saWIvZGVwZW5kZW5jaWVzL0FNRFJlcXVpcmVEZXBlbmRlbmNpZXNCbG9jaycpO1xuICBCbG9ja1NjaGVtYXM0WzBdLkRlcGVuZGVuY3lCbG9jayA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL2RlcGVuZGVuY2llcy9BTURSZXF1aXJlRGVwZW5kZW5jaWVzQmxvY2snKTtcbn0gY2F0Y2ggKF8pIHt9XG50cnkge1xuICBCbG9ja1NjaGVtYXMzWzFdLkRlcGVuZGVuY3lCbG9jayA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL2RlcGVuZGVuY2llcy9JbXBvcnREZXBlbmRlbmNpZXNCbG9jaycpO1xuICBCbG9ja1NjaGVtYXM0WzFdLkRlcGVuZGVuY3lCbG9jayA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL2RlcGVuZGVuY2llcy9JbXBvcnREZXBlbmRlbmNpZXNCbG9jaycpO1xufSBjYXRjaCAoXykge31cbnRyeSB7XG4gIEJsb2NrU2NoZW1hczNbMl0uRGVwZW5kZW5jeUJsb2NrID0gcmVxdWlyZSgnd2VicGFjay9saWIvZGVwZW5kZW5jaWVzL1JlcXVpcmVFbnN1cmVEZXBlbmRlbmNpZXNCbG9jaycpO1xuICBCbG9ja1NjaGVtYXM0WzJdLkRlcGVuZGVuY3lCbG9jayA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL2RlcGVuZGVuY2llcy9SZXF1aXJlRW5zdXJlRGVwZW5kZW5jaWVzQmxvY2snKTtcbn0gY2F0Y2ggKF8pIHt9XG50cnkge1xuICBCbG9ja1NjaGVtYXMzWzNdLkRlcGVuZGVuY3lCbG9jayA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL0FzeW5jRGVwZW5kZW5jaWVzQmxvY2snKTtcbiAgQmxvY2tTY2hlbWFzNFszXS5EZXBlbmRlbmN5QmxvY2sgPSByZXF1aXJlKCd3ZWJwYWNrL2xpYi9Bc3luY0RlcGVuZGVuY2llc0Jsb2NrJyk7XG59IGNhdGNoIChfKSB7fVxuXG5jb25zdCBmcmVlemVBcmd1bWVudCA9IHtcbiAgY2h1bmtOYW1lKGFyZywgeyBjaHVua05hbWUgfSwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgICByZXR1cm4gY2h1bmtOYW1lO1xuICB9LFxuICBuYW1lKGFyZywgeyBuYW1lIH0sIGV4dHJhLCBtZXRob2RzKSB7XG4gICAgcmV0dXJuIG5hbWU7XG4gIH0sXG4gIGdyb3VwT3B0aW9ucyhhcmcsIHsgZ3JvdXBPcHRpb25zIH0pIHtcbiAgICByZXR1cm4gZ3JvdXBPcHRpb25zO1xuICB9LFxuICBtb2R1bGUoYXJnLCBibG9jaywgZXh0cmEsIG1ldGhvZHMpIHt9LFxuICBvcmlnaW5Nb2R1bGUoYXJnLCBibG9jaywgZXh0cmEsIG1ldGhvZHMpIHt9LFxufTtcblxuY29uc3QgdGhhd0FyZ3VtZW50ID0ge1xuICBtb2R1bGUoYXJnLCBmcm96ZW4sIGV4dHJhLCBtZXRob2RzKSB7XG4gICAgcmV0dXJuIGV4dHJhLm1vZHVsZTtcbiAgfSxcbiAgb3JpZ2luTW9kdWxlKGFyZywgYmxvY2ssIGV4dHJhLCBtZXRob2RzKSB7XG4gICAgcmV0dXJuIGV4dHJhLm1vZHVsZTtcbiAgfSxcbn07XG5cbmZ1bmN0aW9uIGZyZWV6ZURlcGVuZGVuY3lCbG9jayhkZXBlbmRlbmN5QmxvY2ssIGV4dHJhLCBtZXRob2RzKSB7XG4gIGNvbnN0IHNjaGVtYXMgPSBleHRyYS5zY2hlbWFzO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHNjaGVtYXMubGVuZ3RoOyBpKyspIHtcbiAgICBpZiAoZGVwZW5kZW5jeUJsb2NrLmNvbnN0cnVjdG9yID09PSBzY2hlbWFzW2ldLkRlcGVuZGVuY3lCbG9jaykge1xuICAgICAgY29uc3QgZnJvemVuID0ge1xuICAgICAgICB0eXBlOiBzY2hlbWFzW2ldWzBdLFxuICAgICAgfTtcbiAgICAgIGZvciAobGV0IGogPSAxOyBqIDwgc2NoZW1hc1tpXS5sZW5ndGg7IGorKykge1xuICAgICAgICBsZXQgYXJnID0gZGVwZW5kZW5jeUJsb2NrW3NjaGVtYXNbaV1bal1dO1xuICAgICAgICBpZiAoZnJlZXplQXJndW1lbnRbc2NoZW1hc1tpXVtqXV0pIHtcbiAgICAgICAgICBhcmcgPSBmcmVlemVBcmd1bWVudFtzY2hlbWFzW2ldW2pdXShcbiAgICAgICAgICAgIGFyZyxcbiAgICAgICAgICAgIGRlcGVuZGVuY3lCbG9jayxcbiAgICAgICAgICAgIGV4dHJhLFxuICAgICAgICAgICAgbWV0aG9kcyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGZyb3plbltzY2hlbWFzW2ldW2pdXSA9IGFyZztcbiAgICAgIH1cbiAgICAgIHJldHVybiBmcm96ZW47XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHRoYXdEZXBlbmRlbmN5QmxvY2soZnJvemVuLCBleHRyYSwgbWV0aG9kcykge1xuICBjb25zdCBzY2hlbWFzID0gZXh0cmEuc2NoZW1hcztcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzY2hlbWFzLmxlbmd0aDsgaSsrKSB7XG4gICAgaWYgKGZyb3plbi50eXBlID09PSBzY2hlbWFzW2ldWzBdKSB7XG4gICAgICBjb25zdCBEZXBlbmRlbmN5QmxvY2sgPSBzY2hlbWFzW2ldLkRlcGVuZGVuY3lCbG9jaztcbiAgICAgIGNvbnN0IGFyZ3MgPSBbXTtcbiAgICAgIGZvciAobGV0IGogPSAxOyBqIDwgc2NoZW1hc1tpXS5sZW5ndGg7IGorKykge1xuICAgICAgICBsZXQgYXJnID0gZnJvemVuW3NjaGVtYXNbaV1bal1dO1xuICAgICAgICBpZiAodGhhd0FyZ3VtZW50W3NjaGVtYXNbaV1bal1dKSB7XG4gICAgICAgICAgYXJnID0gdGhhd0FyZ3VtZW50W3NjaGVtYXNbaV1bal1dKGFyZywgZnJvemVuLCBleHRyYSwgbWV0aG9kcyk7XG4gICAgICAgIH1cbiAgICAgICAgYXJncy5wdXNoKGFyZyk7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gbmV3IERlcGVuZGVuY3lCbG9jayguLi5hcmdzKTtcbiAgICAgIH0gY2F0Y2ggKF8pIHtcbiAgICAgICAgcmV0dXJuIG5ldyAoRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQuYXBwbHkoXG4gICAgICAgICAgRGVwZW5kZW5jeUJsb2NrLFxuICAgICAgICAgIFtudWxsXS5jb25jYXQoYXJncyksXG4gICAgICAgICkpKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGFzc2VydEZyb3plbih7IGxlbmd0aCB9LCBvcmlnaW5hbCwgdHlwZU5hbWUsIGZyZWV6ZSkge1xuICBpZiAobGVuZ3RoICE9PSBvcmlnaW5hbC5sZW5ndGgpIHtcbiAgICBjb25zdCBkaWROb3RGcmVlemUgPSBvcmlnaW5hbC5maWx0ZXIoaXRlbSA9PiAhZnJlZXplKGl0ZW0pKTtcbiAgICBpZiAoZGlkTm90RnJlZXplLmxlbmd0aCA+IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFVuZnJvemVuICR7dHlwZU5hbWV9ICgke2RpZE5vdEZyZWV6ZS5sZW5ndGh9IC8gJHtcbiAgICAgICAgICBvcmlnaW5hbC5sZW5ndGhcbiAgICAgICAgfSk6ICR7ZGlkTm90RnJlZXplXG4gICAgICAgICAgLm1hcCgoeyBjb25zdHJ1Y3RvciB9KSA9PiBjb25zdHJ1Y3Rvci5uYW1lKVxuICAgICAgICAgIC5maWx0ZXIoKG5hbWUsIGksIG5hbWVzKSA9PiAhbmFtZXMuc2xpY2UoMCwgaSkuaW5jbHVkZXMobmFtZSkpXG4gICAgICAgICAgLmpvaW4oJywgJyl9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIFRyYW5zZm9ybURlcGVuZGVuY3lCbG9ja1BsdWdpbiB7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHtcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG5cbiAgYXBwbHkoY29tcGlsZXIpIHtcbiAgICBsZXQgc2NoZW1hcyA9IEJsb2NrU2NoZW1hczQ7XG4gICAgaWYgKHRoaXMub3B0aW9ucy5zY2hlbWEgPCA0KSB7XG4gICAgICBzY2hlbWFzID0gQmxvY2tTY2hlbWFzMztcbiAgICB9XG5cbiAgICBsZXQgbWV0aG9kcztcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZU1ldGhvZHMnLFxuICAgICAgJ1RyYW5zZm9ybURlcGVuZGVuY3lCbG9ja1BsdWdpbicsXG4gICAgICBfbWV0aG9kcyA9PiB7XG4gICAgICAgIG1ldGhvZHMgPSBfbWV0aG9kcztcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGxldCBmcmVlemU7XG4gICAgbGV0IG1hcEZyZWV6ZTtcbiAgICBsZXQgbWFwVGhhdztcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZU1ldGhvZHMnLFxuICAgICAgJ1RyYW5zZm9ybURlcGVuZGVuY3lCbG9ja1BsdWdpbicsXG4gICAgICBtZXRob2RzID0+IHtcbiAgICAgICAgLy8gc3RvcmUgPSBtZXRob2RzLnN0b3JlO1xuICAgICAgICAvLyBmZXRjaCA9IG1ldGhvZHMuZmV0Y2g7XG4gICAgICAgIGZyZWV6ZSA9IG1ldGhvZHMuZnJlZXplO1xuICAgICAgICAvLyB0aGF3ID0gbWV0aG9kcy50aGF3O1xuICAgICAgICBtYXBGcmVlemUgPSBtZXRob2RzLm1hcEZyZWV6ZTtcbiAgICAgICAgbWFwVGhhdyA9IG1ldGhvZHMubWFwVGhhdztcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZUZyZWV6ZURlcGVuZGVuY3lWYXJpYWJsZScsXG4gICAgICAnVHJhbnNmb3JtRGVwZW5kZW5jeUJsb2NrUGx1Z2luJyxcbiAgICAgIChmcm96ZW4sIHsgbmFtZSwgZXhwcmVzc2lvbiwgZGVwZW5kZW5jaWVzIH0sIGV4dHJhKSA9PiAoe1xuICAgICAgICB0eXBlOiAnRGVwZW5kZW5jaWVzQmxvY2tWYXJpYWJsZScsXG4gICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgIGV4cHJlc3Npb246IGV4cHJlc3Npb24sXG4gICAgICAgIGRlcGVuZGVuY2llczogbWFwRnJlZXplKCdEZXBlbmRlbmN5JywgbnVsbCwgZGVwZW5kZW5jaWVzLCBleHRyYSksXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgcGx1Z2luQ29tcGF0LnRhcChcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlRnJlZXplRGVwZW5kZW5jeUJsb2NrJyxcbiAgICAgICdUcmFuc2Zvcm1EZXBlbmRlbmN5QmxvY2tQbHVnaW4nLFxuICAgICAgKGZyb3plbiwgYmxvY2ssIGV4dHJhKSA9PiB7XG4gICAgICAgIGV4dHJhLnNjaGVtYXMgPSBzY2hlbWFzO1xuICAgICAgICBjb25zdCBfZnJvemVuID0gZnJlZXplRGVwZW5kZW5jeUJsb2NrKGJsb2NrLCBleHRyYSwgbWV0aG9kcyk7XG4gICAgICAgIGlmIChfZnJvemVuKSB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgKGJsb2NrLmRlcGVuZGVuY2llcyAmJiBibG9jay5kZXBlbmRlbmNpZXMubGVuZ3RoID4gMCkgfHxcbiAgICAgICAgICAgIChibG9jay52YXJpYWJsZXMgJiYgYmxvY2sudmFyaWFibGVzLmxlbmd0aCA+IDApIHx8XG4gICAgICAgICAgICAoYmxvY2suYmxvY2tzICYmIGJsb2NrLmJsb2Nrcy5sZW5ndGggPiAwKVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgX2Zyb3plbi5kZXBlbmRlbmNpZXMgPSBtYXBGcmVlemUoXG4gICAgICAgICAgICAgICdEZXBlbmRlbmN5JyxcbiAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgYmxvY2suZGVwZW5kZW5jaWVzLFxuICAgICAgICAgICAgICBleHRyYSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBhc3NlcnRGcm96ZW4oXG4gICAgICAgICAgICAgIF9mcm96ZW4uZGVwZW5kZW5jaWVzLFxuICAgICAgICAgICAgICBibG9jay5kZXBlbmRlbmNpZXMsXG4gICAgICAgICAgICAgICdkZXBlbmRlbmNpZXMnLFxuICAgICAgICAgICAgICBpdGVtID0+IGZyZWV6ZSgnRGVwZW5kZW5jeScsIG51bGwsIGl0ZW0sIGV4dHJhKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBfZnJvemVuLnZhcmlhYmxlcyA9IG1hcEZyZWV6ZShcbiAgICAgICAgICAgICAgJ0RlcGVuZGVuY3lWYXJpYWJsZScsXG4gICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgIGJsb2NrLnZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgZXh0cmEsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgYXNzZXJ0RnJvemVuKFxuICAgICAgICAgICAgICBfZnJvemVuLnZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgYmxvY2sudmFyaWFibGVzLFxuICAgICAgICAgICAgICAnZGVwZW5kZW5jeSB2YXJpYWJsZXMnLFxuICAgICAgICAgICAgICBpdGVtID0+IGZyZWV6ZSgnRGVwZW5kZW5jeVZhcmlhYmxlJywgbnVsbCwgaXRlbSwgZXh0cmEpLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIF9mcm96ZW4uYmxvY2tzID0gbWFwRnJlZXplKFxuICAgICAgICAgICAgICAnRGVwZW5kZW5jeUJsb2NrJyxcbiAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgYmxvY2suYmxvY2tzLFxuICAgICAgICAgICAgICBleHRyYSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBhc3NlcnRGcm96ZW4oX2Zyb3plbi5ibG9ja3MsIGJsb2NrLmJsb2NrcywgJ2Jsb2NrcycsIGl0ZW0gPT5cbiAgICAgICAgICAgICAgZnJlZXplKCdEZXBlbmRlbmN5QmxvY2snLCBudWxsLCBpdGVtLCBleHRyYSksXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoYmxvY2sucGFyZW50KSB7XG4gICAgICAgICAgICBfZnJvemVuLnBhcmVudCA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBfZnJvemVuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgX2Zyb3plbkJsb2NrID0ge1xuICAgICAgICAgIHR5cGU6ICdEZXBlbmRlbmNpZXNCbG9jaycsXG4gICAgICAgICAgZGVwZW5kZW5jaWVzOiBtYXBGcmVlemUoXG4gICAgICAgICAgICAnRGVwZW5kZW5jeScsXG4gICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgYmxvY2suZGVwZW5kZW5jaWVzLFxuICAgICAgICAgICAgZXh0cmEsXG4gICAgICAgICAgKSxcbiAgICAgICAgICB2YXJpYWJsZXM6IG1hcEZyZWV6ZShcbiAgICAgICAgICAgICdEZXBlbmRlbmN5VmFyaWFibGUnLFxuICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIGJsb2NrLnZhcmlhYmxlcyxcbiAgICAgICAgICAgIGV4dHJhLFxuICAgICAgICAgICksXG4gICAgICAgICAgYmxvY2tzOiBtYXBGcmVlemUoJ0RlcGVuZGVuY3lCbG9jaycsIG51bGwsIGJsb2NrLmJsb2NrcywgZXh0cmEpLFxuICAgICAgICB9O1xuXG4gICAgICAgIGFzc2VydEZyb3plbihcbiAgICAgICAgICBfZnJvemVuQmxvY2suZGVwZW5kZW5jaWVzLFxuICAgICAgICAgIGJsb2NrLmRlcGVuZGVuY2llcyxcbiAgICAgICAgICAnZGVwZW5kZW5jaWVzJyxcbiAgICAgICAgICBpdGVtID0+IGZyZWV6ZSgnRGVwZW5kZW5jeScsIG51bGwsIGl0ZW0sIGV4dHJhKSxcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0RnJvemVuKFxuICAgICAgICAgIF9mcm96ZW5CbG9jay52YXJpYWJsZXMsXG4gICAgICAgICAgYmxvY2sudmFyaWFibGVzLFxuICAgICAgICAgICdkZXBlbmRlbmN5IHZhcmlhYmxlcycsXG4gICAgICAgICAgaXRlbSA9PiBmcmVlemUoJ0RlcGVuZGVuY3lWYXJpYWJsZScsIG51bGwsIGl0ZW0sIGV4dHJhKSxcbiAgICAgICAgKTtcbiAgICAgICAgYXNzZXJ0RnJvemVuKF9mcm96ZW5CbG9jay5ibG9ja3MsIGJsb2NrLmJsb2NrcywgJ2Jsb2NrcycsIGl0ZW0gPT5cbiAgICAgICAgICBmcmVlemUoJ0RlcGVuZGVuY3lCbG9jaycsIG51bGwsIGl0ZW0sIGV4dHJhKSxcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gX2Zyb3plbkJsb2NrO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgcGx1Z2luQ29tcGF0LnRhcChcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlVGhhd0RlcGVuZGVuY3lWYXJpYWJsZScsXG4gICAgICAnVHJhbnNmb3JtRGVwZW5kZW5jeUJsb2NrUGx1Z2luJyxcbiAgICAgICh2YXJpYWJsZSwgeyBuYW1lLCBleHByZXNzaW9uLCBkZXBlbmRlbmNpZXMgfSwgZXh0cmEpID0+XG4gICAgICAgIG5ldyBEZXBlbmRlbmNpZXNCbG9ja1ZhcmlhYmxlKFxuICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgZXhwcmVzc2lvbixcbiAgICAgICAgICBtYXBUaGF3KCdEZXBlbmRlbmN5JywgbnVsbCwgZGVwZW5kZW5jaWVzLCBleHRyYSksXG4gICAgICAgICksXG4gICAgKTtcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZVRoYXdEZXBlbmRlbmN5QmxvY2snLFxuICAgICAgJ1RyYW5zZm9ybURlcGVuZGVuY3lCbG9ja1BsdWdpbicsXG4gICAgICAoYmxvY2ssIGZyb3plbiwgZXh0cmEpID0+IHtcbiAgICAgICAgZXh0cmEuc2NoZW1hcyA9IHNjaGVtYXM7XG4gICAgICAgIGNvbnN0IF90aGF3ZWQgPSB0aGF3RGVwZW5kZW5jeUJsb2NrKGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpO1xuICAgICAgICBpZiAoX3RoYXdlZCkge1xuICAgICAgICAgIGlmIChfdGhhd2VkLmRlcGVuZGVuY2llcykge1xuICAgICAgICAgICAgdmFyIGJsb2NrRXh0cmEgPSB7XG4gICAgICAgICAgICAgIHN0YXRlOiBleHRyYS5zdGF0ZSxcbiAgICAgICAgICAgICAgbW9kdWxlOiBleHRyYS5tb2R1bGUsXG4gICAgICAgICAgICAgIHBhcmVudDogX3RoYXdlZCxcbiAgICAgICAgICAgICAgY29tcGlsYXRpb246IGV4dHJhLmNvbXBpbGF0aW9uLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIF90aGF3ZWQuZGVwZW5kZW5jaWVzID0gbWFwVGhhdyhcbiAgICAgICAgICAgICAgJ0RlcGVuZGVuY3knLFxuICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICBmcm96ZW4uZGVwZW5kZW5jaWVzLFxuICAgICAgICAgICAgICBibG9ja0V4dHJhLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIF90aGF3ZWQudmFyaWFibGVzID0gbWFwVGhhdyhcbiAgICAgICAgICAgICAgJ0RlcGVuZGVuY3lWYXJpYWJsZScsXG4gICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgIGZyb3plbi52YXJpYWJsZXMsXG4gICAgICAgICAgICAgIGJsb2NrRXh0cmEsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgbWFwVGhhdygnRGVwZW5kZW5jeUJsb2NrJywgbnVsbCwgZnJvemVuLmJsb2NrcywgYmxvY2tFeHRyYSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChmcm96ZW4ucGFyZW50KSB7XG4gICAgICAgICAgICBleHRyYS5wYXJlbnQuYWRkQmxvY2soX3RoYXdlZCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBfdGhhd2VkO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGJsb2NrKSB7XG4gICAgICAgICAgdmFyIGJsb2NrRXh0cmEgPSB7XG4gICAgICAgICAgICBzdGF0ZTogZXh0cmEuc3RhdGUsXG4gICAgICAgICAgICBtb2R1bGU6IGV4dHJhLm1vZHVsZSxcbiAgICAgICAgICAgIHBhcmVudDogYmxvY2ssXG4gICAgICAgICAgICBjb21waWxhdGlvbjogZXh0cmEuY29tcGlsYXRpb24sXG4gICAgICAgICAgfTtcbiAgICAgICAgICBibG9jay5kZXBlbmRlbmNpZXMgPSBtYXBUaGF3KFxuICAgICAgICAgICAgJ0RlcGVuZGVuY3knLFxuICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIGZyb3plbi5kZXBlbmRlbmNpZXMsXG4gICAgICAgICAgICBibG9ja0V4dHJhLFxuICAgICAgICAgICk7XG4gICAgICAgICAgYmxvY2sudmFyaWFibGVzID0gbWFwVGhhdyhcbiAgICAgICAgICAgICdEZXBlbmRlbmN5VmFyaWFibGUnLFxuICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIGZyb3plbi52YXJpYWJsZXMsXG4gICAgICAgICAgICBibG9ja0V4dHJhLFxuICAgICAgICAgICk7XG4gICAgICAgICAgYmxvY2suYmxvY2tzID0gbWFwVGhhdyhcbiAgICAgICAgICAgICdEZXBlbmRlbmN5QmxvY2snLFxuICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIGZyb3plbi5ibG9ja3MsXG4gICAgICAgICAgICBibG9ja0V4dHJhLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYmxvY2s7XG4gICAgICB9LFxuICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBUcmFuc2Zvcm1EZXBlbmRlbmN5QmxvY2tQbHVnaW47XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
