'use strict';

const pluginCompat = require('./util/plugin-compat');
const logMessages = require('./util/log-messages');
const { ParityRoot } = require('./util/parity');

class ParitySystem {
  apply(compiler) {
    pluginCompat.register(compiler, '_hardSourceParityCache', 'sync', ['parityRoot']);

    const compilerHooks = pluginCompat.hooks(compiler);

    function runParityOrReset(_compiler) {
      const parityRoot = new ParityRoot();
      compilerHooks._hardSourceParityCache.call(parityRoot);
      if (!parityRoot.verify()) {
        logMessages.cacheNoParity(compiler, { parityRoot });

        // Reset the cache, some part of it is incomplete and using it will lead
        // to errors.
        compilerHooks._hardSourceResetCache.call();
      }

      return Promise.resolve();
    }

    compilerHooks.watchRun.tapPromise('HardSource - index - parityOrReset', runParityOrReset);
    compilerHooks.run.tapPromise('HardSource - index - parityOrReset', runParityOrReset);
  }
}

module.exports = ParitySystem;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9TeXN0ZW1QYXJpdHkuanMiXSwibmFtZXMiOlsicGx1Z2luQ29tcGF0IiwicmVxdWlyZSIsImxvZ01lc3NhZ2VzIiwiUGFyaXR5Um9vdCIsIlBhcml0eVN5c3RlbSIsImFwcGx5IiwiY29tcGlsZXIiLCJyZWdpc3RlciIsImNvbXBpbGVySG9va3MiLCJob29rcyIsInJ1blBhcml0eU9yUmVzZXQiLCJfY29tcGlsZXIiLCJwYXJpdHlSb290IiwiX2hhcmRTb3VyY2VQYXJpdHlDYWNoZSIsImNhbGwiLCJ2ZXJpZnkiLCJjYWNoZU5vUGFyaXR5IiwiX2hhcmRTb3VyY2VSZXNldENhY2hlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJ3YXRjaFJ1biIsInRhcFByb21pc2UiLCJydW4iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLGVBQWVDLCtCQUFyQjtBQUNBLE1BQU1DLGNBQWNELDhCQUFwQjtBQUNBLE1BQU0sRUFBRUUsVUFBRixLQUFpQkYsd0JBQXZCOztBQUVBLE1BQU1HLFlBQU4sQ0FBbUI7QUFDakJDLFFBQU1DLFFBQU4sRUFBZ0I7QUFDZE4saUJBQWFPLFFBQWIsQ0FBc0JELFFBQXRCLEVBQWdDLHdCQUFoQyxFQUEwRCxNQUExRCxFQUFrRSxDQUNoRSxZQURnRSxDQUFsRTs7QUFJQSxVQUFNRSxnQkFBZ0JSLGFBQWFTLEtBQWIsQ0FBbUJILFFBQW5CLENBQXRCOztBQUVBLGFBQVNJLGdCQUFULENBQTBCQyxTQUExQixFQUFxQztBQUNuQyxZQUFNQyxhQUFhLElBQUlULFVBQUosRUFBbkI7QUFDQUssb0JBQWNLLHNCQUFkLENBQXFDQyxJQUFyQyxDQUEwQ0YsVUFBMUM7QUFDQSxVQUFJLENBQUNBLFdBQVdHLE1BQVgsRUFBTCxFQUEwQjtBQUN4QmIsb0JBQVljLGFBQVosQ0FBMEJWLFFBQTFCLEVBQW9DLEVBQUVNLFVBQUYsRUFBcEM7O0FBRUE7QUFDQTtBQUNBSixzQkFBY1MscUJBQWQsQ0FBb0NILElBQXBDO0FBQ0Q7O0FBRUQsYUFBT0ksUUFBUUMsT0FBUixFQUFQO0FBQ0Q7O0FBRURYLGtCQUFjWSxRQUFkLENBQXVCQyxVQUF2QixDQUNFLG9DQURGLEVBRUVYLGdCQUZGO0FBSUFGLGtCQUFjYyxHQUFkLENBQWtCRCxVQUFsQixDQUNFLG9DQURGLEVBRUVYLGdCQUZGO0FBSUQ7QUE5QmdCOztBQWlDbkJhLE9BQU9DLE9BQVAsR0FBaUJwQixZQUFqQiIsImZpbGUiOiJoYXJkLXNvdXJjZS13ZWJwYWNrLXBsdWdpbi9saWIvU3lzdGVtUGFyaXR5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcGx1Z2luQ29tcGF0ID0gcmVxdWlyZSgnLi91dGlsL3BsdWdpbi1jb21wYXQnKTtcbmNvbnN0IGxvZ01lc3NhZ2VzID0gcmVxdWlyZSgnLi91dGlsL2xvZy1tZXNzYWdlcycpO1xuY29uc3QgeyBQYXJpdHlSb290IH0gPSByZXF1aXJlKCcuL3V0aWwvcGFyaXR5Jyk7XG5cbmNsYXNzIFBhcml0eVN5c3RlbSB7XG4gIGFwcGx5KGNvbXBpbGVyKSB7XG4gICAgcGx1Z2luQ29tcGF0LnJlZ2lzdGVyKGNvbXBpbGVyLCAnX2hhcmRTb3VyY2VQYXJpdHlDYWNoZScsICdzeW5jJywgW1xuICAgICAgJ3Bhcml0eVJvb3QnLFxuICAgIF0pO1xuXG4gICAgY29uc3QgY29tcGlsZXJIb29rcyA9IHBsdWdpbkNvbXBhdC5ob29rcyhjb21waWxlcik7XG5cbiAgICBmdW5jdGlvbiBydW5QYXJpdHlPclJlc2V0KF9jb21waWxlcikge1xuICAgICAgY29uc3QgcGFyaXR5Um9vdCA9IG5ldyBQYXJpdHlSb290KCk7XG4gICAgICBjb21waWxlckhvb2tzLl9oYXJkU291cmNlUGFyaXR5Q2FjaGUuY2FsbChwYXJpdHlSb290KTtcbiAgICAgIGlmICghcGFyaXR5Um9vdC52ZXJpZnkoKSkge1xuICAgICAgICBsb2dNZXNzYWdlcy5jYWNoZU5vUGFyaXR5KGNvbXBpbGVyLCB7IHBhcml0eVJvb3QgfSk7XG5cbiAgICAgICAgLy8gUmVzZXQgdGhlIGNhY2hlLCBzb21lIHBhcnQgb2YgaXQgaXMgaW5jb21wbGV0ZSBhbmQgdXNpbmcgaXQgd2lsbCBsZWFkXG4gICAgICAgIC8vIHRvIGVycm9ycy5cbiAgICAgICAgY29tcGlsZXJIb29rcy5faGFyZFNvdXJjZVJlc2V0Q2FjaGUuY2FsbCgpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgY29tcGlsZXJIb29rcy53YXRjaFJ1bi50YXBQcm9taXNlKFxuICAgICAgJ0hhcmRTb3VyY2UgLSBpbmRleCAtIHBhcml0eU9yUmVzZXQnLFxuICAgICAgcnVuUGFyaXR5T3JSZXNldCxcbiAgICApO1xuICAgIGNvbXBpbGVySG9va3MucnVuLnRhcFByb21pc2UoXG4gICAgICAnSGFyZFNvdXJjZSAtIGluZGV4IC0gcGFyaXR5T3JSZXNldCcsXG4gICAgICBydW5QYXJpdHlPclJlc2V0LFxuICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBQYXJpdHlTeXN0ZW07XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
