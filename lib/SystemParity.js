'use strict';

require('source-map-support/register');

const pluginCompat = require('./util/plugin-compat');
const logMessages = require('./util/log-messages');
const { ParityRoot } = require('./util/parity');

class ParitySystem {
  apply(compiler) {
    pluginCompat.register(compiler, '_hardSourceParityCache', 'sync', ['parityRoot']);

    const compilerHooks = pluginCompat.hooks(compiler);

    function runParityOrReset(_compiler) {
      const parityRoot = new ParityRoot();
      compilerHooks._hardSourceParityCache.call(parityRoot);
      if (!parityRoot.verify()) {
        logMessages.cacheNoParity(compiler, { parityRoot });

        // Reset the cache, some part of it is incomplete and using it will lead
        // to errors.
        compilerHooks._hardSourceResetCache.call();
      }

      return Promise.resolve();
    }

    compilerHooks.watchRun.tapPromise('HardSource - index - parityOrReset', runParityOrReset);
    compilerHooks.run.tapPromise('HardSource - index - parityOrReset', runParityOrReset);
  }
}

module.exports = ParitySystem;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9TeXN0ZW1QYXJpdHkuanMiXSwibmFtZXMiOlsicGx1Z2luQ29tcGF0IiwicmVxdWlyZSIsImxvZ01lc3NhZ2VzIiwiUGFyaXR5Um9vdCIsIlBhcml0eVN5c3RlbSIsImFwcGx5IiwiY29tcGlsZXIiLCJyZWdpc3RlciIsImNvbXBpbGVySG9va3MiLCJob29rcyIsInJ1blBhcml0eU9yUmVzZXQiLCJfY29tcGlsZXIiLCJwYXJpdHlSb290IiwiX2hhcmRTb3VyY2VQYXJpdHlDYWNoZSIsImNhbGwiLCJ2ZXJpZnkiLCJjYWNoZU5vUGFyaXR5IiwiX2hhcmRTb3VyY2VSZXNldENhY2hlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJ3YXRjaFJ1biIsInRhcFByb21pc2UiLCJydW4iLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsZUFBZUMsUUFBUSxzQkFBUixDQUFyQjtBQUNBLE1BQU1DLGNBQWNELFFBQVEscUJBQVIsQ0FBcEI7QUFDQSxNQUFNLEVBQUVFLFVBQUYsS0FBaUJGLFFBQVEsZUFBUixDQUF2Qjs7QUFFQSxNQUFNRyxZQUFOLENBQW1CO0FBQ2pCQyxRQUFNQyxRQUFOLEVBQWdCO0FBQ2ROLGlCQUFhTyxRQUFiLENBQXNCRCxRQUF0QixFQUFnQyx3QkFBaEMsRUFBMEQsTUFBMUQsRUFBa0UsQ0FDaEUsWUFEZ0UsQ0FBbEU7O0FBSUEsVUFBTUUsZ0JBQWdCUixhQUFhUyxLQUFiLENBQW1CSCxRQUFuQixDQUF0Qjs7QUFFQSxhQUFTSSxnQkFBVCxDQUEwQkMsU0FBMUIsRUFBcUM7QUFDbkMsWUFBTUMsYUFBYSxJQUFJVCxVQUFKLEVBQW5CO0FBQ0FLLG9CQUFjSyxzQkFBZCxDQUFxQ0MsSUFBckMsQ0FBMENGLFVBQTFDO0FBQ0EsVUFBSSxDQUFDQSxXQUFXRyxNQUFYLEVBQUwsRUFBMEI7QUFDeEJiLG9CQUFZYyxhQUFaLENBQTBCVixRQUExQixFQUFvQyxFQUFFTSxVQUFGLEVBQXBDOztBQUVBO0FBQ0E7QUFDQUosc0JBQWNTLHFCQUFkLENBQW9DSCxJQUFwQztBQUNEOztBQUVELGFBQU9JLFFBQVFDLE9BQVIsRUFBUDtBQUNEOztBQUVEWCxrQkFBY1ksUUFBZCxDQUF1QkMsVUFBdkIsQ0FDRSxvQ0FERixFQUVFWCxnQkFGRjtBQUlBRixrQkFBY2MsR0FBZCxDQUFrQkQsVUFBbEIsQ0FDRSxvQ0FERixFQUVFWCxnQkFGRjtBQUlEO0FBOUJnQjs7QUFpQ25CYSxPQUFPQyxPQUFQLEdBQWlCcEIsWUFBakIiLCJmaWxlIjoiaGFyZC1zb3VyY2Utd2VicGFjay1wbHVnaW4vbGliL1N5c3RlbVBhcml0eS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHBsdWdpbkNvbXBhdCA9IHJlcXVpcmUoJy4vdXRpbC9wbHVnaW4tY29tcGF0Jyk7XG5jb25zdCBsb2dNZXNzYWdlcyA9IHJlcXVpcmUoJy4vdXRpbC9sb2ctbWVzc2FnZXMnKTtcbmNvbnN0IHsgUGFyaXR5Um9vdCB9ID0gcmVxdWlyZSgnLi91dGlsL3Bhcml0eScpO1xuXG5jbGFzcyBQYXJpdHlTeXN0ZW0ge1xuICBhcHBseShjb21waWxlcikge1xuICAgIHBsdWdpbkNvbXBhdC5yZWdpc3Rlcihjb21waWxlciwgJ19oYXJkU291cmNlUGFyaXR5Q2FjaGUnLCAnc3luYycsIFtcbiAgICAgICdwYXJpdHlSb290JyxcbiAgICBdKTtcblxuICAgIGNvbnN0IGNvbXBpbGVySG9va3MgPSBwbHVnaW5Db21wYXQuaG9va3MoY29tcGlsZXIpO1xuXG4gICAgZnVuY3Rpb24gcnVuUGFyaXR5T3JSZXNldChfY29tcGlsZXIpIHtcbiAgICAgIGNvbnN0IHBhcml0eVJvb3QgPSBuZXcgUGFyaXR5Um9vdCgpO1xuICAgICAgY29tcGlsZXJIb29rcy5faGFyZFNvdXJjZVBhcml0eUNhY2hlLmNhbGwocGFyaXR5Um9vdCk7XG4gICAgICBpZiAoIXBhcml0eVJvb3QudmVyaWZ5KCkpIHtcbiAgICAgICAgbG9nTWVzc2FnZXMuY2FjaGVOb1Bhcml0eShjb21waWxlciwgeyBwYXJpdHlSb290IH0pO1xuXG4gICAgICAgIC8vIFJlc2V0IHRoZSBjYWNoZSwgc29tZSBwYXJ0IG9mIGl0IGlzIGluY29tcGxldGUgYW5kIHVzaW5nIGl0IHdpbGwgbGVhZFxuICAgICAgICAvLyB0byBlcnJvcnMuXG4gICAgICAgIGNvbXBpbGVySG9va3MuX2hhcmRTb3VyY2VSZXNldENhY2hlLmNhbGwoKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cblxuICAgIGNvbXBpbGVySG9va3Mud2F0Y2hSdW4udGFwUHJvbWlzZShcbiAgICAgICdIYXJkU291cmNlIC0gaW5kZXggLSBwYXJpdHlPclJlc2V0JyxcbiAgICAgIHJ1blBhcml0eU9yUmVzZXQsXG4gICAgKTtcbiAgICBjb21waWxlckhvb2tzLnJ1bi50YXBQcm9taXNlKFxuICAgICAgJ0hhcmRTb3VyY2UgLSBpbmRleCAtIHBhcml0eU9yUmVzZXQnLFxuICAgICAgcnVuUGFyaXR5T3JSZXNldCxcbiAgICApO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gUGFyaXR5U3lzdGVtO1xuIl0sInNvdXJjZVJvb3QiOiIvVXNlcnMvdHlsZXJhcmJ1cy9kZXYvcHJvdmlkZXIvc3JjIn0=
