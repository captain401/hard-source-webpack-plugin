'use strict';

const relateContext = require('./util/relate-context');
const pluginCompat = require('./util/plugin-compat');

const ParserSchemas3 = [['Parser', 'options']];
const ParserSchemas4 = [['JsonParser', 'options'], ['Parser', 'options', 'sourceType'], ['WebAssemblyParser', 'options']];

try {
  ParserSchemas3[0].Parser = require('webpack/lib/Parser');
} catch (_) {}

try {
  ParserSchemas4[0].Parser = require('webpack/lib/JsonParser');
  ParserSchemas4[1].Parser = require('webpack/lib/Parser');
  try {
    ParserSchemas4[2].Parser = require('webpack/lib/WebAssemblyParser');
  } catch (_) {
    ParserSchemas4[2].Parser = require('webpack/lib/wasm/WebAssemblyParser');
  }
} catch (_) {}

const freezeArgument = {};

const thawArgument = {};

function freezeParser(parser, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (parser.constructor === schemas[i].Parser) {
      const frozen = {
        type: schemas[i][0]
      };
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = parser[schemas[i][j]];
        if (freezeArgument[schemas[i][j]]) {
          arg = freezeArgument[schemas[i][j]](arg, parser, extra, methods);
        }
        frozen[schemas[i][j]] = arg;
      }
      return frozen;
    }
  }
}

function thawParser(frozen, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (frozen.type === schemas[i][0]) {
      const Parser = schemas[i].Parser;
      const args = [];
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = frozen[schemas[i][j]];
        if (thawArgument[schemas[i][j]]) {
          arg = thawArgument[schemas[i][j]](arg, frozen, extra, methods);
        }
        args.push(arg);
      }
      try {
        return new Parser(...args);
      } catch (_) {
        return new (Function.prototype.bind.apply(Parser, [null].concat(args)))();
      }
    }
  }
}

class TransformParserPlugin {
  constructor(options) {
    this.options = options || {};
  }

  apply(compiler) {
    const schema = this.options.schema;
    let schemas = ParserSchemas4;
    if (schema < 4) {
      schemas = ParserSchemas3;
    }

    pluginCompat.register(compiler, '_hardSourceBeforeFreezeParser', 'syncWaterfall', ['frozen', 'item', 'extra']);
    pluginCompat.register(compiler, '_hardSourceFreezeParser', 'syncWaterfall', ['frozen', 'item', 'extra']);
    pluginCompat.register(compiler, '_hardSourceAfterFreezeParser', 'syncWaterfall', ['frozen', 'item', 'extra']);

    pluginCompat.register(compiler, '_hardSourceBeforeThawParser', 'syncWaterfall', ['item', 'frozen', 'extra']);
    pluginCompat.register(compiler, '_hardSourceThawParser', 'syncWaterfall', ['item', 'frozen', 'extra']);
    pluginCompat.register(compiler, '_hardSourceAfterThawParser', 'syncWaterfall', ['item', 'frozen', 'extra']);

    let methods;

    pluginCompat.tap(compiler, '_hardSourceMethods', 'TransformParserPlugin', _methods => {
      methods = _methods;
    });

    pluginCompat.tap(compiler, '_hardSourceFreezeParser', 'TransformParserPlugin freeze', (frozen, parser, extra) => {
      extra.schemas = schemas;
      frozen = freezeParser(parser, extra, methods);
      if (schema === 4) {
        frozen.moduleType = extra.module.type;
      }
      return frozen;
    });

    pluginCompat.tap(compiler, '_hardSourceThawParser', 'TransformParserPlugin thaw', (parser, { options, moduleType }, { normalModuleFactory }) => {
      if (schema < 4) {
        return normalModuleFactory.getParser(options);
      } else {
        return normalModuleFactory.getParser(moduleType, options);
      }
    });
  }
}

module.exports = TransformParserPlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9UcmFuc2Zvcm1QYXJzZXJQbHVnaW4uanMiXSwibmFtZXMiOlsicmVsYXRlQ29udGV4dCIsInJlcXVpcmUiLCJwbHVnaW5Db21wYXQiLCJQYXJzZXJTY2hlbWFzMyIsIlBhcnNlclNjaGVtYXM0IiwiUGFyc2VyIiwiXyIsImZyZWV6ZUFyZ3VtZW50IiwidGhhd0FyZ3VtZW50IiwiZnJlZXplUGFyc2VyIiwicGFyc2VyIiwiZXh0cmEiLCJtZXRob2RzIiwic2NoZW1hcyIsImkiLCJsZW5ndGgiLCJjb25zdHJ1Y3RvciIsImZyb3plbiIsInR5cGUiLCJqIiwiYXJnIiwidGhhd1BhcnNlciIsImFyZ3MiLCJwdXNoIiwiRnVuY3Rpb24iLCJwcm90b3R5cGUiLCJiaW5kIiwiYXBwbHkiLCJjb25jYXQiLCJUcmFuc2Zvcm1QYXJzZXJQbHVnaW4iLCJvcHRpb25zIiwiY29tcGlsZXIiLCJzY2hlbWEiLCJyZWdpc3RlciIsInRhcCIsIl9tZXRob2RzIiwibW9kdWxlVHlwZSIsIm1vZHVsZSIsIm5vcm1hbE1vZHVsZUZhY3RvcnkiLCJnZXRQYXJzZXIiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLGdCQUFnQkMsZ0NBQXRCO0FBQ0EsTUFBTUMsZUFBZUQsK0JBQXJCOztBQUVBLE1BQU1FLGlCQUFpQixDQUFDLENBQUMsUUFBRCxFQUFXLFNBQVgsQ0FBRCxDQUF2QjtBQUNBLE1BQU1DLGlCQUFpQixDQUNyQixDQUFDLFlBQUQsRUFBZSxTQUFmLENBRHFCLEVBRXJCLENBQUMsUUFBRCxFQUFXLFNBQVgsRUFBc0IsWUFBdEIsQ0FGcUIsRUFHckIsQ0FBQyxtQkFBRCxFQUFzQixTQUF0QixDQUhxQixDQUF2Qjs7QUFNQSxJQUFJO0FBQ0ZELGlCQUFlLENBQWYsRUFBa0JFLE1BQWxCLEdBQTJCSixRQUFRLG9CQUFSLENBQTNCO0FBQ0QsQ0FGRCxDQUVFLE9BQU9LLENBQVAsRUFBVSxDQUFFOztBQUVk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Z0MsR0FBYixDQUNFSCxRQURGLEVBRUUsb0JBRkYsRUFHRSx1QkFIRixFQUlFSSxZQUFZO0FBQ1Z2QixnQkFBVXVCLFFBQVY7QUFDRCxLQU5IOztBQVNBakMsaUJBQWFnQyxHQUFiLENBQ0VILFFBREYsRUFFRSx5QkFGRixFQUdFLDhCQUhGLEVBSUUsQ0FBQ2QsTUFBRCxFQUFTUCxNQUFULEVBQWlCQyxLQUFqQixLQUEyQjtBQUN6QkEsWUFBTUUsT0FBTixHQUFnQkEsT0FBaEI7QUFDQUksZUFBU1IsYUFBYUMsTUFBYixFQUFxQkMsS0FBckIsRUFBNEJDLE9BQTVCLENBQVQ7QUFDQSxVQUFJb0IsV0FBVyxDQUFmLEVBQWtCO0FBQ2hCZixlQUFPbUIsVUFBUCxHQUFvQnpCLE1BQU0wQixNQUFOLENBQWFuQixJQUFqQztBQUNEO0FBQ0QsYUFBT0QsTUFBUDtBQUNELEtBWEg7O0FBY0FmLGlCQUFhZ0MsR0FBYixDQUNFSCxRQURGLEVBRUUsdUJBRkYsRUFHRSw0QkFIRixFQUlFLENBQUNyQixNQUFELEVBQVMsRUFBRW9CLE9BQUYsRUFBV00sVUFBWCxFQUFULEVBQWtDLEVBQUVFLG1CQUFGLEVBQWxDLEtBQThEO0FBQzVELFVBQUlOLFNBQVMsQ0FBYixFQUFnQjtBQUNkLGVBQU9NLG9CQUFvQkMsU0FBcEIsQ0FBOEJULE9BQTlCLENBQVA7QUFDRCxPQUZELE1BRU87QUFDTCxlQUFPUSxvQkFBb0JDLFNBQXBCLENBQThCSCxVQUE5QixFQUEwQ04sT0FBMUMsQ0FBUDtBQUNEO0FBQ0YsS0FWSDtBQVlEO0FBdEZ5Qjs7QUF5RjVCTyxPQUFPRyxPQUFQLEdBQWlCWCxxQkFBakIiLCJmaWxlIjoiaGFyZC1zb3VyY2Utd2VicGFjay1wbHVnaW4vbGliL1RyYW5zZm9ybVBhcnNlclBsdWdpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHJlbGF0ZUNvbnRleHQgPSByZXF1aXJlKCcuL3V0aWwvcmVsYXRlLWNvbnRleHQnKTtcbmNvbnN0IHBsdWdpbkNvbXBhdCA9IHJlcXVpcmUoJy4vdXRpbC9wbHVnaW4tY29tcGF0Jyk7XG5cbmNvbnN0IFBhcnNlclNjaGVtYXMzID0gW1snUGFyc2VyJywgJ29wdGlvbnMnXV07XG5jb25zdCBQYXJzZXJTY2hlbWFzNCA9IFtcbiAgWydKc29uUGFyc2VyJywgJ29wdGlvbnMnXSxcbiAgWydQYXJzZXInLCAnb3B0aW9ucycsICdzb3VyY2VUeXBlJ10sXG4gIFsnV2ViQXNzZW1ibHlQYXJzZXInLCAnb3B0aW9ucyddLFxuXTtcblxudHJ5IHtcbiAgUGFyc2VyU2NoZW1hczNbMF0uUGFyc2VyID0gcmVxdWlyZSgnd2VicGFjay9saWIvUGFyc2VyJyk7XG59IGNhdGNoIChfKSB7fVxuXG50cnkge1xuICBQYXJzZXJTY2hlbWFzNFswXS5QYXJzZXIgPSByZXF1aXJlKCd3ZWJwYWNrL2xpYi9Kc29uUGFyc2VyJyk7XG4gIFBhcnNlclNjaGVtYXM0WzFdLlBhcnNlciA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL1BhcnNlcicpO1xuICB0cnkge1xuICAgIFBhcnNlclNjaGVtYXM0WzJdLlBhcnNlciA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL1dlYkFzc2VtYmx5UGFyc2VyJyk7XG4gIH0gY2F0Y2ggKF8pIHtcbiAgICBQYXJzZXJTY2hlbWFzNFsyXS5QYXJzZXIgPSByZXF1aXJlKCd3ZWJwYWNrL2xpYi93YXNtL1dlYkFzc2VtYmx5UGFyc2VyJyk7XG4gIH1cbn0gY2F0Y2ggKF8pIHt9XG5cbmNvbnN0IGZyZWV6ZUFyZ3VtZW50ID0ge307XG5cbmNvbnN0IHRoYXdBcmd1bWVudCA9IHt9O1xuXG5mdW5jdGlvbiBmcmVlemVQYXJzZXIocGFyc2VyLCBleHRyYSwgbWV0aG9kcykge1xuICBjb25zdCBzY2hlbWFzID0gZXh0cmEuc2NoZW1hcztcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzY2hlbWFzLmxlbmd0aDsgaSsrKSB7XG4gICAgaWYgKHBhcnNlci5jb25zdHJ1Y3RvciA9PT0gc2NoZW1hc1tpXS5QYXJzZXIpIHtcbiAgICAgIGNvbnN0IGZyb3plbiA9IHtcbiAgICAgICAgdHlwZTogc2NoZW1hc1tpXVswXSxcbiAgICAgIH07XG4gICAgICBmb3IgKGxldCBqID0gMTsgaiA8IHNjaGVtYXNbaV0ubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgbGV0IGFyZyA9IHBhcnNlcltzY2hlbWFzW2ldW2pdXTtcbiAgICAgICAgaWYgKGZyZWV6ZUFyZ3VtZW50W3NjaGVtYXNbaV1bal1dKSB7XG4gICAgICAgICAgYXJnID0gZnJlZXplQXJndW1lbnRbc2NoZW1hc1tpXVtqXV0oYXJnLCBwYXJzZXIsIGV4dHJhLCBtZXRob2RzKTtcbiAgICAgICAgfVxuICAgICAgICBmcm96ZW5bc2NoZW1hc1tpXVtqXV0gPSBhcmc7XG4gICAgICB9XG4gICAgICByZXR1cm4gZnJvemVuO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiB0aGF3UGFyc2VyKGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgY29uc3Qgc2NoZW1hcyA9IGV4dHJhLnNjaGVtYXM7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgc2NoZW1hcy5sZW5ndGg7IGkrKykge1xuICAgIGlmIChmcm96ZW4udHlwZSA9PT0gc2NoZW1hc1tpXVswXSkge1xuICAgICAgY29uc3QgUGFyc2VyID0gc2NoZW1hc1tpXS5QYXJzZXI7XG4gICAgICBjb25zdCBhcmdzID0gW107XG4gICAgICBmb3IgKGxldCBqID0gMTsgaiA8IHNjaGVtYXNbaV0ubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgbGV0IGFyZyA9IGZyb3plbltzY2hlbWFzW2ldW2pdXTtcbiAgICAgICAgaWYgKHRoYXdBcmd1bWVudFtzY2hlbWFzW2ldW2pdXSkge1xuICAgICAgICAgIGFyZyA9IHRoYXdBcmd1bWVudFtzY2hlbWFzW2ldW2pdXShhcmcsIGZyb3plbiwgZXh0cmEsIG1ldGhvZHMpO1xuICAgICAgICB9XG4gICAgICAgIGFyZ3MucHVzaChhcmcpO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQYXJzZXIoLi4uYXJncyk7XG4gICAgICB9IGNhdGNoIChfKSB7XG4gICAgICAgIHJldHVybiBuZXcgKEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kLmFwcGx5KFxuICAgICAgICAgIFBhcnNlcixcbiAgICAgICAgICBbbnVsbF0uY29uY2F0KGFyZ3MpLFxuICAgICAgICApKSgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5jbGFzcyBUcmFuc2Zvcm1QYXJzZXJQbHVnaW4ge1xuICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgfVxuXG4gIGFwcGx5KGNvbXBpbGVyKSB7XG4gICAgY29uc3Qgc2NoZW1hID0gdGhpcy5vcHRpb25zLnNjaGVtYTtcbiAgICBsZXQgc2NoZW1hcyA9IFBhcnNlclNjaGVtYXM0O1xuICAgIGlmIChzY2hlbWEgPCA0KSB7XG4gICAgICBzY2hlbWFzID0gUGFyc2VyU2NoZW1hczM7XG4gICAgfVxuXG4gICAgcGx1Z2luQ29tcGF0LnJlZ2lzdGVyKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnX2hhcmRTb3VyY2VCZWZvcmVGcmVlemVQYXJzZXInLFxuICAgICAgJ3N5bmNXYXRlcmZhbGwnLFxuICAgICAgWydmcm96ZW4nLCAnaXRlbScsICdleHRyYSddLFxuICAgICk7XG4gICAgcGx1Z2luQ29tcGF0LnJlZ2lzdGVyKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnX2hhcmRTb3VyY2VGcmVlemVQYXJzZXInLFxuICAgICAgJ3N5bmNXYXRlcmZhbGwnLFxuICAgICAgWydmcm96ZW4nLCAnaXRlbScsICdleHRyYSddLFxuICAgICk7XG4gICAgcGx1Z2luQ29tcGF0LnJlZ2lzdGVyKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnX2hhcmRTb3VyY2VBZnRlckZyZWV6ZVBhcnNlcicsXG4gICAgICAnc3luY1dhdGVyZmFsbCcsXG4gICAgICBbJ2Zyb3plbicsICdpdGVtJywgJ2V4dHJhJ10sXG4gICAgKTtcblxuICAgIHBsdWdpbkNvbXBhdC5yZWdpc3RlcihcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlQmVmb3JlVGhhd1BhcnNlcicsXG4gICAgICAnc3luY1dhdGVyZmFsbCcsXG4gICAgICBbJ2l0ZW0nLCAnZnJvemVuJywgJ2V4dHJhJ10sXG4gICAgKTtcbiAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoY29tcGlsZXIsICdfaGFyZFNvdXJjZVRoYXdQYXJzZXInLCAnc3luY1dhdGVyZmFsbCcsIFtcbiAgICAgICdpdGVtJyxcbiAgICAgICdmcm96ZW4nLFxuICAgICAgJ2V4dHJhJyxcbiAgICBdKTtcbiAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZUFmdGVyVGhhd1BhcnNlcicsXG4gICAgICAnc3luY1dhdGVyZmFsbCcsXG4gICAgICBbJ2l0ZW0nLCAnZnJvemVuJywgJ2V4dHJhJ10sXG4gICAgKTtcblxuICAgIGxldCBtZXRob2RzO1xuXG4gICAgcGx1Z2luQ29tcGF0LnRhcChcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlTWV0aG9kcycsXG4gICAgICAnVHJhbnNmb3JtUGFyc2VyUGx1Z2luJyxcbiAgICAgIF9tZXRob2RzID0+IHtcbiAgICAgICAgbWV0aG9kcyA9IF9tZXRob2RzO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgcGx1Z2luQ29tcGF0LnRhcChcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlRnJlZXplUGFyc2VyJyxcbiAgICAgICdUcmFuc2Zvcm1QYXJzZXJQbHVnaW4gZnJlZXplJyxcbiAgICAgIChmcm96ZW4sIHBhcnNlciwgZXh0cmEpID0+IHtcbiAgICAgICAgZXh0cmEuc2NoZW1hcyA9IHNjaGVtYXM7XG4gICAgICAgIGZyb3plbiA9IGZyZWV6ZVBhcnNlcihwYXJzZXIsIGV4dHJhLCBtZXRob2RzKTtcbiAgICAgICAgaWYgKHNjaGVtYSA9PT0gNCkge1xuICAgICAgICAgIGZyb3plbi5tb2R1bGVUeXBlID0gZXh0cmEubW9kdWxlLnR5cGU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZyb3plbjtcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZVRoYXdQYXJzZXInLFxuICAgICAgJ1RyYW5zZm9ybVBhcnNlclBsdWdpbiB0aGF3JyxcbiAgICAgIChwYXJzZXIsIHsgb3B0aW9ucywgbW9kdWxlVHlwZSB9LCB7IG5vcm1hbE1vZHVsZUZhY3RvcnkgfSkgPT4ge1xuICAgICAgICBpZiAoc2NoZW1hIDwgNCkge1xuICAgICAgICAgIHJldHVybiBub3JtYWxNb2R1bGVGYWN0b3J5LmdldFBhcnNlcihvcHRpb25zKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gbm9ybWFsTW9kdWxlRmFjdG9yeS5nZXRQYXJzZXIobW9kdWxlVHlwZSwgb3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFRyYW5zZm9ybVBhcnNlclBsdWdpbjtcbiJdLCJzb3VyY2VSb290IjoiL1VzZXJzL3R5bGVyYXJidXMvZGV2L3Byb3ZpZGVyL3NyYyJ9
