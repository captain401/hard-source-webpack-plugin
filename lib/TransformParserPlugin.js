'use strict';

require('source-map-support/register');

const relateContext = require('./util/relate-context');
const pluginCompat = require('./util/plugin-compat');

const ParserSchemas3 = [['Parser', 'options']];
const ParserSchemas4 = [['JsonParser', 'options'], ['Parser', 'options', 'sourceType'], ['WebAssemblyParser', 'options']];

try {
  ParserSchemas3[0].Parser = require('webpack/lib/Parser');
} catch (_) {}

try {
  ParserSchemas4[0].Parser = require('webpack/lib/JsonParser');
  ParserSchemas4[1].Parser = require('webpack/lib/Parser');
  try {
    ParserSchemas4[2].Parser = require('webpack/lib/WebAssemblyParser');
  } catch (_) {
    ParserSchemas4[2].Parser = require('webpack/lib/wasm/WebAssemblyParser');
  }
} catch (_) {}

const freezeArgument = {};

const thawArgument = {};

function freezeParser(parser, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (parser.constructor === schemas[i].Parser) {
      const frozen = {
        type: schemas[i][0]
      };
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = parser[schemas[i][j]];
        if (freezeArgument[schemas[i][j]]) {
          arg = freezeArgument[schemas[i][j]](arg, parser, extra, methods);
        }
        frozen[schemas[i][j]] = arg;
      }
      return frozen;
    }
  }
}

function thawParser(frozen, extra, methods) {
  const schemas = extra.schemas;
  for (let i = 0; i < schemas.length; i++) {
    if (frozen.type === schemas[i][0]) {
      const Parser = schemas[i].Parser;
      const args = [];
      for (let j = 1; j < schemas[i].length; j++) {
        let arg = frozen[schemas[i][j]];
        if (thawArgument[schemas[i][j]]) {
          arg = thawArgument[schemas[i][j]](arg, frozen, extra, methods);
        }
        args.push(arg);
      }
      try {
        return new Parser(...args);
      } catch (_) {
        return new (Function.prototype.bind.apply(Parser, [null].concat(args)))();
      }
    }
  }
}

class TransformParserPlugin {
  constructor(options) {
    this.options = options || {};
  }

  apply(compiler) {
    const schema = this.options.schema;
    let schemas = ParserSchemas4;
    if (schema < 4) {
      schemas = ParserSchemas3;
    }

    pluginCompat.register(compiler, '_hardSourceBeforeFreezeParser', 'syncWaterfall', ['frozen', 'item', 'extra']);
    pluginCompat.register(compiler, '_hardSourceFreezeParser', 'syncWaterfall', ['frozen', 'item', 'extra']);
    pluginCompat.register(compiler, '_hardSourceAfterFreezeParser', 'syncWaterfall', ['frozen', 'item', 'extra']);

    pluginCompat.register(compiler, '_hardSourceBeforeThawParser', 'syncWaterfall', ['item', 'frozen', 'extra']);
    pluginCompat.register(compiler, '_hardSourceThawParser', 'syncWaterfall', ['item', 'frozen', 'extra']);
    pluginCompat.register(compiler, '_hardSourceAfterThawParser', 'syncWaterfall', ['item', 'frozen', 'extra']);

    let methods;

    pluginCompat.tap(compiler, '_hardSourceMethods', 'TransformParserPlugin', _methods => {
      methods = _methods;
    });

    pluginCompat.tap(compiler, '_hardSourceFreezeParser', 'TransformParserPlugin freeze', (frozen, parser, extra) => {
      extra.schemas = schemas;
      frozen = freezeParser(parser, extra, methods);
      if (schema === 4) {
        frozen.moduleType = extra.module.type;
      }
      return frozen;
    });

    pluginCompat.tap(compiler, '_hardSourceThawParser', 'TransformParserPlugin thaw', (parser, { options, moduleType }, { normalModuleFactory }) => {
      if (schema < 4) {
        return normalModuleFactory.getParser(options);
      } else {
        return normalModuleFactory.getParser(moduleType, options);
      }
    });
  }
}

module.exports = TransformParserPlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9UcmFuc2Zvcm1QYXJzZXJQbHVnaW4uanMiXSwibmFtZXMiOlsicmVsYXRlQ29udGV4dCIsInJlcXVpcmUiLCJwbHVnaW5Db21wYXQiLCJQYXJzZXJTY2hlbWFzMyIsIlBhcnNlclNjaGVtYXM0IiwiUGFyc2VyIiwiXyIsImZyZWV6ZUFyZ3VtZW50IiwidGhhd0FyZ3VtZW50IiwiZnJlZXplUGFyc2VyIiwicGFyc2VyIiwiZXh0cmEiLCJtZXRob2RzIiwic2NoZW1hcyIsImkiLCJsZW5ndGgiLCJjb25zdHJ1Y3RvciIsImZyb3plbiIsInR5cGUiLCJqIiwiYXJnIiwidGhhd1BhcnNlciIsImFyZ3MiLCJwdXNoIiwiRnVuY3Rpb24iLCJwcm90b3R5cGUiLCJiaW5kIiwiYXBwbHkiLCJjb25jYXQiLCJUcmFuc2Zvcm1QYXJzZXJQbHVnaW4iLCJvcHRpb25zIiwiY29tcGlsZXIiLCJzY2hlbWEiLCJyZWdpc3RlciIsInRhcCIsIl9tZXRob2RzIiwibW9kdWxlVHlwZSIsIm1vZHVsZSIsIm5vcm1hbE1vZHVsZUZhY3RvcnkiLCJnZXRQYXJzZXIiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsZ0JBQWdCQyxRQUFRLHVCQUFSLENBQXRCO0FBQ0EsTUFBTUMsZUFBZUQsUUFBUSxzQkFBUixDQUFyQjs7QUFFQSxNQUFNRSxpQkFBaUIsQ0FBQyxDQUFDLFFBQUQsRUFBVyxTQUFYLENBQUQsQ0FBdkI7QUFDQSxNQUFNQyxpQkFBaUIsQ0FDckIsQ0FBQyxZQUFELEVBQWUsU0FBZixDQURxQixFQUVyQixDQUFDLFFBQUQsRUFBVyxTQUFYLEVBQXNCLFlBQXRCLENBRnFCLEVBR3JCLENBQUMsbUJBQUQsRUFBc0IsU0FBdEIsQ0FIcUIsQ0FBdkI7O0FBTUEsSUFBSTtBQUNGRCxpQkFBZSxDQUFmLEVBQWtCRSxNQUFsQixHQUEyQkosUUFBUSxvQkFBUixDQUEzQjtBQUNELENBRkQsQ0FFRSxPQUFP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QUluQixPQUFKOztBQUVBVixpQkFBYWdDLEdBQWIsQ0FDRUgsUUFERixFQUVFLG9CQUZGLEVBR0UsdUJBSEYsRUFJRUksWUFBWTtBQUNWdkIsZ0JBQVV1QixRQUFWO0FBQ0QsS0FOSDs7QUFTQWpDLGlCQUFhZ0MsR0FBYixDQUNFSCxRQURGLEVBRUUseUJBRkYsRUFHRSw4QkFIRixFQUlFLENBQUNkLE1BQUQsRUFBU1AsTUFBVCxFQUFpQkMsS0FBakIsS0FBMkI7QUFDekJBLFlBQU1FLE9BQU4sR0FBZ0JBLE9BQWhCO0FBQ0FJLGVBQVNSLGFBQWFDLE1BQWIsRUFBcUJDLEtBQXJCLEVBQTRCQyxPQUE1QixDQUFUO0FBQ0EsVUFBSW9CLFdBQVcsQ0FBZixFQUFrQjtBQUNoQmYsZUFBT21CLFVBQVAsR0FBb0J6QixNQUFNMEIsTUFBTixDQUFhbkIsSUFBakM7QUFDRDtBQUNELGFBQU9ELE1BQVA7QUFDRCxLQVhIOztBQWNBZixpQkFBYWdDLEdBQWIsQ0FDRUgsUUFERixFQUVFLHVCQUZGLEVBR0UsNEJBSEYsRUFJRSxDQUFDckIsTUFBRCxFQUFTLEVBQUVvQixPQUFGLEVBQVdNLFVBQVgsRUFBVCxFQUFrQyxFQUFFRSxtQkFBRixFQUFsQyxLQUE4RDtBQUM1RCxVQUFJTixTQUFTLENBQWIsRUFBZ0I7QUFDZCxlQUFPTSxvQkFBb0JDLFNBQXBCLENBQThCVCxPQUE5QixDQUFQO0FBQ0QsT0FGRCxNQUVPO0FBQ0wsZUFBT1Esb0JBQW9CQyxTQUFwQixDQUE4QkgsVUFBOUIsRUFBMENOLE9BQTFDLENBQVA7QUFDRDtBQUNGLEtBVkg7QUFZRDtBQXRGeUI7O0FBeUY1Qk8sT0FBT0csT0FBUCxHQUFpQlgscUJBQWpCIiwiZmlsZSI6ImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9UcmFuc2Zvcm1QYXJzZXJQbHVnaW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCByZWxhdGVDb250ZXh0ID0gcmVxdWlyZSgnLi91dGlsL3JlbGF0ZS1jb250ZXh0Jyk7XG5jb25zdCBwbHVnaW5Db21wYXQgPSByZXF1aXJlKCcuL3V0aWwvcGx1Z2luLWNvbXBhdCcpO1xuXG5jb25zdCBQYXJzZXJTY2hlbWFzMyA9IFtbJ1BhcnNlcicsICdvcHRpb25zJ11dO1xuY29uc3QgUGFyc2VyU2NoZW1hczQgPSBbXG4gIFsnSnNvblBhcnNlcicsICdvcHRpb25zJ10sXG4gIFsnUGFyc2VyJywgJ29wdGlvbnMnLCAnc291cmNlVHlwZSddLFxuICBbJ1dlYkFzc2VtYmx5UGFyc2VyJywgJ29wdGlvbnMnXSxcbl07XG5cbnRyeSB7XG4gIFBhcnNlclNjaGVtYXMzWzBdLlBhcnNlciA9IHJlcXVpcmUoJ3dlYnBhY2svbGliL1BhcnNlcicpO1xufSBjYXRjaCAoXykge31cblxudHJ5IHtcbiAgUGFyc2VyU2NoZW1hczRbMF0uUGFyc2VyID0gcmVxdWlyZSgnd2VicGFjay9saWIvSnNvblBhcnNlcicpO1xuICBQYXJzZXJTY2hlbWFzNFsxXS5QYXJzZXIgPSByZXF1aXJlKCd3ZWJwYWNrL2xpYi9QYXJzZXInKTtcbiAgdHJ5IHtcbiAgICBQYXJzZXJTY2hlbWFzNFsyXS5QYXJzZXIgPSByZXF1aXJlKCd3ZWJwYWNrL2xpYi9XZWJBc3NlbWJseVBhcnNlcicpO1xuICB9IGNhdGNoIChfKSB7XG4gICAgUGFyc2VyU2NoZW1hczRbMl0uUGFyc2VyID0gcmVxdWlyZSgnd2VicGFjay9saWIvd2FzbS9XZWJBc3NlbWJseVBhcnNlcicpO1xuICB9XG59IGNhdGNoIChfKSB7fVxuXG5jb25zdCBmcmVlemVBcmd1bWVudCA9IHt9O1xuXG5jb25zdCB0aGF3QXJndW1lbnQgPSB7fTtcblxuZnVuY3Rpb24gZnJlZXplUGFyc2VyKHBhcnNlciwgZXh0cmEsIG1ldGhvZHMpIHtcbiAgY29uc3Qgc2NoZW1hcyA9IGV4dHJhLnNjaGVtYXM7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgc2NoZW1hcy5sZW5ndGg7IGkrKykge1xuICAgIGlmIChwYXJzZXIuY29uc3RydWN0b3IgPT09IHNjaGVtYXNbaV0uUGFyc2VyKSB7XG4gICAgICBjb25zdCBmcm96ZW4gPSB7XG4gICAgICAgIHR5cGU6IHNjaGVtYXNbaV1bMF0sXG4gICAgICB9O1xuICAgICAgZm9yIChsZXQgaiA9IDE7IGogPCBzY2hlbWFzW2ldLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGxldCBhcmcgPSBwYXJzZXJbc2NoZW1hc1tpXVtqXV07XG4gICAgICAgIGlmIChmcmVlemVBcmd1bWVudFtzY2hlbWFzW2ldW2pdXSkge1xuICAgICAgICAgIGFyZyA9IGZyZWV6ZUFyZ3VtZW50W3NjaGVtYXNbaV1bal1dKGFyZywgcGFyc2VyLCBleHRyYSwgbWV0aG9kcyk7XG4gICAgICAgIH1cbiAgICAgICAgZnJvemVuW3NjaGVtYXNbaV1bal1dID0gYXJnO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZyb3plbjtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gdGhhd1BhcnNlcihmcm96ZW4sIGV4dHJhLCBtZXRob2RzKSB7XG4gIGNvbnN0IHNjaGVtYXMgPSBleHRyYS5zY2hlbWFzO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHNjaGVtYXMubGVuZ3RoOyBpKyspIHtcbiAgICBpZiAoZnJvemVuLnR5cGUgPT09IHNjaGVtYXNbaV1bMF0pIHtcbiAgICAgIGNvbnN0IFBhcnNlciA9IHNjaGVtYXNbaV0uUGFyc2VyO1xuICAgICAgY29uc3QgYXJncyA9IFtdO1xuICAgICAgZm9yIChsZXQgaiA9IDE7IGogPCBzY2hlbWFzW2ldLmxlbmd0aDsgaisrKSB7XG4gICAgICAgIGxldCBhcmcgPSBmcm96ZW5bc2NoZW1hc1tpXVtqXV07XG4gICAgICAgIGlmICh0aGF3QXJndW1lbnRbc2NoZW1hc1tpXVtqXV0pIHtcbiAgICAgICAgICBhcmcgPSB0aGF3QXJndW1lbnRbc2NoZW1hc1tpXVtqXV0oYXJnLCBmcm96ZW4sIGV4dHJhLCBtZXRob2RzKTtcbiAgICAgICAgfVxuICAgICAgICBhcmdzLnB1c2goYXJnKTtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBuZXcgUGFyc2VyKC4uLmFyZ3MpO1xuICAgICAgfSBjYXRjaCAoXykge1xuICAgICAgICByZXR1cm4gbmV3IChGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5hcHBseShcbiAgICAgICAgICBQYXJzZXIsXG4gICAgICAgICAgW251bGxdLmNvbmNhdChhcmdzKSxcbiAgICAgICAgKSkoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgVHJhbnNmb3JtUGFyc2VyUGx1Z2luIHtcbiAgY29uc3RydWN0b3Iob3B0aW9ucykge1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gIH1cblxuICBhcHBseShjb21waWxlcikge1xuICAgIGNvbnN0IHNjaGVtYSA9IHRoaXMub3B0aW9ucy5zY2hlbWE7XG4gICAgbGV0IHNjaGVtYXMgPSBQYXJzZXJTY2hlbWFzNDtcbiAgICBpZiAoc2NoZW1hIDwgNCkge1xuICAgICAgc2NoZW1hcyA9IFBhcnNlclNjaGVtYXMzO1xuICAgIH1cblxuICAgIHBsdWdpbkNvbXBhdC5yZWdpc3RlcihcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlQmVmb3JlRnJlZXplUGFyc2VyJyxcbiAgICAgICdzeW5jV2F0ZXJmYWxsJyxcbiAgICAgIFsnZnJvemVuJywgJ2l0ZW0nLCAnZXh0cmEnXSxcbiAgICApO1xuICAgIHBsdWdpbkNvbXBhdC5yZWdpc3RlcihcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlRnJlZXplUGFyc2VyJyxcbiAgICAgICdzeW5jV2F0ZXJmYWxsJyxcbiAgICAgIFsnZnJvemVuJywgJ2l0ZW0nLCAnZXh0cmEnXSxcbiAgICApO1xuICAgIHBsdWdpbkNvbXBhdC5yZWdpc3RlcihcbiAgICAgIGNvbXBpbGVyLFxuICAgICAgJ19oYXJkU291cmNlQWZ0ZXJGcmVlemVQYXJzZXInLFxuICAgICAgJ3N5bmNXYXRlcmZhbGwnLFxuICAgICAgWydmcm96ZW4nLCAnaXRlbScsICdleHRyYSddLFxuICAgICk7XG5cbiAgICBwbHVnaW5Db21wYXQucmVnaXN0ZXIoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZUJlZm9yZVRoYXdQYXJzZXInLFxuICAgICAgJ3N5bmNXYXRlcmZhbGwnLFxuICAgICAgWydpdGVtJywgJ2Zyb3plbicsICdleHRyYSddLFxuICAgICk7XG4gICAgcGx1Z2luQ29tcGF0LnJlZ2lzdGVyKGNvbXBpbGVyLCAnX2hhcmRTb3VyY2VUaGF3UGFyc2VyJywgJ3N5bmNXYXRlcmZhbGwnLCBbXG4gICAgICAnaXRlbScsXG4gICAgICAnZnJvemVuJyxcbiAgICAgICdleHRyYScsXG4gICAgXSk7XG4gICAgcGx1Z2luQ29tcGF0LnJlZ2lzdGVyKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnX2hhcmRTb3VyY2VBZnRlclRoYXdQYXJzZXInLFxuICAgICAgJ3N5bmNXYXRlcmZhbGwnLFxuICAgICAgWydpdGVtJywgJ2Zyb3plbicsICdleHRyYSddLFxuICAgICk7XG5cbiAgICBsZXQgbWV0aG9kcztcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZU1ldGhvZHMnLFxuICAgICAgJ1RyYW5zZm9ybVBhcnNlclBsdWdpbicsXG4gICAgICBfbWV0aG9kcyA9PiB7XG4gICAgICAgIG1ldGhvZHMgPSBfbWV0aG9kcztcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdfaGFyZFNvdXJjZUZyZWV6ZVBhcnNlcicsXG4gICAgICAnVHJhbnNmb3JtUGFyc2VyUGx1Z2luIGZyZWV6ZScsXG4gICAgICAoZnJvemVuLCBwYXJzZXIsIGV4dHJhKSA9PiB7XG4gICAgICAgIGV4dHJhLnNjaGVtYXMgPSBzY2hlbWFzO1xuICAgICAgICBmcm96ZW4gPSBmcmVlemVQYXJzZXIocGFyc2VyLCBleHRyYSwgbWV0aG9kcyk7XG4gICAgICAgIGlmIChzY2hlbWEgPT09IDQpIHtcbiAgICAgICAgICBmcm96ZW4ubW9kdWxlVHlwZSA9IGV4dHJhLm1vZHVsZS50eXBlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmcm96ZW47XG4gICAgICB9LFxuICAgICk7XG5cbiAgICBwbHVnaW5Db21wYXQudGFwKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnX2hhcmRTb3VyY2VUaGF3UGFyc2VyJyxcbiAgICAgICdUcmFuc2Zvcm1QYXJzZXJQbHVnaW4gdGhhdycsXG4gICAgICAocGFyc2VyLCB7IG9wdGlvbnMsIG1vZHVsZVR5cGUgfSwgeyBub3JtYWxNb2R1bGVGYWN0b3J5IH0pID0+IHtcbiAgICAgICAgaWYgKHNjaGVtYSA8IDQpIHtcbiAgICAgICAgICByZXR1cm4gbm9ybWFsTW9kdWxlRmFjdG9yeS5nZXRQYXJzZXIob3B0aW9ucyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIG5vcm1hbE1vZHVsZUZhY3RvcnkuZ2V0UGFyc2VyKG1vZHVsZVR5cGUsIG9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBUcmFuc2Zvcm1QYXJzZXJQbHVnaW47XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
