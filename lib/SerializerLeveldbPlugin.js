'use strict';

require('source-map-support/register');

const join = require('path').join;

const pluginCompat = require('./util/plugin-compat');

let LevelDbSerializer;
let AppendSerializerPlugin;

class HardSourceLevelDbSerializerPlugin {
  apply(compiler) {
    pluginCompat.tap(compiler, 'hardSourceCacheFactory', 'LevelDbSerializer', factory => info => {
      if (info.type === 'data') {
        return HardSourceLevelDbSerializerPlugin.createSerializer(info);
      }
      return factory(info);
    });
  }
}

HardSourceLevelDbSerializerPlugin.createSerializer = info => {
  if (!LevelDbSerializer) {
    try {
      LevelDbSerializer = require('./SerializerLeveldb');
    } catch (e) {}
  }

  if (LevelDbSerializer) {
    return new LevelDbSerializer({
      cacheDirPath: join(info.cacheDirPath, info.name)
    });
  } else {
    if (!AppendSerializerPlugin) {
      AppendSerializerPlugin = require('./SerializerAppendPlugin');
    }

    return AppendSerializerPlugin.createSerializer(info);
  }
};

module.exports = HardSourceLevelDbSerializerPlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9TZXJpYWxpemVyTGV2ZWxkYlBsdWdpbi5qcyJdLCJuYW1lcyI6WyJqb2luIiwicmVxdWlyZSIsInBsdWdpbkNvbXBhdCIsIkxldmVsRGJTZXJpYWxpemVyIiwiQXBwZW5kU2VyaWFsaXplclBsdWdpbiIsIkhhcmRTb3VyY2VMZXZlbERiU2VyaWFsaXplclBsdWdpbiIsImFwcGx5IiwiY29tcGlsZXIiLCJ0YXAiLCJmYWN0b3J5IiwiaW5mbyIsInR5cGUiLCJjcmVhdGVTZXJpYWxpemVyIiwiZSIsImNhY2hlRGlyUGF0aCIsIm5hbWUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsT0FBT0MsUUFBUSxNQUFSLEVBQWdCRCxJQUE3Qjs7QUFFQSxNQUFNRSxlQUFlRCxRQUFRLHNCQUFSLENBQXJCOztBQUVBLElBQUlFLGlCQUFKO0FBQ0EsSUFBSUMsc0JBQUo7O0FBRUEsTUFBTUMsaUNBQU4sQ0FBd0M7QUFDdENDLFFBQU1DLFFBQU4sRUFBZ0I7QUFDZEwsaUJBQWFNLEdBQWIsQ0FDRUQsUUFERixFQUVFLHdCQUZGLEVBR0UsbUJBSEYsRUFJRUUsV0FBV0MsUUFBUTtBQUNqQixVQUFJQSxLQUFLQyxJQUFMLEtBQWMsTUFBbEIsRUFBMEI7QUFDeEIsZUFBT04sa0NBQWtDTyxnQkFBbEMsQ0FBbURGLElBQW5ELENBQVA7QUFDRDtBQUNELGFBQU9ELFFBQVFDLElBQVIsQ0FBUDtBQUNELEtBVEg7QUFXRDtBQWJxQzs7QUFnQnhDTCxrQ0FBa0NPLGdCQUFsQyxHQUFxREYsUUFBUTtBQUMzRCxNQUFJLENBQUNQLGlCQUFMLEVBQXdCO0FBQ3RCLFFBQUk7QUFDRkEsMEJBQW9CRixRQUFRLHFCQUFSLENBQXBCO0FBQ0QsS0FGRCxDQUVFLE9BQU9ZLENBQVAsRUFBVSxDQUFFO0FBQ2Y7O0FBRUQsTUFBSVYsaUJBQUosRUFBdUI7QUFDckIsV0FBTyxJQUFJQSxpQkFBSixDQUFzQjtBQUMzQlcsb0JBQWNkLEtBQUtVLEtBQUtJLFlBQVYsRUFBd0JKLEtBQUtLLElBQTdCO0FBRGEsS0FBdEIsQ0FBUDtBQUdELEdBSkQsTUFJTztBQUNMLFFBQUksQ0FBQ1gsc0JBQUwsRUFBNkI7QUFDM0JBLCtCQUF5QkgsUUFBUSwwQkFBUixDQUF6QjtBQUNEOztBQUVELFdBQU9HLHVCQUF1QlEsZ0JBQXZCLENBQXdDRixJQUF4QyxDQUFQO0FBQ0Q7QUFDRixDQWxCRDs7QUFvQkFNLE9BQU9DLE9BQVAsR0FBaUJaLGlDQUFqQiIsImZpbGUiOiJoYXJkLXNvdXJjZS13ZWJwYWNrLXBsdWdpbi9saWIvU2VyaWFsaXplckxldmVsZGJQbHVnaW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBqb2luID0gcmVxdWlyZSgncGF0aCcpLmpvaW47XG5cbmNvbnN0IHBsdWdpbkNvbXBhdCA9IHJlcXVpcmUoJy4vdXRpbC9wbHVnaW4tY29tcGF0Jyk7XG5cbmxldCBMZXZlbERiU2VyaWFsaXplcjtcbmxldCBBcHBlbmRTZXJpYWxpemVyUGx1Z2luO1xuXG5jbGFzcyBIYXJkU291cmNlTGV2ZWxEYlNlcmlhbGl6ZXJQbHVnaW4ge1xuICBhcHBseShjb21waWxlcikge1xuICAgIHBsdWdpbkNvbXBhdC50YXAoXG4gICAgICBjb21waWxlcixcbiAgICAgICdoYXJkU291cmNlQ2FjaGVGYWN0b3J5JyxcbiAgICAgICdMZXZlbERiU2VyaWFsaXplcicsXG4gICAgICBmYWN0b3J5ID0+IGluZm8gPT4ge1xuICAgICAgICBpZiAoaW5mby50eXBlID09PSAnZGF0YScpIHtcbiAgICAgICAgICByZXR1cm4gSGFyZFNvdXJjZUxldmVsRGJTZXJpYWxpemVyUGx1Z2luLmNyZWF0ZVNlcmlhbGl6ZXIoaW5mbyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhY3RvcnkoaW5mbyk7XG4gICAgICB9LFxuICAgICk7XG4gIH1cbn1cblxuSGFyZFNvdXJjZUxldmVsRGJTZXJpYWxpemVyUGx1Z2luLmNyZWF0ZVNlcmlhbGl6ZXIgPSBpbmZvID0+IHtcbiAgaWYgKCFMZXZlbERiU2VyaWFsaXplcikge1xuICAgIHRyeSB7XG4gICAgICBMZXZlbERiU2VyaWFsaXplciA9IHJlcXVpcmUoJy4vU2VyaWFsaXplckxldmVsZGInKTtcbiAgICB9IGNhdGNoIChlKSB7fVxuICB9XG5cbiAgaWYgKExldmVsRGJTZXJpYWxpemVyKSB7XG4gICAgcmV0dXJuIG5ldyBMZXZlbERiU2VyaWFsaXplcih7XG4gICAgICBjYWNoZURpclBhdGg6IGpvaW4oaW5mby5jYWNoZURpclBhdGgsIGluZm8ubmFtZSksXG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKCFBcHBlbmRTZXJpYWxpemVyUGx1Z2luKSB7XG4gICAgICBBcHBlbmRTZXJpYWxpemVyUGx1Z2luID0gcmVxdWlyZSgnLi9TZXJpYWxpemVyQXBwZW5kUGx1Z2luJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIEFwcGVuZFNlcmlhbGl6ZXJQbHVnaW4uY3JlYXRlU2VyaWFsaXplcihpbmZvKTtcbiAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBIYXJkU291cmNlTGV2ZWxEYlNlcmlhbGl6ZXJQbHVnaW47XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
