'use strict';

const join = require('path').join;

const pluginCompat = require('./util/plugin-compat');

let LevelDbSerializer;
let AppendSerializerPlugin;

class HardSourceLevelDbSerializerPlugin {
  apply(compiler) {
    pluginCompat.tap(compiler, 'hardSourceCacheFactory', 'LevelDbSerializer', factory => info => {
      if (info.type === 'data') {
        return HardSourceLevelDbSerializerPlugin.createSerializer(info);
      }
      return factory(info);
    });
  }
}

HardSourceLevelDbSerializerPlugin.createSerializer = info => {
  if (!LevelDbSerializer) {
    try {
      LevelDbSerializer = require('./SerializerLeveldb');
    } catch (e) {}
  }

  if (LevelDbSerializer) {
    return new LevelDbSerializer({
      cacheDirPath: join(info.cacheDirPath, info.name)
    });
  } else {
    if (!AppendSerializerPlugin) {
      AppendSerializerPlugin = require('./SerializerAppendPlugin');
    }

    return AppendSerializerPlugin.createSerializer(info);
  }
};

module.exports = HardSourceLevelDbSerializerPlugin;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9TZXJpYWxpemVyTGV2ZWxkYlBsdWdpbi5qcyJdLCJuYW1lcyI6WyJqb2luIiwicmVxdWlyZSIsInBsdWdpbkNvbXBhdCIsIkxldmVsRGJTZXJpYWxpemVyIiwiQXBwZW5kU2VyaWFsaXplclBsdWdpbiIsIkhhcmRTb3VyY2VMZXZlbERiU2VyaWFsaXplclBsdWdpbiIsImFwcGx5IiwiY29tcGlsZXIiLCJ0YXAiLCJmYWN0b3J5IiwiaW5mbyIsInR5cGUiLCJjcmVhdGVTZXJpYWxpemVyIiwiZSIsImNhY2hlRGlyUGF0aCIsIm5hbWUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLE9BQU9DLFFBQVEsTUFBUixFQUFnQkQsSUFBN0I7O0FBRUEsTUFBTUUsZUFBZUQsK0JBQXJCOztBQUVBLElBQUlFLGlCQUFKO0FBQ0EsSUFBSUMsc0JBQUo7O0FBRUEsTUFBTUMsaUNBQU4sQ0FBd0M7QUFDdENDLFFBQU1DLFFBQU4sRUFBZ0I7QUFDZEwsaUJBQWFNLEdBQWIsQ0FDRUQsUUFERixFQUVFLHdCQUZGLEVBR0UsbUJBSEYsRUFJRUUsV0FBV0MsUUFBUTtBQUNqQixVQUFJQSxLQUFLQyxJQUFMLEtBQWMsTUFBbEIsRUFBMEI7QUFDeEIsZUFBT04sa0NBQWtDTyxnQkFBbEMsQ0FBbURGLElBQW5ELENBQVA7QUFDRDtBQUNELGFBQU9ELFFBQVFDLElBQVIsQ0FBUDtBQUNELEtBVEg7QUFXRDtBQWJxQzs7QUFnQnhDTCxrQ0FBa0NPLGdCQUFsQyxHQUFxREYsUUFBUTtBQUMzRCxNQUFJLENBQUNQLGlCQUFMLEVBQXdCO0FBQ3RCLFFBQUk7QUFDRkEsMEJBQW9CRiw4QkFBcEI7QUFDRCxLQUZELENBRUUsT0FBT1ksQ0FBUCxFQUFVLENBQUU7QUFDZjs7QUFFRCxNQUFJVixpQkFBSixFQUF1QjtBQUNyQixXQUFPLElBQUlBLGlCQUFKLENBQXNCO0FBQzNCVyxvQkFBY2QsS0FBS1UsS0FBS0ksWUFBVixFQUF3QkosS0FBS0ssSUFBN0I7QUFEYSxLQUF0QixDQUFQO0FBR0QsR0FKRCxNQUlPO0FBQ0wsUUFBSSxDQUFDWCxzQkFBTCxFQUE2QjtBQUMzQkEsK0JBQXlCSCxtQ0FBekI7QUFDRDs7QUFFRCxXQUFPRyx1QkFBdUJRLGdCQUF2QixDQUF3Q0YsSUFBeEMsQ0FBUDtBQUNEO0FBQ0YsQ0FsQkQ7O0FBb0JBTSxPQUFPQyxPQUFQLEdBQWlCWixpQ0FBakIiLCJmaWxlIjoiaGFyZC1zb3VyY2Utd2VicGFjay1wbHVnaW4vbGliL1NlcmlhbGl6ZXJMZXZlbGRiUGx1Z2luLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgam9pbiA9IHJlcXVpcmUoJ3BhdGgnKS5qb2luO1xuXG5jb25zdCBwbHVnaW5Db21wYXQgPSByZXF1aXJlKCcuL3V0aWwvcGx1Z2luLWNvbXBhdCcpO1xuXG5sZXQgTGV2ZWxEYlNlcmlhbGl6ZXI7XG5sZXQgQXBwZW5kU2VyaWFsaXplclBsdWdpbjtcblxuY2xhc3MgSGFyZFNvdXJjZUxldmVsRGJTZXJpYWxpemVyUGx1Z2luIHtcbiAgYXBwbHkoY29tcGlsZXIpIHtcbiAgICBwbHVnaW5Db21wYXQudGFwKFxuICAgICAgY29tcGlsZXIsXG4gICAgICAnaGFyZFNvdXJjZUNhY2hlRmFjdG9yeScsXG4gICAgICAnTGV2ZWxEYlNlcmlhbGl6ZXInLFxuICAgICAgZmFjdG9yeSA9PiBpbmZvID0+IHtcbiAgICAgICAgaWYgKGluZm8udHlwZSA9PT0gJ2RhdGEnKSB7XG4gICAgICAgICAgcmV0dXJuIEhhcmRTb3VyY2VMZXZlbERiU2VyaWFsaXplclBsdWdpbi5jcmVhdGVTZXJpYWxpemVyKGluZm8pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWN0b3J5KGluZm8pO1xuICAgICAgfSxcbiAgICApO1xuICB9XG59XG5cbkhhcmRTb3VyY2VMZXZlbERiU2VyaWFsaXplclBsdWdpbi5jcmVhdGVTZXJpYWxpemVyID0gaW5mbyA9PiB7XG4gIGlmICghTGV2ZWxEYlNlcmlhbGl6ZXIpIHtcbiAgICB0cnkge1xuICAgICAgTGV2ZWxEYlNlcmlhbGl6ZXIgPSByZXF1aXJlKCcuL1NlcmlhbGl6ZXJMZXZlbGRiJyk7XG4gICAgfSBjYXRjaCAoZSkge31cbiAgfVxuXG4gIGlmIChMZXZlbERiU2VyaWFsaXplcikge1xuICAgIHJldHVybiBuZXcgTGV2ZWxEYlNlcmlhbGl6ZXIoe1xuICAgICAgY2FjaGVEaXJQYXRoOiBqb2luKGluZm8uY2FjaGVEaXJQYXRoLCBpbmZvLm5hbWUpLFxuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIGlmICghQXBwZW5kU2VyaWFsaXplclBsdWdpbikge1xuICAgICAgQXBwZW5kU2VyaWFsaXplclBsdWdpbiA9IHJlcXVpcmUoJy4vU2VyaWFsaXplckFwcGVuZFBsdWdpbicpO1xuICAgIH1cblxuICAgIHJldHVybiBBcHBlbmRTZXJpYWxpemVyUGx1Z2luLmNyZWF0ZVNlcmlhbGl6ZXIoaW5mbyk7XG4gIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gSGFyZFNvdXJjZUxldmVsRGJTZXJpYWxpemVyUGx1Z2luO1xuIl0sInNvdXJjZVJvb3QiOiIvVXNlcnMvdHlsZXJhcmJ1cy9kZXYvcHJvdmlkZXIvc3JjIn0=
