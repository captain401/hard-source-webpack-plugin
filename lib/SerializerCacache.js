'use strict';

require('source-map-support/register');

const cacache = require('cacache');

class CacacheSerializer {
  constructor({ cacheDirPath }) {
    this.path = cacheDirPath;
  }

  read() {
    const cache = {};
    const promises = [];
    return new Promise((resolve, reject) => {
      cacache.ls.stream(this.path).on('data', ({ key }) => {
        promises.push(cacache.get(this.path, key).then(({ data }) => {
          cache[key] = JSON.parse(data);
        }));
      }).on('error', reject).on('end', () => {
        resolve();
      });
    }).then(() => Promise.all(promises)).then(() => cache);
  }

  write(ops) {
    return Promise.all(ops.map(op => {
      if (op.value) {
        return cacache.put(this.path, op.key, JSON.stringify(op.value));
      } else {
        return cacache.rm.entry(this.path, op.key);
      }
    }));
  }
}

module.exports = CacacheSerializer;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9TZXJpYWxpemVyQ2FjYWNoZS5qcyJdLCJuYW1lcyI6WyJjYWNhY2hlIiwicmVxdWlyZSIsIkNhY2FjaGVTZXJpYWxpemVyIiwiY29uc3RydWN0b3IiLCJjYWNoZURpclBhdGgiLCJwYXRoIiwicmVhZCIsImNhY2hlIiwicHJvbWlzZXMiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImxzIiwic3RyZWFtIiwib24iLCJrZXkiLCJwdXNoIiwiZ2V0IiwidGhlbiIsImRhdGEiLCJKU09OIiwicGFyc2UiLCJhbGwiLCJ3cml0ZSIsIm9wcyIsIm1hcCIsIm9wIiwidmFsdWUiLCJwdXQiLCJzdHJpbmdpZnkiLCJybSIsImVudHJ5IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLFVBQVVDLFFBQVEsU0FBUixDQUFoQjs7QUFFQSxNQUFNQyxpQkFBTixDQUF3QjtBQUN0QkMsY0FBWSxFQUFFQyxZQUFGLEVBQVosRUFBOEI7QUFDNUIsU0FBS0MsSUFBTCxHQUFZRCxZQUFaO0FBQ0Q7O0FBRURFLFNBQU87QUFDTCxVQUFNQyxRQUFRLEVBQWQ7QUFDQSxVQUFNQyxXQUFXLEVBQWpCO0FBQ0EsV0FBTyxJQUFJQyxPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQ3RDWCxjQUFRWSxFQUFSLENBQ0dDLE1BREgsQ0FDVSxLQUFLUixJQURmLEVBRUdTLEVBRkgsQ0FFTSxNQUZOLEVBRWMsQ0FBQyxFQUFFQyxHQUFGLEVBQUQsS0FBYTtBQUN2QlAsaUJBQVNRLElBQVQsQ0FDRWhCLFFBQVFpQixHQUFSLENBQVksS0FBS1osSUFBakIsRUFBdUJVLEdBQXZCLEVBQTRCRyxJQUE1QixDQUFpQyxDQUFDLEVBQUVDLElBQUYsRUFBRCxLQUFjO0FBQzdDWixnQkFBTVEsR0FBTixJQUFhSyxLQUFLQyxLQUFMLENBQVdGLElBQVgsQ0FBYjtBQUNELFNBRkQsQ0FERjtBQUtELE9BUkgsRUFTR0wsRUFUSCxDQVNNLE9BVE4sRUFTZUgsTUFUZixFQVVHRyxFQVZILENBVU0sS0FWTixFQVVhLE1BQU07QUFDZko7QUFDRCxPQVpIO0FBYUQsS0FkTSxFQWVKUSxJQWZJLENBZUMsTUFBTVQsUUFBUWEsR0FBUixDQUFZZCxRQUFaLENBZlAsRUFnQkpVLElBaEJJLENBZ0JDLE1BQU1YLEtBaEJQLENBQVA7QUFpQkQ7O0FBRURnQixRQUFNQyxHQUFOLEVBQVc7QUFDVCxXQUFPZixRQUFRYSxHQUFSLENBQ0xFLElBQUlDLEdBQUosQ0FBUUMsTUFBTTtBQUNaLFVBQUlBLEdBQUdDLEtBQVAsRUFBYztBQUNaLGVBQU8zQixRQUFRNEIsR0FBUixDQUFZLEtBQUt2QixJQUFqQixFQUF1QnFCLEdBQUdYLEdBQTFCLEVBQStCSyxLQUFLUyxTQUFMLENBQWVILEdBQUdDLEtBQWxCLENBQS9CLENBQVA7QUFDRCxPQUZELE1BRU87QUFDTCxlQUFPM0IsUUFBUThCLEVBQVIsQ0FBV0MsS0FBWCxDQUFpQixLQUFLMUIsSUFBdEIsRUFBNEJxQixHQUFHWCxHQUEvQixDQUFQO0FBQ0Q7QUFDRixLQU5ELENBREssQ0FBUDtBQVNEO0FBckNxQjs7QUF3Q3hCaUIsT0FBT0MsT0FBUCxHQUFpQi9CLGlCQUFqQiIsImZpbGUiOiJoYXJkLXNvdXJjZS13ZWJwYWNrLXBsdWdpbi9saWIvU2VyaWFsaXplckNhY2FjaGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBjYWNhY2hlID0gcmVxdWlyZSgnY2FjYWNoZScpO1xuXG5jbGFzcyBDYWNhY2hlU2VyaWFsaXplciB7XG4gIGNvbnN0cnVjdG9yKHsgY2FjaGVEaXJQYXRoIH0pIHtcbiAgICB0aGlzLnBhdGggPSBjYWNoZURpclBhdGg7XG4gIH1cblxuICByZWFkKCkge1xuICAgIGNvbnN0IGNhY2hlID0ge307XG4gICAgY29uc3QgcHJvbWlzZXMgPSBbXTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY2FjYWNoZS5sc1xuICAgICAgICAuc3RyZWFtKHRoaXMucGF0aClcbiAgICAgICAgLm9uKCdkYXRhJywgKHsga2V5IH0pID0+IHtcbiAgICAgICAgICBwcm9taXNlcy5wdXNoKFxuICAgICAgICAgICAgY2FjYWNoZS5nZXQodGhpcy5wYXRoLCBrZXkpLnRoZW4oKHsgZGF0YSB9KSA9PiB7XG4gICAgICAgICAgICAgIGNhY2hlW2tleV0gPSBKU09OLnBhcnNlKGRhdGEpO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgKTtcbiAgICAgICAgfSlcbiAgICAgICAgLm9uKCdlcnJvcicsIHJlamVjdClcbiAgICAgICAgLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9KTtcbiAgICB9KVxuICAgICAgLnRoZW4oKCkgPT4gUHJvbWlzZS5hbGwocHJvbWlzZXMpKVxuICAgICAgLnRoZW4oKCkgPT4gY2FjaGUpO1xuICB9XG5cbiAgd3JpdGUob3BzKSB7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFxuICAgICAgb3BzLm1hcChvcCA9PiB7XG4gICAgICAgIGlmIChvcC52YWx1ZSkge1xuICAgICAgICAgIHJldHVybiBjYWNhY2hlLnB1dCh0aGlzLnBhdGgsIG9wLmtleSwgSlNPTi5zdHJpbmdpZnkob3AudmFsdWUpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gY2FjYWNoZS5ybS5lbnRyeSh0aGlzLnBhdGgsIG9wLmtleSk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBDYWNhY2hlU2VyaWFsaXplcjtcbiJdLCJzb3VyY2VSb290IjoiL1VzZXJzL3R5bGVyYXJidXMvZGV2L3Byb3ZpZGVyL3NyYyJ9
