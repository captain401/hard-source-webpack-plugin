'use strict';

const cacache = require('cacache');

class CacacheSerializer {
  constructor({ cacheDirPath }) {
    this.path = cacheDirPath;
  }

  read() {
    const cache = {};
    const promises = [];
    return new Promise((resolve, reject) => {
      cacache.ls.stream(this.path).on('data', ({ key }) => {
        promises.push(cacache.get(this.path, key).then(({ data }) => {
          cache[key] = JSON.parse(data);
        }));
      }).on('error', reject).on('end', () => {
        resolve();
      });
    }).then(() => Promise.all(promises)).then(() => cache);
  }

  write(ops) {
    return Promise.all(ops.map(op => {
      if (op.value) {
        return cacache.put(this.path, op.key, JSON.stringify(op.value));
      } else {
        return cacache.rm.entry(this.path, op.key);
      }
    }));
  }
}

module.exports = CacacheSerializer;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhcmQtc291cmNlLXdlYnBhY2stcGx1Z2luL2xpYi9TZXJpYWxpemVyQ2FjYWNoZS5qcyJdLCJuYW1lcyI6WyJjYWNhY2hlIiwicmVxdWlyZSIsIkNhY2FjaGVTZXJpYWxpemVyIiwiY29uc3RydWN0b3IiLCJjYWNoZURpclBhdGgiLCJwYXRoIiwicmVhZCIsImNhY2hlIiwicHJvbWlzZXMiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImxzIiwic3RyZWFtIiwib24iLCJrZXkiLCJwdXNoIiwiZ2V0IiwidGhlbiIsImRhdGEiLCJKU09OIiwicGFyc2UiLCJhbGwiLCJ3cml0ZSIsIm9wcyIsIm1hcCIsIm9wIiwidmFsdWUiLCJwdXQiLCJzdHJpbmdpZnkiLCJybSIsImVudHJ5IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxVQUFVQyxRQUFRLFNBQVIsQ0FBaEI7O0FBRUEsTUFBTUMsaUJBQU4sQ0FBd0I7QUFDdEJDLGNBQVksRUFBRUMsWUFBRixFQUFaLEVBQThCO0FBQzVCLFNBQUtDLElBQUwsR0FBWUQsWUFBWjtBQUNEOztBQUVERSxTQUFPO0FBQ0wsVUFBTUMsUUFBUSxFQUFkO0FBQ0EsVUFBTUMsV0FBVyxFQUFqQjtBQUNBLFdBQU8sSUFBSUMsT0FBSixDQUFZLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUN0Q1gsY0FBUVksRUFBUixDQUNHQyxNQURILENBQ1UsS0FBS1IsSUFEZixFQUVHUyxFQUZILENBRU0sTUFGTixFQUVjLENBQUMsRUFBRUMsR0FBRixFQUFELEtBQWE7QUFDdkJQLGlCQUFTUSxJQUFULENBQ0VoQixRQUFRaUIsR0FBUixDQUFZLEtBQUtaLElBQWpCLEVBQXVCVSxHQUF2QixFQUE0QkcsSUFBNUIsQ0FBaUMsQ0FBQyxFQUFFQyxJQUFGLEVBQUQsS0FBYztBQUM3Q1osZ0JBQU1RLEdBQU4sSUFBYUssS0FBS0MsS0FBTCxDQUFXRixJQUFYLENBQWI7QUFDRCxTQUZELENBREY7QUFLRCxPQVJILEVBU0dMLEVBVEgsQ0FTTSxPQVROLEVBU2VILE1BVGYsRUFVR0csRUFWSCxDQVVNLEtBVk4sRUFVYSxNQUFNO0FBQ2ZKO0FBQ0QsT0FaSDtBQWFELEtBZE0sRUFlSlEsSUFmSSxDQWVDLE1BQU1ULFFBQVFhLEdBQVIsQ0FBWWQsUUFBWixDQWZQLEVBZ0JKVSxJQWhCSSxDQWdCQyxNQUFNWCxLQWhCUCxDQUFQO0FBaUJEOztBQUVEZ0IsUUFBTUMsR0FBTixFQUFXO0FBQ1QsV0FBT2YsUUFBUWEsR0FBUixDQUNMRSxJQUFJQyxHQUFKLENBQVFDLE1BQU07QUFDWixVQUFJQSxHQUFHQyxLQUFQLEVBQWM7QUFDWixlQUFPM0IsUUFBUTRCLEdBQVIsQ0FBWSxLQUFLdkIsSUFBakIsRUFBdUJxQixHQUFHWCxHQUExQixFQUErQkssS0FBS1MsU0FBTCxDQUFlSCxHQUFHQyxLQUFsQixDQUEvQixDQUFQO0FBQ0QsT0FGRCxNQUVPO0FBQ0wsZUFBTzNCLFFBQVE4QixFQUFSLENBQVdDLEtBQVgsQ0FBaUIsS0FBSzFCLElBQXRCLEVBQTRCcUIsR0FBR1gsR0FBL0IsQ0FBUDtBQUNEO0FBQ0YsS0FORCxDQURLLENBQVA7QUFTRDtBQXJDcUI7O0FBd0N4QmlCLE9BQU9DLE9BQVAsR0FBaUIvQixpQkFBakIiLCJmaWxlIjoiaGFyZC1zb3VyY2Utd2VicGFjay1wbHVnaW4vbGliL1NlcmlhbGl6ZXJDYWNhY2hlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgY2FjYWNoZSA9IHJlcXVpcmUoJ2NhY2FjaGUnKTtcblxuY2xhc3MgQ2FjYWNoZVNlcmlhbGl6ZXIge1xuICBjb25zdHJ1Y3Rvcih7IGNhY2hlRGlyUGF0aCB9KSB7XG4gICAgdGhpcy5wYXRoID0gY2FjaGVEaXJQYXRoO1xuICB9XG5cbiAgcmVhZCgpIHtcbiAgICBjb25zdCBjYWNoZSA9IHt9O1xuICAgIGNvbnN0IHByb21pc2VzID0gW107XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNhY2FjaGUubHNcbiAgICAgICAgLnN0cmVhbSh0aGlzLnBhdGgpXG4gICAgICAgIC5vbignZGF0YScsICh7IGtleSB9KSA9PiB7XG4gICAgICAgICAgcHJvbWlzZXMucHVzaChcbiAgICAgICAgICAgIGNhY2FjaGUuZ2V0KHRoaXMucGF0aCwga2V5KS50aGVuKCh7IGRhdGEgfSkgPT4ge1xuICAgICAgICAgICAgICBjYWNoZVtrZXldID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICk7XG4gICAgICAgIH0pXG4gICAgICAgIC5vbignZXJyb3InLCByZWplY3QpXG4gICAgICAgIC5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfSk7XG4gICAgfSlcbiAgICAgIC50aGVuKCgpID0+IFByb21pc2UuYWxsKHByb21pc2VzKSlcbiAgICAgIC50aGVuKCgpID0+IGNhY2hlKTtcbiAgfVxuXG4gIHdyaXRlKG9wcykge1xuICAgIHJldHVybiBQcm9taXNlLmFsbChcbiAgICAgIG9wcy5tYXAob3AgPT4ge1xuICAgICAgICBpZiAob3AudmFsdWUpIHtcbiAgICAgICAgICByZXR1cm4gY2FjYWNoZS5wdXQodGhpcy5wYXRoLCBvcC5rZXksIEpTT04uc3RyaW5naWZ5KG9wLnZhbHVlKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIGNhY2FjaGUucm0uZW50cnkodGhpcy5wYXRoLCBvcC5rZXkpO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICApO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQ2FjYWNoZVNlcmlhbGl6ZXI7XG4iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy90eWxlcmFyYnVzL2Rldi9wcm92aWRlci9zcmMifQ==
